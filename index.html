<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="msapplication-navbutton-color" content="#E8A9B3">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .header {
                padding-top: 12px;
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding-top: var(--safe-area-inset-top);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .header h1 { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .header-subtitle { 
            font-size: calc(11px * var(--font-scale)); 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .header-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #10b981; 
            border: 2px solid white; 
        }
        
        .sync-indicator.syncing { 
            background: #f39c12; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        .sync-status-bar { 
            background: var(--button-primary); 
            color: white; 
            padding: 4px 10px; 
            font-size: calc(11px * var(--font-scale)); 
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
        }
        
        .tabs { 
            background: var(--card-bg); 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            overflow-x: auto; 
        }
        
        .tab { 
            flex: 1; 
            min-width: 80px; 
            padding: 10px 8px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            font-size: calc(12px * var(--font-scale)); 
            transition: all 0.2s;
        }
        
        .tab.active { 
            color: var(--accent-color); 
            border-bottom-color: var(--accent-color); 
        }
        
        .stats-bar { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: var(--bg-color); 
        }
        
        .main-content-wrapper {
            margin-top: 200px;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 210px;
            }
        }
        
        .container { 
            padding: 10px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 80px; 
        }
        
        .stat-card { 
            background: var(--card-bg); 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px var(--shadow-color); 
            text-align: center; 
        }
        
        .stat-card h3 { 
            font-size: calc(16px * var(--font-scale)); 
            color: var(--accent-color); 
            margin-bottom: 2px; 
            font-weight: 700; 
        }
        
        .stat-card.income h3 { color: var(--income-color); }
        .stat-card.expense h3 { color: var(--expense-color); }
        
        .stat-card p {
            color: var(--text-secondary);
            font-size: calc(11px * var(--font-scale));
        }
        
        .project-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            margin-bottom: 12px; 
            overflow: visible;
        }
        
        .project-header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 12px; 
            border-radius: 12px 12px 0 0;
            transition: all 0.2s;
        }
        
        .project-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .project-header:active {
            transform: translateY(0);
        }
        
        .project-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: rgba(0,0,0,0.1); 
            margin-top: 8px;
            border-radius: 8px;
        }
        
        .project-actions { 
            display: flex; 
            gap: 5px; 
            margin-top: 8px; 
            flex-wrap: wrap; 
        }
        
        .action-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(10px * var(--font-scale)); 
            transition: background 0.2s;
        }
        
        .action-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .gantt-container { 
            background: var(--card-bg); 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            overflow-x: auto; 
            margin-bottom: 15px; 
            position: relative;
        }
        
        .gantt-timeline-header {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        .gantt-timeline-months {
            margin-left: 150px;
            display: flex;
            flex: 1;
            gap: 2px;
        }
        
        .gantt-month {
            flex: 1;
            text-align: center;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-secondary);
            font-weight: 600;
            padding: 4px;
            background: var(--bg-color);
            border-radius: 4px;
        }
        
        .gantt-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            min-height: 40px; 
        }
        
        .gantt-label { 
            width: 150px; 
            font-size: calc(11px * var(--font-scale)); 
            font-weight: 500; 
            color: var(--text-color); 
            padding-right: 10px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .gantt-timeline { 
            flex: 1; 
            position: relative; 
            height: 35px; 
            background: var(--bg-color); 
            border-radius: 4px; 
        }
        
        .gantt-bar { 
            position: absolute; 
            height: 100%; 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 0 8px; 
            font-size: calc(9px * var(--font-scale)); 
            color: white; 
            font-weight: 500; 
            cursor: pointer;
        }
        
        .gantt-bar-dates {
            font-size: calc(8px * var(--font-scale));
            opacity: 0.9;
        }
        
        .today-line {
            position: absolute;
            top: -10px;
            bottom: -10px;
            width: 4px;
            background: #ef4444;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
        }
        
        .today-line::before {
            content: 'TODAY';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            padding: 20px; 
        }
        
        .modal.show { display: flex; }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 12px; 
            width: 100%; 
            max-width: 400px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            background: var(--bg-color); 
            color: var(--text-color); 
        }
        
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .btn-primary { 
            background: var(--button-primary); 
            color: white; 
        }
        
        .btn-primary:hover {
            background: var(--button-primary-hover);
        }
        
        .btn-secondary { 
            background: var(--bg-color); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .settings-panel { 
            position: fixed; 
            top: 0; 
            right: -100%; 
            width: 90%; 
            max-width: 400px; 
            height: 100vh; 
            background: var(--card-bg); 
            box-shadow: -2px 0 10px rgba(0,0,0,0.2); 
            transition: right 0.3s; 
            z-index: 1001; 
            overflow-y: auto; 
            padding: 20px; 
            padding-top: calc(20px + var(--safe-area-inset-top));
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        .settings-panel.show { right: 0; }
        
        .settings-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            transition: opacity 0.3s;
        }
        
        .settings-backdrop.show {
            display: block;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-top: 10px;
        }
        
        .settings-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .settings-close-btn:active {
            background: var(--bg-color);
        }
        
        .theme-grid { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
        }
        
        .theme-option { 
            padding: 10px;
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.2s; 
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .theme-option:hover { 
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .theme-option.active { 
            border-color: var(--button-primary); 
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .theme-preview {
            height: 50px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .theme-name {
            font-size: 11px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .contrast-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .contrast-btn {
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: calc(11px * var(--font-scale));
            transition: all 0.2s;
            color: var(--text-color);
        }
        
        .contrast-btn.active {
            background: var(--button-primary);
            color: white;
            border-color: var(--button-primary);
        }
        
        .fab-container { 
            position: fixed; 
            bottom: calc(20px + var(--safe-area-inset-bottom)); 
            right: 20px; 
            z-index: 99; 
        }
        
        .fab { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: var(--button-primary); 
            color: white; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px var(--shadow-color); 
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .fab:hover {
            background: var(--button-primary-hover);
            transform: scale(1.05);
        }
        
        .fab-menu { 
            position: absolute; 
            bottom: 60px; 
            right: 0; 
            display: none; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .fab-menu.show { display: flex; }
        
        .fab-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            background: var(--card-bg); 
            color: var(--text-color);
            border-radius: 8px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            cursor: pointer; 
            white-space: nowrap; 
            font-size: calc(12px * var(--font-scale)); 
        }
        
        .toast { 
            position: fixed; 
            bottom: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--card-bg); 
            color: var(--text-color); 
            padding: 12px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            z-index: 9999; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .toast.show { opacity: 1; }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-secondary); 
        }
        
        .smart-reminder {
            position: fixed;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 12px 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            z-index: 9998;
            max-width: 280px;
            animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .smart-reminder:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }
        
        .smart-reminder.night-mode-reminder {
            background: #3d3d3d;
            border-color: #ffc107;
            color: #fff;
        }
        
        @keyframes slideInBounce {
            0% {
                transform: translateX(100px) scale(0.5);
                opacity: 0;
            }
            70% {
                transform: translateX(-10px) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            to {
                transform: translateX(150px);
                opacity: 0;
            }
        }
        
        .reminder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #856404;
        }
        
        .night-mode-reminder .reminder-header {
            color: #ffc107;
        }
        
        .attention-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulseDot 1.5s infinite;
            flex-shrink: 0;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
        }
        
        @keyframes pulseDot {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }
        
        .reminder-content {
            font-size: 12px;
            line-height: 1.4;
            color: #664d03;
            margin-bottom: 8px;
        }
        
        .night-mode-reminder .reminder-content {
            color: #e0e0e0;
        }
        
        .reminder-action {
            font-size: 11px;
            color: #0066cc;
            font-weight: 500;
            text-decoration: underline;
        }
        
        .night-mode-reminder .reminder-action {
            color: #66b3ff;
        }
        
        .reminder-close {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 18px;
            color: #856404;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .night-mode-reminder .reminder-close {
            color: #ffc107;
        }
        
        .reminder-close:hover {
            opacity: 1;
        }
        
        .task-item { 
            padding: 10px; 
            margin-bottom: 8px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            border-left: 3px solid var(--accent-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .task-item {
                padding: 8px;
                gap: 8px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: calc(14px * var(--font-scale));
            }
        }
        
        .icon-btn { 
            background: var(--accent-color); 
            border: none; 
            color: white; 
            width: 28px; 
            height: 28px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(12px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .icon-btn:hover {
            transform: scale(1.05);
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        .icon-btn.danger { 
            background: var(--danger); 
        }
        
        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .calendar-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 15px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 10px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            padding: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 4px;
            font-size: calc(10px * var(--font-scale));
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: var(--card-bg);
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--shadow-color);
            z-index: 10;
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
            font-weight: bold;
            border: 3px solid #dc2626 !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.7) !important;
            animation: todayPulse 2s infinite;
            transform: scale(1.05);
            z-index: 20;
        }
        
        @keyframes todayPulse {
            0%, 100% { 
                box-shadow: 0 0 25px rgba(239, 68, 68, 0.7);
            }
            50% { 
                box-shadow: 0 0 35px rgba(239, 68, 68, 1);
            }
        }
        
        .calendar-day.today:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            transform: scale(1.08) !important;
        }
        
        .calendar-day.today .calendar-event {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #ef4444 !important;
            font-weight: 700;
        }
        
        .calendar-day.has-event {
            border: 2px solid var(--highlight-color);
        }
        
        .calendar-event {
            font-size: calc(8px * var(--font-scale));
            padding: 2px;
            background: var(--accent-color);
            color: white;
            border-radius: 2px;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sync-calendar-btn {
            background: var(--button-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: calc(13px * var(--font-scale));
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 250px;
            }
            
            .tabs {
                -webkit-overflow-scrolling: touch;
            }
            
            .fab {
                width: 56px;
                height: 56px;
            }
            
            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                max-height: 350px;
            }
            
            .theme-preview {
                height: 40px;
                font-size: 12px;
            }
            
            .stats-bar {
                gap: 6px;
                padding: 8px;
            }
            
            .stat-card {
                padding: 8px;
            }
            
            .stat-card h3 {
                font-size: calc(14px * var(--font-scale));
            }
            
            .stat-card p {
                font-size: calc(10px * var(--font-scale));
            }
            
            .task-item {
                padding: 8px;
                gap: 8px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: calc(14px * var(--font-scale));
            }
            
            .project-card {
                margin-bottom: 16px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: calc(12px * var(--font-scale));
            }
        }
        
        @media (max-width: 400px) {
            .main-content-wrapper {
                margin-top: 260px;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .gantt-label {
                width: 100px;
                font-size: calc(10px * var(--font-scale));
            }
            
            .project-header h3 {
                font-size: calc(14px * var(--font-scale));
            }
            
            .action-btn {
                font-size: calc(9px * var(--font-scale));
                padding: 3px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="showProfileModal()">
                        <div>
                            <h1 id="headerName">Builder Pro</h1>
                            <div class="header-subtitle" id="headerPosition">by REFIT Interior</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="smartSync()" title="Smart Sync">
                            🔄
                            <span class="sync-indicator" id="syncIndicator"></span>
                        </button>
                        <button class="header-btn" onclick="toggleSettings()" title="Settings">⚙️</button>
                    </div>
                </div>
                <div class="sync-status-bar" id="syncStatusBar">
                    <span id="deviceType"></span> • 
                    <span id="lastSyncTime" style="cursor: pointer;" onclick="showToast('Click 🔄 to sync now')" title="Click 🔄 to sync">Never synced</span> • 
                    <span id="syncMode">Offline</span>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchView('home')">Home</div>
                <div class="tab" onclick="switchView('kanban')">Kanban</div>
                <div class="tab" onclick="switchView('projects')">Projects</div>
                <div class="tab" onclick="switchView('schedule')">Schedule</div>
                <div class="tab" onclick="switchView('calendar')">Calendar</div>
            </div>

            <div class="stats-bar">
                <div class="stat-card">
                    <h3 id="totalProjects">0</h3>
                    <p>Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTasks">0</h3>
                    <p>Tasks</p>
                </div>
                <div class="stat-card income">
                    <h3 id="totalIncome">$0</h3>
                    <p>Income</p>
                </div>
                <div class="stat-card expense">
                    <h3 id="totalExpenses">$0</h3>
                    <p>Expenses</p>
                </div>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="container" id="mainContent"></div>
        </div>
    </div>

    <div class="settings-backdrop" id="settingsBackdrop" onclick="toggleSettings()"></div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span style="font-size: 1.25rem; font-weight: bold; color: var(--text-color);">⚙️ Settings</span>
            <button class="settings-close-btn" onclick="toggleSettings()">✕</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔑 Smart Sync API</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="password" id="apiKeyInput" placeholder="JSONBin API Key" style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
            </div>
            <div style="padding: 8px; background: var(--bg-color); border-radius: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">
                <strong style="color: var(--text-color);">🧠 Smart Sync Logic:</strong><br>
                1️⃣ Pull cloud data<br>
                2️⃣ Compare timestamps (created_at, updated_at)<br>
                3️⃣ Keep most recent version<br>
                4️⃣ Push merged data to cloud<br>
                <span style="color: var(--accent-color); font-weight: bold;">✓ Latest edits always win!</span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: 500; color: var(--text-color);">⚡ Auto-Sync (every 5 minutes)</span>
                <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()" style="width: 44px; height: 24px;">
            </div>
            <button class="btn btn-primary" onclick="smartSync()" style="width: 100%; margin-bottom: 8px;">🔄 Manual Sync Now</button>
            <button class="btn btn-secondary" onclick="testSync()" style="width: 100%;">🔍 Test Sync Connection</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: 600; color: var(--text-color);">🧠 Smart Reminders</span>
                <input type="checkbox" id="smartRemindersToggle" onchange="toggleSmartReminders()" checked style="width: 44px; height: 24px;">
            </div>
            <p style="font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">
                Auto-detects missed tasks, overdue items, and important actions. Shows helpful sticky notes with attention dots!
            </p>
            <button class="btn btn-secondary" onclick="showSmartReminder()" style="width: 100%; font-size: 12px;">
                🔍 Check For Reminders Now
            </button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Theme Colors (18 Premium Themes)</label>
            <div class="theme-grid" id="themeGrid"></div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">⚡ Theme Contrast</label>
            <div class="contrast-controls">
                <button class="contrast-btn" onclick="setContrast('low')">Low</button>
                <button class="contrast-btn active" onclick="setContrast('normal')">Normal</button>
                <button class="contrast-btn" onclick="setContrast('high')">High</button>
                <button class="contrast-btn" onclick="setContrast('extra')">Extra</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Color Saturation</label>
            <div class="contrast-controls">
                <button class="contrast-btn" onclick="setSaturation('low')">Low</button>
                <button class="contrast-btn active" onclick="setSaturation('normal')">Normal</button>
                <button class="contrast-btn" onclick="setSaturation('high')">High</button>
                <button class="contrast-btn" onclick="setSaturation('vibrant')">Vibrant</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔤 Font Size</label>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <button class="btn btn-secondary" onclick="setFontSize('s')">S</button>
                <button class="btn btn-secondary" onclick="setFontSize('m')">M</button>
                <button class="btn btn-secondary" onclick="setFontSize('l')">L</button>
                <button class="btn btn-secondary" onclick="setFontSize('xl')">XL</button>
                <button class="btn btn-secondary" onclick="setFontSize('xxl')">XXL</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 600; color: var(--text-color);">🌙 Night Mode</span>
                <input type="checkbox" id="nightToggle" onchange="toggleNightMode()" style="width: 44px; height: 24px;">
            </div>
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="exportData()" style="width: 100%;">📤 Export Data</button>
            <label class="btn btn-success" style="display: block; text-align: center; margin-top: 10px; width: 100%;">
                📥 Import Data
                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
            </label>
        </div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="showProjectModal()">
                <span>📁</span>New Project
            </div>
            <div class="fab-option" onclick="showTaskModal()">
                <span>📋</span>New Task
            </div>
            <div class="fab-option" onclick="showTransactionModal('income')">
                <span>💰</span>Add Income
            </div>
            <div class="fab-option" onclick="showTransactionModal('expense')">
                <span>💸</span>Add Expense
            </div>
        </div>
        <button class="fab" onclick="toggleFabMenu()">+</button>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: var(--text-color);">Profile Settings</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('profileModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Your Name</label>
                    <input type="text" id="profileName" placeholder="John Doe" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Position</label>
                    <input type="text" id="profilePosition" placeholder="Project Manager" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('profileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectModalTitle" style="color: var(--text-color);">New Project</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('projectModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project Name *</label>
                    <input type="text" id="projectName" placeholder="Kitchen Renovation">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Client Name *</label>
                    <input type="text" id="projectClient" placeholder="John Doe">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="projectStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">End Date</label>
                        <input type="date" id="projectEnd">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="projectLocked" style="width: 20px; height: 20px;">
                    <label for="projectLocked" style="font-size: 12px; color: var(--text-color);">🔒 Lock project (prevents editing)</label>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="taskModalTitle" style="color: var(--text-color);">New Task</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('taskModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Task Name *</label>
                    <input type="text" id="taskName" placeholder="Install cabinets">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="taskProject"></select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Due Date *</label>
                        <input type="date" id="taskDue">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Priority</label>
                        <select id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Status</label>
                        <select id="taskStatus">
                            <option value="Get Ready">Get Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Worker name">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="taskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="transactionModalTitle" style="color: var(--text-color);">Add Transaction</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('transactionModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Type</label>
                    <select id="transType" onchange="updateCategories()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="transProject"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Category *</label>
                    <select id="transCategory"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Amount ($) *</label>
                    <input type="number" step="0.01" id="transAmount" placeholder="0.00">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Date *</label>
                    <input type="date" id="transDate">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="transDescription" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectDetailTitle" style="color: var(--text-color);">Project Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('projectDetailModal')">×</span>
            </div>
            <div id="projectDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('projectDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="dayDetailTitle" style="color: var(--text-color);">📅 Day Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('dayDetailModal')">×</span>
            </div>
            <div id="dayDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('dayDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    
    <div id="smartReminderContainer"></div>

    <script>
        const APP_CONFIG = {
            binId: '68e121b8ae596e708f05df17',
            baseUrl: 'https://api.jsonbin.io/v3',
            deviceType: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Laptop'
        };

        const themeColors = [
            { name: 'Rose Blush', bg: '#F4EDEB', accent: '#E8A9B3', highlight: '#D47C90', text: '#1C1C1C' },
            { name: 'Mocha Cream', bg: '#FFF6F1', accent: '#C9A48F', highlight: '#8A5C4E', text: '#1C1C1C' },
            { name: 'Sand & Coffee', bg: '#F5EFE6', accent: '#A87C5F', highlight: '#6B4C3B', text: '#1C1C1C' },
            { name: 'Soft Plum', bg: '#F8F3F7', accent: '#B08CA5', highlight: '#8B5E83', text: '#1C1C1C' },
            { name: 'Nude Clay', bg: '#EFE5DC', accent: '#D5AA85', highlight: '#9F6B3F', text: '#1C1C1C' },
            { name: 'Charcoal Rose', bg: '#F0E6E9', accent: '#A77E94', highlight: '#7B4C60', text: '#1C1C1C' },
            { name: 'Muted Mauve', bg: '#F7F2F3', accent: '#C4A3B3', highlight: '#905E78', text: '#1C1C1C' },
            { name: 'Desert Sand', bg: '#F3E9DD', accent: '#C29D7F', highlight: '#7E5439', text: '#1C1C1C' },
            { name: 'Pastel Taupe', bg: '#EDE6E1', accent: '#B89C92', highlight: '#805B4D', text: '#1C1C1C' },
            { name: 'Cocoa Mint', bg: '#F6F4F2', accent: '#A68B76', highlight: '#5D3C2B', text: '#1C1C1C' },
            { name: 'Latte Rose', bg: '#F2E9E4', accent: '#C6A9A3', highlight: '#885E58', text: '#1C1C1C' },
            { name: 'Warm Pebble', bg: '#F4F1EE', accent: '#A39A92', highlight: '#645B52', text: '#1C1C1C' },
            { name: 'Dusty Coral', bg: '#FAF3F0', accent: '#D6A89A', highlight: '#B06653', text: '#1C1C1C' },
            { name: 'Almond Cocoa', bg: '#F5EFE8', accent: '#C9B29B', highlight: '#7C5A3D', text: '#1C1C1C' },
            { name: 'Blush Beige', bg: '#F6F1EF', accent: '#E2C9C0', highlight: '#A67D75', text: '#1C1C1C' },
            { name: 'Earthy Pink', bg: '#F3E5E1', accent: '#CF9D9E', highlight: '#804E50', text: '#1C1C1C' },
            { name: 'Champagne Gold', bg: '#FAF4EF', accent: '#E7D2B9', highlight: '#B18F63', text: '#1C1C1C' },
            { name: 'Neutral Blush', bg: '#F5F3F2', accent: '#D0B8AD', highlight: '#8C6A5A', text: '#1C1C1C' }
        ];

        let data = {
            currentUser: 'Builder Pro',
            userPosition: 'by REFIT Interior',
            currentView: 'home',
            projects: [],
            tasks: [],
            transactions: [],
            permanentlyDeleted: [],
            archivedProjects: [],
            expandedProjects: [],
            expandedScheduleProjects: [],
            showArchived: false,
            nightMode: false,
            themeColor: 0,
            fontSize: 'm',
            contrast: 'normal',
            saturation: 'normal',
            timelineFilter: 'all',
            scheduleView: 'month',
            calendarEvents: [],
            lastUpdated: null,
            smartRemindersEnabled: true
        };

        let editingId = null;
        let editingType = null;
        let syncApiKey = '';
        let autoSyncInterval = null;
        let autoSyncEnabled = false;

        // Smart Reminder Tracker
        let reminderTracker = {
            shown: [],
            dismissed: [],
            lastCheck: null,
            checkInterval: null
        };

        // Load reminder tracker from localStorage
        function loadReminderTracker() {
            const saved = localStorage.getItem('reminderTracker');
            if (saved) {
                reminderTracker = JSON.parse(saved);
            }
        }

        function saveReminderTracker() {
            localStorage.setItem('reminderTracker', JSON.stringify(reminderTracker));
        }

        // Smart detection functions
        function detectIssues() {
            const issues = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 1. Projects without dates
            const projectsNoDates = data.projects.filter(p => !p.startDate || !p.endDate);
            if (projectsNoDates.length > 0) {
                issues.push({
                    id: 'projects-no-dates',
                    type: 'warning',
                    title: '⚠️ Missing Dates!',
                    message: `${projectsNoDates.length} project${projectsNoDates.length > 1 ? 's' : ''} missing start/end dates. Timeline view won't work properly!`,
                    action: 'Fix Now',
                    actionFn: () => {
                        switchView('projects');
                        showToast('Edit projects to add dates');
                    }
                });
            }

            // 2. Overdue tasks
            const overdueTasks = data.tasks.filter(t => {
                const due = new Date(t.dueDate);
                due.setHours(0, 0, 0, 0);
                return due < today && t.status !== 'Completed';
            });
            if (overdueTasks.length > 0) {
                issues.push({
                    id: 'overdue-tasks',
                    type: 'urgent',
                    title: '🚨 Overdue Tasks!',
                    message: `${overdueTasks.length} task${overdueTasks.length > 1 ? 's are' : ' is'} overdue! Check Kanban to complete them.`,
                    action: 'View Kanban',
                    actionFn: () => {
                        switchView('kanban');
                    }
                });
            }

            // 3. Tasks due today
            const todayTasks = data.tasks.filter(t => {
                const due = new Date(t.dueDate);
                due.setHours(0, 0, 0, 0);
                return due.getTime() === today.getTime() && t.status !== 'Completed';
            });
            if (todayTasks.length > 0) {
                issues.push({
                    id: 'tasks-due-today',
                    type: 'info',
                    title: '📅 Due Today!',
                    message: `${todayTasks.length} task${todayTasks.length > 1 ? 's are' : ' is'} due today. Don't forget!`,
                    action: 'View Tasks',
                    actionFn: () => {
                        switchView('kanban');
                    }
                });
            }

            // 4. Projects with no tasks
            const projectsNoTasks = data.projects.filter(p => {
                return data.tasks.filter(t => t.projectId === p.id).length === 0;
            });
            if (projectsNoTasks.length > 0) {
                issues.push({
                    id: 'projects-no-tasks',
                    type: 'warning',
                    title: '📋 Empty Projects!',
                    message: `${projectsNoTasks.length} project${projectsNoTasks.length > 1 ? 's have' : ' has'} no tasks. Add tasks to track progress!`,
                    action: 'Add Tasks',
                    actionFn: () => {
                        switchView('projects');
                        showToast('Click + to add tasks to your projects');
                    }
                });
            }

            // 5. Projects with expenses but no income
            const projectsNoIncome = data.projects.filter(p => {
                const transactions = data.transactions.filter(t => t.projectId === p.id);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                return expenses > 0 && income === 0;
            });
            if (projectsNoIncome.length > 0) {
                issues.push({
                    id: 'projects-no-income',
                    type: 'warning',
                    title: '💸 No Income Recorded!',
                    message: `${projectsNoIncome.length} project${projectsNoIncome.length > 1 ? 's have' : ' has'} expenses but no income. Track your payments!`,
                    action: 'Add Income',
                    actionFn: () => {
                        switchView('projects');
                        showToast('Add income to your projects');
                    }
                });
            }

            // 6. High priority tasks not in progress
            const highPriorityNotStarted = data.tasks.filter(t => 
                (t.priority === 'High' || t.priority === 'Critical') && 
                t.status === 'Get Ready' &&
                t.status !== 'Completed'
            );
            if (highPriorityNotStarted.length > 0) {
                issues.push({
                    id: 'high-priority-not-started',
                    type: 'urgent',
                    title: '⚡ High Priority Tasks!',
                    message: `${highPriorityNotStarted.length} critical task${highPriorityNotStarted.length > 1 ? 's' : ''} still in "Get Ready". Time to start!`,
                    action: 'View Tasks',
                    actionFn: () => {
                        switchView('kanban');
                    }
                });
            }

            // 7. Projects ending soon (within 3 days)
            const endingSoon = data.projects.filter(p => {
                if (!p.endDate) return false;
                const end = new Date(p.endDate);
                end.setHours(0, 0, 0, 0);
                const diff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
                return diff >= 0 && diff <= 3;
            });
            if (endingSoon.length > 0) {
                issues.push({
                    id: 'projects-ending-soon',
                    type: 'info',
                    title: '⏰ Project Deadline!',
                    message: `${endingSoon.length} project${endingSoon.length > 1 ? 's end' : ' ends'} within 3 days. Final push!`,
                    action: 'View Schedule',
                    actionFn: () => {
                        switchView('schedule');
                    }
                });
            }

            // 8. Tasks without assignees
            const tasksNoAssignee = data.tasks.filter(t => !t.assignee && t.status !== 'Completed');
            if (tasksNoAssignee.length > 0 && data.tasks.length > 5) {
                issues.push({
                    id: 'tasks-no-assignee',
                    type: 'info',
                    title: '👤 Unassigned Tasks!',
                    message: `${tasksNoAssignee.length} task${tasksNoAssignee.length > 1 ? 's have' : ' has'} no assignee. Assign workers for better tracking!`,
                    action: 'Assign Now',
                    actionFn: () => {
                        switchView('kanban');
                        showToast('Edit tasks to assign workers');
                    }
                });
            }

            // 9. No sync in 24 hours
            const lastSyncTime = localStorage.getItem('lastSyncTime');
            if (syncApiKey && lastSyncTime) {
                const hoursSinceSync = (Date.now() - parseInt(lastSyncTime)) / (1000 * 60 * 60);
                if (hoursSinceSync > 24) {
                    issues.push({
                        id: 'sync-needed',
                        type: 'info',
                        title: '🔄 Sync Needed!',
                        message: `Last sync was ${Math.floor(hoursSinceSync)} hours ago. Sync to backup your data!`,
                        action: 'Sync Now',
                        actionFn: () => {
                            smartSync();
                        }
                    });
                }
            }

            return issues;
        }

        // Show smart reminder
        function showSmartReminder() {
            // Check if smart reminders are enabled
            if (!data.smartRemindersEnabled) return;
            
            const issues = detectIssues();
            
            // Filter out already dismissed issues
            const newIssues = issues.filter(issue => {
                const wasShownRecently = reminderTracker.shown.some(s => 
                    s.id === issue.id && 
                    (Date.now() - s.timestamp) < 3600000 // Don't show same issue within 1 hour
                );
                const wasDismissed = reminderTracker.dismissed.some(d => 
                    d.id === issue.id && 
                    (Date.now() - d.timestamp) < 86400000 // Don't show dismissed issue within 24 hours
                );
                return !wasShownRecently && !wasDismissed;
            });

            if (newIssues.length === 0) return;

            // Prioritize issues based on current view
            let priorityIssue = null;
            const currentView = data.currentView;
            
            if (currentView === 'projects') {
                priorityIssue = newIssues.find(i => i.id === 'projects-no-dates' || i.id === 'projects-no-tasks' || i.id === 'projects-no-income');
            } else if (currentView === 'kanban') {
                priorityIssue = newIssues.find(i => i.id === 'overdue-tasks' || i.id === 'high-priority-not-started' || i.id === 'tasks-due-today');
            } else if (currentView === 'schedule') {
                priorityIssue = newIssues.find(i => i.id === 'projects-ending-soon' || i.id === 'projects-no-dates');
            } else if (currentView === 'calendar') {
                priorityIssue = newIssues.find(i => i.id === 'tasks-due-today' || i.id === 'overdue-tasks');
            }
            
            // If no priority issue for current view, pick urgent ones first, then random
            if (!priorityIssue) {
                const urgentIssues = newIssues.filter(i => i.type === 'urgent');
                if (urgentIssues.length > 0) {
                    priorityIssue = urgentIssues[Math.floor(Math.random() * urgentIssues.length)];
                } else {
                    priorityIssue = newIssues[Math.floor(Math.random() * newIssues.length)];
                }
            }
            
            const issue = priorityIssue;

            // Random positioning
            const positions = [
                { top: '80px', right: '20px' },
                { top: '80px', left: '20px' },
                { bottom: '100px', left: '20px' },
                { top: '50%', right: '20px', transform: 'translateY(-50%)' }
            ];
            const pos = positions[Math.floor(Math.random() * positions.length)];

            // Create reminder element
            const container = document.getElementById('smartReminderContainer');
            const reminder = document.createElement('div');
            reminder.className = 'smart-reminder' + (data.nightMode ? ' night-mode-reminder' : '');
            
            Object.keys(pos).forEach(key => {
                reminder.style[key] = pos[key];
            });

            reminder.innerHTML = `
                <button class="reminder-close" onclick="dismissReminder('${issue.id}', this.parentElement)">×</button>
                <div class="reminder-header">
                    <div class="attention-dot"></div>
                    <span>${issue.title}</span>
                </div>
                <div class="reminder-content">${issue.message}</div>
                <div class="reminder-action">${issue.action} →</div>
            `;

            reminder.onclick = (e) => {
                if (e.target.classList.contains('reminder-close')) return;
                issue.actionFn();
                dismissReminder(issue.id, reminder);
            };

            container.appendChild(reminder);

            // Track that we showed this reminder
            reminderTracker.shown.push({
                id: issue.id,
                timestamp: Date.now()
            });
            saveReminderTracker();

            // Auto-dismiss after 15 seconds
            setTimeout(() => {
                if (reminder.parentElement) {
                    dismissReminder(issue.id, reminder, true);
                }
            }, 15000);
        }

        function dismissReminder(issueId, element, auto = false) {
            if (!auto) {
                // Track dismissal only if user manually dismissed
                reminderTracker.dismissed.push({
                    id: issueId,
                    timestamp: Date.now()
                });
                saveReminderTracker();
            }

            // Animate out
            element.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (element.parentElement) {
                    element.remove();
                }
            }, 300);
        }

        // Start smart reminder system
        function startSmartReminders() {
            // Initial check after 10 seconds
            setTimeout(() => {
                showSmartReminder();
            }, 10000);

            // Check every 15 minutes
            reminderTracker.checkInterval = setInterval(() => {
                showSmartReminder();
            }, 15 * 60 * 1000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadReminderTracker();
            aggressiveCleanup();
            initUI();
            updateStats();
            renderView();
            initAutoSync();
            initializeLastSync();
            
            // Start smart reminder system
            startSmartReminders();
            
            if (!navigator.onLine) {
                document.getElementById('syncMode').textContent = 'Offline';
            }
            
            document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
            
            if (data.projects.length === 0 && data.tasks.length === 0) {
                setTimeout(() => {
                    showToast('👋 Welcome to Builder Pro! Press + to get started');
                }, 1000);
            }
        });

        function aggressiveCleanup() {
            const unwantedNames = [
                'william. mock up 1',
                'fnn ice cream booth',
                'fnn meeting room 1-refreshment',
                'fnn add on ac diffuser',
                'ms ng- tmn midah. kl',
                'fnn ceo blind',
                'fnn. relocate ac thermostat',
                'ss3 winsum',
                'usj 11. nicky',
                'dsara damai. james house',
                'william mockup 2',
                'liam. production 50 crackle set',
                'william. production 50 crackle set',
                'elaine bu11/14',
                "adrian home. - d'clover residences",
                'wong n carol no 37, ss3'
            ];
            
            const beforeCount = data.projects.length;
            
            data.projects = data.projects.filter(project => {
                const projectNameLower = project.name.toLowerCase().trim();
                const shouldRemove = unwantedNames.some(unwantedName => 
                    projectNameLower === unwantedName.toLowerCase().trim() ||
                    projectNameLower.includes(unwantedName.toLowerCase().trim())
                );
                return !shouldRemove;
            });
            
            const removedCount = beforeCount - data.projects.length;
            
            if (removedCount > 0) {
                const validProjectIds = data.projects.map(p => p.id);
                data.tasks = data.tasks.filter(task => validProjectIds.includes(task.projectId));
                data.transactions = data.transactions.filter(trans => validProjectIds.includes(trans.projectId));
                saveData();
                console.log(`✅ CLEANUP: Removed ${removedCount} unwanted projects`);
            }
        }

        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                data = { ...data, ...JSON.parse(saved) };
            }
            syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';
            applySettings();
        }

        function saveData() {
            data.lastUpdated = new Date().toISOString();
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        function addTimestamps(item, isNew = false) {
            const now = new Date().toISOString();
            if (isNew) {
                item.created_at = now;
            }
            item.updated_at = now;
            return item;
        }

        function mergeByTimestamp(localItems, cloudItems, type) {
            const merged = new Map();
            
            localItems.forEach(item => {
                merged.set(item.id, { ...item, _source: 'local' });
            });
            
            cloudItems.forEach(cloudItem => {
                const localItem = merged.get(cloudItem.id);
                
                if (!localItem) {
                    merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                } else {
                    const localTime = new Date(localItem.updated_at || localItem.created_at || 0);
                    const cloudTime = new Date(cloudItem.updated_at || cloudItem.created_at || 0);
                    
                    if (cloudTime > localTime) {
                        merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                    }
                }
            });
            
            const result = Array.from(merged.values()).filter(item => !item.deleted_at);
            result.forEach(item => delete item._source);
            
            return result;
        }

        function applySettings() {
            if (data.nightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('nightToggle').checked = true;
            }
            applyThemeColor(data.themeColor || 0);
            setFontSize(data.fontSize || 'm');
            setContrast(data.contrast || 'normal');
            setSaturation(data.saturation || 'normal');
            updateHeader();
            
            // Restore smart reminders toggle
            if (typeof data.smartRemindersEnabled !== 'undefined') {
                document.getElementById('smartRemindersToggle').checked = data.smartRemindersEnabled;
            }
        }

        function toggleSmartReminders() {
            data.smartRemindersEnabled = document.getElementById('smartRemindersToggle').checked;
            saveData();
            
            if (data.smartRemindersEnabled) {
                showToast('✅ Smart reminders enabled');
                // Show a reminder immediately to demonstrate
                setTimeout(() => {
                    showSmartReminder();
                }, 2000);
            } else {
                showToast('🔕 Smart reminders disabled');
                // Clear any existing reminders
                document.getElementById('smartReminderContainer').innerHTML = '';
            }
        }

        function initUI() {
            initThemePicker();
            document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
        }

        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            themeColors.forEach((theme, index) => {
                const div = document.createElement('div');
                div.className = 'theme-option' + (index === (data.themeColor || 0) ? ' active' : '');
                
                const preview = document.createElement('div');
                preview.className = 'theme-preview';
                preview.style.background = `linear-gradient(135deg, ${theme.accent} 0%, ${theme.highlight} 100%)`;
                preview.innerHTML = 'Aa';
                
                const name = document.createElement('div');
                name.className = 'theme-name';
                name.textContent = theme.name;
                
                div.appendChild(preview);
                div.appendChild(name);
                div.onclick = () => selectThemeColor(index);
                
                grid.appendChild(div);
            });
        }

        function selectThemeColor(index) {
            data.themeColor = index;
            applyThemeColor(index);
            saveData();
            
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.theme-option')[index].classList.add('active');
            showToast('Theme updated: ' + themeColors[index].name);
        }

        function applyThemeColor(index) {
            const theme = themeColors[index];
            if (!document.body.classList.contains('night-mode')) {
                document.documentElement.style.setProperty('--bg-color', theme.bg);
                document.documentElement.style.setProperty('--text-color', theme.text);
            }
            document.documentElement.style.setProperty('--accent-color', theme.accent);
            document.documentElement.style.setProperty('--highlight-color', theme.highlight);
            
            document.querySelector('meta[name="theme-color"]').content = theme.accent;
        }

        function setContrast(level) {
            document.body.classList.remove('low-contrast', 'normal-contrast', 'high-contrast', 'extra-contrast');
            document.body.classList.add(level + '-contrast');
            data.contrast = level;
            saveData();
            
            document.querySelectorAll('.contrast-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === level) {
                    btn.classList.add('active');
                }
            });
            
            setSaturation(data.saturation || 'normal');
        }

        function setSaturation(level) {
            document.body.classList.remove('sat-low', 'sat-normal', 'sat-high', 'sat-vibrant');
            document.body.classList.add('sat-' + level);
            data.saturation = level;
            saveData();
            
            const saturationSection = document.querySelectorAll('.contrast-controls')[1];
            if (saturationSection) {
                saturationSection.querySelectorAll('.contrast-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === level) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function setFontSize(size) {
            document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl');
            document.body.classList.add('font-' + size);
            data.fontSize = size;
            saveData();
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            data.nightMode = document.body.classList.contains('night-mode');
            saveData();
            applyThemeColor(data.themeColor);
        }

        function updateHeader() {
            if (data.currentUser !== 'Builder Pro') {
                document.getElementById('headerName').textContent = data.currentUser;
            }
            if (data.userPosition !== 'by REFIT Interior') {
                document.getElementById('headerPosition').textContent = data.userPosition;
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const backdrop = document.getElementById('settingsBackdrop');
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.style.overflow = '';
            } else {
                panel.classList.add('show');
                backdrop.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    initThemePicker();
                }, 100);
            }
        }

        function toggleFabMenu() {
            document.getElementById('fabMenu').classList.toggle('show');
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function switchView(view) {
            data.currentView = view;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderView();
            
            // Check for smart reminders after view switch (delayed)
            setTimeout(() => {
                const random = Math.random();
                if (random < 0.3) { // 30% chance to show reminder on view switch
                    showSmartReminder();
                }
            }, 3000);
        }

        function renderView() {
            const content = document.getElementById('mainContent');
            switch(data.currentView) {
                case 'home': renderHome(content); break;
                case 'kanban': renderKanban(content); break;
                case 'projects': renderProjects(content); break;
                case 'schedule': renderSchedule(content); break;
                case 'calendar': renderCalendar(content); break;
            }
        }

        // Placeholder render functions - these would need the full implementation
        function renderHome(container) {
            container.innerHTML = '<div class="empty-state">Home view placeholder</div>';
        }

        function renderKanban(container) {
            container.innerHTML = '<div class="empty-state">Kanban view placeholder</div>';
        }

        function renderProjects(container) {
            container.innerHTML = '<div class="empty-state">Projects view placeholder</div>';
        }

        function renderSchedule(container) {
            container.innerHTML = '<div class="empty-state">Schedule view placeholder</div>';
        }

        function renderCalendar(container) {
            container.innerHTML = '<div class="empty-state">Calendar view placeholder</div>';
        }
            document.getElementById('totalProjects').textContent = data.projects.length;
            document.getElementById('totalTasks').textContent = data.tasks.length;
            
            const income = data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('totalIncome').textContent = '$' + income.toFixed(0);
            document.getElementById('totalExpenses').textContent = '$' + expenses.toFixed(0);
        }

        function showProfileModal() {
            document.getElementById('profileName').value = data.currentUser;
            document.getElementById('profilePosition').value = data.userPosition;
            document.getElementById('profileModal').classList.add('show');
        }

        function saveProfile() {
            data.currentUser = document.getElementById('profileName').value || 'Builder Pro';
            data.userPosition = document.getElementById('profilePosition').value || 'by REFIT Interior';
            updateHeader();
            saveData();
            closeModal('profileModal');
            showToast('Profile updated');
        }

        function showProjectModal() {
            editingId = null;
            editingType = 'project';
            document.getElementById('projectModalTitle').textContent = 'New Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectClient').value = '';
            document.getElementById('projectStart').value = '';
            document.getElementById('projectEnd').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectLocked').checked = false;
            document.getElementById('projectModal').classList.add('show');
            toggleFabMenu();
        }

        function saveProject() {
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                client: document.getElementById('projectClient').value.trim(),
                startDate: document.getElementById('projectStart').value,
                endDate: document.getElementById('projectEnd').value,
                description: document.getElementById('projectDescription').value.trim(),
                locked: document.getElementById('projectLocked').checked
            };
            
            if (!projectData.name || !projectData.client) {
                showToast('Please fill required fields');
                return;
            }
            
            if (editingId) {
                const index = data.projects.findIndex(p => p.id === editingId);
                data.projects[index] = addTimestamps({ 
                    ...data.projects[index], 
                    ...projectData 
                }, false);
                showToast('Project updated');
            } else {
                projectData.id = Date.now();
                data.projects.push(addTimestamps(projectData, true));
                showToast('Project created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('projectModal');
            
            // Check for reminders after saving
            setTimeout(() => {
                showSmartReminder();
            }, 5000);
        }

        function showTaskModal() {
            editingId = null;
            editingType = 'task';
            document.getElementById('taskModalTitle').textContent = 'New Task';
            document.getElementById('taskName').value = '';
            document.getElementById('taskPriority').value = 'Medium';
            document.getElementById('taskStatus').value = 'Get Ready';
            document.getElementById('taskStart').value = '';
            document.getElementById('taskDue').value = '';
            document.getElementById('taskAssignee').value = '';
            document.getElementById('taskDescription').value = '';
            
            const select = document.getElementById('taskProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            document.getElementById('taskModal').classList.add('show');
            
            // Only toggle fab menu if not called from projects or schedule page  
            if (data.currentView !== 'projects' && data.currentView !== 'schedule') {
                toggleFabMenu();
            }
        }
            const taskData = {
                name: document.getElementById('taskName').value.trim(),
                projectId: parseInt(document.getElementById('taskProject').value),
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                startDate: document.getElementById('taskStart').value,
                dueDate: document.getElementById('taskDue').value,
                assignee: document.getElementById('taskAssignee').value.trim(),
                description: document.getElementById('taskDescription').value.trim()
            };
            
            if (!taskData.name || !taskData.projectId || !taskData.dueDate) {
                showToast('Please fill required fields');
                return;
            }
            
            if (editingId) {
                const index = data.tasks.findIndex(t => t.id === editingId);
                data.tasks[index] = addTimestamps({ 
                    ...data.tasks[index], 
                    ...taskData 
                }, false);
                showToast('Task updated');
            } else {
                taskData.id = Date.now();
                data.tasks.push(addTimestamps(taskData, true));
                showToast('Task created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('taskModal');
            
            // Check for reminders after saving
            setTimeout(() => {
                showSmartReminder();
            }, 5000);
        }

        function showTransactionModal(type) {
            editingId = null;
            editingType = 'transaction';
            document.getElementById('transactionModalTitle').textContent = type === 'income' ? 'Add Income' : 'Add Expense';
            document.getElementById('transType').value = type;
            document.getElementById('transAmount').value = '';
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transDescription').value = '';
            
            const select = document.getElementById('transProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            updateCategories();
            document.getElementById('transactionModal').classList.add('show');
            
            // Only toggle fab menu if called from fab (not from projects page)
            if (data.currentView !== 'projects') {
                toggleFabMenu();
            }
        }

        function updateCategories() {
            const type = document.getElementById('transType').value;
            const categories = type === 'expense' ? 
                ['Materials', 'Labor', 'Equipment', 'Transport', 'Other'] : 
                ['Payment', 'Deposit', 'Final Payment', 'Other'];
            
            const select = document.getElementById('transCategory');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function saveTransaction() {
            const transData = {
                type: document.getElementById('transType').value,
                projectId: parseInt(document.getElementById('transProject').value),
                category: document.getElementById('transCategory').value,
                amount: parseFloat(document.getElementById('transAmount').value),
                date: document.getElementById('transDate').value,
                description: document.getElementById('transDescription').value.trim()
            };
            
            if (!transData.projectId || !transData.category || !transData.amount || isNaN(transData.amount)) {
                showToast('Please fill all fields correctly');
                return;
            }
            
            if (editingId && editingType === 'transaction') {
                const index = data.transactions.findIndex(t => t.id === editingId);
                data.transactions[index] = addTimestamps({ 
                    ...data.transactions[index], 
                    ...transData 
                }, false);
                showToast('Transaction updated');
            } else {
                transData.id = Date.now();
                data.transactions.push(addTimestamps(transData, true));
                showToast('Transaction added');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('transactionModal');
        }

        function initAutoSync() {
            const savedAutoSync = localStorage.getItem('autoSyncEnabled');
            if (savedAutoSync === 'true' && syncApiKey) {
                autoSyncEnabled = true;
                document.getElementById('autoSyncToggle').checked = true;
                startAutoSync();
            }
        }

        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
            
            if (autoSyncEnabled) {
                startAutoSync();
                showToast('Auto-sync enabled');
            } else {
                stopAutoSync();
                showToast('Auto-sync disabled');
            }
        }

        function startAutoSync() {
            stopAutoSync();
            if (syncApiKey && autoSyncEnabled) {
                autoSyncInterval = setInterval(() => {
                    smartSync();
                }, 5 * 60 * 1000);
            }
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }

        function initializeLastSync() {
            const lastSyncTime = localStorage.getItem('lastSyncTime');
            if (lastSyncTime) {
                const date = new Date(parseInt(lastSyncTime));
                const timeStr = date.toLocaleTimeString();
                document.getElementById('lastSyncTime').textContent = `Last: ${timeStr}`;
            } else {
                document.getElementById('lastSyncTime').textContent = 'Not synced yet';
            }
            
            if (syncApiKey) {
                document.getElementById('syncMode').textContent = 'Ready';
            } else {
                document.getElementById('syncMode').textContent = 'No API key';
            }
        }

        async function smartSync() {
            showToast('Sync functionality requires JSONBin API implementation');
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('✅ API key saved!');
        }

        async function testSync() {
            showToast('Test sync functionality requires API implementation');
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
