<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="msapplication-navbutton-color" content="#E8A9B3">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Apple Touch Icons - Fixed for iPad with PNG -->
    <link rel="apple-touch-icon" sizes="180x180" id="icon180">
    <link rel="apple-touch-icon" sizes="152x152" id="icon152">
    <link rel="apple-touch-icon" sizes="120x120" id="icon120">
    <link rel="icon" type="image/png" id="favicon">
    
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }

        /* Color Theme Classes */
        body.theme-pink-rose {
            --bg-color: #f5ebe9;
            --accent-color: #d2bcbf;
            --highlight-color: #a67980;
            --button-primary: #a67980;
            --button-primary-hover: #8d5f66;
        }

        body.theme-sage {
            --bg-color: #e8ebe5;
            --accent-color: #c0ccb8;
            --highlight-color: #60665c;
            --button-primary: #60665c;
            --button-primary-hover: #4a4f47;
        }

        body.theme-gold {
            --bg-color: #f9f3e5;
            --accent-color: #e0b558;
            --highlight-color: #ecd299;
            --button-primary: #c49840;
            --button-primary-hover: #b08838;
        }

        body.theme-periwinkle {
            --bg-color: #e5ebf5;
            --accent-color: #99b3ec;
            --highlight-color: #151b73;
            --button-primary: #151b73;
            --button-primary-hover: #1a2291;
        }

        body.theme-slate {
            --bg-color: #e5e6e8;
            --accent-color: #8386a4;
            --highlight-color: #191a22;
            --button-primary: #191a22;
            --button-primary-hover: #2a2b35;
        }

        body.theme-teal {
            --bg-color: #e5eeef;
            --accent-color: #90b2b8;
            --highlight-color: #2c4144;
            --button-primary: #2c4144;
            --button-primary-hover: #3d5558;
        }

        body.theme-aqua {
            --bg-color: #e8f0f1;
            --accent-color: #9cbbbf;
            --highlight-color: #436266;
            --button-primary: #436266;
            --button-primary-hover: #557478;
        }

        body.theme-terracotta {
            --bg-color: #f2e8e5;
            --accent-color: #c48779;
            --highlight-color: #391f19;
            --button-primary: #391f19;
            --button-primary-hover: #4d2b22;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, var(--safe-area-inset-top));
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding: 20px 0 0;
        }
        
        .header {
            padding: 0 16px 16px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            cursor: pointer;
        }
        
        h1 {
            font-size: calc(24px * var(--font-scale));
            font-weight: 800;
            color: var(--text-color);
        }
        
        .header-subtitle {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .header-controls {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 12px;
            font-size: calc(18px * var(--font-scale));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .header-btn:active {
            background: var(--border-color);
            transform: scale(0.95);
        }
        
        .sync-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            opacity: 0.3;
        }
        
        .sync-indicator.syncing {
            background: var(--warning);
            opacity: 1;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
            background: var(--bg-color);
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 1px 3px var(--shadow-color);
        }
        
        .stat-label {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: calc(22px * var(--font-scale));
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .stat-value.income { color: var(--income-color); }
        .stat-value.expense { color: var(--expense-color); }
        .stat-value.net { color: var(--text-color); }
        
        .stat-sub {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
        }
        
        .main-content-wrapper {
            margin-top: 260px;
            padding-bottom: calc(80px + var(--safe-area-inset-bottom));
            flex: 1;
        }
        
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: calc(14px * var(--font-scale));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--button-primary);
            border-bottom-color: var(--button-primary);
        }
        
        .tab:active {
            background: var(--border-color);
        }
        
        .content {
            padding: 16px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: calc(48px * var(--font-scale));
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: calc(16px * var(--font-scale));
            margin-bottom: 8px;
        }
        
        .empty-hint {
            font-size: calc(13px * var(--font-scale));
            opacity: 0.7;
        }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px var(--shadow-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .card-title {
            font-size: calc(17px * var(--font-scale));
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        
        .card-subtitle {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-secondary);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: calc(11px * var(--font-scale));
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge.active { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge.pending { background: rgba(243, 156, 18, 0.15); color: var(--warning); }
        .badge.completed { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
        
        .card-body {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
        }
        
        .transaction-amount {
            font-size: calc(18px * var(--font-scale));
            font-weight: 700;
        }
        
        .transaction-amount.income { color: var(--income-color); }
        .transaction-amount.expense { color: var(--expense-color); }
        
        .fab {
            position: fixed;
            bottom: calc(80px + var(--safe-area-inset-bottom));
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--button-primary);
            color: white;
            border: none;
            font-size: calc(28px * var(--font-scale));
            box-shadow: 0 4px 12px var(--shadow-color);
            cursor: pointer;
            z-index: 90;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .fab:active {
            transform: scale(0.9);
            background: var(--button-primary-hover);
        }
        
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            padding-bottom: var(--safe-area-inset-bottom);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: calc(22px * var(--font-scale));
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .nav-label {
            font-size: calc(10px * var(--font-scale));
            font-weight: 600;
        }
        
        .nav-item.active {
            color: var(--button-primary);
        }
        
        .nav-item:active {
            background: var(--border-color);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: calc(20px * var(--font-scale));
            font-weight: 700;
        }
        
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--border-color);
            color: var(--text-color);
            font-size: calc(24px * var(--font-scale));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:active {
            background: var(--text-secondary);
            color: white;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: calc(13px * var(--font-scale));
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: calc(15px * var(--font-scale));
            font-family: inherit;
            background: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--button-primary);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: calc(15px * var(--font-scale));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--button-primary);
            color: white;
        }
        
        .btn-primary:active {
            background: var(--button-primary-hover);
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }
        
        .btn-secondary:active {
            background: var(--text-secondary);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            width: 100%;
        }
        
        .btn-danger:active {
            background: #dc2626;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .settings-title {
            font-size: calc(15px * var(--font-scale));
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .option-label {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-color);
        }
        
        .toggle-group {
            display: flex;
            gap: 6px;
        }
        
        .toggle-btn {
            padding: 6px 12px;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 6px;
            font-size: calc(12px * var(--font-scale));
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: var(--button-primary);
            color: white;
            border-color: var(--button-primary);
        }
        
        .action-btn {
            width: 100%;
            padding: 14px;
            border: none;
            background: var(--card-bg);
            color: var(--text-color);
            text-align: left;
            font-size: calc(14px * var(--font-scale));
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .action-btn:active {
            background: var(--border-color);
        }
        
        .action-btn:last-child {
            border-bottom: none;
        }
        
        .toast {
            position: fixed;
            bottom: calc(80px + var(--safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: calc(13px * var(--font-scale));
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
        }

        /* Reminder Popup Styles */
        .reminder-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: var(--card-bg);
            border: 3px solid var(--button-primary);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 2500;
            max-width: 90%;
            width: 350px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }

        .reminder-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }

        .reminder-popup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .reminder-popup-icon {
            font-size: calc(32px * var(--font-scale));
        }

        .reminder-popup-title {
            font-size: calc(18px * var(--font-scale));
            font-weight: 700;
            color: var(--text-color);
        }

        .reminder-popup-body {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .reminder-popup-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .reminder-popup-list li {
            padding: 8px 12px;
            background: var(--bg-color);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: calc(13px * var(--font-scale));
        }

        .reminder-popup-footer {
            text-align: center;
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
            font-style: italic;
        }

        .reminder-popup-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--border-color);
            color: var(--text-color);
            font-size: calc(18px * var(--font-scale));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reminder-popup-close:active {
            background: var(--text-secondary);
            color: white;
        }
        
        .detail-view {
            padding: 20px;
        }
        
        .detail-header {
            margin-bottom: 24px;
        }
        
        .detail-title {
            font-size: calc(22px * var(--font-scale));
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .detail-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .detail-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }
        
        .detail-label {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: calc(15px * var(--font-scale));
            font-weight: 600;
        }

        /* Theme Picker Styles */
        .theme-picker {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
            padding: 16px;
        }

        .theme-option {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 3px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .theme-option.active {
            border-color: var(--button-primary);
            box-shadow: 0 4px 12px var(--shadow-color);
            transform: scale(1.05);
        }

        .theme-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: var(--theme-accent);
        }

        .theme-option::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: var(--theme-highlight);
        }

        .theme-name {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: calc(10px * var(--font-scale));
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            z-index: 1;
        }

        .theme-pink-rose-preview { --theme-accent: #d2bcbf; --theme-highlight: #a67980; }
        .theme-sage-preview { --theme-accent: #c0ccb8; --theme-highlight: #60665c; }
        .theme-gold-preview { --theme-accent: #e0b558; --theme-highlight: #ecd299; }
        .theme-periwinkle-preview { --theme-accent: #99b3ec; --theme-highlight: #151b73; }
        .theme-slate-preview { --theme-accent: #8386a4; --theme-highlight: #191a22; }
        .theme-teal-preview { --theme-accent: #90b2b8; --theme-highlight: #2c4144; }
        .theme-aqua-preview { --theme-accent: #9cbbbf; --theme-highlight: #436266; }
        .theme-terracotta-preview { --theme-accent: #c48779; --theme-highlight: #391f19; }
    </style>
</head>
<body class="normal-contrast font-m sat-normal">
    <!-- Reminder Popup -->
    <div id="reminderPopup" class="reminder-popup">
        <button class="reminder-popup-close" onclick="dismissReminder()">×</button>
        <div class="reminder-popup-header">
            <div class="reminder-popup-icon">⏰</div>
            <div class="reminder-popup-title">Time to Check!</div>
        </div>
        <div class="reminder-popup-body">
            <div id="reminderContent"></div>
        </div>
        <div class="reminder-popup-footer">Auto-closes in <span id="reminderCountdown">5</span>s</div>
    </div>

    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="showView('dashboard')">
                        <div>
                            <h1>Builder Pro</h1>
                            <div class="header-subtitle">
                                <span id="projectCount">0</span> projects • 
                                <span id="taskCount">0</span> tasks
                            </div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="syncNow()" title="Sync Data">
                            🔄
                            <div class="sync-indicator" id="syncIndicator"></div>
                        </button>
                        <button class="header-btn" onclick="showSettings()">⚙️</button>
                    </div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value income" id="totalIncome">RM 0</div>
                    <div class="stat-sub" id="incomeCount">0 transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value expense" id="totalExpense">RM 0</div>
                    <div class="stat-sub" id="expenseCount">0 transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value net" id="netBalance">RM 0</div>
                    <div class="stat-sub" id="profitMargin">0% margin</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sync Status</div>
                    <div class="stat-value" style="font-size: calc(14px * var(--font-scale));" id="syncMode">Offline</div>
                    <div class="stat-sub" id="lastSyncTime">Never synced</div>
                </div>
            </div>
        </div>
        
        <div class="main-content-wrapper">
            <div class="tabs">
                <button class="tab active" data-view="projects" onclick="showView('projects')">📁 Projects</button>
                <button class="tab" data-view="tasks" onclick="showView('tasks')">✓ Tasks</button>
                <button class="tab" data-view="finance" onclick="showView('finance')">💰 Finance</button>
            </div>
            
            <div class="content">
                <div id="projects" class="view active"></div>
                <div id="tasks" class="view"></div>
                <div id="finance" class="view"></div>
            </div>
        </div>
        
        <button class="fab" onclick="showAddOptions()">+</button>
        
        <div class="nav">
            <button class="nav-item active" data-view="projects" onclick="showView('projects')">
                📁
                <span class="nav-label">Projects</span>
            </button>
            <button class="nav-item" data-view="tasks" onclick="showView('tasks')">
                ✓
                <span class="nav-label">Tasks</span>
            </button>
            <button class="nav-item" data-view="finance" onclick="showView('finance')">
                💰
                <span class="nav-label">Finance</span>
            </button>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="projectModalTitle">New Project</div>
                <button class="close-btn" onclick="closeModal('projectModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" class="form-input" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="projectDesc"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="projectStart">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="projectEnd">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Budget (RM)</label>
                            <input type="number" class="form-input" id="projectBudget" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="projectStatus">
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    <button type="button" class="btn btn-danger" id="deleteProjectBtn" style="display: none; margin-top: 10px;" onclick="deleteProject()">Delete Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="taskModalTitle">New Task</div>
                <button class="close-btn" onclick="closeModal('taskModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Name *</label>
                        <input type="text" class="form-input" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="taskProject">
                            <option value="">No Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="taskDesc"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="taskDue">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="taskStatus">
                                <option value="pending">Pending</option>
                                <option value="active">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    <button type="button" class="btn btn-danger" id="deleteTaskBtn" style="display: none; margin-top: 10px;" onclick="deleteTask()">Delete Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="transactionModalTitle">New Transaction</div>
                <button class="close-btn" onclick="closeModal('transactionModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="transactionForm" onsubmit="saveTransaction(event)">
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="transactionType" required>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (RM) *</label>
                        <input type="number" class="form-input" id="transactionAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <input type="text" class="form-input" id="transactionDesc" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="transactionProject">
                            <option value="">No Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="transactionDate">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    <button type="button" class="btn btn-danger" id="deleteTransactionBtn" style="display: none; margin-top: 10px;" onclick="deleteTransaction()">Delete Transaction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title">🎨 Color Theme</div>
                    <div class="theme-picker">
                        <div class="theme-option theme-pink-rose-preview" onclick="changeTheme('pink-rose')">
                            <div class="theme-name">Pink Rose</div>
                        </div>
                        <div class="theme-option theme-sage-preview" onclick="changeTheme('sage')">
                            <div class="theme-name">Sage</div>
                        </div>
                        <div class="theme-option theme-gold-preview" onclick="changeTheme('gold')">
                            <div class="theme-name">Gold</div>
                        </div>
                        <div class="theme-option theme-periwinkle-preview" onclick="changeTheme('periwinkle')">
                            <div class="theme-name">Periwinkle</div>
                        </div>
                        <div class="theme-option theme-slate-preview" onclick="changeTheme('slate')">
                            <div class="theme-name">Slate</div>
                        </div>
                        <div class="theme-option theme-teal-preview" onclick="changeTheme('teal')">
                            <div class="theme-name">Teal</div>
                        </div>
                        <div class="theme-option theme-aqua-preview" onclick="changeTheme('aqua')">
                            <div class="theme-name">Aqua</div>
                        </div>
                        <div class="theme-option theme-terracotta-preview" onclick="changeTheme('terracotta')">
                            <div class="theme-name">Terracotta</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">🌙 Display Mode</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Night Mode</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="toggleNightMode(false)">Off</button>
                                <button class="toggle-btn" onclick="toggleNightMode(true)">On</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">📝 Text Size</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Font Scale</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="changeFontSize('s')">S</button>
                                <button class="toggle-btn" onclick="changeFontSize('m')">M</button>
                                <button class="toggle-btn" onclick="changeFontSize('l')">L</button>
                                <button class="toggle-btn" onclick="changeFontSize('xl')">XL</button>
                                <button class="toggle-btn" onclick="changeFontSize('xxl')">XXL</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">🎨 Visual</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Contrast</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="changeContrast('low')">Low</button>
                                <button class="toggle-btn" onclick="changeContrast('normal')">Normal</button>
                                <button class="toggle-btn" onclick="changeContrast('high')">High</button>
                                <button class="toggle-btn" onclick="changeContrast('extra')">Extra</button>
                            </div>
                        </div>
                        <div class="option-item">
                            <span class="option-label">Saturation</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="changeSaturation('low')">Low</button>
                                <button class="toggle-btn" onclick="changeSaturation('normal')">Normal</button>
                                <button class="toggle-btn" onclick="changeSaturation('high')">High</button>
                                <button class="toggle-btn" onclick="changeSaturation('vibrant')">Vibrant</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">☁️ Cloud Sync (JSONBin.io)</div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your JSONBin API key">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="saveApiKey()">Save API Key</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="testSync()">Test Sync Connection</button>
                </div>

                <div class="settings-section">
                    <div class="settings-title">💾 Data Management</div>
                    <button class="action-btn" onclick="exportData()">📤 Export Backup (JSON)</button>
                    <button class="action-btn" onclick="document.getElementById('importFile').click()">📥 Import Backup</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Add Options Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New</div>
                <button class="close-btn" onclick="closeModal('addModal')">×</button>
            </div>
            <div class="modal-body">
                <button class="action-btn" onclick="closeModal('addModal'); showProjectForm()">📁 New Project</button>
                <button class="action-btn" onclick="closeModal('addModal'); showTaskForm()">✓ New Task</button>
                <button class="action-btn" onclick="closeModal('addModal'); showTransactionForm()">💰 New Transaction</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // IMPORTANT: Your JSONBin configuration - Keep your bin number here
        const APP_CONFIG = {
            binId: '678d47b3e41b4d34e47b381d',  // YOUR BIN NUMBER - DO NOT CHANGE
            baseUrl: 'https://api.jsonbin.io/v3'
        };

        let syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';
        
        // Data structure
        let data = {
            projects: [],
            tasks: [],
            transactions: [],
            settings: {
                nightMode: false,
                fontSize: 'm',
                contrast: 'normal',
                saturation: 'normal',
                theme: 'pink-rose'
            }
        };
        
        let currentView = 'projects';
        let editingId = null;
        let editingType = null;

        // ============ NEW: ICON GENERATOR FOR IPAD ============
        function generateAppIcons() {
            const sizes = [
                { id: 'icon180', size: 180 },
                { id: 'icon152', size: 152 },
                { id: 'icon120', size: 120 },
                { id: 'favicon', size: 64 }
            ];

            sizes.forEach(({ id, size }) => {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                // Background
                ctx.fillStyle = '#E8A9B3';
                ctx.fillRect(0, 0, size, size);

                // Letter "B"
                ctx.fillStyle = 'white';
                ctx.font = `bold ${size * 0.5}px -apple-system, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('B', size / 2, size / 2);

                // Set icon
                const link = document.getElementById(id);
                if (link) {
                    link.href = canvas.toDataURL('image/png');
                }
            });
        }

        // ============ NEW: REMINDER SYSTEM ============
        let reminderTimer = null;
        let reminderCountdownInterval = null;

        function startReminderSystem() {
            const scheduleNextReminder = () => {
                // Random interval between 35-45 minutes
                const minutes = 35 + Math.random() * 10;
                const milliseconds = minutes * 60 * 1000;
                
                console.log(`⏰ Next reminder in ${minutes.toFixed(1)} minutes`);
                
                if (reminderTimer) clearTimeout(reminderTimer);
                reminderTimer = setTimeout(() => {
                    showSmartReminder();
                    scheduleNextReminder();
                }, milliseconds);
            };

            scheduleNextReminder();
        }

        function showSmartReminder() {
            const reminderData = analyzeWhatToCheck();
            
            if (reminderData.items.length === 0) {
                console.log('⏰ No reminders needed right now');
                return;
            }

            const popup = document.getElementById('reminderPopup');
            const content = document.getElementById('reminderContent');
            
            let html = `<p><strong>${reminderData.title}</strong></p><ul class="reminder-popup-list">`;
            reminderData.items.forEach(item => {
                html += `<li>${item}</li>`;
            });
            html += '</ul>';
            
            content.innerHTML = html;
            popup.classList.add('show');

            // Auto-close countdown
            let countdown = 5;
            const countdownEl = document.getElementById('reminderCountdown');
            
            reminderCountdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 0) {
                    dismissReminder();
                }
            }, 1000);
        }

        function analyzeWhatToCheck() {
            const result = {
                title: '',
                items: []
            };

            const now = Date.now();
            const today = new Date().toISOString().split('T')[0];

            // Check overdue tasks
            const overdueTasks = data.tasks.filter(t => {
                if (t.status === 'completed' || !t.dueDate) return false;
                return new Date(t.dueDate) < new Date(today);
            });

            if (overdueTasks.length > 0) {
                result.title = '⚠️ Action Required';
                result.items.push(`${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''}`);
            }

            // Check tasks due today
            const dueTodayTasks = data.tasks.filter(t => {
                return t.status !== 'completed' && t.dueDate === today;
            });

            if (dueTodayTasks.length > 0) {
                if (!result.title) result.title = '📌 Today\'s Focus';
                result.items.push(`${dueTodayTasks.length} task${dueTodayTasks.length > 1 ? 's' : ''} due today`);
            }

            // Check active projects without recent activity
            const activeProjects = data.projects.filter(p => p.status === 'active');
            const staleProjects = activeProjects.filter(p => {
                const daysSinceUpdate = (now - p.updatedAt) / (1000 * 60 * 60 * 24);
                return daysSinceUpdate > 3;
            });

            if (staleProjects.length > 0) {
                if (!result.title) result.title = '🔍 Time to Review';
                result.items.push(`${staleProjects.length} project${staleProjects.length > 1 ? 's' : ''} need attention`);
            }

            // Check pending tasks
            const pendingTasks = data.tasks.filter(t => t.status === 'pending');
            if (pendingTasks.length > 5) {
                if (!result.title) result.title = '📋 Pending Items';
                result.items.push(`${pendingTasks.length} tasks waiting to start`);
            }

            // Check budget vs expenses
            activeProjects.forEach(project => {
                if (project.budget > 0) {
                    const projectExpenses = data.transactions
                        .filter(t => t.type === 'expense' && t.projectId === project.id)
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const percentage = (projectExpenses / project.budget) * 100;
                    if (percentage > 80) {
                        if (!result.title) result.title = '💰 Budget Alert';
                        result.items.push(`${project.name}: ${percentage.toFixed(0)}% budget used`);
                    }
                }
            });

            // If nothing specific, provide general reminder
            if (result.items.length === 0 && (activeProjects.length > 0 || data.tasks.length > 0)) {
                result.title = '✨ Quick Check-in';
                result.items.push('Review your active projects');
                result.items.push('Update task statuses');
                if (data.transactions.length > 0) {
                    result.items.push('Check your finances');
                }
            }

            return result;
        }

        function dismissReminder() {
            const popup = document.getElementById('reminderPopup');
            popup.classList.remove('show');
            
            if (reminderCountdownInterval) {
                clearInterval(reminderCountdownInterval);
                reminderCountdownInterval = null;
            }
            
            // Reset countdown for next time
            document.getElementById('reminderCountdown').textContent = '5';
        }

        // ============ DATA MANAGEMENT ============
        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                data = JSON.parse(saved);
                
                // Ensure theme exists
                if (!data.settings.theme) {
                    data.settings.theme = 'pink-rose';
                }
            }
        }

        function saveData() {
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        // ============ VIEW MANAGEMENT ============
        function showView(viewName) {
            currentView = viewName;
            
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(viewName).classList.add('active');
            
            const tab = document.querySelector(`.tab[data-view="${viewName}"]`);
            if (tab) tab.classList.add('active');
            
            const navItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (navItem) navItem.classList.add('active');
            
            renderView();
        }

        function renderView() {
            switch(currentView) {
                case 'projects':
                    renderProjects();
                    break;
                case 'tasks':
                    renderTasks();
                    break;
                case 'finance':
                    renderFinance();
                    break;
            }
        }

        function renderProjects() {
            const container = document.getElementById('projects');
            
            if (data.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <div class="empty-text">No projects yet</div>
                        <div class="empty-hint">Tap + to create your first project</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.projects.forEach(project => {
                const projectTasks = data.tasks.filter(t => t.projectId === project.id);
                const completedTasks = projectTasks.filter(t => t.status === 'completed').length;
                
                const projectIncome = data.transactions
                    .filter(t => t.type === 'income' && t.projectId === project.id)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const projectExpense = data.transactions
                    .filter(t => t.type === 'expense' && t.projectId === project.id)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                html += `
                    <div class="card" onclick="showProjectForm('${project.id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${project.name}</div>
                                <div class="card-subtitle">${project.description || 'No description'}</div>
                            </div>
                            <span class="badge ${project.status}">${project.status}</span>
                        </div>
                        <div class="card-footer">
                            <div>📋 ${projectTasks.length} tasks (${completedTasks} done)</div>
                            <div>💰 RM ${(projectIncome - projectExpense).toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderTasks() {
            const container = document.getElementById('tasks');
            
            if (data.tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">✓</div>
                        <div class="empty-text">No tasks yet</div>
                        <div class="empty-hint">Tap + to create your first task</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.tasks.forEach(task => {
                const project = data.projects.find(p => p.id === task.projectId);
                const projectName = project ? project.name : 'No project';
                
                html += `
                    <div class="card" onclick="showTaskForm('${task.id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${task.name}</div>
                                <div class="card-subtitle">${projectName}</div>
                            </div>
                            <span class="badge ${task.status}">${task.status}</span>
                        </div>
                        ${task.description ? `<div class="card-body">${task.description}</div>` : ''}
                        <div class="card-footer">
                            <div>${task.dueDate ? '📅 ' + new Date(task.dueDate).toLocaleDateString() : 'No due date'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderFinance() {
            const container = document.getElementById('finance');
            
            if (data.transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💰</div>
                        <div class="empty-text">No transactions yet</div>
                        <div class="empty-hint">Tap + to add your first transaction</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            const sortedTransactions = [...data.transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedTransactions.forEach(trans => {
                const project = data.projects.find(p => p.id === trans.projectId);
                const projectName = project ? project.name : 'No project';
                
                html += `
                    <div class="card" onclick="showTransactionForm('${trans.id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title transaction-amount ${trans.type}">
                                    ${trans.type === 'income' ? '+' : '-'} RM ${trans.amount.toFixed(2)}
                                </div>
                                <div class="card-subtitle">${trans.description}</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div>📁 ${projectName}</div>
                            <div>📅 ${new Date(trans.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('projectCount').textContent = data.projects.length;
            document.getElementById('taskCount').textContent = data.tasks.length;
            
            const income = data.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = data.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const net = income - expense;
            
            document.getElementById('totalIncome').textContent = `RM ${income.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `RM ${expense.toFixed(2)}`;
            document.getElementById('netBalance').textContent = `RM ${net.toFixed(2)}`;
            
            const incomeCount = data.transactions.filter(t => t.type === 'income').length;
            const expenseCount = data.transactions.filter(t => t.type === 'expense').length;
            
            document.getElementById('incomeCount').textContent = `${incomeCount} transaction${incomeCount !== 1 ? 's' : ''}`;
            document.getElementById('expenseCount').textContent = `${expenseCount} transaction${expenseCount !== 1 ? 's' : ''}`;
            
            const margin = income > 0 ? ((net / income) * 100).toFixed(1) : '0.0';
            document.getElementById('profitMargin').textContent = `${margin}% margin`;
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showAddOptions() {
            document.getElementById('addModal').classList.add('active');
        }

        function applySettings() {
            const { nightMode, fontSize, contrast, saturation, theme } = data.settings;
            
            // Apply theme
            document.body.className = '';
            if (theme) {
                document.body.classList.add(`theme-${theme}`);
                updateThemeSelector(theme);
                updateAppIcons(theme);
            }
            
            // Apply night mode
            if (nightMode) {
                document.body.classList.add('night-mode');
            }
            
            // Apply font size
            document.body.classList.add(`font-${fontSize}`);
            updateToggleButtons('font', fontSize);
            
            // Apply contrast
            document.body.classList.add(`${contrast}-contrast`);
            updateToggleButtons('contrast', contrast);
            
            // Apply saturation
            document.body.classList.add(`sat-${saturation}`);
            updateToggleButtons('sat', saturation);
            
            // Update night mode toggle
            updateNightModeToggle(nightMode);
        }

        function updateAppIcons(theme) {
            const themeColors = {
                'pink-rose': '#d2bcbf',
                'sage': '#c0ccb8',
                'gold': '#e0b558',
                'periwinkle': '#99b3ec',
                'slate': '#8386a4',
                'teal': '#90b2b8',
                'aqua': '#9cbbbf',
                'terracotta': '#c48779'
            };

            const color = themeColors[theme] || '#E8A9B3';
            
            const sizes = [
                { id: 'icon180', size: 180 },
                { id: 'icon152', size: 152 },
                { id: 'icon120', size: 120 },
                { id: 'favicon', size: 64 }
            ];

            sizes.forEach(({ id, size }) => {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = color;
                ctx.fillRect(0, 0, size, size);

                ctx.fillStyle = 'white';
                ctx.font = `bold ${size * 0.5}px -apple-system, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('B', size / 2, size / 2);

                const link = document.getElementById(id);
                if (link) {
                    link.href = canvas.toDataURL('image/png');
                }
            });
        }

        function updateThemeSelector(theme) {
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.remove('active');
            });
            const activeTheme = document.querySelector(`.theme-${theme}-preview`);
            if (activeTheme) {
                activeTheme.classList.add('active');
            }
        }

        function changeTheme(theme) {
            data.settings.theme = theme;
            saveData();
            applySettings();
            showToast(`Theme changed to ${theme.charAt(0).toUpperCase() + theme.slice(1).replace(/-/g, ' ')}`);
        }

        function toggleNightMode(enabled) {
            data.settings.nightMode = enabled;
            saveData();
            applySettings();
        }

        function changeFontSize(size) {
            data.settings.fontSize = size;
            saveData();
            applySettings();
        }

        function changeContrast(level) {
            data.settings.contrast = level;
            saveData();
            applySettings();
        }

        function changeSaturation(level) {
            data.settings.saturation = level;
            saveData();
            applySettings();
        }

        function updateToggleButtons(type, value) {
            const typeMap = {
                'font': 'font-',
                'contrast': '',
                'sat': 'sat-'
            };
            
            const buttons = document.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(type === 'font' ? 'changeFontSize' : (type === 'contrast' ? 'changeContrast' : 'changeSaturation'))) {
                    btn.classList.remove('active');
                    if (onclick.includes(`'${value}'`)) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        function updateNightModeToggle(enabled) {
            const buttons = document.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes('toggleNightMode')) {
                    btn.classList.remove('active');
                    if ((enabled && onclick.includes('true')) || (!enabled && onclick.includes('false'))) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
            applySettings();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingId = null;
            editingType = null;
        }

        function showProjectForm(id = null) {
            editingId = id;
            editingType = 'project';
            
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            
            if (id) {
                const project = data.projects.find(p => p.id === id);
                title.textContent = 'Edit Project';
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectDesc').value = project.description || '';
                document.getElementById('projectStart').value = project.startDate || '';
                document.getElementById('projectEnd').value = project.endDate || '';
                document.getElementById('projectBudget').value = project.budget || '';
                document.getElementById('projectStatus').value = project.status;
                deleteBtn.style.display = 'block';
            } else {
                title.textContent = 'New Project';
                document.getElementById('projectForm').reset();
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function saveProject(event) {
            event.preventDefault();
            
            const project = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDesc').value,
                startDate: document.getElementById('projectStart').value,
                endDate: document.getElementById('projectEnd').value,
                budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                status: document.getElementById('projectStatus').value,
                createdAt: editingId ? data.projects.find(p => p.id === editingId).createdAt : Date.now(),
                updatedAt: Date.now()
            };
            
            if (editingId) {
                const index = data.projects.findIndex(p => p.id === editingId);
                data.projects[index] = project;
            } else {
                data.projects.push(project);
            }
            
            saveData();
            closeModal('projectModal');
            renderView();
            updateStats();
            showToast(editingId ? 'Project updated' : 'Project created');
        }

        function deleteProject() {
            if (confirm('Delete this project and all its tasks?')) {
                data.projects = data.projects.filter(p => p.id !== editingId);
                data.tasks = data.tasks.filter(t => t.projectId !== editingId);
                data.transactions = data.transactions.filter(t => t.projectId !== editingId);
                saveData();
                closeModal('projectModal');
                renderView();
                updateStats();
                showToast('Project deleted');
            }
        }

        function showTaskForm(id = null, projectId = null) {
            editingId = id;
            editingType = 'task';
            
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            const deleteBtn = document.getElementById('deleteTaskBtn');
            const projectSelect = document.getElementById('taskProject');
            
            projectSelect.innerHTML = '<option value="">No Project</option>';
            data.projects.forEach(p => {
                projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            if (id) {
                const task = data.tasks.find(t => t.id === id);
                title.textContent = 'Edit Task';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDesc').value = task.description || '';
                document.getElementById('taskDue').value = task.dueDate || '';
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskProject').value = task.projectId || '';
                deleteBtn.style.display = 'block';
            } else {
                title.textContent = 'New Task';
                document.getElementById('taskForm').reset();
                if (projectId) {
                    document.getElementById('taskProject').value = projectId;
                }
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function saveTask(event) {
            event.preventDefault();
            
            const task = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('taskName').value,
                description: document.getElementById('taskDesc').value,
                dueDate: document.getElementById('taskDue').value,
                status: document.getElementById('taskStatus').value,
                projectId: document.getElementById('taskProject').value || null,
                createdAt: editingId ? data.tasks.find(t => t.id === editingId).createdAt : Date.now(),
                updatedAt: Date.now()
            };
            
            if (editingId) {
                const index = data.tasks.findIndex(t => t.id === editingId);
                data.tasks[index] = task;
            } else {
                data.tasks.push(task);
            }
            
            saveData();
            closeModal('taskModal');
            renderView();
            updateStats();
            showToast(editingId ? 'Task updated' : 'Task created');
        }

        function deleteTask() {
            if (confirm('Delete this task?')) {
                data.tasks = data.tasks.filter(t => t.id !== editingId);
                saveData();
                closeModal('taskModal');
                renderView();
                updateStats();
                showToast('Task deleted');
            }
        }

        function showTransactionForm(id = null, projectId = null) {
            editingId = id;
            editingType = 'transaction';
            
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('transactionModalTitle');
            const deleteBtn = document.getElementById('deleteTransactionBtn');
            const projectSelect = document.getElementById('transactionProject');
            
            projectSelect.innerHTML = '<option value="">No Project</option>';
            data.projects.forEach(p => {
                projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            if (id) {
                const transaction = data.transactions.find(t => t.id === id);
                title.textContent = 'Edit Transaction';
                document.getElementById('transactionType').value = transaction.type;
                document.getElementById('transactionAmount').value = transaction.amount;
                document.getElementById('transactionDesc').value = transaction.description;
                document.getElementById('transactionProject').value = transaction.projectId || '';
                document.getElementById('transactionDate').value = transaction.date;
                deleteBtn.style.display = 'block';
            } else {
                title.textContent = 'New Transaction';
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                if (projectId) {
                    document.getElementById('transactionProject').value = projectId;
                }
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function saveTransaction(event) {
            event.preventDefault();
            
            const transaction = {
                id: editingId || Date.now().toString(),
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                description: document.getElementById('transactionDesc').value,
                projectId: document.getElementById('transactionProject').value || null,
                date: document.getElementById('transactionDate').value,
                createdAt: editingId ? data.transactions.find(t => t.id === editingId).createdAt : Date.now()
            };
            
            if (editingId) {
                const index = data.transactions.findIndex(t => t.id === editingId);
                data.transactions[index] = transaction;
            } else {
                data.transactions.push(transaction);
            }
            
            saveData();
            closeModal('transactionModal');
            renderView();
            updateStats();
            showToast(editingId ? 'Transaction updated' : 'Transaction added');
        }

        function deleteTransaction() {
            if (confirm('Delete this transaction?')) {
                data.transactions = data.transactions.filter(t => t.id !== editingId);
                saveData();
                closeModal('transactionModal');
                renderView();
                updateStats();
                showToast('Transaction deleted');
            }
        }

        // ============ SYNC FUNCTIONS ============
        async function syncNow() {
            if (!syncApiKey) {
                showToast('⚠️ No API key! Set it in Settings first.');
                return;
            }
            
            const indicator = document.getElementById('syncIndicator');
            const syncMode = document.getElementById('syncMode');
            
            indicator.classList.add('syncing');
            syncMode.textContent = 'Syncing...';
            
            const startTime = Date.now();
            
            try {
                console.log('🔄 Step 1: Fetching cloud data...');
                const getResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`Fetch failed: ${getResponse.status} - ${getResponse.statusText}`);
                }
                
                const cloudData = await getResponse.json();
                const cloudRecord = cloudData.record;
                
                console.log('📊 Cloud data:', {
                    projects: cloudRecord.projects?.length || 0,
                    tasks: cloudRecord.tasks?.length || 0,
                    transactions: cloudRecord.transactions?.length || 0
                });
                
                console.log('📱 Local data:', {
                    projects: data.projects.length,
                    tasks: data.tasks.length,
                    transactions: data.transactions.length
                });
                
                console.log('🔄 Step 2: Merging data...');
                syncMode.textContent = 'Merging...';
                
                const mergeArrays = (local, cloud, type) => {
                    const merged = new Map();
                    
                    cloud.forEach(item => {
                        merged.set(item.id, { ...item, source: 'cloud' });
                    });
                    
                    local.forEach(item => {
                        if (!merged.has(item.id)) {
                            merged.set(item.id, { ...item, source: 'local' });
                        } else {
                            const existing = merged.get(item.id);
                            const localTime = item.updatedAt || item.createdAt || 0;
                            const cloudTime = existing.updatedAt || existing.createdAt || 0;
                            
                            if (localTime > cloudTime) {
                                merged.set(item.id, { ...item, source: 'local-newer' });
                            }
                        }
                    });
                    
                    return Array.from(merged.values());
                };
                
                const hasCloudData = cloudRecord.projects || cloudRecord.tasks || cloudRecord.transactions;
                
                if (hasCloudData) {
                    data.projects = mergeArrays(data.projects, cloudRecord.projects || [], 'projects');
                    data.tasks = mergeArrays(data.tasks, cloudRecord.tasks || [], 'tasks');
                    data.transactions = mergeArrays(data.transactions, cloudRecord.transactions || [], 'transactions');
                    
                    saveData();
                    renderView();
                    updateStats();
                }
                
                console.log('🔄 Step 3: Pushing merged data to cloud...');
                syncMode.textContent = 'Pushing...';
                const putResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': syncApiKey
                    },
                    body: JSON.stringify(data)
                });
                
                if (!putResponse.ok) {
                    throw new Error(`Push failed: ${putResponse.status} - ${putResponse.statusText}`);
                }
                
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`✅ Sync complete in ${syncDuration}s`);
                
                localStorage.setItem('lastSyncTime', Date.now().toString());
                const nowTime = new Date().toLocaleTimeString();
                document.getElementById('lastSyncTime').textContent = `Last: ${nowTime}`;
                showToast(`✅ Synced ${data.projects.length}p ${data.tasks.length}t ${data.transactions.length}tr in ${syncDuration}s!`, 5000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Connected';
                
            } catch (error) {
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.error('❌ Sync error:', error);
                
                let errorMsg = error.message;
                if (error.message.includes('401')) {
                    errorMsg = 'Invalid API key! Check Settings';
                } else if (error.message.includes('404')) {
                    errorMsg = 'Bin not found! Check Bin ID';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'No internet connection!';
                }
                
                showToast(`❌ ${errorMsg}`, 6000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Error';
                
                console.log('Sync diagnostics:', {
                    duration: syncDuration + 's',
                    apiKey: syncApiKey ? 'SET (length: ' + syncApiKey.length + ')' : 'NOT SET',
                    binId: APP_CONFIG.binId,
                    online: navigator.onLine,
                    localData: {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    }
                });
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('✅ API key saved! Now click "Test Sync Connection"', 5000);
        }

        async function testSync() {
            if (!syncApiKey) {
                showToast('⚠️ No API key set! Enter your JSONBin API key first.');
                return;
            }
            
            showToast('🔍 Testing connection...');
            
            try {
                console.log('🔍 Testing sync connection...');
                console.log('API Key length:', syncApiKey.length);
                console.log('Bin ID:', APP_CONFIG.binId);
                console.log('Base URL:', APP_CONFIG.baseUrl);
                
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Connection successful!');
                    console.log('Cloud data:', {
                        projects: result.record?.projects?.length || 0,
                        tasks: result.record?.tasks?.length || 0,
                        transactions: result.record?.transactions?.length || 0
                    });
                    
                    showToast('✅ Connection works! Your API key is valid.');
                    document.getElementById('syncMode').textContent = 'Connected';
                } else if (response.status === 401) {
                    showToast('❌ Invalid API key! Get a new one from jsonbin.io');
                    document.getElementById('syncMode').textContent = 'Invalid Key';
                } else if (response.status === 404) {
                    showToast('❌ Bin not found! Check your Bin ID.');
                    document.getElementById('syncMode').textContent = 'Invalid Bin';
                } else {
                    showToast(`❌ Error ${response.status}: ${response.statusText}`);
                    document.getElementById('syncMode').textContent = 'Error';
                }
            } catch (error) {
                console.error('❌ Test failed:', error);
                showToast('❌ Connection failed! Check internet & open browser console (F12)');
                document.getElementById('syncMode').textContent = 'Offline';
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            if (!data.settings.theme) {
                                data.settings.theme = 'pink-rose';
                            }
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }

        // ============ INITIALIZE APP ============
        loadData();
        applySettings();
        renderView();
        updateStats();
        
        // Generate icons for iPad (PNG format)
        generateAppIcons();
        
        // Start reminder system
        startReminderSystem();
        
        // Update sync status
        const lastSync = localStorage.getItem('lastSyncTime');
        if (lastSync) {
            const time = new Date(parseInt(lastSync)).toLocaleTimeString();
            document.getElementById('lastSyncTime').textContent = `Last: ${time}`;
        }
        
        if (syncApiKey) {
            document.getElementById('syncMode').textContent = 'Ready';
        }
    </script>
</body>
</html>
