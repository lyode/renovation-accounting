<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#E8A9B3">
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { max-width: 100vw; min-height: 100vh; display: flex; flex-direction: column; }
        
        .fixed-header-section { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: var(--bg-color); }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
        .header h1 { font-size: calc(16px * var(--font-scale)); font-weight: 600; }
        .header-subtitle { font-size: calc(11px * var(--font-scale)); opacity: 0.9; margin-top: 2px; }
        .header-controls { display: flex; gap: 8px; align-items: center; }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active { background: rgba(255,255,255,0.3); }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #10b981; 
            border: 2px solid white; 
        }
        
        .sync-indicator.syncing { background: #f39c12; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .sync-status-bar { 
            background: var(--button-primary); 
            color: white; 
            padding: 4px 10px; 
            font-size: calc(11px * var(--font-scale)); 
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
        }
        
        .tabs { background: var(--card-bg); display: flex; border-bottom: 2px solid var(--border-color); overflow-x: auto; }
        
        .tab { 
            flex: 1; 
            min-width: 80px; 
            padding: 10px 8px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            font-size: calc(12px * var(--font-scale)); 
            transition: all 0.2s;
        }
        
        .tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        
        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; background: var(--bg-color); }
        
        .main-content-wrapper { margin-top: 200px; flex: 1; }
        
        @media (max-width: 768px) { .main-content-wrapper { margin-top: 210px; } }
        
        .container { padding: 10px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        
        .stat-card { 
            background: var(--card-bg); 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px var(--shadow-color); 
            text-align: center; 
        }
        
        .stat-card h3 { font-size: calc(16px * var(--font-scale)); color: var(--accent-color); margin-bottom: 2px; font-weight: 700; }
        .stat-card.income h3 { color: var(--income-color); }
        .stat-card.expense h3 { color: var(--expense-color); }
        .stat-card p { color: var(--text-secondary); font-size: calc(11px * var(--font-scale)); }
        
        .project-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            margin-bottom: 12px; 
            overflow: visible;
        }
        
        .project-header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 12px; 
            border-radius: 12px 12px 0 0;
        }
        
        .project-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: rgba(0,0,0,0.1); 
            margin-top: 8px;
            border-radius: 8px;
        }
        
        .project-actions { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
        
        .action-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(10px * var(--font-scale)); 
            transition: background 0.2s;
        }
        
        .action-btn:active { background: rgba(255,255,255,0.3); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .gantt-container { 
            background: var(--card-bg); 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            overflow-x: auto; 
            margin-bottom: 15px; 
        }
        
        .gantt-timeline-header { display: flex; border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-bottom: 10px; }
        .gantt-timeline-months { margin-left: 150px; display: flex; flex: 1; gap: 2px; }
        
        .gantt-month {
            flex: 1;
            text-align: center;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-secondary);
            font-weight: 600;
            padding: 4px;
            background: var(--bg-color);
            border-radius: 4px;
        }
        
        .gantt-row { display: flex; align-items: center; margin-bottom: 8px; min-height: 40px; }
        
        .gantt-label { 
            width: 150px; 
            font-size: calc(11px * var(--font-scale)); 
            font-weight: 500; 
            color: var(--text-color); 
            padding-right: 10px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .gantt-timeline { flex: 1; position: relative; height: 35px; background: var(--bg-color); border-radius: 4px; }
        
        .gantt-bar { 
            position: absolute; 
            height: 100%; 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 0 8px; 
            font-size: calc(9px * var(--font-scale)); 
            color: white; 
            font-weight: 500; 
            cursor: pointer;
        }
        
        .gantt-bar-dates { font-size: calc(8px * var(--font-scale)); opacity: 0.9; }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            padding: 20px; 
        }
        
        .modal.show { display: flex; }
        .modal-content { background: var(--card-bg); border-radius: 12px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            background: var(--bg-color); 
            color: var(--text-color); 
        }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: calc(13px * var(--font-scale)); cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--button-primary); color: white; }
        .btn-primary:hover { background: var(--button-primary-hover); }
        .btn-secondary { background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        .settings-panel { 
            position: fixed; 
            top: 0; 
            right: -100%; 
            width: 90%; 
            max-width: 400px; 
            height: 100vh; 
            background: var(--card-bg); 
            box-shadow: -2px 0 10px rgba(0,0,0,0.2); 
            transition: right 0.3s; 
            z-index: 1001; 
            overflow-y: auto; 
            padding: 20px; 
        }
        
        .settings-panel.show { right: 0; }
        
        .theme-grid { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
        }
        
        .theme-option { 
            padding: 10px;
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.2s; 
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .theme-option:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .theme-option.active { border-color: var(--button-primary); transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .theme-preview {
            height: 50px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .theme-name { font-size: 11px; text-align: center; color: var(--text-secondary); font-weight: 500; }
        
        .contrast-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        
        .contrast-btn {
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: calc(11px * var(--font-scale));
            transition: all 0.2s;
            color: var(--text-color);
        }
        
        .contrast-btn.active { background: var(--button-primary); color: white; border-color: var(--button-primary); }
        
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 99; }
        
        .fab { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: var(--button-primary); 
            color: white; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px var(--shadow-color); 
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .fab:hover { background: var(--button-primary-hover); transform: scale(1.05); }
        
        .fab-menu { position: absolute; bottom: 60px; right: 0; display: none; flex-direction: column; gap: 8px; }
        .fab-menu.show { display: flex; }
        
        .fab-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            background: var(--card-bg); 
            color: var(--text-color);
            border-radius: 8px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            cursor: pointer; 
            white-space: nowrap; 
            font-size: calc(12px * var(--font-scale)); 
        }
        
        .toast { 
            position: fixed; 
            bottom: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--card-bg); 
            color: var(--text-color); 
            padding: 12px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            z-index: 9999; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .toast.show { opacity: 1; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        
        .task-item { 
            padding: 10px; 
            margin-bottom: 8px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            border-left: 3px solid var(--accent-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
        }
        
        .icon-btn { 
            background: var(--accent-color); 
            border: none; 
            color: white; 
            width: 28px; 
            height: 28px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(12px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
        }
        
        .icon-btn:hover { transform: scale(1.05); }
        .icon-btn.danger { background: var(--danger); }
        
        .calendar-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 15px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
            padding: 8px 0;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            padding: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 4px;
            font-size: calc(10px * var(--font-scale));
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: var(--card-bg);
            transform: scale(1.05);
        }
        
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { background: var(--accent-color); color: white; font-weight: bold; }
        .calendar-day.has-event { border: 2px solid var(--highlight-color); }
        
        .calendar-event {
            font-size: calc(7px * var(--font-scale));
            padding: 1px 2px;
            background: var(--accent-color);
            color: white;
            border-radius: 2px;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper { margin-top: 210px; }
            .tabs { -webkit-overflow-scrolling: touch; }
            .fab { width: 56px; height: 56px; }
            .theme-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 350px; }
            .theme-preview { height: 40px; font-size: 12px; }
            .stats-bar { gap: 6px; padding: 8px; }
            .stat-card { padding: 8px; }
            .stat-card h3 { font-size: calc(14px * var(--font-scale)); }
            .stat-card p { font-size: calc(10px * var(--font-scale)); }
        }
        
        @media (max-width: 400px) {
            .main-content-wrapper { margin-top: 220px; }
            .theme-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="app.showProfileModal()">
                        <div>
                            <h1 id="headerName">Builder Pro</h1>
                            <div class="header-subtitle" id="headerPosition">by REFIT Interior</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="app.smartSync()" title="Smart Sync">
                            🔄
                            <span class="sync-indicator" id="syncIndicator"></span>
                        </button>
                        <button class="header-btn" onclick="app.toggleSettings()" title="Settings">⚙️</button>
                    </div>
                </div>
                <div class="sync-status-bar" id="syncStatusBar">
                    <span id="deviceType"></span> • 
                    <span id="lastSyncTime">Never synced</span> • 
                    <span id="syncMode">Offline</span>
                </div>
            </div>
            
            <div class="tabs" id="tabsContainer">
                <div class="tab active" data-view="home">Home</div>
                <div class="tab" data-view="kanban">Kanban</div>
                <div class="tab" data-view="projects">Projects</div>
                <div class="tab" data-view="schedule">Schedule</div>
                <div class="tab" data-view="calendar">Calendar</div>
            </div>

            <div class="stats-bar">
                <div class="stat-card">
                    <h3 id="totalProjects">0</h3>
                    <p>Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTasks">0</h3>
                    <p>Tasks</p>
                </div>
                <div class="stat-card income">
                    <h3 id="totalIncome">$0</h3>
                    <p>Income</p>
                </div>
                <div class="stat-card expense">
                    <h3 id="totalExpenses">$0</h3>
                    <p>Expenses</p>
                </div>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="container" id="mainContent"></div>
        </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
            <span style="font-size: 1.25rem; font-weight: bold; color: var(--text-color);">Settings</span>
            <button onclick="app.toggleSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color);">✕</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔑 Smart Sync API</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="password" id="apiKeyInput" placeholder="JSONBin API Key" style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                <button class="btn btn-primary" onclick="app.saveApiKey()">Save</button>
            </div>
            <div style="padding: 8px; background: var(--bg-color); border-radius: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">
                Smart Sync: Pulls cloud data → Merges with local → Pushes complete dataset
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: 500; color: var(--text-color);">⚡ Auto-Sync (every 5 minutes)</span>
                <input type="checkbox" id="autoSyncToggle" onchange="app.toggleAutoSync()" style="width: 44px; height: 24px;">
            </div>
            <button class="btn btn-primary" onclick="app.smartSync()" style="width: 100%;">Manual Sync Now</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Theme Colors (18 Premium Themes)</label>
            <div class="theme-grid" id="themeGrid"></div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">⚡ Theme Contrast</label>
            <div class="contrast-controls" id="contrastControls">
                <button class="contrast-btn" data-contrast="low">Low</button>
                <button class="contrast-btn active" data-contrast="normal">Normal</button>
                <button class="contrast-btn" data-contrast="high">High</button>
                <button class="contrast-btn" data-contrast="extra">Extra</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔤 Font Size</label>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;" id="fontSizeControls">
                <button class="btn btn-secondary" data-size="s">S</button>
                <button class="btn btn-secondary" data-size="m">M</button>
                <button class="btn btn-secondary" data-size="l">L</button>
                <button class="btn btn-secondary" data-size="xl">XL</button>
                <button class="btn btn-secondary" data-size="xxl">XXL</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 600; color: var(--text-color);">🌙 Night Mode</span>
                <input type="checkbox" id="nightToggle" onchange="app.toggleNightMode()" style="width: 44px; height: 24px;">
            </div>
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="app.exportData()" style="width: 100%;">📤 Export Data</button>
            <label class="btn btn-success" style="display: block; text-align: center; margin-top: 10px; width: 100%;">
                📥 Import Data
                <input type="file" accept=".json" id="importFile" style="display: none;">
            </label>
        </div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="app.showProjectModal()">
                <span>📁</span>New Project
            </div>
            <div class="fab-option" onclick="app.showTaskModal()">
                <span>📋</span>New Task
            </div>
            <div class="fab-option" onclick="app.showTransactionModal('income')">
                <span>💰</span>Add Income
            </div>
            <div class="fab-option" onclick="app.showTransactionModal('expense')">
                <span>💸</span>Add Expense
            </div>
        </div>
        <button class="fab" onclick="app.toggleFabMenu()">+</button>
    </div>

    <!-- Modals -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: var(--text-color);">Profile Settings</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="app.closeModal('profileModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Your Name</label>
                    <input type="text" id="profileName" placeholder="John Doe" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Position</label>
                    <input type="text" id="profilePosition" placeholder="Project Manager" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="app.closeModal('profileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectModalTitle" style="color: var(--text-color);">New Project</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="app.closeModal('projectModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project Name *</label>
                    <input type="text" id="projectName" placeholder="Kitchen Renovation">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Client Name *</label>
                    <input type="text" id="projectClient" placeholder="John Doe">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="projectStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">End Date</label>
                        <input type="date" id="projectEnd">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="projectLocked" style="width: 20px; height: 20px;">
                    <label for="projectLocked" style="font-size: 12px; color: var(--text-color);">🔒 Lock project (prevents editing)</label>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="app.closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="taskModalTitle" style="color: var(--text-color);">New Task</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="app.closeModal('taskModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Task Name *</label>
                    <input type="text" id="taskName" placeholder="Install cabinets">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="taskProject"></select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Due Date *</label>
                        <input type="date" id="taskDue">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Priority</label>
                        <select id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Status</label>
                        <select id="taskStatus">
                            <option value="Get Ready">Get Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Worker name">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="taskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="app.closeModal('taskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="transactionModalTitle" style="color: var(--text-color);">Add Transaction</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="app.closeModal('transactionModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Type</label>
                    <select id="transType" onchange="app.updateCategories()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="transProject"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Category *</label>
                    <select id="transCategory"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Amount ($) *</label>
                    <input type="number" step="0.01" id="transAmount" placeholder="0.00">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Date *</label>
                    <input type="date" id="transDate">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="transDescription" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="app.closeModal('transactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectDetailTitle" style="color: var(--text-color);">Project Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="app.closeModal('projectDetailModal')">×</span>
            </div>
            <div id="projectDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="app.closeModal('projectDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const BuilderProApp = (function() {
            'use strict';
            
            // Configuration
            const APP_CONFIG = {
                binId: '68e121b8ae596e708f05df17',
                baseUrl: 'https://api.jsonbin.io/v3',
                deviceType: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Laptop',
                autoSyncInterval: 5 * 60 * 1000 // 5 minutes
            };

            // Theme colors
            const themeColors = [
                { name: 'Rose Blush', bg: '#F4EDEB', accent: '#E8A9B3', highlight: '#D47C90', text: '#1C1C1C' },
                { name: 'Mocha Cream', bg: '#FFF6F1', accent: '#C9A48F', highlight: '#8A5C4E', text: '#1C1C1C' },
                { name: 'Sand & Coffee', bg: '#F5EFE6', accent: '#A87C5F', highlight: '#6B4C3B', text: '#1C1C1C' },
                { name: 'Soft Plum', bg: '#F8F3F7', accent: '#B08CA5', highlight: '#8B5E83', text: '#1C1C1C' },
                { name: 'Nude Clay', bg: '#EFE5DC', accent: '#D5AA85', highlight: '#9F6B3F', text: '#1C1C1C' },
                { name: 'Charcoal Rose', bg: '#F0E6E9', accent: '#A77E94', highlight: '#7B4C60', text: '#1C1C1C' },
                { name: 'Muted Mauve', bg: '#F7F2F3', accent: '#C4A3B3', highlight: '#905E78', text: '#1C1C1C' },
                { name: 'Desert Sand', bg: '#F3E9DD', accent: '#C29D7F', highlight: '#7E5439', text: '#1C1C1C' },
                { name: 'Pastel Taupe', bg: '#EDE6E1', accent: '#B89C92', highlight: '#805B4D', text: '#1C1C1C' },
                { name: 'Cocoa Mint', bg: '#F6F4F2', accent: '#A68B76', highlight: '#5D3C2B', text: '#1C1C1C' },
                { name: 'Latte Rose', bg: '#F2E9E4', accent: '#C6A9A3', highlight: '#885E58', text: '#1C1C1C' },
                { name: 'Warm Pebble', bg: '#F4F1EE', accent: '#A39A92', highlight: '#645B52', text: '#1C1C1C' },
                { name: 'Dusty Coral', bg: '#FAF3F0', accent: '#D6A89A', highlight: '#B06653', text: '#1C1C1C' },
                { name: 'Almond Cocoa', bg: '#F5EFE8', accent: '#C9B29B', highlight: '#7C5A3D', text: '#1C1C1C' },
                { name: 'Blush Beige', bg: '#F6F1EF', accent: '#E2C9C0', highlight: '#A67D75', text: '#1C1C1C' },
                { name: 'Earthy Pink', bg: '#F3E5E1', accent: '#CF9D9E', highlight: '#804E50', text: '#1C1C1C' },
                { name: 'Champagne Gold', bg: '#FAF4EF', accent: '#E7D2B9', highlight: '#B18F63', text: '#1C1C1C' },
                { name: 'Neutral Blush', bg: '#F5F3F2', accent: '#D0B8AD', highlight: '#8C6A5A', text: '#1C1C1C' }
            ];

            // App State
            let state = {
                currentUser: 'Builder Pro',
                userPosition: 'by REFIT Interior',
                currentView: 'home',
                projects: [],
                tasks: [],
                transactions: [],
                deletedItems: [],
                nightMode: false,
                themeColor: 0,
                fontSize: 'm',
                contrast: 'normal',
                timelineFilter: 'all',
                scheduleView: 'month',
                calendarMonth: new Date().getMonth(),
                calendarYear: new Date().getFullYear()
            };

            let editingId = null;
            let editingType = null;
            let syncApiKey = '';
            let autoSyncInterval = null;
            let autoSyncEnabled = false;
            let draggedTaskId = null;

            // Utility: Sanitize HTML to prevent XSS
            function sanitize(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            // Utility: Show toast notification
            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }

            // Data Management
            function loadData() {
                const saved = localStorage.getItem('builderProData');
                if (saved) {
                    try {
                        state = { ...state, ...JSON.parse(saved) };
                    } catch (e) {
                        console.error('Failed to load data:', e);
                        showToast('Error loading saved data');
                    }
                }
                syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';
                applySettings();
            }

            function saveData() {
                state.lastUpdated = new Date().toISOString();
                localStorage.setItem('builderProData', JSON.stringify(state));
            }

            function applySettings() {
                if (state.nightMode) {
                    document.body.classList.add('night-mode');
                    document.getElementById('nightToggle').checked = true;
                }
                applyThemeColor(state.themeColor || 0);
                setFontSize(state.fontSize || 'm');
                setContrast(state.contrast || 'normal');
                updateHeader();
            }

            function updateHeader() {
                document.getElementById('headerName').textContent = sanitize(state.currentUser || 'Builder Pro');
                document.getElementById('headerPosition').textContent = sanitize(state.userPosition || 'by REFIT Interior');
            }

            function updateStats() {
                document.getElementById('totalProjects').textContent = state.projects.length;
                document.getElementById('totalTasks').textContent = state.tasks.length;
                
                const income = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                document.getElementById('totalIncome').textContent = '$' + income.toFixed(0);
                document.getElementById('totalExpenses').textContent = '$' + expenses.toFixed(0);
            }

            // Theme Management
            function initThemePicker() {
                const grid = document.getElementById('themeGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                themeColors.forEach((theme, index) => {
                    const div = document.createElement('div');
                    div.className = 'theme-option' + (index === (state.themeColor || 0) ? ' active' : '');
                    
                    const preview = document.createElement('div');
                    preview.className = 'theme-preview';
                    preview.style.background = `linear-gradient(135deg, ${theme.accent} 0%, ${theme.highlight} 100%)`;
                    preview.textContent = 'Aa';
                    
                    const name = document.createElement('div');
                    name.className = 'theme-name';
                    name.textContent = theme.name;
                    
                    div.appendChild(preview);
                    div.appendChild(name);
                    div.onclick = () => selectThemeColor(index);
                    
                    grid.appendChild(div);
                });
            }

            function selectThemeColor(index) {
                state.themeColor = index;
                applyThemeColor(index);
                saveData();
                
                document.querySelectorAll('.theme-option').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });
                showToast('Theme updated: ' + themeColors[index].name);
            }

            function applyThemeColor(index) {
                const theme = themeColors[index];
                if (!document.body.classList.contains('night-mode')) {
                    document.documentElement.style.setProperty('--bg-color', theme.bg);
                    document.documentElement.style.setProperty('--text-color', theme.text);
                }
                document.documentElement.style.setProperty('--accent-color', theme.accent);
                document.documentElement.style.setProperty('--highlight-color', theme.highlight);
                document.querySelector('meta[name="theme-color"]').content = theme.accent;
            }

            function setContrast(level) {
                document.body.classList.remove('low-contrast', 'normal-contrast', 'high-contrast', 'extra-contrast');
                document.body.classList.add(level + '-contrast');
                state.contrast = level;
                saveData();
                
                document.querySelectorAll('.contrast-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.contrast === level);
                });
            }

            function setFontSize(size) {
                document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl');
                document.body.classList.add('font-' + size);
                state.fontSize = size;
                saveData();
            }

            function toggleNightMode() {
                document.body.classList.toggle('night-mode');
                state.nightMode = document.body.classList.contains('night-mode');
                saveData();
                applyThemeColor(state.themeColor);
            }

            function toggleSettings() {
                const panel = document.getElementById('settingsPanel');
                panel.classList.toggle('show');
                if (panel.classList.contains('show')) {
                    setTimeout(initThemePicker, 100);
                }
            }

            function toggleFabMenu() {
                document.getElementById('fabMenu').classList.toggle('show');
            }

            // Modal Management
            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
            }

            function showProfileModal() {
                document.getElementById('profileName').value = state.currentUser;
                document.getElementById('profilePosition').value = state.userPosition;
                document.getElementById('profileModal').classList.add('show');
            }

            function saveProfile() {
                state.currentUser = document.getElementById('profileName').value.trim() || 'Builder Pro';
                state.userPosition = document.getElementById('profilePosition').value.trim() || 'by REFIT Interior';
                updateHeader();
                saveData();
                closeModal('profileModal');
                showToast('Profile updated');
            }

            // View Management
            function switchView(view) {
                state.currentView = view;
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === view);
                });
                renderView();
            }

            function renderView() {
                const content = document.getElementById('mainContent');
                switch(state.currentView) {
                    case 'home': renderHome(content); break;
                    case 'kanban': renderKanban(content); break;
                    case 'projects': renderProjects(content); break;
                    case 'schedule': renderSchedule(content); break;
                    case 'calendar': renderCalendar(content); break;
                }
            }

            function renderHome(container) {
                const income = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                let html = `
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-color);">💰 Finance Summary</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Income</div>
                                <div style="font-size: 18px; font-weight: bold; color: var(--income-color);">$${income.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Expenses</div>
                                <div style="font-size: 18px; font-weight: bold; color: var(--expense-color);">$${expenses.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Profit</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${income - expenses >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">
                                    $${(income - expenses).toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                html += `
                    <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 10px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color);">
                        <button class="btn btn-secondary ${state.timelineFilter === 'all' ? 'active' : ''}" 
                            onclick="app.setTimelineFilter('all')" style="flex: 1;">All</button>
                        <button class="btn btn-secondary ${state.timelineFilter === 'day' ? 'active' : ''}" 
                            onclick="app.setTimelineFilter('day')" style="flex: 1;">Today</button>
                        <button class="btn btn-secondary ${state.timelineFilter === 'week' ? 'active' : ''}" 
                            onclick="app.setTimelineFilter('week')" style="flex: 1;">Week</button>
                        <button class="btn btn-secondary ${state.timelineFilter === 'month' ? 'active' : ''}" 
                            onclick="app.setTimelineFilter('month')" style="flex: 1;">Month</button>
                    </div>
                `;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let dueTasks = state.tasks.filter(t => {
                    const due = new Date(t.dueDate);
                    due.setHours(0, 0, 0, 0);
                    return due <= today && t.status !== 'Completed';
                });
                
                if (state.timelineFilter === 'day') {
                    dueTasks = dueTasks.filter(t => {
                        const due = new Date(t.dueDate);
                        due.setHours(0, 0, 0, 0);
                        return due.getTime() === today.getTime();
                    });
                } else if (state.timelineFilter === 'week') {
                    const weekEnd = new Date(today);
                    weekEnd.setDate(today.getDate() + 7);
                    dueTasks = dueTasks.filter(t => new Date(t.dueDate) <= weekEnd);
                } else if (state.timelineFilter === 'month') {
                    const monthEnd = new Date(today);
                    monthEnd.setMonth(today.getMonth() + 1);
                    dueTasks = dueTasks.filter(t => new Date(t.dueDate) <= monthEnd);
                }
                
                if (dueTasks.length > 0) {
                    html += `<div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--danger);">🎯 Priority Tasks (${dueTasks.length})</h3>`;
                    
                    dueTasks.forEach(task => {
                        const project = state.projects.find(p => p.id === task.projectId);
                        html += `
                            <div class="task-item" style="border-left-color: var(--danger);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; margin-bottom: 5px; color: var(--text-color);">${sanitize(task.name)}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">
                                        ${project ? sanitize(project.name) : 'No Project'} • Due: ${task.dueDate}
                                        ${task.assignee ? ` • Assigned to: ${sanitize(task.assignee)}` : ''}
                                    </div>
                                </div>
                                <button class="icon-btn" onclick="app.editTask(${task.id})">✏️</button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                if (state.projects.length > 0) {
                    html += renderProjectTimeline();
                }
                
                container.innerHTML = html || '<div class="empty-state">No data yet. Click + to get started!</div>';
            }

            function setTimelineFilter(filter) {
                state.timelineFilter = filter;
                saveData();
                renderView();
            }

            function renderProjectTimeline() {
                const projectsWithDates = state.projects.filter(p => p.startDate && p.endDate);
                
                if (state.projects.length === 0) return '';
                
                let html = '<div class="gantt-container"><h3 style="font-size: 14px; margin-bottom: 15px; color: var(--text-color);">📅 Project Timeline</h3>';
                
                if (projectsWithDates.length === 0) {
                    html += '<div style="padding: 10px; background: var(--bg-color); border-radius: 8px;">';
                    html += '<p style="color: var(--text-secondary); margin-bottom: 10px;">No project dates set. Projects list:</p>';
                    state.projects.forEach(project => {
                        html += `
                            <div style="padding: 8px; margin-bottom: 5px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid var(--accent-color);">
                                <strong style="color: var(--text-color);">${sanitize(project.name)}</strong> - <span style="color: var(--text-secondary);">${sanitize(project.client)}</span>
                                ${project.locked ? ' 🔒' : ''}
                            </div>
                        `;
                    });
                    html += '</div></div>';
                    return html;
                }
                
                let minDate = new Date(projectsWithDates[0].startDate);
                let maxDate = new Date(projectsWithDates[0].endDate);
                
                projectsWithDates.forEach(p => {
                    const start = new Date(p.startDate);
                    const end = new Date(p.endDate);
                    if (start < minDate) minDate = start;
                    if (end > maxDate) maxDate = end;
                });
                
                const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
                
                const months = [];
                let current = new Date(minDate);
                while (current <= maxDate) {
                    months.push({
                        label: current.toLocaleDateString('en', { month: 'short', year: 'numeric' }),
                        start: new Date(current),
                        end: new Date(current.getFullYear(), current.getMonth() + 1, 0)
                    });
                    current.setMonth(current.getMonth() + 1);
                }
                
                html += '<div class="gantt-timeline-header"><div class="gantt-timeline-months">';
                months.forEach(month => {
                    const monthStart = Math.max(0, Math.ceil((month.start - minDate) / (1000 * 60 * 60 * 24)));
                    const monthEnd = Math.min(totalDays, Math.ceil((month.end - minDate) / (1000 * 60 * 60 * 24)) + 1);
                    const width = ((monthEnd - monthStart) / totalDays) * 100;
                    html += `<div class="gantt-month" style="width: ${width}%;">${month.label}</div>`;
                });
                html += '</div></div>';
                
                projectsWithDates.forEach(project => {
                    const start = new Date(project.startDate);
                    const end = new Date(project.endDate);
                    const startOffset = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
                    const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    const width = (duration / totalDays) * 100;
                    const left = (startOffset / totalDays) * 100;
                    
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-label">${sanitize(project.name)} ${project.locked ? '🔒' : ''}</div>
                            <div class="gantt-timeline">
                                <div class="gantt-bar" style="left: ${left}%; width: ${width}%;" onclick="app.showProjectDetail(${project.id})">
                                    <div>${duration} days</div>
                                    <div class="gantt-bar-dates">
                                        ${start.toLocaleDateString('en', { month: 'short', day: 'numeric' })} - 
                                        ${end.toLocaleDateString('en', { month: 'short', day: 'numeric' })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }

            function renderProjects(container) {
                if (state.projects.length === 0) {
                    container.innerHTML = '<div class="empty-state">No projects yet. Click + to create one!</div>';
                    return;
                }
                
                let html = '';
                state.projects.forEach(project => {
                    const tasks = state.tasks.filter(t => t.projectId === project.id);
                    const transactions = state.transactions.filter(t => t.projectId === project.id);
                    const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    
                    html += `
                        <div class="project-card">
                            <div class="project-header" onclick="app.showProjectDetail(${project.id})" style="cursor: pointer;">
                                <h3>${sanitize(project.name)} ${project.locked ? '🔒' : ''}</h3>
                                <div style="font-size: 11px; opacity: 0.9;">Client: ${sanitize(project.client)}</div>
                                ${project.startDate && project.endDate ? 
                                    `<div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">
                                        ${new Date(project.startDate).toLocaleDateString()} - 
                                        ${new Date(project.endDate).toLocaleDateString()}
                                    </div>` : ''}
                                <div class="project-stats">
                                    <div style="text-align: center;">
                                        <div style="font-size: 9px; opacity: 0.8;">Tasks</div>
                                        <div style="font-size: 13px; font-weight: bold;">${tasks.length}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 9px; opacity: 0.8;">Income</div>
                                        <div style="font-size: 13px; font-weight: bold; color: #4ade80;">${income.toFixed(0)}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 9px; opacity: 0.8;">Profit</div>
                                        <div style="font-size: 13px; font-weight: bold; color: ${income - expenses >= 0 ? '#4ade80' : '#f87171'};">
                                            ${(income - expenses).toFixed(0)}
                                        </div>
                                    </div>
                                </div>
                                <div class="project-actions" onclick="event.stopPropagation();">
                                    <button class="action-btn" onclick="app.editProject(${project.id})" ${project.locked ? 'disabled' : ''}>
                                        ${project.locked ? 'Locked' : 'Edit'}
                                    </button>
                                    <button class="action-btn" onclick="app.toggleProjectLock(${project.id})">
                                        ${project.locked ? 'Unlock' : 'Lock'}
                                    </button>
                                    <button class="action-btn" onclick="app.permanentDeleteProject(${project.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }

            function showProjectDetail(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) return;
                
                const tasks = state.tasks.filter(t => t.projectId === projectId);
                const transactions = state.transactions.filter(t => t.projectId === projectId);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const profit = income - expenses;
                
                document.getElementById('projectDetailTitle').textContent = sanitize(project.name) + (project.locked ? ' 🔒' : '');
                
                let html = `
                    <div style="background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">📋 Project Info</h4>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                            <div><strong>Client:</strong> ${sanitize(project.client)}</div>
                            ${project.startDate ? `<div><strong>Duration:</strong> ${project.startDate} to ${project.endDate || 'Ongoing'}</div>` : ''}
                            ${project.description ? `<div style="margin-top: 8px;"><strong>Description:</strong><br>${sanitize(project.description)}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">💰 Finance Summary</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 10px; color: var(--text-secondary);">Income</div>
                                <div style="font-size: 16px; font-weight: bold; color: var(--income-color);">$${income.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: var(--text-secondary);">Expenses</div>
                                <div style="font-size: 16px; font-weight: bold; color: var(--expense-color);">$${expenses.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: var(--text-secondary);">Profit</div>
                                <div style="font-size: 16px; font-weight: bold; color: ${profit >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">
                                    $${profit.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="app.showTransactionModalForProject('income', ${projectId})">
                            + Add Income
                        </button>
                        <button class="btn btn-danger" onclick="app.showTransactionModalForProject('expense', ${projectId})">
                            + Add Expense
                        </button>
                    </div>
                    
                    <h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">📋 Tasks (${tasks.length})</h4>
                `;
                
                if (tasks.length === 0) {
                    html += '<p style="text-align: center; color: var(--text-secondary); padding: 20px 0;">No tasks yet</p>';
                } else {
                    tasks.forEach(task => {
                        html += `
                            <div class="task-item" style="margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--text-color);">${sanitize(task.name)}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary);">
                                        ${task.dueDate} • ${task.priority} • ${task.status}
                                        ${task.assignee ? ` • ${sanitize(task.assignee)}` : ''}
                                    </div>
                                </div>
                                <button class="icon-btn" onclick="app.closeModal('projectDetailModal'); app.editTask(${task.id});">✏️</button>
                            </div>
                        `;
                    });
                }
                
                html += `<h4 style="font-size: 13px; margin: 15px 0 10px; color: var(--text-color);">💳 Transactions (${transactions.length})</h4>`;
                
                if (transactions.length === 0) {
                    html += '<p style="text-align: center; color: var(--text-secondary); padding: 20px 0;">No transactions yet</p>';
                } else {
                    transactions.forEach(trans => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-color); border-radius: 8px; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 500; font-size: 12px; color: var(--text-color);">${sanitize(trans.category)}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary);">
                                        ${trans.date}
                                        ${trans.description ? ` • ${sanitize(trans.description)}` : ''}
                                    </div>
                                </div>
                                <div style="font-weight: bold; color: ${trans.type === 'income' ? 'var(--income-color)' : 'var(--expense-color)'};">
                                    ${trans.type === 'income' ? '+' : '-'}$${trans.amount.toFixed(2)}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('projectDetailBody').innerHTML = html;
                document.getElementById('projectDetailModal').classList.add('show');
            }

            function showTransactionModalForProject(type, projectId) {
                showTransactionModal(type);
                document.getElementById('transProject').value = projectId;
            }

            function toggleProjectLock(id) {
                const project = state.projects.find(p => p.id === id);
                if (project) {
                    project.locked = !project.locked;
                    saveData();
                    renderView();
                    showToast(project.locked ? 'Project locked' : 'Project unlocked');
                }
            }

            function renderSchedule(container) {
                let html = `
                    <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 10px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color);">
                        <button class="btn btn-secondary ${state.scheduleView === 'day' ? 'active' : ''}" 
                            onclick="app.setScheduleView('day')" style="flex: 1;">Day</button>
                        <button class="btn btn-secondary ${state.scheduleView === 'week' ? 'active' : ''}" 
                            onclick="app.setScheduleView('week')" style="flex: 1;">Week</button>
                        <button class="btn btn-secondary ${state.scheduleView === 'month' ? 'active' : ''}" 
                            onclick="app.setScheduleView('month')" style="flex: 1;">Month</button>
                        <button class="btn btn-secondary ${state.scheduleView === 'all' ? 'active' : ''}" 
                            onclick="app.setScheduleView('all')" style="flex: 1;">All</button>
                    </div>
                `;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let filteredTasks = [...state.tasks];
                let minDate = new Date();
                let maxDate = new Date();
                
                if (state.scheduleView === 'day') {
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.dueDate);
                        taskDate.setHours(0, 0, 0, 0);
                        return taskDate.getTime() === today.getTime();
                    });
                    minDate = today;
                    maxDate = today;
                } else if (state.scheduleView === 'week') {
                    const weekEnd = new Date(today);
                    weekEnd.setDate(today.getDate() + 7);
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.dueDate);
                        return taskDate >= today && taskDate <= weekEnd;
                    });
                    minDate = today;
                    maxDate = weekEnd;
                } else if (state.scheduleView === 'month') {
                    const monthEnd = new Date(today);
                    monthEnd.setMonth(today.getMonth() + 1);
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.dueDate);
                        return taskDate >= today && taskDate <= monthEnd;
                    });
                    minDate = today;
                    maxDate = monthEnd;
                } else {
                    filteredTasks.forEach(task => {
                        if (task.startDate) {
                            const start = new Date(task.startDate);
                            if (start < minDate) minDate = start;
                        }
                        if (task.dueDate) {
                            const due = new Date(task.dueDate);
                            if (due > maxDate) maxDate = due;
                        }
                    });
                }
                
                if (maxDate - minDate < 1000 * 60 * 60 * 24) {
                    maxDate = new Date(minDate);
                    maxDate.setDate(maxDate.getDate() + 7);
                }
                
                const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
                
                html += '<div class="gantt-container"><h3 style="font-size: 14px; margin-bottom: 15px; color: var(--text-color);">📊 Task Schedule Gantt Chart</h3>';
                
                if (filteredTasks.length === 0) {
                    html += `<p class="empty-state">No tasks scheduled for ${state.scheduleView === 'all' ? 'any time' : 'this ' + state.scheduleView}</p>`;
                } else {
                    html += '<div class="gantt-timeline-header"><div class="gantt-timeline-months">';
                    
                    if (state.scheduleView === 'day') {
                        for (let hour = 0; hour < 24; hour += 3) {
                            html += `<div class="gantt-month" style="flex: 1; font-size: 9px;">${hour}:00</div>`;
                        }
                    } else if (state.scheduleView === 'week') {
                        for (let d = 0; d <= 7; d++) {
                            const day = new Date(today);
                            day.setDate(today.getDate() + d);
                            html += `<div class="gantt-month" style="flex: 1; font-size: 9px;">
                                ${day.toLocaleDateString('en', { weekday: 'short', day: 'numeric' })}
                            </div>`;
                        }
                    } else {
                        const months = [];
                        let current = new Date(minDate);
                        while (current <= maxDate) {
                            months.push({
                                label: current.toLocaleDateString('en', { month: 'short', year: 'numeric' }),
                                start: new Date(current),
                                end: new Date(current.getFullYear(), current.getMonth() + 1, 0)
                            });
                            current.setMonth(current.getMonth() + 1);
                        }
                        
                        months.forEach(month => {
                            const monthStart = Math.max(0, Math.ceil((month.start - minDate) / (1000 * 60 * 60 * 24)));
                            const monthEnd = Math.min(totalDays, Math.ceil((month.end - minDate) / (1000 * 60 * 60 * 24)) + 1);
                            const width = ((monthEnd - monthStart) / totalDays) * 100;
                            html += `<div class="gantt-month" style="width: ${width}%;">${month.label}</div>`;
                        });
                    }
                    
                    html += '</div></div>';
                    
                    const sortedTasks = filteredTasks.sort((a, b) => new Date(a.dueDate || a.startDate) - new Date(b.dueDate || b.startDate));
                    
                    sortedTasks.forEach(task => {
                        const project = state.projects.find(p => p.id === task.projectId);
                        const startDate = task.startDate ? new Date(task.startDate) : new Date(task.dueDate);
                        const dueDate = new Date(task.dueDate);
                        
                        const startOffset = Math.max(0, Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24)));
                        const duration = Math.ceil((dueDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        const width = Math.max((duration / totalDays) * 100, 2);
                        const left = (startOffset / totalDays) * 100;
                        
                        let barColor = 'linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%)';
                        if (task.status === 'Completed') barColor = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                        else if (task.status === 'In Progress') barColor = 'linear-gradient(135deg, #f39c12 0%, #f9c74f 100%)';
                        else if (dueDate < today) barColor = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
                        
                        html += `
                            <div class="gantt-row">
                                <div class="gantt-label" title="${sanitize(task.name)} - ${project ? sanitize(project.name) : 'No Project'}">${sanitize(task.name)}</div>
                                <div class="gantt-timeline">
                                    <div class="gantt-bar" style="left: ${left}%; width: ${width}%; background: ${barColor};" 
                                         onclick="app.editTask(${task.id})" title="${task.priority} Priority - ${task.status}">
                                        <div style="font-size: 9px;">${duration}d</div>
                                        <div class="gantt-bar-dates" style="font-size: 8px;">
                                            ${startDate.toLocaleDateString('en', { month: 'short', day: 'numeric' })} - 
                                            ${dueDate.toLocaleDateString('en', { month: 'short', day: 'numeric' })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            function setScheduleView(view) {
                state.scheduleView = view;
                saveData();
                renderView();
            }

            function renderKanban(container) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const dueTasks = state.tasks.filter(t => {
                    const dueDate = new Date(t.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate <= today && t.status !== 'Completed';
                });
                
                const inProgressTasks = state.tasks.filter(t => t.status === 'In Progress');
                const getReadyTasks = state.tasks.filter(t => 
                    (t.status === 'Get Ready' || !t.status) && !dueTasks.includes(t)
                );
                
                const columns = [
                    { title: 'Due', status: 'Due', tasks: dueTasks, color: '#ef4444' },
                    { title: 'In Progress', status: 'In Progress', tasks: inProgressTasks, color: '#f39c12' },
                    { title: 'Get Ready', status: 'Get Ready', tasks: getReadyTasks, color: 'var(--accent-color)' }
                ];
                
                let html = '<div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">';
                columns.forEach(column => {
                    html += `
                        <div style="min-width: 280px; background: var(--card-bg); border-radius: 10px; padding: 10px; box-shadow: 0 2px 10px var(--shadow-color);">
                            <h3 style="font-size: 14px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid ${column.color}; color: ${column.color};">
                                ${column.title} (${column.tasks.length})
                            </h3>
                            <div data-status="${column.status}" style="min-height: 100px;">
                    `;
                    
                    column.tasks.forEach(task => {
                        const project = state.projects.find(p => p.id === task.projectId);
                        
                        html += `
                            <div draggable="true" data-task-id="${task.id}" 
                                 style="background: var(--bg-color); padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: move; 
                                        border-left: 3px solid ${column.color};">
                                <div style="font-weight: 500; margin-bottom: 5px; color: var(--text-color);">${sanitize(task.name)}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    ${project ? sanitize(project.name) : 'No Project'}
                                </div>
                                <div style="font-size: 10px; margin-top: 5px; color: var(--text-secondary);">
                                    📅 ${task.dueDate} • ${task.priority} Priority
                                    ${task.assignee ? ` • 👤 ${sanitize(task.assignee)}` : ''}
                                </div>
                                ${task.description ? `
                                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 5px; 
                                                padding-top: 5px; border-top: 1px solid var(--border-color);">
                                        ${sanitize(task.description.substring(0, 50))}${task.description.length > 50 ? '...' : ''}
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 4px; margin-top: 8px;">
                                    <button class="btn btn-secondary" onclick="app.editTask(${task.id}); event.stopPropagation();" 
                                            style="padding: 4px 8px; font-size: 11px;">✏️ Edit</button>
                                    <button class="btn btn-secondary" onclick="app.completeTask(${task.id}); event.stopPropagation();" 
                                            style="padding: 4px 8px; font-size: 11px;">✅</button>
                                    <button class="btn btn-secondary" onclick="app.deleteTask(${task.id}); event.stopPropagation();" 
                                            style="padding: 4px 8px; font-size: 11px;">🗑️</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                });
                html += '</div>';
                
                container.innerHTML = html;
                setupDragAndDrop();
            }

            function setupDragAndDrop() {
                const draggables = document.querySelectorAll('[draggable="true"]');
                const dropZones = document.querySelectorAll('[data-status]');
                
                draggables.forEach(draggable => {
                    draggable.addEventListener('dragstart', (e) => {
                        draggedTaskId = parseInt(e.target.dataset.taskId);
                        e.target.style.opacity = '0.5';
                    });
                    
                    draggable.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '1';
                    });
                });
                
                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        zone.style.background = 'rgba(0,0,0,0.05)';
                    });
                    
                    zone.addEventListener('dragleave', (e) => {
                        zone.style.background = '';
                    });
                    
                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        zone.style.background = '';
                        const status = zone.dataset.status;
                        
                        if (status === 'Due') {
                            showToast('Tasks are automatically marked as Due based on date');
                            return;
                        }
                        
                        const task = state.tasks.find(t => t.id === draggedTaskId);
                        if (task) {
                            task.status = status;
                            saveData();
                            renderView();
                            showToast('Task moved');
                        }
                    });
                });
            }

            function completeTask(id) {
                const task = state.tasks.find(t => t.id === id);
                if (task) {
                    task.status = 'Completed';
                    task.completedAt = new Date().toISOString();
                    saveData();
                    renderView();
                    showToast('✅ Task completed');
                }
            }

            function deleteTask(id) {
                if (!confirm('Delete this task?')) return;
                
                state.tasks = state.tasks.filter(t => t.id !== id);
                if (!state.deletedItems) state.deletedItems = [];
                state.deletedItems.push({ id, type: 'task', deletedAt: new Date().toISOString() });
                
                saveData();
                renderView();
                updateStats();
                showToast('Task deleted');
            }

            function renderCalendar(container) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                const today = new Date();
                const currentMonth = state.calendarMonth;
                const currentYear = state.calendarYear;
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const prevLastDay = new Date(currentYear, currentMonth, 0);
                
                const firstDayOfWeek = firstDay.getDay();
                const lastDate = lastDay.getDate();
                const prevLastDate = prevLastDay.getDate();
                
                let html = `
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="app.changeMonth(-1)">◀</button>
                            <h3 style="color: var(--text-color);">${monthNames[currentMonth]} ${currentYear}</h3>
                            <button class="btn btn-secondary" onclick="app.changeMonth(1)">▶</button>
                        </div>
                        <div class="calendar-grid">
                `;
                
                // Day headers
                dayNames.forEach(day => {
                    html += `<div class="calendar-day-header">${day}</div>`;
                });
                
                // Previous month days
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    html += `<div class="calendar-day other-month">${prevLastDate - i}</div>`;
                }
                
                // Current month days
                for (let day = 1; day <= lastDate; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const isToday = date.toDateString() === today.toDateString();
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const tasksOnDay = state.tasks.filter(t => t.dueDate === dateStr);
                    const hasEvent = tasksOnDay.length > 0;
                    
                    html += `
                        <div class="calendar-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}">
                            <div>${day}</div>
                            ${tasksOnDay.slice(0, 2).map(t => 
                                `<div class="calendar-event" title="${sanitize(t.name)}">${sanitize(t.name.substring(0, 8))}</div>`
                            ).join('')}
                        </div>
                    `;
                }
                
                // Next month days to fill grid
                const totalCells = firstDayOfWeek + lastDate;
                const remainingCells = 42 - totalCells; // Always show 6 weeks
                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="calendar-day other-month">${day}</div>`;
                }
                
                html += `
                        </div>
                    </div>
                    
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--text-color);">📅 Tasks this month</h4>
                `;
                
                const monthTasks = state.tasks.filter(t => {
                    const taskDate = new Date(t.dueDate);
                    return taskDate.getMonth() === currentMonth && taskDate.getFullYear() === currentYear;
                }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                if (monthTasks.length === 0) {
                    html += '<p class="empty-state">No tasks this month</p>';
                } else {
                    monthTasks.forEach(task => {
                        const project = state.projects.find(p => p.id === task.projectId);
                        html += `
                            <div class="task-item">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--text-color);">${sanitize(task.name)}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">
                                        ${project ? sanitize(project.name) : 'No Project'} • ${task.dueDate} • ${task.status}
                                    </div>
                                </div>
                                <button class="icon-btn" onclick="app.editTask(${task.id})">✏️</button>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            function changeMonth(delta) {
                state.calendarMonth += delta;
                if (state.calendarMonth > 11) {
                    state.calendarMonth = 0;
                    state.calendarYear++;
                } else if (state.calendarMonth < 0) {
                    state.calendarMonth = 11;
                    state.calendarYear--;
                }
                renderView();
            }

            // Project CRUD
            function showProjectModal() {
                editingId = null;
                editingType = 'project';
                document.getElementById('projectModalTitle').textContent = 'New Project';
                document.getElementById('projectName').value = '';
                document.getElementById('projectClient').value = '';
                document.getElementById('projectStart').value = '';
                document.getElementById('projectEnd').value = '';
                document.getElementById('projectDescription').value = '';
                document.getElementById('projectLocked').checked = false;
                document.getElementById('projectModal').classList.add('show');
                toggleFabMenu();
            }

            function editProject(id) {
                const project = state.projects.find(p => p.id === id);
                if (!project || project.locked) return;
                
                editingId = id;
                editingType = 'project';
                document.getElementById('projectModalTitle').textContent = 'Edit Project';
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectClient').value = project.client;
                document.getElementById('projectStart').value = project.startDate || '';
                document.getElementById('projectEnd').value = project.endDate || '';
                document.getElementById('projectDescription').value = project.description || '';
                document.getElementById('projectLocked').checked = project.locked || false;
                document.getElementById('projectModal').classList.add('show');
            }

            function saveProject() {
                const projectData = {
                    name: document.getElementById('projectName').value.trim(),
                    client: document.getElementById('projectClient').value.trim(),
                    startDate: document.getElementById('projectStart').value,
                    endDate: document.getElementById('projectEnd').value,
                    description: document.getElementById('projectDescription').value.trim(),
                    locked: document.getElementById('projectLocked').checked
                };
                
                if (!projectData.name || !projectData.client) {
                    showToast('Please fill required fields');
                    return;
                }
                
                if (editingId) {
                    const index = state.projects.findIndex(p => p.id === editingId);
                    state.projects[index] = { ...state.projects[index], ...projectData };
                    showToast('Project updated');
                } else {
                    projectData.id = Date.now();
                    state.projects.push(projectData);
                    showToast('Project created');
                }
                
                saveData();
                renderView();
                updateStats();
                closeModal('projectModal');
            }

            // Fixed: Add missing permanentDeleteProject function
            function permanentDeleteProject(id) {
                if (!confirm('⚠️ Permanently delete this project and all its tasks/transactions?\n\nThis action cannot be undone!')) return;
                
                state.projects = state.projects.filter(p => p.id !== id);
                state.tasks = state.tasks.filter(t => t.projectId !== id);
                state.transactions = state.transactions.filter(t => t.projectId !== id);
                
                if (!state.deletedItems) state.deletedItems = [];
                state.deletedItems.push({ 
                    id, 
                    type: 'project', 
                    deletedAt: new Date().toISOString() 
                });
                
                saveData();
                renderView();
                updateStats();
                showToast('Project permanently deleted');
            }

            // Task CRUD
            function showTaskModal() {
                editingId = null;
                editingType = 'task';
                document.getElementById('taskModalTitle').textContent = 'New Task';
                document.getElementById('taskName').value = '';
                document.getElementById('taskPriority').value = 'Medium';
                document.getElementById('taskStatus').value = 'Get Ready';
                document.getElementById('taskStart').value = '';
                document.getElementById('taskDue').value = '';
                document.getElementById('taskAssignee').value = '';
                document.getElementById('taskDescription').value = '';
                
                const select = document.getElementById('taskProject');
                select.innerHTML = '<option value="">Select Project</option>';
                state.projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${sanitize(p.name)}</option>`;
                });
                
                document.getElementById('taskModal').classList.add('show');
                toggleFabMenu();
            }

            function editTask(id) {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;
                
                editingId = id;
                editingType = 'task';
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskStart').value = task.startDate || '';
                document.getElementById('taskDue').value = task.dueDate;
                document.getElementById('taskAssignee').value = task.assignee || '';
                document.getElementById('taskDescription').value = task.description || '';
                
                const select = document.getElementById('taskProject');
                select.innerHTML = '<option value="">Select Project</option>';
                state.projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${sanitize(p.name)}</option>`;
                });
                select.value = task.projectId;
                
                document.getElementById('taskModal').classList.add('show');
            }

            function saveTask() {
                const taskData = {
                    name: document.getElementById('taskName').value.trim(),
                    projectId: parseInt(document.getElementById('taskProject').value),
                    priority: document.getElementById('taskPriority').value,
                    status: document.getElementById('taskStatus').value,
                    startDate: document.getElementById('taskStart').value,
                    dueDate: document.getElementById('taskDue').value,
                    assignee: document.getElementById('taskAssignee').value.trim(),
                    description: document.getElementById('taskDescription').value.trim()
                };
                
                if (!taskData.name || !taskData.projectId || !taskData.dueDate) {
                    showToast('Please fill required fields');
                    return;
                }
                
                if (editingId) {
                    const index = state.tasks.findIndex(t => t.id === editingId);
                    state.tasks[index] = { ...state.tasks[index], ...taskData };
                    showToast('Task updated');
                } else {
                    taskData.id = Date.now();
                    state.tasks.push(taskData);
                    showToast('Task created');
                }
                
                saveData();
                renderView();
                updateStats();
                closeModal('taskModal');
            }

            // Transaction CRUD
            function showTransactionModal(type) {
                editingId = null;
                editingType = 'transaction';
                document.getElementById('transactionModalTitle').textContent = type === 'income' ? 'Add Income' : 'Add Expense';
                document.getElementById('transType').value = type;
                document.getElementById('transAmount').value = '';
                document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('transDescription').value = '';
                
                const select = document.getElementById('transProject');
                select.innerHTML = '<option value="">Select Project</option>';
                state.projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${sanitize(p.name)}</option>`;
                });
                
                updateCategories();
                document.getElementById('transactionModal').classList.add('show');
                toggleFabMenu();
            }

            function updateCategories() {
                const type = document.getElementById('transType').value;
                const categories = type === 'expense' ? 
                    ['Materials', 'Labor', 'Equipment', 'Transport', 'Other'] : 
                    ['Payment', 'Deposit', 'Final Payment', 'Other'];
                
                const select = document.getElementById('transCategory');
                select.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }

            function saveTransaction() {
                const transData = {
                    type: document.getElementById('transType').value,
                    projectId: parseInt(document.getElementById('transProject').value),
                    category: document.getElementById('transCategory').value,
                    amount: parseFloat(document.getElementById('transAmount').value),
                    date: document.getElementById('transDate').value,
                    description: document.getElementById('transDescription').value.trim()
                };
                
                if (!transData.projectId || !transData.category || !transData.amount || isNaN(transData.amount)) {
                    showToast('Please fill all fields correctly');
                    return;
                }
                
                transData.id = Date.now();
                state.transactions.push(transData);
                showToast('Transaction added');
                
                saveData();
                renderView();
                updateStats();
                closeModal('transactionModal');
            }

            // Smart Sync
            async function smartSync() {
                if (!syncApiKey) {
                    showToast('Please set up API key first');
                    return;
                }
                
                const indicator = document.getElementById('syncIndicator');
                const syncMode = document.getElementById('syncMode');
                
                indicator.classList.add('syncing');
                syncMode.textContent = 'Syncing...';
                
                try {
                    const pullResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                        headers: { 'X-Master-Key': syncApiKey }
                    });
                    
                    let cloudData = {};
                    if (pullResponse.ok) {
                        const result = await pullResponse.json();
                        cloudData = result.record || {};
                    }
                    
                    const mergedData = {
                        projects: mergeArrays(cloudData.projects || [], state.projects, 'id'),
                        tasks: mergeArrays(cloudData.tasks || [], state.tasks, 'id'),
                        transactions: mergeArrays(cloudData.transactions || [], state.transactions, 'id'),
                        deletedItems: mergeArrays(cloudData.deletedItems || [], state.deletedItems || [], 'id'),
                        currentUser: state.currentUser,
                        userPosition: state.userPosition,
                        themeColor: state.themeColor,
                        fontSize: state.fontSize,
                        contrast: state.contrast,
                        nightMode: state.nightMode,
                        lastUpdated: new Date().toISOString(),
                        lastUpdateDevice: APP_CONFIG.deviceType
                    };
                    
                    if (mergedData.deletedItems.length > 0) {
                        const deletedIds = new Set(mergedData.deletedItems.map(d => d.id));
                        mergedData.projects = mergedData.projects.filter(p => !deletedIds.has(p.id));
                        mergedData.tasks = mergedData.tasks.filter(t => !deletedIds.has(t.id));
                        mergedData.transactions = mergedData.transactions.filter(t => !deletedIds.has(t.id));
                    }
                    
                    const pushResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': syncApiKey
                        },
                        body: JSON.stringify(mergedData)
                    });
                    
                    if (pushResponse.ok) {
                        state = { ...state, ...mergedData };
                        saveData();
                        renderView();
                        updateStats();
                        
                        localStorage.setItem('lastSyncTime', Date.now().toString());
                        document.getElementById('lastSyncTime').textContent = new Date().toLocaleTimeString();
                        
                        showToast('Smart sync complete!');
                    } else {
                        showToast('Sync failed');
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                    showToast('Sync error - offline');
                } finally {
                    indicator.classList.remove('syncing');
                    syncMode.textContent = syncApiKey ? 'Connected' : 'Offline';
                }
            }

            function mergeArrays(cloudArray, localArray, key) {
                const merged = [...cloudArray];
                const cloudIds = new Set(cloudArray.map(item => item[key]));
                
                localArray.forEach(localItem => {
                    if (!cloudIds.has(localItem[key])) {
                        merged.push(localItem);
                    }
                });
                
                return merged;
            }

            function saveApiKey() {
                const key = document.getElementById('apiKeyInput').value.trim();
                if (!key) {
                    showToast('Please enter an API key');
                    return;
                }
                syncApiKey = key;
                localStorage.setItem('builderProSyncApiKey', key);
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('syncMode').textContent = 'Connected';
                showToast('API key saved - Smart Sync ready!');
            }

            function toggleAutoSync() {
                autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
                localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
                
                if (autoSyncEnabled) {
                    startAutoSync();
                    showToast('Auto-sync enabled');
                } else {
                    stopAutoSync();
                    showToast('Auto-sync disabled');
                }
            }

            function startAutoSync() {
                stopAutoSync();
                if (syncApiKey && autoSyncEnabled) {
                    autoSyncInterval = setInterval(smartSync, APP_CONFIG.autoSyncInterval);
                }
            }

            function stopAutoSync() {
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                    autoSyncInterval = null;
                }
            }

            function initAutoSync() {
                const savedAutoSync = localStorage.getItem('autoSyncEnabled');
                if (savedAutoSync === 'true' && syncApiKey) {
                    autoSyncEnabled = true;
                    document.getElementById('autoSyncToggle').checked = true;
                    startAutoSync();
                    setTimeout(smartSync, 1000);
                }
            }

            function initializeLastSync() {
                const lastSyncTime = localStorage.getItem('lastSyncTime');
                if (lastSyncTime) {
                    const date = new Date(parseInt(lastSyncTime));
                    document.getElementById('lastSyncTime').textContent = date.toLocaleTimeString();
                }
                
                if (syncApiKey) {
                    document.getElementById('syncMode').textContent = 'Connected';
                }
            }

            // Export/Import
            function exportData() {
                const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `builder-pro-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Data exported');
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('⚠️ Replace all current data with imported data?')) {
                            state = { ...state, ...imported };
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported successfully');
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Import failed - invalid file');
                    }
                };
                reader.readAsText(file);
            }

            // Initialize App
            function init() {
                loadData();
                updateStats();
                renderView();
                initAutoSync();
                initializeLastSync();
                document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
                
                // Event delegation for tabs
                document.getElementById('tabsContainer').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab')) {
                        switchView(e.target.dataset.view);
                    }
                });
                
                // Event delegation for contrast controls
                document.getElementById('contrastControls').addEventListener('click', (e) => {
                    if (e.target.classList.contains('contrast-btn')) {
                        setContrast(e.target.dataset.contrast);
                    }
                });
                
                // Event delegation for font size controls
                document.getElementById('fontSizeControls').addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn')) {
                        setFontSize(e.target.dataset.size);
                    }
                });
                
                // Import file handler
                document.getElementById('importFile').addEventListener('change', importData);
                
                // Check online status
                if (!navigator.onLine) {
                    document.getElementById('syncMode').textContent = 'Offline';
                }
                
                // Show welcome message for new users
                if (state.projects.length === 0 && state.tasks.length === 0) {
                    setTimeout(() => {
                        showToast('👋 Welcome to Builder Pro! Press + to get started');
                    }, 1000);
                }
            }

            // Public API
            return {
                init,
                showProfileModal,
                saveProfile,
                showProjectModal,
                editProject,
                saveProject,
                permanentDeleteProject,
                toggleProjectLock,
                showProjectDetail,
                showTransactionModalForProject,
                showTaskModal,
                editTask,
                saveTask,
                deleteTask,
                completeTask,
                showTransactionModal,
                updateCategories,
                saveTransaction,
                switchView,
                setTimelineFilter,
                setScheduleView,
                changeMonth,
                toggleSettings,
                toggleNightMode,
                toggleFabMenu,
                selectThemeColor,
                setContrast,
                setFontSize,
                smartSync,
                saveApiKey,
                toggleAutoSync,
                exportData,
                closeModal
            };
        })();

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', BuilderProApp.init);
        } else {
            BuilderProApp.init();
        }

        // Expose app globally for onclick handlers
        window.app = BuilderProApp;
    </script>
