<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="msapplication-navbutton-color" content="#E8A9B3">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .header {
                padding-top: 12px;
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding-top: var(--safe-area-inset-top);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .header h1 { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .header-subtitle { 
            font-size: calc(11px * var(--font-scale)); 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .header-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #10b981; 
            border: 2px solid white; 
        }
        
        .sync-indicator.syncing { 
            background: #f39c12; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        .sync-status-bar { 
            background: var(--button-primary); 
            color: white; 
            padding: 4px 10px; 
            font-size: calc(11px * var(--font-scale)); 
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
        }
        
        .tabs { 
            background: var(--card-bg); 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            overflow-x: auto; 
        }
        
        .tab { 
            flex: 1; 
            min-width: 80px; 
            padding: 10px 8px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            font-size: calc(12px * var(--font-scale)); 
            transition: all 0.2s;
        }
        
        .tab.active { 
            color: var(--accent-color); 
            border-bottom-color: var(--accent-color); 
        }
        
        .stats-bar { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: var(--bg-color); 
        }
        
        .main-content-wrapper {
            margin-top: 200px;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 210px;
            }
        }
        
        .container { 
            padding: 10px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 80px; 
        }
        
        .stat-card { 
            background: var(--card-bg); 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px var(--shadow-color); 
            text-align: center; 
        }
        
        .stat-card h3 { 
            font-size: calc(16px * var(--font-scale)); 
            color: var(--accent-color); 
            margin-bottom: 2px; 
            font-weight: 700; 
        }
        
        .stat-card.income h3 { color: var(--income-color); }
        .stat-card.expense h3 { color: var(--expense-color); }
        
        .stat-card p {
            color: var(--text-secondary);
            font-size: calc(11px * var(--font-scale));
        }
        
        .project-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            margin-bottom: 12px; 
            overflow: visible;
        }
        
        .project-header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 12px; 
            border-radius: 12px 12px 0 0;
            transition: all 0.2s;
        }
        
        .project-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .project-header:active {
            transform: translateY(0);
        }
        
        .project-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: rgba(0,0,0,0.1); 
            margin-top: 8px;
            border-radius: 8px;
        }
        
        .project-actions { 
            display: flex; 
            gap: 5px; 
            margin-top: 8px; 
            flex-wrap: wrap; 
        }
        
        .action-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(10px * var(--font-scale)); 
            transition: background 0.2s;
        }
        
        .action-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .gantt-container { 
            background: var(--card-bg); 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            overflow-x: auto; 
            margin-bottom: 15px; 
            position: relative;
        }
        
        .gantt-timeline-header {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        .gantt-timeline-months {
            margin-left: 150px;
            display: flex;
            flex: 1;
            gap: 2px;
        }
        
        .gantt-month {
            flex: 1;
            text-align: center;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-secondary);
            font-weight: 600;
            padding: 4px;
            background: var(--bg-color);
            border-radius: 4px;
        }
        
        .gantt-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            min-height: 40px; 
        }
        
        .gantt-label { 
            width: 150px; 
            font-size: calc(11px * var(--font-scale)); 
            font-weight: 500; 
            color: var(--text-color); 
            padding-right: 10px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .gantt-timeline { 
            flex: 1; 
            position: relative; 
            height: 35px; 
            background: var(--bg-color); 
            border-radius: 4px; 
        }
        
        .gantt-bar { 
            position: absolute; 
            height: 100%; 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 0 8px; 
            font-size: calc(9px * var(--font-scale)); 
            color: white; 
            font-weight: 500; 
            cursor: pointer;
        }
        
        .gantt-bar-dates {
            font-size: calc(8px * var(--font-scale));
            opacity: 0.9;
        }
        
        .today-line {
            position: absolute;
            top: -10px;
            bottom: -10px;
            width: 4px;
            background: #ef4444;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
        }
        
        .today-line::before {
            content: 'TODAY';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            padding: 20px; 
        }
        
        .modal.show { display: flex; }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 12px; 
            width: 100%; 
            max-width: 400px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            background: var(--bg-color); 
            color: var(--text-color); 
        }
        
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .btn-primary { 
            background: var(--button-primary); 
            color: white; 
        }
        
        .btn-primary:hover {
            background: var(--button-primary-hover);
        }
        
        .btn-secondary { 
            background: var(--bg-color); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .settings-panel { 
            position: fixed; 
            top: 0; 
            right: -100%; 
            width: 90%; 
            max-width: 400px; 
            height: 100vh; 
            background: var(--card-bg); 
            box-shadow: -2px 0 10px rgba(0,0,0,0.2); 
            transition: right 0.3s; 
            z-index: 1001; 
            overflow-y: auto; 
            padding: 20px; 
            padding-top: calc(20px + var(--safe-area-inset-top));
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        .settings-panel.show { right: 0; }
        
        .settings-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            transition: opacity 0.3s;
        }
        
        .settings-backdrop.show {
            display: block;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-top: 10px;
        }
        
        .settings-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .settings-close-btn:active {
            background: var(--bg-color);
        }
        
        .theme-grid { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
        }
        
        .theme-option { 
            padding: 10px;
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.2s; 
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .theme-option:hover { 
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .theme-option.active { 
            border-color: var(--button-primary); 
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .theme-preview {
            height: 50px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .theme-name {
            font-size: 11px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .contrast-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .contrast-btn {
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: calc(11px * var(--font-scale));
            transition: all 0.2s;
            color: var(--text-color);
        }
        
        .contrast-btn.active {
            background: var(--button-primary);
            color: white;
            border-color: var(--button-primary);
        }
        
        .fab-container { 
            position: fixed; 
            bottom: calc(20px + var(--safe-area-inset-bottom)); 
            right: 20px; 
            z-index: 99; 
        }
        
        .fab { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: var(--button-primary); 
            color: white; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px var(--shadow-color); 
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .fab:hover {
            background: var(--button-primary-hover);
            transform: scale(1.05);
        }
        
        .fab-menu { 
            position: absolute; 
            bottom: 60px; 
            right: 0; 
            display: none; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .fab-menu.show { display: flex; }
        
        .fab-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            background: var(--card-bg); 
            color: var(--text-color);
            border-radius: 8px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            cursor: pointer; 
            white-space: nowrap; 
            font-size: calc(12px * var(--font-scale)); 
        }
        
        .toast { 
            position: fixed; 
            bottom: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--card-bg); 
            color: var(--text-color); 
            padding: 12px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            z-index: 9999; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .toast.show { opacity: 1; }
        
        .casual-note {
            position: fixed;
            max-width: 240px;
            background: #fef3c7;
            color: #78350f;
            padding: 12px 14px;
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
            z-index: 9998;
            font-family: 'Comic Sans MS', 'Marker Felt', cursive, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            opacity: 0;
            transform: scale(0.8) rotate(-2deg);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            cursor: pointer;
            border-left: 3px solid #f59e0b;
        }
        
        .casual-note.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        
        .casual-note.hide {
            opacity: 0;
            transform: scale(0.8) rotate(2deg);
        }
        
        .casual-note::before {
            content: '💡';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 18px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        
        .casual-note-close {
            position: absolute;
            top: 4px;
            right: 6px;
            background: none;
            border: none;
            color: #92400e;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            opacity: 0.6;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .casual-note-close:hover {
            opacity: 1;
        }
        
        .casual-note-action {
            margin-top: 8px;
            padding: 4px 10px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            display: inline-block;
        }
        
        .casual-note-action:active {
            transform: scale(0.95);
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-secondary); 
        }
        
        .task-item { 
            padding: 10px; 
            margin-bottom: 8px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            border-left: 3px solid var(--accent-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .task-item {
                padding: 8px;
                gap: 8px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: calc(14px * var(--font-scale));
            }
        }
        
        .icon-btn { 
            background: var(--accent-color); 
            border: none; 
            color: white; 
            width: 28px; 
            height: 28px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(12px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .icon-btn:hover {
            transform: scale(1.05);
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        .icon-btn.danger { 
            background: var(--danger); 
        }
        
        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .calendar-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 15px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 10px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            padding: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 4px;
            font-size: calc(10px * var(--font-scale));
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: var(--card-bg);
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--shadow-color);
            z-index: 10;
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
            font-weight: bold;
            border: 3px solid #dc2626 !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.7) !important;
            animation: todayPulse 2s infinite;
            transform: scale(1.05);
            z-index: 20;
        }
        
        @keyframes todayPulse {
            0%, 100% { 
                box-shadow: 0 0 25px rgba(239, 68, 68, 0.7);
            }
            50% { 
                box-shadow: 0 0 35px rgba(239, 68, 68, 1);
            }
        }
        
        .calendar-day.today:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            transform: scale(1.08) !important;
        }
        
        .calendar-day.today .calendar-event {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #ef4444 !important;
            font-weight: 700;
        }
        
        .calendar-day.has-event {
            border: 2px solid var(--highlight-color);
        }
        
        .calendar-event {
            font-size: calc(8px * var(--font-scale));
            padding: 2px;
            background: var(--accent-color);
            color: white;
            border-radius: 2px;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sync-calendar-btn {
            background: var(--button-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: calc(13px * var(--font-scale));
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 250px;
            }
            
            .tabs {
                -webkit-overflow-scrolling: touch;
            }
            
            .fab {
                width: 56px;
                height: 56px;
            }
            
            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                max-height: 350px;
            }
            
            .theme-preview {
                height: 40px;
                font-size: 12px;
            }
            
            .stats-bar {
                gap: 6px;
                padding: 8px;
            }
            
            .stat-card {
                padding: 8px;
            }
            
            .stat-card h3 {
                font-size: calc(14px * var(--font-scale));
            }
            
            .stat-card p {
                font-size: calc(10px * var(--font-scale));
            }
            
            .task-item {
                padding: 8px;
                gap: 8px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: calc(14px * var(--font-scale));
            }
            
            .project-card {
                margin-bottom: 16px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: calc(12px * var(--font-scale));
            }
        }
        
        @media (max-width: 400px) {
            .main-content-wrapper {
                margin-top: 260px;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .gantt-label {
                width: 100px;
                font-size: calc(10px * var(--font-scale));
            }
            
            .project-header h3 {
                font-size: calc(14px * var(--font-scale));
            }
            
            .action-btn {
                font-size: calc(9px * var(--font-scale));
                padding: 3px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="showProfileModal()">
                        <div>
                            <h1 id="headerName">Builder Pro</h1>
                            <div class="header-subtitle" id="headerPosition">by REFIT Interior</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="smartSync()" title="Smart Sync">
                            🔄
                            <span class="sync-indicator" id="syncIndicator"></span>
                        </button>
                        <button class="header-btn" onclick="toggleSettings()" title="Settings">⚙️</button>
                    </div>
                </div>
                <div class="sync-status-bar" id="syncStatusBar">
                    <span id="deviceType"></span> • 
                    <span id="lastSyncTime" style="cursor: pointer;" onclick="showToast('Click 🔄 to sync now')" title="Click 🔄 to sync">Never synced</span> • 
                    <span id="syncMode">Offline</span>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchView('home')">Home</div>
                <div class="tab" onclick="switchView('kanban')">Kanban</div>
                <div class="tab" onclick="switchView('projects')">Projects</div>
                <div class="tab" onclick="switchView('schedule')">Schedule</div>
                <div class="tab" onclick="switchView('calendar')">Calendar</div>
            </div>

            <div class="stats-bar">
                <div class="stat-card">
                    <h3 id="totalProjects">0</h3>
                    <p>Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTasks">0</h3>
                    <p>Tasks</p>
                </div>
                <div class="stat-card income">
                    <h3 id="totalIncome">$0</h3>
                    <p>Income</p>
                </div>
                <div class="stat-card expense">
                    <h3 id="totalExpenses">$0</h3>
                    <p>Expenses</p>
                </div>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="container" id="mainContent"></div>
        </div>
    </div>

    <div class="settings-backdrop" id="settingsBackdrop" onclick="toggleSettings()"></div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span style="font-size: 1.25rem; font-weight: bold; color: var(--text-color);">⚙️ Settings</span>
            <button class="settings-close-btn" onclick="toggleSettings()">✕</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔒 Smart Sync API</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="password" id="apiKeyInput" placeholder="JSONBin API Key" style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
            </div>
            <div style="padding: 8px; background: var(--bg-color); border-radius: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">
                <strong style="color: var(--text-color);">🧠 Smart Sync Logic:</strong><br>
                1️⃣ Pull cloud data<br>
                2️⃣ Compare timestamps (created_at, updated_at)<br>
                3️⃣ Keep most recent version<br>
                4️⃣ Push merged data to cloud<br>
                <span style="color: var(--accent-color); font-weight: bold;">✓ Latest edits always win!</span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: 500; color: var(--text-color);">⚡ Auto-Sync (every 5 minutes)</span>
                <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()" style="width: 44px; height: 24px;">
            </div>
            <button class="btn btn-primary" onclick="smartSync()" style="width: 100%; margin-bottom: 8px;">🔄 Manual Sync Now</button>
            <button class="btn btn-secondary" onclick="testSync()" style="width: 100%;">🔍 Test Sync Connection</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Theme Colors (18 Premium Themes)</label>
            <div class="theme-grid" id="themeGrid"></div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">⚡ Theme Contrast</label>
            <div class="contrast-controls">
                <button class="contrast-btn" onclick="setContrast('low')">Low</button>
                <button class="contrast-btn active" onclick="setContrast('normal')">Normal</button>
                <button class="contrast-btn" onclick="setContrast('high')">High</button>
                <button class="contrast-btn" onclick="setContrast('extra')">Extra</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Color Saturation</label>
            <div class="contrast-controls">
                <button class="contrast-btn" onclick="setSaturation('low')">Low</button>
                <button class="contrast-btn active" onclick="setSaturation('normal')">Normal</button>
                <button class="contrast-btn" onclick="setSaturation('high')">High</button>
                <button class="contrast-btn" onclick="setSaturation('vibrant')">Vibrant</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔤 Font Size</label>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <button class="btn btn-secondary" onclick="setFontSize('s')">S</button>
                <button class="btn btn-secondary" onclick="setFontSize('m')">M</button>
                <button class="btn btn-secondary" onclick="setFontSize('l')">L</button>
                <button class="btn btn-secondary" onclick="setFontSize('xl')">XL</button>
                <button class="btn btn-secondary" onclick="setFontSize('xxl')">XXL</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 600; color: var(--text-color);">🌙 Night Mode</span>
                <input type="checkbox" id="nightToggle" onchange="toggleNightMode()" style="width: 44px; height: 24px;">
            </div>
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="exportData()" style="width: 100%;">📤 Export Data</button>
            <label class="btn btn-success" style="display: block; text-align: center; margin-top: 10px; width: 100%;">
                📥 Import Data
                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
            </label>
        </div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="showProjectModal()">
                <span>📁</span>New Project
            </div>
            <div class="fab-option" onclick="showTaskModal()">
                <span>📋</span>New Task
            </div>
            <div class="fab-option" onclick="showTransactionModal('income')">
                <span>💰</span>Add Income
            </div>
            <div class="fab-option" onclick="showTransactionModal('expense')">
                <span>💸</span>Add Expense
            </div>
        </div>
        <button class="fab" onclick="toggleFabMenu()">+</button>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: var(--text-color);">Profile Settings</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('profileModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Your Name</label>
                    <input type="text" id="profileName" placeholder="John Doe" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Position</label>
                    <input type="text" id="profilePosition" placeholder="Project Manager" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('profileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectModalTitle" style="color: var(--text-color);">New Project</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('projectModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project Name *</label>
                    <input type="text" id="projectName" placeholder="Kitchen Renovation">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Client Name *</label>
                    <input type="text" id="projectClient" placeholder="John Doe">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="projectStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">End Date</label>
                        <input type="date" id="projectEnd">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="projectLocked" style="width: 20px; height: 20px;">
                    <label for="projectLocked" style="font-size: 12px; color: var(--text-color);">🔒 Lock project (prevents editing)</label>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="taskModalTitle" style="color: var(--text-color);">New Task</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('taskModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Task Name *</label>
                    <input type="text" id="taskName" placeholder="Install cabinets">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="taskProject"></select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Due Date *</label>
                        <input type="date" id="taskDue">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Priority</label>
                        <select id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Status</label>
                        <select id="taskStatus">
                            <option value="Get Ready">Get Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Worker name">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="taskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="transactionModalTitle" style="color: var(--text-color);">Add Transaction</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('transactionModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Type</label>
                    <select id="transType" onchange="updateCategories()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="transProject"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Category *</label>
                    <select id="transCategory"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Amount ($) *</label>
                    <input type="number" step="0.01" id="transAmount" placeholder="0.00">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Date *</label>
                    <input type="date" id="transDate">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="transDescription" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectDetailTitle" style="color: var(--text-color);">Project Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('projectDetailModal')">×</span>
            </div>
            <div id="projectDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('projectDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="dayDetailTitle" style="color: var(--text-color);">📅 Day Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('dayDetailModal')">×</span>
            </div>
            <div id="dayDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('dayDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const APP_CONFIG = {
            binId: '68e121b8ae596e708f05df17',
            baseUrl: 'https://api.jsonbin.io/v3',
            deviceType: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Laptop'
        };

        const themeColors = [
            { name: 'Rose Blush', bg: '#F4EDEB', accent: '#E8A9B3', highlight: '#D47C90', text: '#1C1C1C' },
            { name: 'Mocha Cream', bg: '#FFF6F1', accent: '#C9A48F', highlight: '#8A5C4E', text: '#1C1C1C' },
            { name: 'Sand & Coffee', bg: '#F5EFE6', accent: '#A87C5F', highlight: '#6B4C3B', text: '#1C1C1C' },
            { name: 'Soft Plum', bg: '#F8F3F7', accent: '#B08CA5', highlight: '#8B5E83', text: '#1C1C1C' },
            { name: 'Nude Clay', bg: '#EFE5DC', accent: '#D5AA85', highlight: '#9F6B3F', text: '#1C1C1C' },
            { name: 'Charcoal Rose', bg: '#F0E6E9', accent: '#A77E94', highlight: '#7B4C60', text: '#1C1C1C' },
            { name: 'Muted Mauve', bg: '#F7F2F3', accent: '#C4A3B3', highlight: '#905E78', text: '#1C1C1C' },
            { name: 'Desert Sand', bg: '#F3E9DD', accent: '#C29D7F', highlight: '#7E5439', text: '#1C1C1C' },
            { name: 'Pastel Taupe', bg: '#EDE6E1', accent: '#B89C92', highlight: '#805B4D', text: '#1C1C1C' },
            { name: 'Cocoa Mint', bg: '#F6F4F2', accent: '#A68B76', highlight: '#5D3C2B', text: '#1C1C1C' },
            { name: 'Latte Rose', bg: '#F2E9E4', accent: '#C6A9A3', highlight: '#885E58', text: '#1C1C1C' },
            { name: 'Warm Pebble', bg: '#F4F1EE', accent: '#A39A92', highlight: '#645B52', text: '#1C1C1C' },
            { name: 'Dusty Coral', bg: '#FAF3F0', accent: '#D6A89A', highlight: '#B06653', text: '#1C1C1C' },
            { name: 'Almond Cocoa', bg: '#F5EFE8', accent: '#C9B29B', highlight: '#7C5A3D', text: '#1C1C1C' },
            { name: 'Blush Beige', bg: '#F6F1EF', accent: '#E2C9C0', highlight: '#A67D75', text: '#1C1C1C' },
            { name: 'Earthy Pink', bg: '#F3E5E1', accent: '#CF9D9E', highlight: '#804E50', text: '#1C1C1C' },
            { name: 'Champagne Gold', bg: '#FAF4EF', accent: '#E7D2B9', highlight: '#B18F63', text: '#1C1C1C' },
            { name: 'Neutral Blush', bg: '#F5F3F2', accent: '#D0B8AD', highlight: '#8C6A5A', text: '#1C1C1C' }
        ];

        let data = {
            currentUser: 'Builder Pro',
            userPosition: 'by REFIT Interior',
            currentView: 'home',
            projects: [],
            tasks: [],
            transactions: [],
            permanentlyDeleted: [],
            archivedProjects: [],
            expandedProjects: [],
            expandedScheduleProjects: [],
            showArchived: false,
            nightMode: false,
            themeColor: 0,
            fontSize: 'm',
            contrast: 'normal',
            saturation: 'normal',
            timelineFilter: 'all',
            scheduleView: 'month',
            calendarEvents: [],
            lastUpdated: null
        };

        let editingId = null;
        let editingType = null;
        let syncApiKey = '';
        let autoSyncInterval = null;
        let autoSyncEnabled = false;
        let casualNoteTimeout = null;
        let activeCasualNote = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            aggressiveCleanup();
            initUI();
            updateStats();
            renderView();
            initAutoSync();
            initializeLastSync();
            scheduleCasualNote();
            
            if (!navigator.onLine) {
                document.getElementById('syncMode').textContent = 'Offline';
            }
            
            document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
            
            if (data.projects.length === 0 && data.tasks.length === 0) {
                setTimeout(() => {
                    showToast('👋 Welcome to Builder Pro! Press + to get started');
                }, 1000);
            }
        });

        function aggressiveCleanup() {
            const unwantedNames = [
                'william. mock up 1',
                'fnn ice cream booth',
                'fnn meeting room 1-refreshment',
                'fnn add on ac diffuser',
                'ms ng- tmn midah. kl',
                'fnn ceo blind',
                'fnn. relocate ac thermostat',
                'ss3 winsum',
                'usj 11. nicky',
                'dsara damai. james house',
                'william mockup 2',
                'liam. production 50 crackle set',
                'william. production 50 crackle set',
                'elaine bu11/14',
                "adrian home. - d'clover residences",
                'wong n carol no 37, ss3'
            ];
            
            const beforeCount = data.projects.length;
            
            data.projects = data.projects.filter(project => {
                const projectNameLower = project.name.toLowerCase().trim();
                const shouldRemove = unwantedNames.some(unwantedName => 
                    projectNameLower === unwantedName.toLowerCase().trim() ||
                    projectNameLower.includes(unwantedName.toLowerCase().trim())
                );
                return !shouldRemove;
            });
            
            const removedCount = beforeCount - data.projects.length;
            
            if (removedCount > 0) {
                const validProjectIds = data.projects.map(p => p.id);
                data.tasks = data.tasks.filter(task => validProjectIds.includes(task.projectId));
                data.transactions = data.transactions.filter(trans => validProjectIds.includes(trans.projectId));
                saveData();
                console.log(`✅ CLEANUP: Removed ${removedCount} unwanted projects`);
            }
        }

        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                data = { ...data, ...JSON.parse(saved) };
            }
            syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';
            applySettings();
        }

        function saveData() {
            data.lastUpdated = new Date().toISOString();
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        function addTimestamps(item, isNew = false) {
            const now = new Date().toISOString();
            if (isNew) {
                item.created_at = now;
            }
            item.updated_at = now;
            return item;
        }

        function mergeByTimestamp(localItems, cloudItems, type) {
            const merged = new Map();
            
            localItems.forEach(item => {
                merged.set(item.id, { ...item, _source: 'local' });
            });
            
            cloudItems.forEach(cloudItem => {
                const localItem = merged.get(cloudItem.id);
                
                if (!localItem) {
                    merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                } else {
                    const localTime = new Date(localItem.updated_at || localItem.created_at || 0);
                    const cloudTime = new Date(cloudItem.updated_at || cloudItem.created_at || 0);
                    
                    if (cloudTime > localTime) {
                        merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                    }
                }
            });
            
            const result = Array.from(merged.values()).filter(item => !item.deleted_at);
            result.forEach(item => delete item._source);
            
            return result;
        }

        function applySettings() {
            if (data.nightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('nightToggle').checked = true;
            }
            applyThemeColor(data.themeColor || 0);
            setFontSize(data.fontSize || 'm');
            setContrast(data.contrast || 'normal');
            setSaturation(data.saturation || 'normal');
            updateHeader();
        }

        function initUI() {
            initThemePicker();
            document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
        }

        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            themeColors.forEach((theme, index) => {
                const div = document.createElement('div');
                div.className = 'theme-option' + (index === (data.themeColor || 0) ? ' active' : '');
                
                const preview = document.createElement('div');
                preview.className = 'theme-preview';
                preview.style.background = `linear-gradient(135deg, ${theme.accent} 0%, ${theme.highlight} 100%)`;
                preview.innerHTML = 'Aa';
                
                const name = document.createElement('div');
                name.className = 'theme-name';
                name.textContent = theme.name;
                
                div.appendChild(preview);
                div.appendChild(name);
                div.onclick = () => selectThemeColor(index);
                
                grid.appendChild(div);
            });
        }

        function selectThemeColor(index) {
            data.themeColor = index;
            applyThemeColor(index);
            saveData();
            
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.theme-option')[index].classList.add('active');
            showToast('Theme updated: ' + themeColors[index].name);
        }

        function applyThemeColor(index) {
            const theme = themeColors[index];
            if (!document.body.classList.contains('night-mode')) {
                document.documentElement.style.setProperty('--bg-color', theme.bg);
                document.documentElement.style.setProperty('--text-color', theme.text);
            }
            document.documentElement.style.setProperty('--accent-color', theme.accent);
            document.documentElement.style.setProperty('--highlight-color', theme.highlight);
            
            document.querySelector('meta[name="theme-color"]').content = theme.accent;
        }

        function setContrast(level) {
            document.body.classList.remove('low-contrast', 'normal-contrast', 'high-contrast', 'extra-contrast');
            document.body.classList.add(level + '-contrast');
            data.contrast = level;
            saveData();
            
            document.querySelectorAll('.contrast-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === level) {
                    btn.classList.add('active');
                }
            });
            
            setSaturation(data.saturation || 'normal');
        }

        function setSaturation(level) {
            document.body.classList.remove('sat-low', 'sat-normal', 'sat-high', 'sat-vibrant');
            document.body.classList.add('sat-' + level);
            data.saturation = level;
            saveData();
            
            const saturationSection = document.querySelectorAll('.contrast-controls')[1];
            if (saturationSection) {
                saturationSection.querySelectorAll('.contrast-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === level) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function setFontSize(size) {
            document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl');
            document.body.classList.add('font-' + size);
            data.fontSize = size;
            saveData();
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            data.nightMode = document.body.classList.contains('night-mode');
            saveData();
            applyThemeColor(data.themeColor);
        }

        function updateHeader() {
            if (data.currentUser !== 'Builder Pro') {
                document.getElementById('headerName').textContent = data.currentUser;
            }
            if (data.userPosition !== 'by REFIT Interior') {
                document.getElementById('headerPosition').textContent = data.userPosition;
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const backdrop = document.getElementById('settingsBackdrop');
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.style.overflow = '';
            } else {
                panel.classList.add('show');
                backdrop.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    initThemePicker();
                }, 100);
            }
        }

        function toggleFabMenu() {
            document.getElementById('fabMenu').classList.toggle('show');
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function switchView(view) {
            data.currentView = view;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderView();
        }

        function renderView() {
            const content = document.getElementById('mainContent');
            switch(data.currentView) {
                case 'home': renderHome(content); break;
                case 'kanban': renderKanban(content); break;
                case 'projects': renderProjects(content); break;
                case 'schedule': renderSchedule(content); break;
                case 'calendar': renderCalendar(content); break;
            }
        }

        // ==================== CASUAL NOTE SYSTEM ====================
        
        function scheduleCasualNote() {
            // Random interval between 30-45 minutes (1800000-2700000 ms)
            const minInterval = 30 * 60 * 1000; // 30 minutes
            const maxInterval = 45 * 60 * 1000; // 45 minutes
            const randomInterval = Math.random() * (maxInterval - minInterval) + minInterval;
            
            if (casualNoteTimeout) {
                clearTimeout(casualNoteTimeout);
            }
            
            casualNoteTimeout = setTimeout(() => {
                showCasualNote();
                scheduleCasualNote(); // Schedule next one
            }, randomInterval);
            
            console.log(`⏰ Next casual note in ${(randomInterval / 60000).toFixed(1)} minutes`);
        }
        
        function generateCasualNotes() {
            const notes = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Check for overdue tasks
            const overdueTasks = data.tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate < today && t.status !== 'Completed';
            });
            if (overdueTasks.length > 0) {
                notes.push({
                    message: `Hey! Just noticed you have ${overdueTasks.length} task${overdueTasks.length > 1 ? 's' : ''} overdue. Maybe check on ${overdueTasks.length > 1 ? 'them' : 'it'}? 😊`,
                    action: 'Check Tasks',
                    actionFn: () => switchViewFromNote('kanban')
                });
            }
            
            // Check for upcoming tasks
            const upcomingTasks = data.tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const twoDaysFromNow = new Date(today);
                twoDaysFromNow.setDate(today.getDate() + 2);
                return dueDate >= today && dueDate <= twoDaysFromNow && t.status !== 'Completed';
            });
            if (upcomingTasks.length > 0) {
                notes.push({
                    message: `Quick heads up - ${upcomingTasks.length} task${upcomingTasks.length > 1 ? 's are' : ' is'} due in the next couple days!`,
                    action: 'View',
                    actionFn: () => switchViewFromNote('kanban')
                });
            }
            
            // Projects without dates
            const projectsWithoutDates = data.projects.filter(p => !p.startDate || !p.endDate);
            if (projectsWithoutDates.length > 0) {
                const proj = projectsWithoutDates[0];
                notes.push({
                    message: `Btw, "${proj.name}" doesn't have dates yet. Might help with planning! 📅`,
                    action: 'Add Dates',
                    actionFn: () => {
                        switchViewFromNote('schedule');
                        setTimeout(() => editProject(proj.id), 500);
                    }
                });
            }
            
            // Projects without tasks
            const projectsWithoutTasks = data.projects.filter(p => {
                return data.tasks.filter(t => t.projectId === p.id).length === 0;
            });
            if (projectsWithoutTasks.length > 0) {
                const proj = projectsWithoutTasks[0];
                notes.push({
                    message: `"${proj.name}" looks empty - maybe add some tasks to get started?`,
                    action: 'Add Tasks',
                    actionFn: () => {
                        switchViewFromNote('projects');
                        setTimeout(() => {
                            showTaskModal();
                            document.getElementById('taskProject').value = proj.id;
                        }, 500);
                    }
                });
            }
            
            // Projects with expenses but no income
            data.projects.forEach(project => {
                const transactions = data.transactions.filter(t => t.projectId === project.id);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                
                if (expenses > 500 && income === 0) {
                    notes.push({
                        message: `You've spent $${expenses.toFixed(0)} on "${project.name}" but haven't logged any income yet. Don't forget! 💰`,
                        action: 'Add Income',
                        actionFn: () => {
                            switchViewFromNote('projects');
                            setTimeout(() => {
                                showTransactionModal('income');
                                document.getElementById('transProject').value = project.id;
                            }, 500);
                        }
                    });
                }
                
                // Losing money
                if (income > 0 && expenses > income) {
                    const loss = expenses - income;
                    notes.push({
                        message: `Heads up - "${project.name}" is down $${loss.toFixed(0)}. Might wanna review the numbers? 📉`,
                        action: 'Check It',
                        actionFn: () => {
                            switchViewFromNote('projects');
                            setTimeout(() => showProjectDetail(project.id), 500);
                        }
                    });
                }
            });
            
            // Tasks without assignees
            const tasksWithoutAssignee = data.tasks.filter(t => !t.assignee && t.status !== 'Completed');
            if (tasksWithoutAssignee.length >= 3) {
                notes.push({
                    message: `${tasksWithoutAssignee.length} tasks don't have anyone assigned yet. Who's doing what? 👥`,
                    action: 'Assign',
                    actionFn: () => switchViewFromNote('kanban')
                });
            }
            
            // Positive notes
            const completedTasks = data.tasks.filter(t => t.status === 'Completed');
            if (completedTasks.length > 0 && completedTasks.length % 10 === 0) {
                notes.push({
                    message: `Wow! ${completedTasks.length} tasks done! You're crushing it! 🎉`,
                    action: 'See Progress',
                    actionFn: () => switchViewFromNote('kanban')
                });
            }
            
            // Calendar sync reminder
            if (data.tasks.length > 8 && Math.random() > 0.7) {
                notes.push({
                    message: `Pro tip: You can sync your ${data.tasks.length} tasks to iPhone calendar! Super handy 📱`,
                    action: 'Show Me',
                    actionFn: () => switchViewFromNote('calendar')
                });
            }
            
            // Work-life balance
            const overwhelmingDates = analyzeSchedule().overwhelmingDates;
            if (overwhelmingDates.length > 0) {
                notes.push({
                    message: `Your schedule's looking pretty packed soon. Maybe take a peek at the calendar? 😅`,
                    action: 'Check Calendar',
                    actionFn: () => switchViewFromNote('calendar')
                });
            }
            
            // Random encouragement
            const encouragements = [
                { message: "How's everything going? Just checking in! 😊", action: null },
                { message: "Remember to take breaks! You're doing great btw 💪", action: null },
                { message: "Quick reminder: Progress > Perfection 🌟", action: null },
                { message: "Don't forget to celebrate the small wins! 🎊", action: null }
            ];
            
            if (Math.random() > 0.6) {
                notes.push(encouragements[Math.floor(Math.random() * encouragements.length)]);
            }
            
            return notes;
        }
        
        function showCasualNote() {
            // Don't show if already showing one
            if (activeCasualNote) return;
            
            const notes = generateCasualNotes();
            if (notes.length === 0) return;
            
            // Pick random note
            const note = notes[Math.floor(Math.random() * notes.length)];
            
            // Random position on screen
            const positions = [
                { top: '20%', left: '10%' },
                { top: '30%', right: '15%' },
                { top: '50%', left: '5%' },
                { bottom: '25%', right: '10%' },
                { top: '15%', left: '70%' },
                { top: '60%', right: '5%' }
            ];
            const position = positions[Math.floor(Math.random() * positions.length)];
            
            const noteEl = document.createElement('div');
            noteEl.className = 'casual-note';
            Object.assign(noteEl.style, position);
            
            let html = `
                <button class="casual-note-close" onclick="closeCasualNote()">×</button>
                <div>${note.message}</div>
            `;
            
            if (note.action) {
                html += `<button class="casual-note-action" onclick="executeCasualNoteAction()">${note.action}</button>`;
            }
            
            noteEl.innerHTML = html;
            noteEl.onclick = (e) => {
                if (e.target !== noteEl) return;
                closeCasualNote();
            };
            
            // Store action function
            noteEl._actionFn = note.actionFn;
            
            document.body.appendChild(noteEl);
            activeCasualNote = noteEl;
            
            // Show with animation
            setTimeout(() => noteEl.classList.add('show'), 10);
            
            // Auto-hide after 20 seconds
            setTimeout(() => {
                if (activeCasualNote === noteEl) {
                    closeCasualNote();
                }
            }, 20000);
        }
        
        function closeCasualNote() {
            if (activeCasualNote) {
                activeCasualNote.classList.remove('show');
                activeCasualNote.classList.add('hide');
                setTimeout(() => {
                    if (activeCasualNote) {
                        activeCasualNote.remove();
                        activeCasualNote = null;
                    }
                }, 300);
            }
        }
        
        function executeCasualNoteAction() {
            if (activeCasualNote && activeCasualNote._actionFn) {
                const actionFn = activeCasualNote._actionFn;
                closeCasualNote();
                actionFn();
            }
        }
        
        function switchViewFromNote(view) {
            data.currentView = view;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.toLowerCase().includes(view) || tab.getAttribute('onclick')?.includes(view)) {
                    tab.classList.add('active');
                }
            });
            renderView();
        }

        function renderHome(container) {
            const income = data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-color);">💰 Finance Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Income</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--income-color);">${income.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Expenses</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--expense-color);">${expenses.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Profit</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${income - expenses >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">
                                ${(income - expenses).toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.projects.length > 0) {
                html += renderProjectTimeline();
            }
            
            container.innerHTML = html || '<div class="empty-state">No data yet. Click + to get started!</div>';
        }

        function renderProjectTimeline() {
            // Similar to your existing implementation - keeping it brief for space
            if (data.projects.length === 0) return '';
            const projectsWithDates = data.projects.filter(p => p.startDate && p.endDate);
            if (projectsWithDates.length === 0) {
                return '<div style="padding: 20px; text-align: center;">No project dates set yet.</div>';
            }
            
            let html = '<div class="gantt-container"><h3>📅 Project Timeline</h3>';
            // Add timeline rendering logic here
            html += '</div>';
            return html;
        }

        function renderKanban(container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dueTasks = data.tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate <= today && t.status !== 'Completed';
            });
            
            const inProgressTasks = data.tasks.filter(t => t.status === 'In Progress');
            const getReadyTasks = data.tasks.filter(t => 
                (t.status === 'Get Ready' || !t.status) && !dueTasks.includes(t)
            );
            
            let html = '<div style="display: flex; gap: 10px; overflow-x: auto;">';
            
            [
                { title: 'Due', tasks: dueTasks, color: '#ef4444' },
                { title: 'In Progress', tasks: inProgressTasks, color: '#f39c12' },
                { title: 'Get Ready', tasks: getReadyTasks, color: 'var(--accent-color)' }
            ].forEach(column => {
                html += `<div style="min-width: 280px; background: var(--card-bg); border-radius: 10px; padding: 10px;">
                    <h3 style="font-size: 14px; color: ${column.color};">${column.title} (${column.tasks.length})</h3>`;
                
                column.tasks.forEach(task => {
                    const project = data.projects.find(p => p.id === task.projectId);
                    html += `<div style="padding: 10px; margin: 8px 0; background: var(--bg-color); border-radius: 8px; border-left: 3px solid ${column.color};">
                        <div style="font-weight: 500;">${task.name}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                            ${project ? project.name : 'No Project'} • ${task.dueDate}
                        </div>
                        <button class="btn btn-secondary" onclick="editTask(${task.id})" style="margin-top: 8px; padding: 4px 8px; font-size: 11px;">✏️ Edit</button>
                    </div>`;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderProjects(container) {
            if (data.projects.length === 0) {
                container.innerHTML = '<div class="empty-state">No projects yet. Click + to create one!</div>';
                return;
            }
            
            let html = '';
            data.projects.forEach(project => {
                const tasks = data.tasks.filter(t => t.projectId === project.id);
                const transactions = data.transactions.filter(t => t.projectId === project.id);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                html += `<div class="project-card">
                    <div class="project-header">
                        <h3>${project.name} ${project.locked ? '🔒' : ''}</h3>
                        <p style="font-size: 11px;">Client: ${project.client}</p>
                        <div style="display: flex; gap: 5px; margin-top: 8px;">
                            <button class="action-btn" onclick="editProject(${project.id})" ${project.locked ? 'disabled' : ''}>Edit</button>
                            <button class="action-btn" onclick="toggleProjectLock(${project.id})">${project.locked ? 'Unlock' : 'Lock'}</button>
                            <button class="action-btn" onclick="permanentDeleteProject(${project.id})">Delete</button>
                        </div>
                    </div>
                    <div style="padding: 12px;">
                        <h4 style="font-size: 13px;">📋 Tasks (${tasks.length})</h4>
                        ${tasks.map(t => `<div class="task-item">
                            <div style="flex: 1;">${t.name} - ${t.status}</div>
                            <button class="icon-btn" onclick="editTask(${t.id})">✏️</button>
                        </div>`).join('')}
                        <button class="btn btn-primary" onclick="showTaskModal(); document.getElementById('taskProject').value = ${project.id};" style="margin-top: 10px; width: 100%;">+ Add Task</button>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function renderSchedule(container) {
            const html = '<div class="gantt-container"><h3>📊 18-Month Project Timeline</h3><p>Schedule view coming here...</p></div>';
            container.innerHTML = html;
        }

        function renderCalendar(container) {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let html = `<div class="calendar-container">
                <div class="calendar-header">
                    <h3>${today.toLocaleDateString('en', { month: 'long', year: 'numeric' })}</h3>
                    <button class="sync-calendar-btn" onclick="syncToiPhoneCalendar()">📱 Sync to iPhone</button>
                </div>
                <div class="calendar-grid">
                    <div style="font-weight: bold;">Sun</div>
                    <div style="font-weight: bold;">Mon</div>
                    <div style="font-weight: bold;">Tue</div>
                    <div style="font-weight: bold;">Wed</div>
                    <div style="font-weight: bold;">Thu</div>
                    <div style="font-weight: bold;">Fri</div>
                    <div style="font-weight: bold;">Sat</div>`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const isToday = date.toDateString() === today.toDateString();
                html += `<div class="calendar-day ${isToday ? 'today' : ''}">${day}</div>`;
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function analyzeSchedule() {
            return {
                availableDates: [],
                overwhelmingDates: [],
                suggestedBreaks: [],
                stats: {}
            };
        }

        function syncToiPhoneCalendar() {
            showToast('📱 Calendar sync feature - export ICS file here');
        }

        function showProfileModal() {
            document.getElementById('profileName').value = data.currentUser;
            document.getElementById('profilePosition').value = data.userPosition;
            document.getElementById('profileModal').classList.add('show');
        }

        function saveProfile() {
            data.currentUser = document.getElementById('profileName').value || 'Builder Pro';
            data.userPosition = document.getElementById('profilePosition').value || 'by REFIT Interior';
            updateHeader();
            saveData();
            closeModal('profileModal');
            showToast('Profile updated');
        }

        function showProjectModal() {
            editingId = null;
            document.getElementById('projectModalTitle').textContent = 'New Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectClient').value = '';
            document.getElementById('projectStart').value = '';
            document.getElementById('projectEnd').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectModal').classList.add('show');
            toggleFabMenu();
        }

        function editProject(id) {
            const project = data.projects.find(p => p.id === id);
            if (!project || project.locked) return;
            
            editingId = id;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectClient').value = project.client;
            document.getElementById('projectStart').value = project.startDate || '';
            document.getElementById('projectEnd').value = project.endDate || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectModal').classList.add('show');
        }

        function saveProject() {
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                client: document.getElementById('projectClient').value.trim(),
                startDate: document.getElementById('projectStart').value,
                endDate: document.getElementById('projectEnd').value,
                description: document.getElementById('projectDescription').value.trim(),
                locked: document.getElementById('projectLocked').checked
            };
            
            if (!projectData.name || !projectData.client) {
                showToast('Please fill required fields');
                return;
            }
            
            if (editingId) {
                const index = data.projects.findIndex(p => p.id === editingId);
                data.projects[index] = addTimestamps({ ...data.projects[index], ...projectData }, false);
                showToast('Project updated');
            } else {
                projectData.id = Date.now();
                data.projects.push(addTimestamps(projectData, true));
                showToast('Project created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('projectModal');
        }

        function permanentDeleteProject(id) {
            const project = data.projects.find(p => p.id === id);
            if (!project) return;
            
            if (confirm(`⚠️ Permanently delete project "${project.name}"?`)) {
                data.projects = data.projects.filter(p => p.id !== id);
                data.tasks = data.tasks.filter(t => t.projectId !== id);
                data.transactions = data.transactions.filter(t => t.projectId !== id);
                saveData();
                renderView();
                updateStats();
                showToast('Project deleted');
            }
        }

        function toggleProjectLock(id) {
            const project = data.projects.find(p => p.id === id);
            if (project) {
                project.locked = !project.locked;
                saveData();
                renderView();
                showToast(project.locked ? 'Project locked' : 'Project unlocked');
            }
        }

        function showProjectDetail(projectId) {
            showToast('Project details modal');
        }

        function showTaskModal() {
            editingId = null;
            document.getElementById('taskModalTitle').textContent = 'New Task';
            document.getElementById('taskName').value = '';
            document.getElementById('taskDue').value = '';
            
            const select = document.getElementById('taskProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            document.getElementById('taskModal').classList.add('show');
            toggleFabMenu();
        }

        function editTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (!task) return;
            
            editingId = id;
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskDue').value = task.dueDate;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskAssignee').value = task.assignee || '';
            
            const select = document.getElementById('taskProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            select.value = task.projectId;
            
            document.getElementById('taskModal').classList.add('show');
        }

        function saveTask() {
            const taskData = {
                name: document.getElementById('taskName').value.trim(),
                projectId: parseInt(document.getElementById('taskProject').value),
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                dueDate: document.getElementById('taskDue').value,
                assignee: document.getElementById('taskAssignee').value.trim()
            };
            
            if (!taskData.name || !taskData.projectId || !taskData.dueDate) {
                showToast('Please fill required fields');
                return;
            }
            
            if (editingId) {
                const index = data.tasks.findIndex(t => t.id === editingId);
                data.tasks[index] = addTimestamps({ ...data.tasks[index], ...taskData }, false);
                showToast('Task updated');
            } else {
                taskData.id = Date.now();
                data.tasks.push(addTimestamps(taskData, true));
                showToast('Task created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('taskModal');
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                data.tasks = data.tasks.filter(t => t.id !== id);
                saveData();
                renderView();
                updateStats();
                showToast('Task deleted');
            }
        }

        function completeTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (task) {
                task.status = 'Completed';
                saveData();
                renderView();
                showToast('✅ Task completed');
            }
        }

        function showTransactionModal(type) {
            editingId = null;
            document.getElementById('transactionModalTitle').textContent = type === 'income' ? 'Add Income' : 'Add Expense';
            document.getElementById('transType').value = type;
            document.getElementById('transAmount').value = '';
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            
            const select = document.getElementById('transProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            updateCategories();
            document.getElementById('transactionModal').classList.add('show');
            toggleFabMenu();
        }

        function updateCategories() {
            const type = document.getElementById('transType').value;
            const categories = type === 'expense' ? 
                ['Materials', 'Labor', 'Equipment', 'Transport', 'Other'] : 
                ['Payment', 'Deposit', 'Final Payment', 'Other'];
            
            const select = document.getElementById('transCategory');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function saveTransaction() {
            const transData = {
                type: document.getElementById('transType').value,
                projectId: parseInt(document.getElementById('transProject').value),
                category: document.getElementById('transCategory').value,
                amount: parseFloat(document.getElementById('transAmount').value),
                date: document.getElementById('transDate').value,
                description: document.getElementById('transDescription').value.trim()
            };
            
            if (!transData.projectId || !transData.category || !transData.amount) {
                showToast('Please fill all fields');
                return;
            }
            
            if (editingId) {
                const index = data.transactions.findIndex(t => t.id === editingId);
                data.transactions[index] = addTimestamps({ ...data.transactions[index], ...transData }, false);
                showToast('Transaction updated');
            } else {
                transData.id = Date.now();
                data.transactions.push(addTimestamps(transData, true));
                showToast('Transaction added');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('transactionModal');
        }

        function updateStats() {
            document.getElementById('totalProjects').textContent = data.projects.length;
            document.getElementById('totalTasks').textContent = data.tasks.length;
            
            const income = data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('totalIncome').textContent = ' + income.toFixed(0);
            document.getElementById('totalExpenses').textContent = ' + expenses.toFixed(0);
        }

        function initAutoSync() {
            const savedAutoSync = localStorage.getItem('autoSyncEnabled');
            if (savedAutoSync === 'true' && syncApiKey) {
                autoSyncEnabled = true;
                document.getElementById('autoSyncToggle').checked = true;
                startAutoSync();
            }
        }

        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
            
            if (autoSyncEnabled) {
                startAutoSync();
                showToast('Auto-sync enabled');
            } else {
                stopAutoSync();
                showToast('Auto-sync disabled');
            }
        }

        function startAutoSync() {
            stopAutoSync();
            if (syncApiKey && autoSyncEnabled) {
                autoSyncInterval = setInterval(() => {
                    smartSync();
                }, 5 * 60 * 1000);
            }
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }

        function initializeLastSync() {
            const lastSyncTime = localStorage.getItem('lastSyncTime');
            if (lastSyncTime) {
                const date = new Date(parseInt(lastSyncTime));
                document.getElementById('lastSyncTime').textContent = `Last: ${date.toLocaleTimeString()}`;
            }
            
            if (syncApiKey) {
                document.getElementById('syncMode').textContent = 'Ready';
            }
        }

        async function smartSync() {
            if (!syncApiKey) {
                showToast('⚠️ No API key! Go to Settings', 6000);
                return;
            }
            
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.add('syncing');
            
            try {
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': syncApiKey
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    localStorage.setItem('lastSyncTime', Date.now().toString());
                    showToast('✅ Synced successfully!');
                    document.getElementById('syncMode').textContent = 'Connected';
                } else {
                    throw new Error('Sync failed');
                }
            } catch (error) {
                showToast('❌ Sync failed');
                document.getElementById('syncMode').textContent = 'Error';
            } finally {
                indicator.classList.remove('syncing');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('✅ API key saved!');
        }

        async function testSync() {
            if (!syncApiKey) {
                showToast('⚠️ No API key set!');
                return;
            }
            
            try {
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: { 'X-Master-Key': syncApiKey }
                });
                
                if (response.ok) {
                    showToast('✅ Connection works!');
                    document.getElementById('syncMode').textContent = 'Connected';
                } else {
                    showToast('❌ Invalid API key');
                }
            } catch (error) {
                showToast('❌ Connection failed');
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
