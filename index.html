<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="format-detection" content="telephone=no">
    
    <title>Builder Pro - Optimized</title>
    
    <style>
        :root {
            --safe-area-top: env(safe-area-inset-top, 0);
            --safe-area-bottom: env(safe-area-inset-bottom, 0);
            --bg: #F4EDEB;
            --accent: #E8A9B3;
            --highlight: #D47C90;
            --text: #1C1C1C;
            --card: #fff;
            --text-secondary: #5a5a5a;
            --border: #e8e8e8;
            --shadow: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --btn-primary: #4B2B1A;
            --btn-primary-hover: #6B4332;
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        .night-mode { 
            --bg: #1a1618 !important; 
            --card: #2d2729 !important; 
            --text: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border: #4a4246 !important; 
            --shadow: rgba(0,0,0,0.3) !important;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: background 0.3s, color 0.3s; 
            font-size: calc(14px * var(--font-scale));
            filter: contrast(var(--contrast)) brightness(var(--brightness));
        }
        
        /* Contrast & Saturation Classes */
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }
        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }
        
        .app { max-width: 100vw; min-height: 100vh; display: flex; flex-direction: column; padding: 0 env(safe-area-inset-right) 0 env(safe-area-inset-left); }
        
        /* Header */
        .header-fixed { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: var(--bg); padding-top: var(--safe-area-top); }
        .header { background: linear-gradient(135deg, var(--accent) 0%, var(--highlight) 100%); color: white; padding: 10px 12px; box-shadow: 0 2px 10px var(--shadow); }
        .header-content { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
        .header h1 { font-size: calc(16px * var(--font-scale)); font-weight: 600; }
        .header-subtitle { font-size: calc(11px * var(--font-scale)); opacity: 0.9; margin-top: 2px; }
        .header-controls { display: flex; gap: 8px; }
        .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: calc(14px * var(--font-scale)); display: flex; align-items: center; justify-content: center; position: relative; transition: background 0.2s; }
        .header-btn:active { background: rgba(255,255,255,0.3); }
        .sync-indicator { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; border-radius: 50%; background: var(--success); border: 2px solid white; }
        .sync-indicator.syncing { background: var(--warning); animation: pulse 1s infinite; }
        #alertBadge { 
            background: var(--danger) !important; 
            width: 18px !important; 
            height: 18px !important; 
            font-size: 10px !important; 
            font-weight: bold !important; 
            display: flex !important; 
            align-items: center !important; 
            justify-content: center !important;
            animation: alertPulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes alertPulse { 
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); 
            } 
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); 
            } 
        }
        .sync-status { background: var(--btn-primary); color: white; padding: 4px 10px; font-size: calc(11px * var(--font-scale)); text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        /* Tabs */
        .tabs { background: var(--card); display: flex; border-bottom: 2px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { flex: 1; min-width: 80px; padding: 10px 8px; text-align: center; cursor: pointer; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; font-size: calc(12px * var(--font-scale)); transition: all 0.2s; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; background: var(--bg); }
        .stat-card { background: var(--card); padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px var(--shadow); text-align: center; }
        .stat-card h3 { font-size: calc(16px * var(--font-scale)); color: var(--accent); margin-bottom: 2px; font-weight: 700; }
        .stat-card.income h3 { color: var(--success); }
        .stat-card.expense h3 { color: var(--danger); }
        .stat-card p { color: var(--text-secondary); font-size: calc(11px * var(--font-scale)); }
        
        /* Main Content */
        .main { margin-top: 200px; flex: 1; padding: 10px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        @media (max-width: 768px) { .main { margin-top: 210px; } }
        
        /* Cards */
        .card { background: var(--card); border-radius: 12px; box-shadow: 0 2px 10px var(--shadow); margin-bottom: 12px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--accent) 0%, var(--highlight) 100%); color: white; padding: 12px; transition: all 0.2s; }
        .card-header:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: calc(13px * var(--font-scale)); cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--btn-primary); color: white; }
        .btn-primary:hover { background: var(--btn-primary-hover); }
        .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* FAB */
        .fab-container { position: fixed; bottom: calc(20px + var(--safe-area-bottom)); right: 20px; z-index: 99; }
        .fab { width: 50px; height: 50px; border-radius: 50%; background: var(--btn-primary); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px var(--shadow); transition: all 0.2s; font-weight: bold; }
        .fab:hover { background: var(--btn-primary-hover); transform: scale(1.05); }
        .fab-menu { position: absolute; bottom: 60px; right: 0; display: none; flex-direction: column; gap: 8px; }
        .fab-menu.show { display: flex; }
        .fab-option { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card); color: var(--text); border-radius: 8px; box-shadow: 0 2px 10px var(--shadow); cursor: pointer; white-space: nowrap; font-size: calc(12px * var(--font-scale)); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: var(--card); border-radius: 12px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; }
        .modal-footer { padding: 12px 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
        
        /* Form */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: calc(12px * var(--font-scale)); color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: calc(13px * var(--font-scale)); background: var(--bg); color: var(--text); }
        
        /* Toast */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--card); color: var(--text); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
        
        /* Settings Panel */
        .settings-panel { position: fixed; top: 0; right: -100%; width: 90%; max-width: 400px; height: 100vh; background: var(--card); box-shadow: -2px 0 10px rgba(0,0,0,0.2); transition: right 0.3s; z-index: 1001; overflow-y: auto; padding: 20px; padding-top: calc(20px + var(--safe-area-top)); padding-bottom: calc(20px + var(--safe-area-bottom)); }
        .settings-panel.show { right: 0; }
        .settings-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
        .settings-backdrop.show { display: block; }
        
        /* Theme Grid */
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; max-height: 400px; overflow-y: auto; padding: 10px; background: var(--bg); border-radius: 8px; }
        .theme-option { padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; background: var(--card); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .theme-option:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .theme-option.active { border-color: var(--btn-primary); transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .theme-preview { height: 50px; border-radius: 6px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .theme-name { font-size: 11px; text-align: center; color: var(--text-secondary); font-weight: 500; }
        
        /* Task Item */
        .task-item { padding: 10px; margin-bottom: 8px; background: var(--bg); border-radius: 8px; border-left: 3px solid var(--accent); display: flex; justify-content: space-between; align-items: start; gap: 10px; }
        .icon-btn { background: var(--accent); border: none; color: white; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-size: calc(12px * var(--font-scale)); display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .icon-btn:hover { transform: scale(1.05); }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn.danger { background: var(--danger); }
        .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Gantt */
        .gantt { background: var(--card); border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px var(--shadow); overflow-x: auto; margin-bottom: 15px; position: relative; }
        .gantt-header { display: flex; border-bottom: 2px solid var(--border); padding-bottom: 8px; margin-bottom: 10px; }
        .gantt-months { margin-left: 150px; display: flex; flex: 1; gap: 2px; }
        .gantt-month { flex: 1; text-align: center; font-size: calc(10px * var(--font-scale)); color: var(--text-secondary); font-weight: 600; padding: 4px; background: var(--bg); border-radius: 4px; }
        .gantt-row { display: flex; align-items: center; margin-bottom: 8px; min-height: 40px; }
        .gantt-label { width: 150px; font-size: calc(11px * var(--font-scale)); font-weight: 500; color: var(--text); padding-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-timeline { flex: 1; position: relative; height: 35px; background: var(--bg); border-radius: 4px; }
        .gantt-bar { position: absolute; height: 100%; background: linear-gradient(135deg, var(--accent) 0%, var(--highlight) 100%); border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 8px; font-size: calc(9px * var(--font-scale)); color: white; font-weight: 500; cursor: pointer; }
        .today-line { position: absolute; top: -10px; bottom: -10px; width: 4px; background: var(--danger); z-index: 10; pointer-events: none; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); }
        .today-line::before { content: 'TODAY'; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4); }
        
        /* Calendar */
        .calendar { background: var(--card); border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px var(--shadow); margin-bottom: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 10px; }
        .calendar-day { aspect-ratio: 1; padding: 5px; border: 1px solid var(--border); background: var(--bg); border-radius: 4px; font-size: calc(10px * var(--font-scale)); position: relative; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background: var(--card); transform: scale(1.05); box-shadow: 0 2px 8px var(--shadow); z-index: 10; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important; color: white !important; font-weight: bold; border: 3px solid #dc2626 !important; box-shadow: 0 0 25px rgba(239, 68, 68, 0.7) !important; animation: todayPulse 2s infinite; transform: scale(1.05); z-index: 20; }
        @keyframes todayPulse { 0%, 100% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 35px rgba(239, 68, 68, 1); } }
        .calendar-event { font-size: calc(8px * var(--font-scale)); padding: 2px; background: var(--accent); color: white; border-radius: 2px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Loading Spinner */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Empty State */
        .empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats { gap: 6px; padding: 8px; }
            .stat-card { padding: 8px; }
            .fab { width: 56px; height: 56px; }
            .theme-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 350px; }
        }
        
        @media (max-width: 400px) {
            .main { margin-top: 260px; }
            .theme-grid { grid-template-columns: 1fr; }
            .gantt-label { width: 100px; font-size: calc(10px * var(--font-scale)); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header-fixed">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="app.showProfile()">
                        <div>
                            <h1 id="headerName">Builder Pro</h1>
                            <div class="header-subtitle" id="headerPosition">by REFIT Interior</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="app.showAlerts()" title="Alerts">
                            🔔
                            <span class="sync-indicator" id="alertBadge" style="background: var(--danger); display: none;">0</span>
                        </button>
                        <button class="header-btn" onclick="app.sync()" title="Smart Sync">
                            🔄
                            <span class="sync-indicator" id="syncIndicator"></span>
                        </button>
                        <button class="header-btn" onclick="app.toggleSettings()" title="Settings">⚙️</button>
                    </div>
                </div>
                <div class="sync-status" id="syncStatus">
                    <span id="deviceType"></span> • 
                    <span id="lastSync" title="Click 🔄 to sync">Never synced</span> • 
                    <span id="syncMode">Offline</span>
                </div>
            </div>
            
            <div class="tabs" id="tabs">
                <div class="tab active" onclick="app.switchView('home')">Home</div>
                <div class="tab" onclick="app.switchView('kanban')">Kanban</div>
                <div class="tab" onclick="app.switchView('projects')">Projects</div>
                <div class="tab" onclick="app.switchView('schedule')">Schedule</div>
                <div class="tab" onclick="app.switchView('calendar')">Calendar</div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalProjects">0</h3>
                    <p>Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTasks">0</h3>
                    <p>Tasks</p>
                </div>
                <div class="stat-card income">
                    <h3 id="totalIncome">$0</h3>
                    <p>Income</p>
                </div>
                <div class="stat-card expense">
                    <h3 id="totalExpenses">$0</h3>
                    <p>Expenses</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main" id="main"></div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-backdrop" id="settingsBackdrop" onclick="app.toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
            <span style="font-size: 1.25rem; font-weight: bold;">⚙️ Settings</span>
            <button style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);" onclick="app.toggleSettings()">✕</button>
        </div>
        
        <!-- API Key -->
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">🔑 Smart Sync API</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="password" id="apiKeyInput" placeholder="JSONBin API Key" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                <button class="btn btn-primary" onclick="app.saveApiKey()">Save</button>
            </div>
            <div style="padding: 8px; background: var(--bg); border-radius: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">
                <strong style="color: var(--text);">🧠 Smart Sync Logic:</strong><br>
                1️⃣ Pull cloud data<br>
                2️⃣ Compare timestamps<br>
                3️⃣ Keep most recent version<br>
                4️⃣ Push merged data back<br>
                <span style="color: var(--accent); font-weight: bold;">✓ Latest edits always win!</span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 8px; background: var(--bg); border-radius: 6px;">
                <span style="font-weight: 500;">⚡ Auto-Sync (every 5 min)</span>
                <input type="checkbox" id="autoSyncToggle" onchange="app.toggleAutoSync()" style="width: 44px; height: 24px;">
            </div>
            <button class="btn btn-primary" onclick="app.sync()" style="width: 100%; margin-bottom: 8px;">🔄 Manual Sync Now</button>
            <button class="btn btn-secondary" onclick="app.testSync()" style="width: 100%;">🔍 Test Connection</button>
        </div>
        
        <!-- Theme -->
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">🎨 Themes</label>
            <div class="theme-grid" id="themeGrid"></div>
        </div>
        
        <!-- Contrast -->
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">⚡ Contrast</label>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                <button class="btn btn-secondary" onclick="app.setContrast('low')">Low</button>
                <button class="btn btn-secondary" onclick="app.setContrast('normal')">Normal</button>
                <button class="btn btn-secondary" onclick="app.setContrast('high')">High</button>
                <button class="btn btn-secondary" onclick="app.setContrast('extra')">Extra</button>
            </div>
        </div>
        
        <!-- Font Size -->
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">🔤 Font Size</label>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <button class="btn btn-secondary" onclick="app.setFontSize('s')">S</button>
                <button class="btn btn-secondary" onclick="app.setFontSize('m')">M</button>
                <button class="btn btn-secondary" onclick="app.setFontSize('l')">L</button>
                <button class="btn btn-secondary" onclick="app.setFontSize('xl')">XL</button>
                <button class="btn btn-secondary" onclick="app.setFontSize('xxl')">XXL</button>
            </div>
        </div>
        
        <!-- Night Mode -->
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 600;">🌙 Night Mode</span>
                <input type="checkbox" id="nightToggle" onchange="app.toggleNight()" style="width: 44px; height: 24px;">
            </div>
        </div>
        
        <!-- Usage Statistics -->
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">📊 Your Usage Stats</label>
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; font-size: 12px; line-height: 1.8; color: var(--text-secondary);" id="usageStats">
                <div><strong style="color: var(--text);">Sessions:</strong> <span id="statSessions">0</span></div>
                <div><strong style="color: var(--text);">Projects Created:</strong> <span id="statProjects">0</span></div>
                <div><strong style="color: var(--text);">Tasks Created:</strong> <span id="statTasks">0</span></div>
                <div><strong style="color: var(--text);">Actions Today:</strong> <span id="statActions">0</span></div>
                <div><strong style="color: var(--text);">Most Used View:</strong> <span id="statTopView">-</span></div>
            </div>
        </div>
        
        <!-- Export/Import -->
        <div>
            <button class="btn btn-primary" onclick="app.exportData()" style="width: 100%;">📤 Export Data</button>
            <label class="btn btn-success" style="display: block; text-align: center; margin-top: 10px; width: 100%;">
                📥 Import Data
                <input type="file" accept=".json" onchange="app.importData(event)" style="display: none;">
            </label>
        </div>
    </div>

    <!-- FAB -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="app.showProjectModal()"><span>📁</span>New Project</div>
            <div class="fab-option" onclick="app.showTaskModal()"><span>📋</span>New Task</div>
            <div class="fab-option" onclick="app.showTransactionModal('income')"><span>💰</span>Add Income</div>
            <div class="fab-option" onclick="app.showTransactionModal('expense')"><span>💸</span>Add Expense</div>
        </div>
        <button class="fab" onclick="app.toggleFab()">+</button>
    </div>

    <!-- Modals -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">New Project</h2>
                <span style="font-size: 24px; cursor: pointer;" onclick="app.closeModal('projectModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" placeholder="Kitchen Renovation">
                </div>
                <div class="form-group">
                    <label>Client Name *</label>
                    <input type="text" id="projectClient" placeholder="John Doe">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStart">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="projectEnd">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription" rows="3"></textarea>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="projectLocked" style="width: 20px; height: 20px;">
                    <label for="projectLocked">🔒 Lock project</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">New Task</h2>
                <span style="font-size: 24px; cursor: pointer;" onclick="app.closeModal('taskModal')">×</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task Name *</label>
                    <input type="text" id="taskName" placeholder="Install cabinets">
                </div>
                <div class="form-group">
                    <label>Project *</label>
                    <select id="taskProject"></select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label>Due Date *</label>
                        <input type="date" id="taskDue">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="taskStatus">
                            <option value="Get Ready">Get Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Worker name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('taskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveTask()">Save</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal" id="alertModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 8px;">
                    <span>🔔</span> 
                    <span>Alerts & Reminders</span>
                    <span id="alertCount" style="background: var(--danger); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">0</span>
                </h2>
                <span style="font-size: 24px; cursor: pointer;" onclick="app.closeModal('alertModal')">×</span>
            </div>
            <div class="modal-body" id="alertBody" style="max-height: 60vh; overflow-y: auto;"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.dismissAllAlerts()">Dismiss All</button>
                <button class="btn btn-primary" onclick="app.closeModal('alertModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // App State Management
        const app = {
            config: {
                binId: '68e121b8ae596e708f05df17',
                baseUrl: 'https://api.jsonbin.io/v3',
                deviceType: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Laptop'
            },
            
            themes: [
                { name: 'Rose Blush', bg: '#F4EDEB', accent: '#E8A9B3', highlight: '#D47C90', text: '#1C1C1C' },
                { name: 'Mocha Cream', bg: '#FFF6F1', accent: '#C9A48F', highlight: '#8A5C4E', text: '#1C1C1C' },
                { name: 'Sand & Coffee', bg: '#F5EFE6', accent: '#A87C5F', highlight: '#6B4C3B', text: '#1C1C1C' },
                { name: 'Soft Plum', bg: '#F8F3F7', accent: '#B08CA5', highlight: '#8B5E83', text: '#1C1C1C' },
                { name: 'Nude Clay', bg: '#EFE5DC', accent: '#D5AA85', highlight: '#9F6B3F', text: '#1C1C1C' },
                { name: 'Charcoal Rose', bg: '#F0E6E9', accent: '#A77E94', highlight: '#7B4C60', text: '#1C1C1C' }
            ],
            
            data: {
                currentUser: 'Builder Pro',
                userPosition: 'by REFIT Interior',
                currentView: 'home',
                projects: [],
                tasks: [],
                transactions: [],
                themeColor: 0,
                fontSize: 'm',
                contrast: 'normal',
                nightMode: false,
                alerts: [],
                dismissedAlerts: [],
                userBehavior: {
                    lastActive: null,
                    totalSessions: 0,
                    viewCounts: { home: 0, kanban: 0, projects: 0, schedule: 0, calendar: 0 },
                    lastSync: null,
                    projectsCreated: 0,
                    tasksCreated: 0,
                    actionsToday: 0,
                    lastActionDate: null
                }
            },
            
            editingId: null,
            editingType: null,
            apiKey: '',
            autoSyncInterval: null,
            autoSyncEnabled: false,
            alertCheckInterval: null,
            
            // Initialize
            init() {
                this.loadData();
                this.applySettings();
                this.updateStats();
                this.render();
                this.initAutoSync();
                this.initBehaviorTracking();
                this.startAlertChecking();
                document.getElementById('deviceType').textContent = this.config.deviceType;
                
                // Cache DOM elements
                this.dom = {
                    main: document.getElementById('main'),
                    toast: document.getElementById('toast'),
                    syncIndicator: document.getElementById('syncIndicator'),
                    syncMode: document.getElementById('syncMode'),
                    lastSync: document.getElementById('lastSync'),
                    alertBadge: document.getElementById('alertBadge')
                };
                
                // Welcome message
                if (this.data.projects.length === 0 && this.data.tasks.length === 0) {
                    setTimeout(() => this.toast('👋 Welcome to Builder Pro! Press + to start'), 1000);
                }
                
                // Check for important alerts after 2 seconds
                setTimeout(() => this.checkAndShowAlerts(), 2000);
            },
            
            // Data Management
            loadData() {
                const saved = localStorage.getItem('builderProData');
                if (saved) {
                    Object.assign(this.data, JSON.parse(saved));
                }
                
                // Initialize arrays if they don't exist
                if (!this.data.alerts) this.data.alerts = [];
                if (!this.data.dismissedAlerts) this.data.dismissedAlerts = [];
                if (!this.data.userBehavior) {
                    this.data.userBehavior = {
                        lastActive: null,
                        totalSessions: 0,
                        viewCounts: { home: 0, kanban: 0, projects: 0, schedule: 0, calendar: 0 },
                        lastSync: null,
                        projectsCreated: 0,
                        tasksCreated: 0,
                        actionsToday: 0,
                        lastActionDate: null
                    };
                }
                
                this.apiKey = localStorage.getItem('builderProApiKey') || '';
                this.autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
                this.updateSyncStatus();
            },
            
            saveData() {
                this.data.lastUpdated = new Date().toISOString();
                localStorage.setItem('builderProData', JSON.stringify(this.data));
            },
            
            // UI Updates
            updateStats() {
                document.getElementById('totalProjects').textContent = this.data.projects.length;
                document.getElementById('totalTasks').textContent = this.data.tasks.length;
                
                const income = this.data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = this.data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                document.getElementById('totalIncome').textContent = '$' + income.toFixed(0);
                document.getElementById('totalExpenses').textContent = '$' + expenses.toFixed(0);
            },
            
            updateSyncStatus() {
                const lastSyncTime = localStorage.getItem('lastSyncTime');
                if (lastSyncTime) {
                    const date = new Date(parseInt(lastSyncTime));
                    this.dom.lastSync.textContent = `Last: ${date.toLocaleTimeString()}`;
                }
                this.dom.syncMode.textContent = this.apiKey ? 'Ready' : 'No API key';
            },
            
            // View Management
            switchView(view) {
                this.data.currentView = view;
                this.trackAction('view_changed', { view: view });
                document.querySelectorAll('.tab').forEach((tab, i) => {
                    tab.classList.toggle('active', ['home','kanban','projects','schedule','calendar'][i] === view);
                });
                this.render();
            },
            
            render() {
                switch(this.data.currentView) {
                    case 'home': this.renderHome(); break;
                    case 'kanban': this.renderKanban(); break;
                    case 'projects': this.renderProjects(); break;
                    case 'schedule': this.renderSchedule(); break;
                    case 'calendar': this.renderCalendar(); break;
                }
            },
            
            renderHome() {
                const income = this.data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = this.data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                this.dom.main.innerHTML = `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="padding: 15px;">
                            <h3 style="font-size: 14px; margin-bottom: 12px;">💰 Finance Summary</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Income</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--success);">$${income.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Expenses</div>
                                    <div style="font-size: 18px; font-weight: bold; color: var(--danger);">$${expenses.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Profit</div>
                                    <div style="font-size: 18px; font-weight: bold; color: ${income - expenses >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        $${(income - expenses).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${this.data.projects.length > 0 ? this.renderTimeline() : '<div class="empty">No projects yet. Click + to get started!</div>'}
                `;
            },
            
            renderTimeline() {
                const projectsWithDates = this.data.projects.filter(p => p.startDate && p.endDate);
                if (projectsWithDates.length === 0) {
                    return '<div class="empty">No project dates set. Add dates to see timeline!</div>';
                }
                
                let minDate = new Date(Math.min(...projectsWithDates.map(p => new Date(p.startDate))));
                let maxDate = new Date(Math.max(...projectsWithDates.map(p => new Date(p.endDate))));
                minDate.setDate(minDate.getDate() - 3);
                maxDate.setDate(maxDate.getDate() + 3);
                
                const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let html = '<div class="gantt"><h3 style="font-size: 14px; margin-bottom: 15px;">📅 Project Timeline</h3>';
                
                if (today >= minDate && today <= maxDate) {
                    const todayOffset = Math.ceil((today - minDate) / (1000 * 60 * 60 * 24));
                    const todayPosition = (todayOffset / totalDays) * 100;
                    html += `<div class="today-line" style="left: calc(150px + ${todayPosition}%);"></div>`;
                }
                
                projectsWithDates.forEach(project => {
                    const start = new Date(project.startDate);
                    const end = new Date(project.endDate);
                    const startOffset = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
                    const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    const width = (duration / totalDays) * 100;
                    const left = (startOffset / totalDays) * 100;
                    
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-label">${project.name} ${project.locked ? '🔒' : ''}</div>
                            <div class="gantt-timeline">
                                <div class="gantt-bar" style="left: ${left}%; width: ${width}%;">
                                    <div style="font-weight: 600;">${duration}d</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            },
            
            renderKanban() {
                this.dom.main.innerHTML = '<div class="empty">Kanban view - Coming soon!</div>';
            },
            
            renderProjects() {
                if (this.data.projects.length === 0) {
                    this.dom.main.innerHTML = '<div class="empty">No projects yet. Click + to create one!</div>';
                    return;
                }
                
                let html = '';
                this.data.projects.forEach(project => {
                    const tasks = this.data.tasks.filter(t => t.projectId === project.id);
                    const trans = this.data.transactions.filter(t => t.projectId === project.id);
                    const income = trans.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const expenses = trans.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h3>${project.name} ${project.locked ? '🔒' : ''}</h3>
                                        <div style="font-size: 11px; opacity: 0.9;">Client: ${project.client}</div>
                                    </div>
                                    <button class="btn btn-secondary" onclick="app.editProject(${project.id})" style="color: white; background: rgba(255,255,255,0.2);">
                                        ${project.locked ? '🔒' : '✏️'}
                                    </button>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; background: rgba(0,0,0,0.1); margin-top: 8px; border-radius: 8px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 9px; opacity: 0.8;">Tasks</div>
                                        <div style="font-size: 13px; font-weight: bold;">${tasks.length}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 9px; opacity: 0.8;">Income</div>
                                        <div style="font-size: 13px; font-weight: bold; color: #4ade80;">${income.toFixed(0)}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 9px; opacity: 0.8;">Profit</div>
                                        <div style="font-size: 13px; font-weight: bold; color: ${income - expenses >= 0 ? '#4ade80' : '#f87171'};">
                                            ${(income - expenses).toFixed(0)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                this.dom.main.innerHTML = html;
            },
            
            renderSchedule() {
                this.dom.main.innerHTML = '<div class="empty">Schedule view - Coming soon!</div>';
            },
            
            renderCalendar() {
                this.dom.main.innerHTML = '<div class="empty">Calendar view - Coming soon!</div>';
            },
            
            // Settings
            applySettings() {
                if (this.data.nightMode) {
                    document.body.classList.add('night-mode');
                    document.getElementById('nightToggle').checked = true;
                }
                this.applyTheme(this.data.themeColor);
                this.setFontSize(this.data.fontSize);
                this.setContrast(this.data.contrast);
            },
            
            applyTheme(index) {
                const theme = this.themes[index];
                if (!document.body.classList.contains('night-mode')) {
                    document.documentElement.style.setProperty('--bg', theme.bg);
                    document.documentElement.style.setProperty('--text', theme.text);
                }
                document.documentElement.style.setProperty('--accent', theme.accent);
                document.documentElement.style.setProperty('--highlight', theme.highlight);
                document.querySelector('meta[name="theme-color"]').content = theme.accent;
            },
            
            setFontSize(size) {
                document.body.className = document.body.className.replace(/font-\w+/g, '');
                document.body.classList.add('font-' + size);
                this.data.fontSize = size;
                this.saveData();
            },
            
            setContrast(level) {
                document.body.className = document.body.className.replace(/\w+-contrast/g, '');
                document.body.classList.add(level + '-contrast');
                this.data.contrast = level;
                this.saveData();
            },
            
            toggleNight() {
                document.body.classList.toggle('night-mode');
                this.data.nightMode = document.body.classList.contains('night-mode');
                this.saveData();
                this.applyTheme(this.data.themeColor);
            },
            
            toggleSettings() {
                const panel = document.getElementById('settingsPanel');
                const backdrop = document.getElementById('settingsBackdrop');
                const isShow = panel.classList.toggle('show');
                backdrop.classList.toggle('show', isShow);
                document.body.style.overflow = isShow ? 'hidden' : '';
                
                if (isShow) {
                    this.initThemePicker();
                    // Update auto-sync toggle state
                    document.getElementById('autoSyncToggle').checked = this.autoSyncEnabled;
                    // Update usage statistics
                    this.updateUsageStats();
                }
            },
            
            updateUsageStats() {
                document.getElementById('statSessions').textContent = this.data.userBehavior.totalSessions || 0;
                document.getElementById('statProjects').textContent = this.data.userBehavior.projectsCreated || 0;
                document.getElementById('statTasks').textContent = this.data.userBehavior.tasksCreated || 0;
                document.getElementById('statActions').textContent = this.data.userBehavior.actionsToday || 0;
                
                // Find most used view
                const views = this.data.userBehavior.viewCounts || {};
                let topView = 'home';
                let maxCount = 0;
                
                Object.entries(views).forEach(([view, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        topView = view;
                    }
                });
                
                const viewNames = {
                    home: 'Home',
                    kanban: 'Kanban',
                    projects: 'Projects',
                    schedule: 'Schedule',
                    calendar: 'Calendar'
                };
                
                document.getElementById('statTopView').textContent = `${viewNames[topView]} (${maxCount}x)`;
            },
            
            initThemePicker() {
                const grid = document.getElementById('themeGrid');
                grid.innerHTML = '';
                
                this.themes.forEach((theme, index) => {
                    const div = document.createElement('div');
                    div.className = 'theme-option' + (index === this.data.themeColor ? ' active' : '');
                    div.innerHTML = `
                        <div class="theme-preview" style="background: linear-gradient(135deg, ${theme.accent} 0%, ${theme.highlight} 100%);">Aa</div>
                        <div class="theme-name">${theme.name}</div>
                    `;
                    div.onclick = () => {
                        this.data.themeColor = index;
                        this.applyTheme(index);
                        this.saveData();
                        document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        this.toast('Theme updated: ' + theme.name);
                    };
                    grid.appendChild(div);
                });
            },
            
            // Modals
            showProjectModal() {
                this.editingId = null;
                this.editingType = 'project';
                document.getElementById('projectModalTitle').textContent = 'New Project';
                document.getElementById('projectName').value = '';
                document.getElementById('projectClient').value = '';
                document.getElementById('projectStart').value = '';
                document.getElementById('projectEnd').value = '';
                document.getElementById('projectDescription').value = '';
                document.getElementById('projectLocked').checked = false;
                document.getElementById('projectModal').classList.add('show');
                this.toggleFab();
            },
            
            editProject(id) {
                const project = this.data.projects.find(p => p.id === id);
                if (!project || project.locked) return;
                
                this.editingId = id;
                this.editingType = 'project';
                document.getElementById('projectModalTitle').textContent = 'Edit Project';
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectClient').value = project.client;
                document.getElementById('projectStart').value = project.startDate || '';
                document.getElementById('projectEnd').value = project.endDate || '';
                document.getElementById('projectDescription').value = project.description || '';
                document.getElementById('projectLocked').checked = project.locked || false;
                document.getElementById('projectModal').classList.add('show');
            },
            
            saveProject() {
                const data = {
                    name: document.getElementById('projectName').value.trim(),
                    client: document.getElementById('projectClient').value.trim(),
                    startDate: document.getElementById('projectStart').value,
                    endDate: document.getElementById('projectEnd').value,
                    description: document.getElementById('projectDescription').value.trim(),
                    locked: document.getElementById('projectLocked').checked
                };
                
                if (!data.name || !data.client) {
                    this.toast('Please fill required fields');
                    return;
                }
                
                if (this.editingId) {
                    const index = this.data.projects.findIndex(p => p.id === this.editingId);
                    this.data.projects[index] = { ...this.data.projects[index], ...data, updated_at: new Date().toISOString() };
                    this.trackAction('project_updated', { projectId: this.editingId, name: data.name });
                    this.toast('Project updated');
                } else {
                    data.id = Date.now();
                    data.created_at = new Date().toISOString();
                    this.data.projects.push(data);
                    this.trackAction('project_created', { projectId: data.id, name: data.name });
                    this.toast('Project created');
                }
                
                this.saveData();
                this.updateStats();
                this.render();
                this.closeModal('projectModal');
                this.checkAndShowAlerts();
            },
            
            showTaskModal() {
                this.editingId = null;
                this.editingType = 'task';
                document.getElementById('taskModalTitle').textContent = 'New Task';
                document.getElementById('taskName').value = '';
                document.getElementById('taskPriority').value = 'Medium';
                document.getElementById('taskStatus').value = 'Get Ready';
                document.getElementById('taskStart').value = '';
                document.getElementById('taskDue').value = '';
                document.getElementById('taskAssignee').value = '';
                
                const select = document.getElementById('taskProject');
                select.innerHTML = '<option value="">Select Project</option>';
                this.data.projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
                
                document.getElementById('taskModal').classList.add('show');
                if (this.data.currentView !== 'projects' && this.data.currentView !== 'schedule') {
                    this.toggleFab();
                }
            },
            
            saveTask() {
                const data = {
                    name: document.getElementById('taskName').value.trim(),
                    projectId: parseInt(document.getElementById('taskProject').value),
                    priority: document.getElementById('taskPriority').value,
                    status: document.getElementById('taskStatus').value,
                    startDate: document.getElementById('taskStart').value,
                    dueDate: document.getElementById('taskDue').value,
                    assignee: document.getElementById('taskAssignee').value.trim()
                };
                
                if (!data.name || !data.projectId || !data.dueDate) {
                    this.toast('Please fill required fields');
                    return;
                }
                
                if (this.editingId) {
                    const index = this.data.tasks.findIndex(t => t.id === this.editingId);
                    this.data.tasks[index] = { ...this.data.tasks[index], ...data, updated_at: new Date().toISOString() };
                    this.trackAction('task_updated', { taskId: this.editingId, name: data.name });
                    this.toast('Task updated');
                } else {
                    data.id = Date.now();
                    data.created_at = new Date().toISOString();
                    this.data.tasks.push(data);
                    this.trackAction('task_created', { taskId: data.id, name: data.name });
                    this.toast('Task created');
                }
                
                this.saveData();
                this.updateStats();
                this.render();
                this.closeModal('taskModal');
                this.checkAndShowAlerts();
            },
            
            showTransactionModal(type) {
                this.toast(`${type} modal - Coming soon!`);
            },
            
            showProfile() {
                this.toast('Profile modal - Coming soon!');
            },
            
            closeModal(id) {
                document.getElementById(id).classList.remove('show');
            },
            
            toggleFab() {
                document.getElementById('fabMenu').classList.toggle('show');
            },
            
            // Sync
            async sync() {
                if (!this.apiKey) {
                    this.toast('⚠️ No API key! Go to Settings → Smart Sync API', 5000);
                    this.dom.syncMode.textContent = 'No API key';
                    return;
                }
                
                this.dom.syncIndicator.classList.add('syncing');
                this.dom.syncMode.textContent = 'Syncing...';
                const startTime = Date.now();
                
                try {
                    // STEP 1: Pull cloud data
                    console.log('🔄 Step 1: Pulling cloud data...');
                    this.dom.syncMode.textContent = 'Pulling...';
                    
                    const getResponse = await fetch(`${this.config.baseUrl}/b/${this.config.binId}/latest`, {
                        headers: { 'X-Master-Key': this.apiKey }
                    });
                    
                    if (!getResponse.ok) {
                        throw new Error(`Pull failed: ${getResponse.status}`);
                    }
                    
                    const result = await getResponse.json();
                    const cloudData = result.record || {};
                    
                    console.log('✅ Cloud data pulled:', {
                        projects: cloudData.projects?.length || 0,
                        tasks: cloudData.tasks?.length || 0,
                        transactions: cloudData.transactions?.length || 0
                    });
                    
                    // STEP 2: Merge data by timestamp
                    console.log('🔄 Step 2: Merging data...');
                    this.dom.syncMode.textContent = 'Merging...';
                    
                    const beforeCounts = {
                        projects: this.data.projects.length,
                        tasks: this.data.tasks.length,
                        transactions: this.data.transactions.length
                    };
                    
                    if (cloudData.projects) {
                        this.data.projects = this.mergeByTimestamp(this.data.projects || [], cloudData.projects || []);
                        this.data.tasks = this.mergeByTimestamp(this.data.tasks || [], cloudData.tasks || []);
                        this.data.transactions = this.mergeByTimestamp(this.data.transactions || [], cloudData.transactions || []);
                        
                        // Preserve other settings from cloud if they exist
                        if (cloudData.currentUser) this.data.currentUser = cloudData.currentUser;
                        if (cloudData.userPosition) this.data.userPosition = cloudData.userPosition;
                    }
                    
                    const afterCounts = {
                        projects: this.data.projects.length,
                        tasks: this.data.tasks.length,
                        transactions: this.data.transactions.length
                    };
                    
                    // Show what changed
                    const changes = [];
                    if (afterCounts.projects !== beforeCounts.projects) {
                        changes.push(`${afterCounts.projects - beforeCounts.projects > 0 ? '+' : ''}${afterCounts.projects - beforeCounts.projects}p`);
                    }
                    if (afterCounts.tasks !== beforeCounts.tasks) {
                        changes.push(`${afterCounts.tasks - beforeCounts.tasks > 0 ? '+' : ''}${afterCounts.tasks - beforeCounts.tasks}t`);
                    }
                    if (afterCounts.transactions !== beforeCounts.transactions) {
                        changes.push(`${afterCounts.transactions - beforeCounts.transactions > 0 ? '+' : ''}${afterCounts.transactions - beforeCounts.transactions}tr`);
                    }
                    
                    console.log('✅ Merge complete:', changes.length > 0 ? changes.join(', ') : 'No changes');
                    
                    this.saveData();
                    this.updateStats();
                    this.render();
                    
                    // STEP 3: Push merged data back to cloud
                    console.log('🔄 Step 3: Pushing merged data...');
                    this.dom.syncMode.textContent = 'Pushing...';
                    
                    const putResponse = await fetch(`${this.config.baseUrl}/b/${this.config.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.apiKey
                        },
                        body: JSON.stringify(this.data)
                    });
                    
                    if (!putResponse.ok) {
                        throw new Error(`Push failed: ${putResponse.status}`);
                    }
                    
                    const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                    console.log(`✅ Sync complete in ${syncDuration}s`);
                    
                    localStorage.setItem('lastSyncTime', Date.now().toString());
                    this.updateSyncStatus();
                    
                    const msg = changes.length > 0 
                        ? `✅ Synced ${this.data.projects.length}p ${this.data.tasks.length}t (${changes.join(', ')}) in ${syncDuration}s`
                        : `✅ Synced ${this.data.projects.length}p ${this.data.tasks.length}t in ${syncDuration}s`;
                    
                    this.toast(msg, 5000);
                    this.dom.syncIndicator.classList.remove('syncing');
                    this.dom.syncMode.textContent = 'Connected';
                    
                } catch (error) {
                    const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                    console.error('❌ Sync error:', error);
                    
                    let errorMsg = error.message;
                    if (error.message.includes('401')) {
                        errorMsg = 'Invalid API key! Check Settings';
                    } else if (error.message.includes('404')) {
                        errorMsg = 'Bin not found!';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMsg = 'No internet connection!';
                    }
                    
                    this.toast(`❌ ${errorMsg}`, 6000);
                    this.dom.syncIndicator.classList.remove('syncing');
                    this.dom.syncMode.textContent = 'Error';
                    
                    console.log('Sync diagnostics:', {
                        duration: syncDuration + 's',
                        apiKey: this.apiKey ? 'SET (length: ' + this.apiKey.length + ')' : 'NOT SET',
                        binId: this.config.binId,
                        online: navigator.onLine,
                        localData: {
                            projects: this.data.projects.length,
                            tasks: this.data.tasks.length,
                            transactions: this.data.transactions.length
                        }
                    });
                }
            },
            
            // Merge arrays by timestamp - keeps most recent version of each item
            mergeByTimestamp(localItems, cloudItems) {
                const merged = new Map();
                
                // Add all local items
                localItems.forEach(item => {
                    merged.set(item.id, { ...item, _source: 'local' });
                });
                
                // Add/update with cloud items if they're newer
                cloudItems.forEach(cloudItem => {
                    const localItem = merged.get(cloudItem.id);
                    
                    if (!localItem) {
                        // New item from cloud
                        merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                    } else {
                        // Item exists in both - compare timestamps
                        const localTime = new Date(localItem.updated_at || localItem.created_at || 0);
                        const cloudTime = new Date(cloudItem.updated_at || cloudItem.created_at || 0);
                        
                        if (cloudTime > localTime) {
                            // Cloud version is newer
                            merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                        }
                        // else keep local version (it's newer or same)
                    }
                });
                
                // Convert back to array and remove deleted items and source marker
                const result = Array.from(merged.values())
                    .filter(item => !item.deleted_at)
                    .map(item => {
                        const { _source, ...cleanItem } = item;
                        return cleanItem;
                    });
                
                return result;
            },
            
            saveApiKey() {
                const key = document.getElementById('apiKeyInput').value.trim();
                if (!key) {
                    this.toast('Please enter an API key');
                    return;
                }
                
                this.apiKey = key;
                localStorage.setItem('builderProApiKey', key);
                document.getElementById('apiKeyInput').value = '';
                this.dom.syncMode.textContent = 'Ready';
                this.toast('✅ API key saved! Click "Test Connection" to verify', 5000);
            },
            
            async testSync() {
                if (!this.apiKey) {
                    this.toast('⚠️ No API key set! Enter your JSONBin API key first.', 5000);
                    return;
                }
                
                this.toast('🔍 Testing connection...');
                
                try {
                    console.log('🔍 Testing sync connection...');
                    console.log('API Key length:', this.apiKey.length);
                    console.log('Bin ID:', this.config.binId);
                    console.log('Base URL:', this.config.baseUrl);
                    
                    const response = await fetch(`${this.config.baseUrl}/b/${this.config.binId}/latest`, {
                        headers: { 'X-Master-Key': this.apiKey }
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response OK:', response.ok);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ Connection successful!');
                        console.log('Cloud data:', {
                            projects: result.record?.projects?.length || 0,
                            tasks: result.record?.tasks?.length || 0,
                            transactions: result.record?.transactions?.length || 0
                        });
                        
                        this.toast('✅ Connection works! Ready to sync.', 5000);
                        this.dom.syncMode.textContent = 'Connected';
                    } else if (response.status === 401) {
                        this.toast('❌ Invalid API key! Get a new one from jsonbin.io', 6000);
                        this.dom.syncMode.textContent = 'Invalid Key';
                    } else if (response.status === 404) {
                        this.toast('❌ Bin not found! Check your Bin ID.', 6000);
                        this.dom.syncMode.textContent = 'Invalid Bin';
                    } else {
                        this.toast(`❌ Error ${response.status}: ${response.statusText}`, 6000);
                        this.dom.syncMode.textContent = 'Error';
                    }
                } catch (error) {
                    console.error('❌ Test failed:', error);
                    this.toast('❌ Connection failed! Check internet connection.', 6000);
                    this.dom.syncMode.textContent = 'Offline';
                }
            },
            
            // Auto-sync functionality
            initAutoSync() {
                const savedAutoSync = localStorage.getItem('autoSyncEnabled');
                if (savedAutoSync === 'true' && this.apiKey) {
                    this.autoSyncEnabled = true;
                    this.startAutoSync();
                }
            },
            
            toggleAutoSync() {
                this.autoSyncEnabled = !this.autoSyncEnabled;
                localStorage.setItem('autoSyncEnabled', this.autoSyncEnabled.toString());
                
                if (this.autoSyncEnabled) {
                    this.startAutoSync();
                    this.toast('⚡ Auto-sync enabled (every 5 min)');
                } else {
                    this.stopAutoSync();
                    this.toast('Auto-sync disabled');
                }
            },
            
            startAutoSync() {
                this.stopAutoSync();
                if (this.apiKey && this.autoSyncEnabled) {
                    this.autoSyncInterval = setInterval(() => {
                        console.log('🔄 Auto-sync triggered');
                        this.sync();
                    }, 5 * 60 * 1000); // Every 5 minutes
                }
            },
            
            stopAutoSync() {
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                    this.autoSyncInterval = null;
                }
            },
            
            // Export/Import
            exportData() {
                const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'builder-pro-backup.json';
                a.click();
                URL.revokeObjectURL(url);
                this.toast('Data exported');
            },
            
            importData(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (confirm('Replace all current data?')) {
                                this.data = imported;
                                this.saveData();
                                this.applySettings();
                                this.updateStats();
                                this.render();
                                this.toast('Data imported');
                            }
                        } catch (error) {
                            this.toast('Import failed');
                        }
                    };
                    reader.readAsText(file);
                }
            },
            
            // Toast
            toast(message, duration = 3000) {
                this.dom.toast.textContent = message;
                this.dom.toast.classList.add('show');
                setTimeout(() => this.dom.toast.classList.remove('show'), duration);
            },
            
            // Behavior Tracking
            initBehaviorTracking() {
                // Track session start
                this.data.userBehavior.totalSessions++;
                this.data.userBehavior.lastActive = new Date().toISOString();
                
                // Reset daily action counter if new day
                const today = new Date().toDateString();
                if (this.data.userBehavior.lastActionDate !== today) {
                    this.data.userBehavior.actionsToday = 0;
                    this.data.userBehavior.lastActionDate = today;
                }
                
                this.saveData();
            },
            
            trackAction(actionType, details = {}) {
                const action = {
                    type: actionType,
                    timestamp: new Date().toISOString(),
                    details: details
                };
                
                // Update behavior stats
                this.data.userBehavior.actionsToday++;
                this.data.userBehavior.lastActive = action.timestamp;
                
                // Track specific actions
                if (actionType === 'project_created') this.data.userBehavior.projectsCreated++;
                if (actionType === 'task_created') this.data.userBehavior.tasksCreated++;
                if (actionType === 'view_changed') {
                    this.data.userBehavior.viewCounts[details.view]++;
                }
                
                this.saveData();
                console.log('📊 Action tracked:', actionType, details);
            },
            
            // Alert System
            startAlertChecking() {
                // Check alerts every 5 minutes
                this.alertCheckInterval = setInterval(() => {
                    this.generateAlerts();
                }, 5 * 60 * 1000);
                
                // Initial check
                this.generateAlerts();
            },
            
            generateAlerts() {
                const alerts = [];
                const now = new Date();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Clear old dismissed alerts (older than 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                // Reset dismissed alerts daily to re-check important items
                const lastResetDate = localStorage.getItem('lastAlertResetDate');
                const todayStr = today.toDateString();
                
                if (lastResetDate !== todayStr) {
                    this.data.dismissedAlerts = [];
                    localStorage.setItem('lastAlertResetDate', todayStr);
                }
                
                // Check overdue tasks
                const overdueTasks = this.data.tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate < today && task.status !== 'Completed';
                });
                
                if (overdueTasks.length > 0) {
                    alerts.push({
                        id: 'overdue_tasks',
                        type: 'critical',
                        icon: '🚨',
                        title: `${overdueTasks.length} Overdue Task${overdueTasks.length > 1 ? 's' : ''}`,
                        message: `You have ${overdueTasks.length} task${overdueTasks.length > 1 ? 's' : ''} past their due date.`,
                        action: 'View Tasks',
                        actionFn: () => { this.switchView('kanban'); this.closeModal('alertModal'); }
                    });
                }
                
                // Check tasks due today
                const todayTasks = this.data.tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate.getTime() === today.getTime() && task.status !== 'Completed';
                });
                
                if (todayTasks.length > 0) {
                    alerts.push({
                        id: 'due_today',
                        type: 'warning',
                        icon: '⏰',
                        title: `${todayTasks.length} Task${todayTasks.length > 1 ? 's' : ''} Due Today`,
                        message: `Don't forget: ${todayTasks.map(t => t.name).slice(0, 2).join(', ')}${todayTasks.length > 2 ? '...' : ''}`,
                        action: 'View Tasks',
                        actionFn: () => { this.switchView('kanban'); this.closeModal('alertModal'); }
                    });
                }
                
                // Check tasks due in next 3 days
                const threeDaysFromNow = new Date(today);
                threeDaysFromNow.setDate(today.getDate() + 3);
                
                const upcomingTasks = this.data.tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate > today && dueDate <= threeDaysFromNow && task.status !== 'Completed';
                });
                
                if (upcomingTasks.length > 0) {
                    alerts.push({
                        id: 'upcoming_tasks',
                        type: 'info',
                        icon: '📅',
                        title: `${upcomingTasks.length} Task${upcomingTasks.length > 1 ? 's' : ''} Due Soon`,
                        message: `Coming up in the next 3 days: ${upcomingTasks.map(t => t.name).slice(0, 2).join(', ')}${upcomingTasks.length > 2 ? '...' : ''}`,
                        action: 'View Schedule',
                        actionFn: () => { this.switchView('schedule'); this.closeModal('alertModal'); }
                    });
                }
                
                // Check projects without dates
                const projectsWithoutDates = this.data.projects.filter(p => !p.startDate || !p.endDate);
                
                if (projectsWithoutDates.length > 0) {
                    alerts.push({
                        id: 'projects_no_dates',
                        type: 'warning',
                        icon: '📆',
                        title: `${projectsWithoutDates.length} Project${projectsWithoutDates.length > 1 ? 's' : ''} Missing Dates`,
                        message: `Add start and end dates to track progress: ${projectsWithoutDates.map(p => p.name).slice(0, 2).join(', ')}${projectsWithoutDates.length > 2 ? '...' : ''}`,
                        action: 'View Projects',
                        actionFn: () => { this.switchView('projects'); this.closeModal('alertModal'); }
                    });
                }
                
                // Check tasks without assignees
                const tasksWithoutAssignee = this.data.tasks.filter(t => !t.assignee && t.status !== 'Completed');
                
                if (tasksWithoutAssignee.length > 3) {
                    alerts.push({
                        id: 'tasks_no_assignee',
                        type: 'info',
                        icon: '👤',
                        title: `${tasksWithoutAssignee.length} Tasks Unassigned`,
                        message: `Assign workers to tasks for better tracking.`,
                        action: 'View Tasks',
                        actionFn: () => { this.switchView('kanban'); this.closeModal('alertModal'); }
                    });
                }
                
                // Check projects with no tasks
                const projectsWithoutTasks = this.data.projects.filter(p => {
                    return this.data.tasks.filter(t => t.projectId === p.id).length === 0;
                });
                
                if (projectsWithoutTasks.length > 0) {
                    alerts.push({
                        id: 'projects_no_tasks',
                        type: 'info',
                        icon: '📋',
                        title: `${projectsWithoutTasks.length} Project${projectsWithoutTasks.length > 1 ? 's' : ''} Without Tasks`,
                        message: `Add tasks to: ${projectsWithoutTasks.map(p => p.name).slice(0, 2).join(', ')}${projectsWithoutTasks.length > 2 ? '...' : ''}`,
                        action: 'Add Tasks',
                        actionFn: () => { this.showTaskModal(); this.closeModal('alertModal'); }
                    });
                }
                
                // Check budget warnings (expenses > income)
                const projectsWithBudgetIssues = this.data.projects.filter(p => {
                    const trans = this.data.transactions.filter(t => t.projectId === p.id);
                    const income = trans.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const expenses = trans.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    return expenses > income && income > 0;
                });
                
                if (projectsWithBudgetIssues.length > 0) {
                    alerts.push({
                        id: 'budget_warning',
                        type: 'critical',
                        icon: '💸',
                        title: `Budget Alert: ${projectsWithBudgetIssues.length} Project${projectsWithBudgetIssues.length > 1 ? 's' : ''}`,
                        message: `Expenses exceed income: ${projectsWithBudgetIssues.map(p => p.name).slice(0, 2).join(', ')}${projectsWithBudgetIssues.length > 2 ? '...' : ''}`,
                        action: 'View Projects',
                        actionFn: () => { this.switchView('projects'); this.closeModal('alertModal'); }
                    });
                }
                
                // Check last sync time
                const lastSyncTime = localStorage.getItem('lastSyncTime');
                if (this.apiKey && lastSyncTime) {
                    const hoursSinceSync = (Date.now() - parseInt(lastSyncTime)) / (1000 * 60 * 60);
                    if (hoursSinceSync > 24) {
                        alerts.push({
                            id: 'sync_reminder',
                            type: 'info',
                            icon: '🔄',
                            title: 'Sync Reminder',
                            message: `Last synced ${Math.floor(hoursSinceSync)} hours ago. Sync now to backup your data.`,
                            action: 'Sync Now',
                            actionFn: () => { this.sync(); this.closeModal('alertModal'); }
                        });
                    }
                }
                
                // Check idle projects (no activity in 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const idleProjects = this.data.projects.filter(p => {
                    const projectTasks = this.data.tasks.filter(t => t.projectId === p.id);
                    const recentActivity = projectTasks.some(t => {
                        const updated = new Date(t.updated_at || t.created_at);
                        return updated > sevenDaysAgo;
                    });
                    return !recentActivity && projectTasks.length > 0;
                });
                
                if (idleProjects.length > 0) {
                    alerts.push({
                        id: 'idle_projects',
                        type: 'info',
                        icon: '⏸️',
                        title: `${idleProjects.length} Idle Project${idleProjects.length > 1 ? 's' : ''}`,
                        message: `No activity in 7+ days: ${idleProjects.map(p => p.name).slice(0, 2).join(', ')}${idleProjects.length > 2 ? '...' : ''}`,
                        action: 'View Projects',
                        actionFn: () => { this.switchView('projects'); this.closeModal('alertModal'); }
                    });
                }
                
                // Filter out dismissed alerts
                const newAlerts = alerts.filter(alert => {
                    return !this.data.dismissedAlerts.includes(alert.id);
                });
                
                this.data.alerts = newAlerts;
                this.updateAlertBadge();
                this.saveData();
            },
            
            checkAndShowAlerts() {
                this.generateAlerts();
                
                // Show critical alerts automatically
                const criticalAlerts = this.data.alerts.filter(a => a.type === 'critical');
                if (criticalAlerts.length > 0) {
                    setTimeout(() => this.showAlerts(), 500);
                }
            },
            
            updateAlertBadge() {
                const badge = this.dom.alertBadge;
                const count = this.data.alerts.length;
                
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            },
            
            showAlerts() {
                if (this.data.alerts.length === 0) {
                    this.toast('No alerts! Everything looks good 👍');
                    return;
                }
                
                const modal = document.getElementById('alertModal');
                const body = document.getElementById('alertBody');
                const countBadge = document.getElementById('alertCount');
                
                countBadge.textContent = this.data.alerts.length;
                
                let html = '';
                
                // Group alerts by type
                const critical = this.data.alerts.filter(a => a.type === 'critical');
                const warning = this.data.alerts.filter(a => a.type === 'warning');
                const info = this.data.alerts.filter(a => a.type === 'info');
                
                const renderAlerts = (alerts, title, color) => {
                    if (alerts.length === 0) return '';
                    
                    let section = `<div style="margin-bottom: 20px;">`;
                    section += `<h3 style="font-size: 13px; color: ${color}; margin-bottom: 10px;">${title}</h3>`;
                    
                    alerts.forEach(alert => {
                        section += `
                            <div style="padding: 12px; background: var(--bg); border-radius: 8px; border-left: 4px solid ${color}; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 4px;">
                                            ${alert.icon} ${alert.title}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                            ${alert.message}
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-primary" onclick="app.executeAlertAction('${alert.id}')" style="padding: 4px 12px; font-size: 11px;">
                                                ${alert.action}
                                            </button>
                                            <button class="btn btn-secondary" onclick="app.dismissAlert('${alert.id}')" style="padding: 4px 12px; font-size: 11px;">
                                                Dismiss
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    section += `</div>`;
                    return section;
                };
                
                html += renderAlerts(critical, '🚨 Critical', 'var(--danger)');
                html += renderAlerts(warning, '⚠️ Warnings', 'var(--warning)');
                html += renderAlerts(info, 'ℹ️ Info', 'var(--accent)');
                
                body.innerHTML = html;
                modal.classList.add('show');
            },
            
            dismissAlert(alertId) {
                this.data.dismissedAlerts.push(alertId);
                this.data.alerts = this.data.alerts.filter(a => a.id !== alertId);
                this.updateAlertBadge();
                this.saveData();
                
                if (this.data.alerts.length === 0) {
                    this.closeModal('alertModal');
                    this.toast('All alerts cleared! 🎉');
                } else {
                    this.showAlerts();
                }
            },
            
            dismissAllAlerts() {
                this.data.alerts.forEach(alert => {
                    this.data.dismissedAlerts.push(alert.id);
                });
                this.data.alerts = [];
                this.updateAlertBadge();
                this.saveData();
                this.closeModal('alertModal');
                this.toast('All alerts dismissed! 🎉');
            },
            
            executeAlertAction(alertId) {
                const alert = this.data.alerts.find(a => a.id === alertId);
                if (alert && alert.actionFn) {
                    alert.actionFn();
                    this.dismissAlert(alertId);
                }
            }
        };
        
        // Initialize app on load
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
