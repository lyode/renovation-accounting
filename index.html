<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="msapplication-navbutton-color" content="#E8A9B3">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Apple Touch Icons - Fixed for iPad -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23E8A9B3'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='80' font-weight='bold' fill='white'%3EB%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 152 152'%3E%3Crect width='152' height='152' fill='%23E8A9B3'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='68' font-weight='bold' fill='white'%3EB%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' fill='%23E8A9B3'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='54' font-weight='bold' fill='white'%3EB%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23E8A9B3' rx='20'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='48' font-weight='bold' fill='white'%3EB%3C/text%3E%3C/svg%3E">
    
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }

        /* Color Theme Classes */
        body.theme-pink-rose {
            --bg-color: #f5ebe9;
            --accent-color: #d2bcbf;
            --highlight-color: #a67980;
            --button-primary: #a67980;
            --button-primary-hover: #8d5f66;
        }

        body.theme-sage {
            --bg-color: #e8ebe5;
            --accent-color: #c0ccb8;
            --highlight-color: #60665c;
            --button-primary: #60665c;
            --button-primary-hover: #4a4f47;
        }

        body.theme-gold {
            --bg-color: #f9f3e5;
            --accent-color: #e0b558;
            --highlight-color: #ecd299;
            --button-primary: #c49840;
            --button-primary-hover: #b08838;
        }

        body.theme-periwinkle {
            --bg-color: #e5ebf5;
            --accent-color: #99b3ec;
            --highlight-color: #151b73;
            --button-primary: #151b73;
            --button-primary-hover: #1a2291;
        }

        body.theme-slate {
            --bg-color: #e5e6e8;
            --accent-color: #8386a4;
            --highlight-color: #191a22;
            --button-primary: #191a22;
            --button-primary-hover: #2a2b35;
        }

        body.theme-teal {
            --bg-color: #e5eeef;
            --accent-color: #90b2b8;
            --highlight-color: #2c4144;
            --button-primary: #2c4144;
            --button-primary-hover: #3d5558;
        }

        body.theme-aqua {
            --bg-color: #e8f0f1;
            --accent-color: #9cbbbf;
            --highlight-color: #436266;
            --button-primary: #436266;
            --button-primary-hover: #557478;
        }

        body.theme-terracotta {
            --bg-color: #f2e8e5;
            --accent-color: #c48779;
            --highlight-color: #391f19;
            --button-primary: #391f19;
            --button-primary-hover: #4d2b22;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .header {
                padding-top: 12px;
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding-top: var(--safe-area-inset-top);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .header h1 { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .header-subtitle { 
            font-size: calc(11px * var(--font-scale)); 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .header-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #10b981; 
            border: 2px solid white; 
        }
        
        .sync-indicator.syncing { 
            background: #f39c12; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            padding: 12px; 
            background: var(--bg-color); 
        }
        
        .stat-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 10px; 
            box-shadow: 0 2px 8px var(--shadow-color); 
            border: 1px solid var(--border-color); 
        }
        
        .stat-label { 
            font-size: calc(11px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-bottom: 4px; 
        }
        
        .stat-value { 
            font-size: calc(18px * var(--font-scale)); 
            font-weight: 700; 
        }
        
        .stat-value.income { 
            color: var(--income-color); 
        }
        
        .stat-value.expense { 
            color: var(--expense-color); 
        }
        
        .stat-sub { 
            font-size: calc(10px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-top: 2px; 
        }
        
        .nav-tabs { 
            display: flex; 
            justify-content: space-around; 
            background: var(--card-bg); 
            border-bottom: 1px solid var(--border-color); 
            padding: 0 12px; 
        }
        
        .nav-tab { 
            flex: 1; 
            padding: 12px 8px; 
            text-align: center; 
            cursor: pointer; 
            color: var(--text-secondary); 
            font-size: calc(12px * var(--font-scale)); 
            position: relative; 
            transition: color 0.2s; 
            border: none; 
            background: none; 
        }
        
        .nav-tab.active { 
            color: var(--highlight-color); 
            font-weight: 600; 
        }
        
        .nav-tab.active::after { 
            content: ''; 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 3px; 
            background: var(--highlight-color); 
            border-radius: 3px 3px 0 0; 
        }
        
        .main-content-wrapper { 
            margin-top: 260px; 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: calc(80px + var(--safe-area-inset-bottom)); 
        }
        
        .view-section { 
            display: none; 
        }
        
        .view-section.active { 
            display: block; 
        }
        
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px; 
            background: var(--card-bg); 
            border-bottom: 1px solid var(--border-color); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .section-title { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .add-btn { 
            background: var(--button-primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            padding: 8px 16px; 
            font-size: calc(12px * var(--font-scale)); 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        
        .add-btn:active { 
            background: var(--button-primary-hover); 
        }
        
        .content-list { 
            padding: 12px; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-secondary); 
        }
        
        .empty-icon { 
            font-size: calc(48px * var(--font-scale)); 
            margin-bottom: 12px; 
        }
        
        .project-card, .task-card, .transaction-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 14px; 
            margin-bottom: 10px; 
            box-shadow: 0 2px 8px var(--shadow-color); 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.2s; 
        }
        
        .project-card:active, .task-card:active, .transaction-card:active { 
            transform: scale(0.98); 
            border-color: var(--accent-color); 
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px; 
        }
        
        .card-title { 
            font-size: calc(15px * var(--font-scale)); 
            font-weight: 600; 
            flex: 1; 
        }
        
        .card-amount { 
            font-size: calc(14px * var(--font-scale)); 
            font-weight: 700; 
        }
        
        .card-amount.income { 
            color: var(--income-color); 
        }
        
        .card-amount.expense { 
            color: var(--expense-color); 
        }
        
        .card-meta { 
            font-size: calc(12px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-bottom: 4px; 
        }
        
        .card-progress { 
            margin-top: 8px; 
        }
        
        .progress-bar { 
            height: 6px; 
            background: var(--border-color); 
            border-radius: 3px; 
            overflow: hidden; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent-color), var(--highlight-color)); 
            transition: width 0.3s; 
        }
        
        .status-badge { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: calc(11px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .status-active { 
            background: rgba(16, 185, 129, 0.1); 
            color: var(--success); 
        }
        
        .status-pending { 
            background: rgba(243, 156, 18, 0.1); 
            color: var(--warning); 
        }
        
        .status-completed { 
            background: rgba(100, 100, 100, 0.1); 
            color: var(--text-secondary); 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 16px; 
            width: 100%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
        }
        
        .modal-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-title { 
            font-size: calc(18px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .close-btn { 
            background: none; 
            border: none; 
            font-size: calc(24px * var(--font-scale)); 
            color: var(--text-secondary); 
            cursor: pointer; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            transition: background 0.2s; 
        }
        
        .close-btn:active { 
            background: var(--border-color); 
        }
        
        .modal-body { 
            padding: 20px; 
        }
        
        .form-group { 
            margin-bottom: 16px; 
        }
        
        .form-label { 
            display: block; 
            font-size: calc(13px * var(--font-scale)); 
            font-weight: 600; 
            margin-bottom: 6px; 
            color: var(--text-color); 
        }
        
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: calc(14px * var(--font-scale)); 
            font-family: inherit; 
            background: var(--card-bg); 
            color: var(--text-color); 
            transition: border-color 0.2s; 
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            outline: none; 
            border-color: var(--accent-color); 
        }
        
        .form-textarea { 
            min-height: 100px; 
            resize: vertical; 
        }
        
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        
        .btn-group { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
        }
        
        .btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-size: calc(14px * var(--font-scale)); 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .btn-primary { 
            background: var(--button-primary); 
            color: white; 
        }
        
        .btn-primary:active { 
            background: var(--button-primary-hover); 
            transform: scale(0.98); 
        }
        
        .btn-secondary { 
            background: var(--border-color); 
            color: var(--text-color); 
        }
        
        .btn-secondary:active { 
            background: #d0d0d0; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-danger:active { 
            background: #dc2626; 
        }
        
        .settings-section { 
            margin-bottom: 24px; 
        }
        
        .settings-title { 
            font-size: calc(15px * var(--font-scale)); 
            font-weight: 600; 
            margin-bottom: 12px; 
            color: var(--text-color); 
        }
        
        .option-group { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            overflow: hidden; 
        }
        
        .option-item { 
            padding: 14px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .option-item:last-child { 
            border-bottom: none; 
        }
        
        .option-label { 
            font-size: calc(14px * var(--font-scale)); 
            color: var(--text-color); 
        }
        
        .toggle-group { 
            display: flex; 
            gap: 6px; 
            flex-wrap: wrap; 
        }
        
        .toggle-btn { 
            padding: 6px 12px; 
            border: 2px solid var(--border-color); 
            background: var(--card-bg); 
            color: var(--text-color); 
            border-radius: 6px; 
            font-size: calc(12px * var(--font-scale)); 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .toggle-btn.active { 
            background: var(--button-primary); 
            color: white; 
            border-color: var(--button-primary); 
        }
        
        .action-btn { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            background: var(--card-bg); 
            color: var(--text-color); 
            text-align: left; 
            font-size: calc(14px * var(--font-scale)); 
            cursor: pointer; 
            transition: background 0.2s; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .action-btn:active { 
            background: var(--border-color); 
        }
        
        .action-btn:last-child { 
            border-bottom: none; 
        }
        
        .toast { 
            position: fixed; 
            bottom: calc(80px + var(--safe-area-inset-bottom)); 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.85); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 8px; 
            font-size: calc(13px * var(--font-scale)); 
            z-index: 2000; 
            opacity: 0; 
            transition: opacity 0.3s; 
            max-width: 90%; 
            text-align: center; 
        }
        
        .toast.show { 
            opacity: 1; 
        }
        
        .detail-view { 
            padding: 20px; 
        }
        
        .detail-header { 
            margin-bottom: 24px; 
        }
        
        .detail-title { 
            font-size: calc(22px * var(--font-scale)); 
            font-weight: 700; 
            margin-bottom: 8px; 
        }
        
        .detail-grid { 
            display: grid; 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        
        .detail-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            padding: 16px; 
        }
        
        .detail-label { 
            font-size: calc(12px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-bottom: 4px; 
        }
        
        .detail-value { 
            font-size: calc(15px * var(--font-scale)); 
            font-weight: 600; 
        }

        /* Theme Picker Styles */
        .theme-picker {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
            padding: 16px;
        }

        .theme-option {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 3px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .theme-option.active {
            border-color: var(--button-primary);
            box-shadow: 0 4px 12px var(--shadow-color);
            transform: scale(1.05);
        }

        .theme-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: var(--theme-accent);
        }

        .theme-option::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: var(--theme-highlight);
        }

        .theme-name {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: calc(10px * var(--font-scale));
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            z-index: 1;
        }

        .theme-pink-rose-preview { --theme-accent: #d2bcbf; --theme-highlight: #a67980; }
        .theme-sage-preview { --theme-accent: #c0ccb8; --theme-highlight: #60665c; }
        .theme-gold-preview { --theme-accent: #e0b558; --theme-highlight: #ecd299; }
        .theme-periwinkle-preview { --theme-accent: #99b3ec; --theme-highlight: #151b73; }
        .theme-slate-preview { --theme-accent: #8386a4; --theme-highlight: #191a22; }
        .theme-teal-preview { --theme-accent: #90b2b8; --theme-highlight: #2c4144; }
        .theme-aqua-preview { --theme-accent: #9cbbbf; --theme-highlight: #436266; }
        .theme-terracotta-preview { --theme-accent: #c48779; --theme-highlight: #391f19; }
    </style>
</head>
<body class="normal-contrast font-m sat-normal">
    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="showView('dashboard')">
                        <div>
                            <h1>Builder Pro</h1>
                            <div class="header-subtitle">
                                <span id="projectCount">0</span> projects • 
                                <span id="taskCount">0</span> tasks
                            </div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="syncNow()" title="Sync Data">
                            🔄
                            <div class="sync-indicator" id="syncIndicator"></div>
                        </button>
                        <button class="header-btn" onclick="showSettings()">⚙️</button>
                    </div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value income" id="totalIncome">RM 0</div>
                    <div class="stat-sub" id="incomeCount">0 transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value expense" id="totalExpense">RM 0</div>
                    <div class="stat-sub" id="expenseCount">0 transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" id="netBalance">RM 0</div>
                    <div class="stat-sub">Current balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Projects</div>
                    <div class="stat-value" id="activeProjects">0</div>
                    <div class="stat-sub" id="completedProjects">0 completed</div>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showView('projects')">📋 Projects</button>
                <button class="nav-tab" onclick="showView('tasks')">✅ Tasks</button>
                <button class="nav-tab" onclick="showView('finance')">💰 Finance</button>
                <button class="nav-tab" onclick="showView('calendar')">📅 Calendar</button>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div id="projectsView" class="view-section active">
                <div class="section-header">
                    <div class="section-title">Projects</div>
                    <button class="add-btn" onclick="showProjectForm()">+ New Project</button>
                </div>
                <div class="content-list" id="projectsList">
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div>No projects yet. Create your first project!</div>
                    </div>
                </div>
            </div>

            <div id="tasksView" class="view-section">
                <div class="section-header">
                    <div class="section-title">Tasks</div>
                    <button class="add-btn" onclick="showTaskForm()">+ New Task</button>
                </div>
                <div class="content-list" id="tasksList">
                    <div class="empty-state">
                        <div class="empty-icon">✅</div>
                        <div>No tasks yet. Add your first task!</div>
                    </div>
                </div>
            </div>

            <div id="financeView" class="view-section">
                <div class="section-header">
                    <div class="section-title">Finance</div>
                    <button class="add-btn" onclick="showTransactionForm()">+ Transaction</button>
                </div>
                <div class="content-list" id="financeList">
                    <div class="empty-state">
                        <div class="empty-icon">💰</div>
                        <div>No transactions yet. Track your income & expenses!</div>
                    </div>
                </div>
            </div>

            <div id="calendarView" class="view-section">
                <div class="section-header">
                    <div class="section-title">Calendar</div>
                </div>
                <div class="content-list" id="calendarContent">
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        📅 Calendar view coming soon!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="projectModalTitle">New Project</div>
                <button class="close-btn" onclick="closeModal('projectModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" class="form-input" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="projectDesc"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="projectStart">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="projectEnd">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Budget (RM)</label>
                            <input type="number" class="form-input" id="projectBudget" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="projectStatus">
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    <button type="button" class="btn btn-danger" id="deleteProjectBtn" style="display: none; margin-top: 10px;" onclick="deleteProject()">Delete Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="taskModalTitle">New Task</div>
                <button class="close-btn" onclick="closeModal('taskModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Name *</label>
                        <input type="text" class="form-input" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="taskProject">
                            <option value="">No Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="taskDesc"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="taskDue">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="taskStatus">
                                <option value="pending">Pending</option>
                                <option value="active">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    <button type="button" class="btn btn-danger" id="deleteTaskBtn" style="display: none; margin-top: 10px;" onclick="deleteTask()">Delete Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="transactionModalTitle">New Transaction</div>
                <button class="close-btn" onclick="closeModal('transactionModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="transactionForm" onsubmit="saveTransaction(event)">
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="transactionType" required>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (RM) *</label>
                        <input type="number" class="form-input" id="transactionAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <input type="text" class="form-input" id="transactionDesc" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project (Optional)</label>
                        <select class="form-select" id="transactionProject">
                            <option value="">No Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="transactionDate">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    <button type="button" class="btn btn-danger" id="deleteTransactionBtn" style="display: none; margin-top: 10px;" onclick="deleteTransaction()">Delete Transaction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title">🎨 Color Theme</div>
                    <div class="theme-picker">
                        <div class="theme-option theme-pink-rose-preview" onclick="changeTheme('pink-rose')">
                            <div class="theme-name">Pink Rose</div>
                        </div>
                        <div class="theme-option theme-sage-preview" onclick="changeTheme('sage')">
                            <div class="theme-name">Sage</div>
                        </div>
                        <div class="theme-option theme-gold-preview" onclick="changeTheme('gold')">
                            <div class="theme-name">Gold</div>
                        </div>
                        <div class="theme-option theme-periwinkle-preview" onclick="changeTheme('periwinkle')">
                            <div class="theme-name">Periwinkle</div>
                        </div>
                        <div class="theme-option theme-slate-preview" onclick="changeTheme('slate')">
                            <div class="theme-name">Slate</div>
                        </div>
                        <div class="theme-option theme-teal-preview" onclick="changeTheme('teal')">
                            <div class="theme-name">Teal</div>
                        </div>
                        <div class="theme-option theme-aqua-preview" onclick="changeTheme('aqua')">
                            <div class="theme-name">Aqua</div>
                        </div>
                        <div class="theme-option theme-terracotta-preview" onclick="changeTheme('terracotta')">
                            <div class="theme-name">Terracotta</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">🌙 Display Mode</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Night Mode</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="toggleNightMode(false)">Off</button>
                                <button class="toggle-btn" onclick="toggleNightMode(true)">On</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">📝 Text Size</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Font Scale</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="changeFontSize('s')">S</button>
                                <button class="toggle-btn" onclick="changeFontSize('m')">M</button>
                                <button class="toggle-btn" onclick="changeFontSize('l')">L</button>
                                <button class="toggle-btn" onclick="changeFontSize('xl')">XL</button>
                                <button class="toggle-btn" onclick="changeFontSize('xxl')">XXL</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">🎨 Visual</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Contrast</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="changeContrast('low')">Low</button>
                                <button class="toggle-btn" onclick="changeContrast('normal')">Normal</button>
                                <button class="toggle-btn" onclick="changeContrast('high')">High</button>
                                <button class="toggle-btn" onclick="changeContrast('extra')">Extra</button>
                            </div>
                        </div>
                        <div class="option-item">
                            <span class="option-label">Saturation</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" onclick="changeSaturation('low')">Low</button>
                                <button class="toggle-btn" onclick="changeSaturation('normal')">Normal</button>
                                <button class="toggle-btn" onclick="changeSaturation('high')">High</button>
                                <button class="toggle-btn" onclick="changeSaturation('vibrant')">Vibrant</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">☁️ Cloud Sync</div>
                    <div class="option-group">
                        <div class="option-item">
                            <span class="option-label">Status: <span id="syncMode">Not Connected</span></span>
                            <span id="lastSyncTime" style="font-size: calc(11px * var(--font-scale)); color: var(--text-secondary);"></span>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <label class="form-label">JSONBin API Key</label>
                        <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your API key">
                        <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" onclick="saveApiKey()">Save API Key</button>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="testSync()">Test Sync Connection</button>
                    <div style="font-size: calc(11px * var(--font-scale)); color: var(--text-secondary); margin-top: 8px; padding: 0 4px;">
                        Get free API key at jsonbin.io. Your data syncs across all devices!
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">📦 Data</div>
                    <div class="option-group">
                        <button class="action-btn" onclick="exportData()">📤 Export Data</button>
                        <label class="action-btn" style="cursor: pointer;">
                            📥 Import Data
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const APP_CONFIG = {
            baseUrl: 'https://api.jsonbin.io/v3',
            binId: '677277c1acd3cb34a8bb0a64'
        };

        let data = {
            projects: [],
            tasks: [],
            transactions: [],
            settings: {
                nightMode: false,
                fontSize: 'm',
                contrast: 'normal',
                saturation: 'normal',
                theme: 'pink-rose'
            }
        };

        let currentView = 'projects';
        let editingId = null;
        let editingType = null;
        let syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';

        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                data = JSON.parse(saved);
                if (!data.settings.theme) {
                    data.settings.theme = 'pink-rose';
                }
            }
        }

        function saveData() {
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        function applySettings() {
            const { nightMode, fontSize, contrast, saturation, theme } = data.settings;
            
            // Apply theme
            document.body.className = '';
            if (theme) {
                document.body.classList.add(`theme-${theme}`);
                updateThemeSelector(theme);
            }
            
            // Apply night mode
            if (nightMode) {
                document.body.classList.add('night-mode');
            }
            
            // Apply font size
            document.body.classList.add(`font-${fontSize}`);
            updateToggleButtons('font', fontSize);
            
            // Apply contrast
            document.body.classList.add(`${contrast}-contrast`);
            updateToggleButtons('contrast', contrast);
            
            // Apply saturation
            document.body.classList.add(`sat-${saturation}`);
            updateToggleButtons('sat', saturation);
            
            // Update night mode toggle
            updateNightModeToggle(nightMode);
        }

        function updateThemeSelector(theme) {
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.remove('active');
            });
            const activeTheme = document.querySelector(`.theme-${theme}-preview`);
            if (activeTheme) {
                activeTheme.classList.add('active');
            }
        }

        function changeTheme(theme) {
            data.settings.theme = theme;
            saveData();
            applySettings();
            showToast(`Theme changed to ${theme.charAt(0).toUpperCase() + theme.slice(1).replace(/-/g, ' ')}`);
        }

        function toggleNightMode(enabled) {
            data.settings.nightMode = enabled;
            saveData();
            applySettings();
        }

        function changeFontSize(size) {
            data.settings.fontSize = size;
            saveData();
            applySettings();
        }

        function changeContrast(level) {
            data.settings.contrast = level;
            saveData();
            applySettings();
        }

        function changeSaturation(level) {
            data.settings.saturation = level;
            saveData();
            applySettings();
        }

        function updateToggleButtons(type, value) {
            const typeMap = {
                'font': 'font-',
                'contrast': '',
                'sat': 'sat-'
            };
            
            const buttons = document.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(type === 'font' ? 'changeFontSize' : (type === 'contrast' ? 'changeContrast' : 'changeSaturation'))) {
                    btn.classList.remove('active');
                    if (onclick.includes(`'${value}'`)) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        function updateNightModeToggle(enabled) {
            const buttons = document.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes('toggleNightMode')) {
                    btn.classList.remove('active');
                    if ((enabled && onclick.includes('true')) || (!enabled && onclick.includes('false'))) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`${view}View`).classList.add('active');
            event.target.classList.add('active');
            
            renderView();
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
            applySettings();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingId = null;
            editingType = null;
        }

        function showProjectForm(id = null) {
            editingId = id;
            editingType = 'project';
            
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            
            if (id) {
                const project = data.projects.find(p => p.id === id);
                title.textContent = 'Edit Project';
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectDesc').value = project.description || '';
                document.getElementById('projectStart').value = project.startDate || '';
                document.getElementById('projectEnd').value = project.endDate || '';
                document.getElementById('projectBudget').value = project.budget || '';
                document.getElementById('projectStatus').value = project.status;
                deleteBtn.style.display = 'block';
            } else {
                title.textContent = 'New Project';
                document.getElementById('projectForm').reset();
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function saveProject(event) {
            event.preventDefault();
            
            const project = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDesc').value,
                startDate: document.getElementById('projectStart').value,
                endDate: document.getElementById('projectEnd').value,
                budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                status: document.getElementById('projectStatus').value,
                createdAt: editingId ? data.projects.find(p => p.id === editingId).createdAt : Date.now(),
                updatedAt: Date.now()
            };
            
            if (editingId) {
                const index = data.projects.findIndex(p => p.id === editingId);
                data.projects[index] = project;
            } else {
                data.projects.push(project);
            }
            
            saveData();
            closeModal('projectModal');
            renderView();
            updateStats();
            showToast(editingId ? 'Project updated' : 'Project created');
        }

        function deleteProject() {
            if (confirm('Delete this project and all its tasks?')) {
                data.projects = data.projects.filter(p => p.id !== editingId);
                data.tasks = data.tasks.filter(t => t.projectId !== editingId);
                data.transactions = data.transactions.filter(t => t.projectId !== editingId);
                saveData();
                closeModal('projectModal');
                renderView();
                updateStats();
                showToast('Project deleted');
            }
        }

        function showTaskForm(id = null, projectId = null) {
            editingId = id;
            editingType = 'task';
            
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            const deleteBtn = document.getElementById('deleteTaskBtn');
            const projectSelect = document.getElementById('taskProject');
            
            projectSelect.innerHTML = '<option value="">No Project</option>';
            data.projects.forEach(p => {
                projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            if (id) {
                const task = data.tasks.find(t => t.id === id);
                title.textContent = 'Edit Task';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDesc').value = task.description || '';
                document.getElementById('taskDue').value = task.dueDate || '';
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskProject').value = task.projectId || '';
                deleteBtn.style.display = 'block';
            } else {
                title.textContent = 'New Task';
                document.getElementById('taskForm').reset();
                if (projectId) {
                    document.getElementById('taskProject').value = projectId;
                }
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function saveTask(event) {
            event.preventDefault();
            
            const task = {
                id: editingId || Date.now().toString(),
                name: document.getElementById('taskName').value,
                description: document.getElementById('taskDesc').value,
                dueDate: document.getElementById('taskDue').value,
                status: document.getElementById('taskStatus').value,
                projectId: document.getElementById('taskProject').value || null,
                createdAt: editingId ? data.tasks.find(t => t.id === editingId).createdAt : Date.now(),
                updatedAt: Date.now()
            };
            
            if (editingId) {
                const index = data.tasks.findIndex(t => t.id === editingId);
                data.tasks[index] = task;
            } else {
                data.tasks.push(task);
            }
            
            saveData();
            closeModal('taskModal');
            renderView();
            updateStats();
            showToast(editingId ? 'Task updated' : 'Task created');
        }

        function deleteTask() {
            if (confirm('Delete this task?')) {
                data.tasks = data.tasks.filter(t => t.id !== editingId);
                saveData();
                closeModal('taskModal');
                renderView();
                updateStats();
                showToast('Task deleted');
            }
        }

        function showTransactionForm(id = null, projectId = null) {
            editingId = id;
            editingType = 'transaction';
            
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('transactionModalTitle');
            const deleteBtn = document.getElementById('deleteTransactionBtn');
            const projectSelect = document.getElementById('transactionProject');
            
            projectSelect.innerHTML = '<option value="">No Project</option>';
            data.projects.forEach(p => {
                projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            if (id) {
                const transaction = data.transactions.find(t => t.id === id);
                title.textContent = 'Edit Transaction';
                document.getElementById('transactionType').value = transaction.type;
                document.getElementById('transactionAmount').value = transaction.amount;
                document.getElementById('transactionDesc').value = transaction.description;
                document.getElementById('transactionProject').value = transaction.projectId || '';
                document.getElementById('transactionDate').value = transaction.date;
                deleteBtn.style.display = 'block';
            } else {
                title.textContent = 'New Transaction';
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                if (projectId) {
                    document.getElementById('transactionProject').value = projectId;
                }
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function saveTransaction(event) {
            event.preventDefault();
            
            const transaction = {
                id: editingId || Date.now().toString(),
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                description: document.getElementById('transactionDesc').value,
                projectId: document.getElementById('transactionProject').value || null,
                date: document.getElementById('transactionDate').value,
                createdAt: editingId ? data.transactions.find(t => t.id === editingId).createdAt : Date.now(),
                updatedAt: Date.now()
            };
            
            if (editingId) {
                const index = data.transactions.findIndex(t => t.id === editingId);
                data.transactions[index] = transaction;
            } else {
                data.transactions.push(transaction);
            }
            
            saveData();
            closeModal('transactionModal');
            renderView();
            updateStats();
            showToast(editingId ? 'Transaction updated' : 'Transaction created');
        }

        function deleteTransaction() {
            if (confirm('Delete this transaction?')) {
                data.transactions = data.transactions.filter(t => t.id !== editingId);
                saveData();
                closeModal('transactionModal');
                renderView();
                updateStats();
                showToast('Transaction deleted');
            }
        }

        function renderView() {
            if (currentView === 'projects') {
                renderProjects();
            } else if (currentView === 'tasks') {
                renderTasks();
            } else if (currentView === 'finance') {
                renderTransactions();
            }
        }

        function renderProjects() {
            const list = document.getElementById('projectsList');
            
            if (data.projects.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div>No projects yet. Create your first project!</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = data.projects.map(p => {
                const tasks = data.tasks.filter(t => t.projectId === p.id);
                const completedTasks = tasks.filter(t => t.status === 'completed').length;
                const progress = tasks.length > 0 ? (completedTasks / tasks.length) * 100 : 0;
                
                return `
                    <div class="project-card" onclick="showProjectForm('${p.id}')">
                        <div class="card-header">
                            <div class="card-title">${p.name}</div>
                            <span class="status-badge status-${p.status}">${p.status}</span>
                        </div>
                        ${p.description ? `<div class="card-meta">${p.description}</div>` : ''}
                        <div class="card-meta">
                            ${tasks.length} tasks • ${completedTasks} completed
                        </div>
                        ${p.budget ? `<div class="card-meta">Budget: RM ${p.budget.toFixed(2)}</div>` : ''}
                        <div class="card-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTasks() {
            const list = document.getElementById('tasksList');
            
            if (data.tasks.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">✅</div>
                        <div>No tasks yet. Add your first task!</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = data.tasks.map(t => {
                const project = t.projectId ? data.projects.find(p => p.id === t.projectId) : null;
                
                return `
                    <div class="task-card" onclick="showTaskForm('${t.id}')">
                        <div class="card-header">
                            <div class="card-title">${t.name}</div>
                            <span class="status-badge status-${t.status}">${t.status}</span>
                        </div>
                        ${t.description ? `<div class="card-meta">${t.description}</div>` : ''}
                        ${project ? `<div class="card-meta">📋 ${project.name}</div>` : ''}
                        ${t.dueDate ? `<div class="card-meta">📅 Due: ${new Date(t.dueDate).toLocaleDateString()}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderTransactions() {
            const list = document.getElementById('financeList');
            
            if (data.transactions.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💰</div>
                        <div>No transactions yet. Track your income & expenses!</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = data.transactions.map(t => {
                const project = t.projectId ? data.projects.find(p => p.id === t.projectId) : null;
                
                return `
                    <div class="transaction-card" onclick="showTransactionForm('${t.id}')">
                        <div class="card-header">
                            <div class="card-title">${t.description}</div>
                            <div class="card-amount ${t.type}">
                                ${t.type === 'income' ? '+' : '-'}RM ${t.amount.toFixed(2)}
                            </div>
                        </div>
                        <div class="card-meta">
                            ${t.type === 'income' ? '💰 Income' : '💸 Expense'} • 
                            ${new Date(t.date).toLocaleDateString()}
                        </div>
                        ${project ? `<div class="card-meta">📋 ${project.name}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const income = data.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = data.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const incomeCount = data.transactions.filter(t => t.type === 'income').length;
            const expenseCount = data.transactions.filter(t => t.type === 'expense').length;
            
            const activeProjects = data.projects.filter(p => p.status === 'active').length;
            const completedProjects = data.projects.filter(p => p.status === 'completed').length;
            
            document.getElementById('totalIncome').textContent = `RM ${income.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `RM ${expense.toFixed(2)}`;
            document.getElementById('netBalance').textContent = `RM ${(income - expense).toFixed(2)}`;
            document.getElementById('incomeCount').textContent = `${incomeCount} transactions`;
            document.getElementById('expenseCount').textContent = `${expenseCount} transactions`;
            document.getElementById('activeProjects').textContent = activeProjects;
            document.getElementById('completedProjects').textContent = `${completedProjects} completed`;
            document.getElementById('projectCount').textContent = data.projects.length;
            document.getElementById('taskCount').textContent = data.tasks.length;
        }

        async function syncNow() {
            if (!syncApiKey) {
                showToast('⚠️ Sync not configured! Open Settings to add your API key.');
                return;
            }
            
            const indicator = document.getElementById('syncIndicator');
            const syncMode = document.getElementById('syncMode');
            indicator.classList.add('syncing');
            syncMode.textContent = 'Syncing...';
            
            const startTime = Date.now();
            
            try {
                console.log('🔄 Step 1: Fetching cloud data...');
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Fetch failed: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.json();
                const cloudData = result.record || {};
                
                console.log('📥 Cloud data received:', {
                    projects: cloudData.projects?.length || 0,
                    tasks: cloudData.tasks?.length || 0,
                    transactions: cloudData.transactions?.length || 0
                });
                
                if (cloudData.projects || cloudData.tasks || cloudData.transactions) {
                    console.log('🔄 Step 2: Merging data...');
                    syncMode.textContent = 'Merging...';
                    
                    const beforeCounts = {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    };
                    
                    const mergeByTimestamp = (local, cloud, idField = 'id') => {
                        const map = new Map();
                        
                        local.forEach(item => {
                            map.set(item[idField], item);
                        });
                        
                        cloud.forEach(item => {
                            const existing = map.get(item[idField]);
                            if (!existing || item.updatedAt > existing.updatedAt) {
                                map.set(item[idField], item);
                            }
                        });
                        
                        return Array.from(map.values());
                    };
                    
                    const mergedProjects = mergeByTimestamp(data.projects, cloudData.projects || []);
                    const mergedTasks = mergeByTimestamp(data.tasks, cloudData.tasks || []);
                    const mergedTransactions = mergeByTimestamp(data.transactions, cloudData.transactions || []);
                    
                    data.projects = mergedProjects;
                    data.tasks = mergedTasks;
                    data.transactions = mergedTransactions;
                    
                    if (cloudData.permanentlyDeleted) {
                        data.permanentlyDeleted = [
                            ...(data.permanentlyDeleted || []),
                            ...cloudData.permanentlyDeleted
                        ];
                        data.permanentlyDeleted = Array.from(
                            new Map(data.permanentlyDeleted.map(item => [item.id, item])).values()
                        );
                    }
                    
                    const afterCounts = {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    };
                    
                    const changes = [];
                    if (afterCounts.projects !== beforeCounts.projects) {
                        changes.push(`${afterCounts.projects - beforeCounts.projects > 0 ? '+' : ''}${afterCounts.projects - beforeCounts.projects} projects`);
                    }
                    if (afterCounts.tasks !== beforeCounts.tasks) {
                        changes.push(`${afterCounts.tasks - beforeCounts.tasks > 0 ? '+' : ''}${afterCounts.tasks - beforeCounts.tasks} tasks`);
                    }
                    if (afterCounts.transactions !== beforeCounts.transactions) {
                        changes.push(`${afterCounts.transactions - beforeCounts.transactions > 0 ? '+' : ''}${afterCounts.transactions - beforeCounts.transactions} trans`);
                    }
                    
                    console.log('✅ Merge complete:', changes.length > 0 ? changes.join(', ') : 'No changes');
                    
                    saveData();
                    renderView();
                    updateStats();
                }
                
                console.log('🔄 Step 3: Pushing merged data to cloud...');
                syncMode.textContent = 'Pushing...';
                const putResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': syncApiKey
                    },
                    body: JSON.stringify(data)
                });
                
                if (!putResponse.ok) {
                    throw new Error(`Push failed: ${putResponse.status} - ${putResponse.statusText}`);
                }
                
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`✅ Sync complete in ${syncDuration}s`);
                
                localStorage.setItem('lastSyncTime', Date.now().toString());
                const nowTime = new Date().toLocaleTimeString();
                document.getElementById('lastSyncTime').textContent = `Last: ${nowTime}`;
                showToast(`✅ Synced ${data.projects.length}p ${data.tasks.length}t ${data.transactions.length}tr in ${syncDuration}s!`, 5000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Connected';
                
            } catch (error) {
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.error('❌ Sync error:', error);
                
                let errorMsg = error.message;
                if (error.message.includes('401')) {
                    errorMsg = 'Invalid API key! Check Settings';
                } else if (error.message.includes('404')) {
                    errorMsg = 'Bin not found! Check Bin ID';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'No internet connection!';
                }
                
                showToast(`❌ ${errorMsg}`, 6000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Error';
                
                console.log('Sync diagnostics:', {
                    duration: syncDuration + 's',
                    apiKey: syncApiKey ? 'SET (length: ' + syncApiKey.length + ')' : 'NOT SET',
                    binId: APP_CONFIG.binId,
                    online: navigator.onLine,
                    localData: {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    }
                });
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('✅ API key saved! Now click "Test Sync Connection"', 5000);
        }

        async function testSync() {
            if (!syncApiKey) {
                showToast('⚠️ No API key set! Enter your JSONBin API key first.');
                return;
            }
            
            showToast('🔍 Testing connection...');
            
            try {
                console.log('🔍 Testing sync connection...');
                console.log('API Key length:', syncApiKey.length);
                console.log('Bin ID:', APP_CONFIG.binId);
                console.log('Base URL:', APP_CONFIG.baseUrl);
                
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Connection successful!');
                    console.log('Cloud data:', {
                        projects: result.record?.projects?.length || 0,
                        tasks: result.record?.tasks?.length || 0,
                        transactions: result.record?.transactions?.length || 0
                    });
                    
                    showToast('✅ Connection works! Your API key is valid.');
                    document.getElementById('syncMode').textContent = 'Connected';
                } else if (response.status === 401) {
                    showToast('❌ Invalid API key! Get a new one from jsonbin.io');
                    document.getElementById('syncMode').textContent = 'Invalid Key';
                } else if (response.status === 404) {
                    showToast('❌ Bin not found! Check your Bin ID.');
                    document.getElementById('syncMode').textContent = 'Invalid Bin';
                } else {
                    showToast(`❌ Error ${response.status}: ${response.statusText}`);
                    document.getElementById('syncMode').textContent = 'Error';
                }
            } catch (error) {
                console.error('❌ Test failed:', error);
                showToast('❌ Connection failed! Check internet & open browser console (F12)');
                document.getElementById('syncMode').textContent = 'Offline';
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            if (!data.settings.theme) {
                                data.settings.theme = 'pink-rose';
                            }
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize
        loadData();
        applySettings();
        renderView();
        updateStats();
        
        // Update sync status
        const lastSync = localStorage.getItem('lastSyncTime');
        if (lastSync) {
            const time = new Date(parseInt(lastSync)).toLocaleTimeString();
            document.getElementById('lastSyncTime').textContent = `Last: ${time}`;
        }
        
        if (syncApiKey) {
            document.getElementById('syncMode').textContent = 'Ready';
        }
    </script>
</body>
</html>
