<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="msapplication-navbutton-color" content="#E8A9B3">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .header {
                padding-top: 12px;
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding-top: var(--safe-area-inset-top);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .header h1 { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .header-subtitle { 
            font-size: calc(11px * var(--font-scale)); 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .header-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #10b981; 
            border: 2px solid white; 
        }
        
        .sync-indicator.syncing { 
            background: #f39c12; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        .sync-status-bar { 
            background: var(--button-primary); 
            color: white; 
            padding: 4px 10px; 
            font-size: calc(11px * var(--font-scale)); 
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
        }
        
        .tabs { 
            background: var(--card-bg); 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            overflow-x: auto; 
        }
        
        .tab { 
            flex: 1; 
            min-width: 80px; 
            padding: 10px 8px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            font-size: calc(12px * var(--font-scale)); 
            transition: all 0.2s;
        }
        
        .tab.active { 
            color: var(--accent-color); 
            border-bottom-color: var(--accent-color); 
        }
        
        .stats-bar { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: var(--bg-color); 
        }
        
        .main-content-wrapper {
            margin-top: 200px;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 210px;
            }
        }
        
        .container { 
            padding: 10px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 80px; 
        }
        
        .stat-card { 
            background: var(--card-bg); 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px var(--shadow-color); 
            text-align: center; 
        }
        
        .stat-card h3 { 
            font-size: calc(16px * var(--font-scale)); 
            color: var(--accent-color); 
            margin-bottom: 2px; 
            font-weight: 700; 
        }
        
        .stat-card.income h3 { color: var(--income-color); }
        .stat-card.expense h3 { color: var(--expense-color); }
        
        .stat-card p {
            color: var(--text-secondary);
            font-size: calc(11px * var(--font-scale));
        }
        
        .project-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            margin-bottom: 12px; 
            overflow: visible;
        }
        
        .project-header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 12px; 
            border-radius: 12px 12px 0 0;
            transition: all 0.2s;
        }
        
        .project-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .project-header:active {
            transform: translateY(0);
        }
        
        .project-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            padding: 10px; 
            background: rgba(0,0,0,0.1); 
            margin-top: 8px;
            border-radius: 8px;
        }
        
        .project-actions { 
            display: flex; 
            gap: 5px; 
            margin-top: 8px; 
            flex-wrap: wrap; 
        }
        
        .action-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(10px * var(--font-scale)); 
            transition: background 0.2s;
        }
        
        .action-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .gantt-container { 
            background: var(--card-bg); 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            overflow-x: auto; 
            margin-bottom: 15px; 
            position: relative;
        }
        
        .gantt-timeline-header {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        .gantt-timeline-months {
            margin-left: 150px;
            display: flex;
            flex: 1;
            gap: 2px;
        }
        
        .gantt-month {
            flex: 1;
            text-align: center;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-secondary);
            font-weight: 600;
            padding: 4px;
            background: var(--bg-color);
            border-radius: 4px;
        }
        
        .gantt-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            min-height: 40px; 
        }
        
        .gantt-label { 
            width: 150px; 
            font-size: calc(11px * var(--font-scale)); 
            font-weight: 500; 
            color: var(--text-color); 
            padding-right: 10px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .gantt-timeline { 
            flex: 1; 
            position: relative; 
            height: 35px; 
            background: var(--bg-color); 
            border-radius: 4px; 
        }
        
        .gantt-bar { 
            position: absolute; 
            height: 100%; 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 0 8px; 
            font-size: calc(9px * var(--font-scale)); 
            color: white; 
            font-weight: 500; 
            cursor: pointer;
        }
        
        .gantt-bar-dates {
            font-size: calc(8px * var(--font-scale));
            opacity: 0.9;
        }
        
        .today-line {
            position: absolute;
            top: -10px;
            bottom: -10px;
            width: 4px;
            background: #ef4444;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
        }
        
        .today-line::before {
            content: 'TODAY';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            padding: 20px; 
        }
        
        .modal.show { display: flex; }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 12px; 
            width: 100%; 
            max-width: 400px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            background: var(--bg-color); 
            color: var(--text-color); 
        }
        
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            font-size: calc(13px * var(--font-scale)); 
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .btn-primary { 
            background: var(--button-primary); 
            color: white; 
        }
        
        .btn-primary:hover {
            background: var(--button-primary-hover);
        }
        
        .btn-secondary { 
            background: var(--bg-color); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .settings-panel { 
            position: fixed; 
            top: 0; 
            right: -100%; 
            width: 90%; 
            max-width: 400px; 
            height: 100vh; 
            background: var(--card-bg); 
            box-shadow: -2px 0 10px rgba(0,0,0,0.2); 
            transition: right 0.3s; 
            z-index: 1001; 
            overflow-y: auto; 
            padding: 20px; 
            padding-top: calc(20px + var(--safe-area-inset-top));
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        .settings-panel.show { right: 0; }
        
        .settings-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            transition: opacity 0.3s;
        }
        
        .settings-backdrop.show {
            display: block;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-top: 10px;
        }
        
        .settings-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .settings-close-btn:active {
            background: var(--bg-color);
        }
        
        .theme-grid { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
        }
        
        .theme-option { 
            padding: 10px;
            border-radius: 8px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.2s; 
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .theme-option:hover { 
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .theme-option.active { 
            border-color: var(--button-primary); 
            transform: scale(1.02); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .theme-preview {
            height: 50px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .theme-name {
            font-size: 11px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .contrast-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .contrast-btn {
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: calc(11px * var(--font-scale));
            transition: all 0.2s;
            color: var(--text-color);
        }
        
        .contrast-btn.active {
            background: var(--button-primary);
            color: white;
            border-color: var(--button-primary);
        }
        
        .fab-container { 
            position: fixed; 
            bottom: calc(20px + var(--safe-area-inset-bottom)); 
            right: 20px; 
            z-index: 99; 
        }
        
        .fab { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: var(--button-primary); 
            color: white; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px var(--shadow-color); 
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .fab:hover {
            background: var(--button-primary-hover);
            transform: scale(1.05);
        }
        
        .fab-menu { 
            position: absolute; 
            bottom: 60px; 
            right: 0; 
            display: none; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .fab-menu.show { display: flex; }
        
        .fab-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            background: var(--card-bg); 
            color: var(--text-color);
            border-radius: 8px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
            cursor: pointer; 
            white-space: nowrap; 
            font-size: calc(12px * var(--font-scale)); 
        }
        
        .toast { 
            position: fixed; 
            bottom: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--card-bg); 
            color: var(--text-color); 
            padding: 12px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            z-index: 9999; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .toast.show { opacity: 1; }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-secondary); 
        }
        
        .task-item { 
            padding: 10px; 
            margin-bottom: 8px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            border-left: 3px solid var(--accent-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .task-item {
                padding: 8px;
                gap: 8px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: calc(14px * var(--font-scale));
            }
        }
        
        .icon-btn { 
            background: var(--accent-color); 
            border: none; 
            color: white; 
            width: 28px; 
            height: 28px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: calc(12px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .icon-btn:hover {
            transform: scale(1.05);
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        .icon-btn.danger { 
            background: var(--danger); 
        }
        
        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .calendar-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 15px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 10px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            padding: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 4px;
            font-size: calc(10px * var(--font-scale));
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: var(--card-bg);
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--shadow-color);
            z-index: 10;
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
            font-weight: bold;
            border: 3px solid #dc2626 !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.7) !important;
            animation: todayPulse 2s infinite;
            transform: scale(1.05);
            z-index: 20;
        }
        
        @keyframes todayPulse {
            0%, 100% { 
                box-shadow: 0 0 25px rgba(239, 68, 68, 0.7);
            }
            50% { 
                box-shadow: 0 0 35px rgba(239, 68, 68, 1);
            }
        }
        
        .calendar-day.today:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            transform: scale(1.08) !important;
        }
        
        .calendar-day.today .calendar-event {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #ef4444 !important;
            font-weight: 700;
        }
        
        .calendar-day.has-event {
            border: 2px solid var(--highlight-color);
        }
        
        .calendar-event {
            font-size: calc(8px * var(--font-scale));
            padding: 2px;
            background: var(--accent-color);
            color: white;
            border-radius: 2px;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sync-calendar-btn {
            background: var(--button-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: calc(13px * var(--font-scale));
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 250px;
            }
            
            .tabs {
                -webkit-overflow-scrolling: touch;
            }
            
            .fab {
                width: 56px;
                height: 56px;
            }
            
            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                max-height: 350px;
            }
            
            .theme-preview {
                height: 40px;
                font-size: 12px;
            }
            
            .stats-bar {
                gap: 6px;
                padding: 8px;
            }
            
            .stat-card {
                padding: 8px;
            }
            
            .stat-card h3 {
                font-size: calc(14px * var(--font-scale));
            }
            
            .stat-card p {
                font-size: calc(10px * var(--font-scale));
            }
            
            .task-item {
                padding: 8px;
                gap: 8px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: calc(14px * var(--font-scale));
            }
            
            .project-card {
                margin-bottom: 16px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: calc(12px * var(--font-scale));
            }
        }
        
        @media (max-width: 400px) {
            .main-content-wrapper {
                margin-top: 260px;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .gantt-label {
                width: 100px;
                font-size: calc(10px * var(--font-scale));
            }
            
            .project-header h3 {
                font-size: calc(14px * var(--font-scale));
            }
            
            .action-btn {
                font-size: calc(9px * var(--font-scale));
                padding: 3px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="showProfileModal()">
                        <div>
                            <h1 id="headerName">Builder Pro</h1>
                            <div class="header-subtitle" id="headerPosition">by REFIT Interior</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="smartSync()" title="Smart Sync">
                            🔄
                            <span class="sync-indicator" id="syncIndicator"></span>
                        </button>
                        <button class="header-btn" onclick="toggleSettings()" title="Settings">⚙️</button>
                    </div>
                </div>
                <div class="sync-status-bar" id="syncStatusBar">
                    <span id="deviceType"></span> • 
                    <span id="lastSyncTime" style="cursor: pointer;" onclick="showToast('Click 🔄 to sync now')" title="Click 🔄 to sync">Never synced</span> • 
                    <span id="syncMode">Offline</span>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchView('home')">Home</div>
                <div class="tab" onclick="switchView('kanban')">Kanban</div>
                <div class="tab" onclick="switchView('projects')">Projects</div>
                <div class="tab" onclick="switchView('schedule')">Schedule</div>
                <div class="tab" onclick="switchView('calendar')">Calendar</div>
            </div>

            <div class="stats-bar">
                <div class="stat-card">
                    <h3 id="totalProjects">0</h3>
                    <p>Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTasks">0</h3>
                    <p>Tasks</p>
                </div>
                <div class="stat-card income">
                    <h3 id="totalIncome">$0</h3>
                    <p>Income</p>
                </div>
                <div class="stat-card expense">
                    <h3 id="totalExpenses">$0</h3>
                    <p>Expenses</p>
                </div>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="container" id="mainContent"></div>
        </div>
    </div>

    <div class="settings-backdrop" id="settingsBackdrop" onclick="toggleSettings()"></div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span style="font-size: 1.25rem; font-weight: bold; color: var(--text-color);">⚙️ Settings</span>
            <button class="settings-close-btn" onclick="toggleSettings()">✕</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔑 Smart Sync API</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="password" id="apiKeyInput" placeholder="JSONBin API Key" style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
            </div>
            <div style="padding: 8px; background: var(--bg-color); border-radius: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">
                <strong style="color: var(--text-color);">🧠 Smart Sync Logic:</strong><br>
                1️⃣ Pull cloud data<br>
                2️⃣ Compare timestamps (created_at, updated_at)<br>
                3️⃣ Keep most recent version<br>
                4️⃣ Push merged data to cloud<br>
                <span style="color: var(--accent-color); font-weight: bold;">✓ Latest edits always win!</span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: 500; color: var(--text-color);">⚡ Auto-Sync (every 5 minutes)</span>
                <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()" style="width: 44px; height: 24px;">
            </div>
            <button class="btn btn-primary" onclick="smartSync()" style="width: 100%; margin-bottom: 8px;">🔄 Manual Sync Now</button>
            <button class="btn btn-secondary" onclick="testSync()" style="width: 100%;">🔍 Test Sync Connection</button>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Theme Colors (18 Premium Themes)</label>
            <div class="theme-grid" id="themeGrid"></div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">⚡ Theme Contrast</label>
            <div class="contrast-controls">
                <button class="contrast-btn" onclick="setContrast('low')">Low</button>
                <button class="contrast-btn active" onclick="setContrast('normal')">Normal</button>
                <button class="contrast-btn" onclick="setContrast('high')">High</button>
                <button class="contrast-btn" onclick="setContrast('extra')">Extra</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🎨 Color Saturation</label>
            <div class="contrast-controls">
                <button class="contrast-btn" onclick="setSaturation('low')">Low</button>
                <button class="contrast-btn active" onclick="setSaturation('normal')">Normal</button>
                <button class="contrast-btn" onclick="setSaturation('high')">High</button>
                <button class="contrast-btn" onclick="setSaturation('vibrant')">Vibrant</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-color);">🔤 Font Size</label>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <button class="btn btn-secondary" onclick="setFontSize('s')">S</button>
                <button class="btn btn-secondary" onclick="setFontSize('m')">M</button>
                <button class="btn btn-secondary" onclick="setFontSize('l')">L</button>
                <button class="btn btn-secondary" onclick="setFontSize('xl')">XL</button>
                <button class="btn btn-secondary" onclick="setFontSize('xxl')">XXL</button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight: 600; color: var(--text-color);">🌙 Night Mode</span>
                <input type="checkbox" id="nightToggle" onchange="toggleNightMode()" style="width: 44px; height: 24px;">
            </div>
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="exportData()" style="width: 100%;">📤 Export Data</button>
            <label class="btn btn-success" style="display: block; text-align: center; margin-top: 10px; width: 100%;">
                📥 Import Data
                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
            </label>
        </div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="showProjectModal()">
                <span>📁</span>New Project
            </div>
            <div class="fab-option" onclick="showTaskModal()">
                <span>📋</span>New Task
            </div>
            <div class="fab-option" onclick="showTransactionModal('income')">
                <span>💰</span>Add Income
            </div>
            <div class="fab-option" onclick="showTransactionModal('expense')">
                <span>💸</span>Add Expense
            </div>
        </div>
        <button class="fab" onclick="toggleFabMenu()">+</button>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: var(--text-color);">Profile Settings</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('profileModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Your Name</label>
                    <input type="text" id="profileName" placeholder="John Doe" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Position</label>
                    <input type="text" id="profilePosition" placeholder="Project Manager" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('profileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectModalTitle" style="color: var(--text-color);">New Project</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('projectModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project Name *</label>
                    <input type="text" id="projectName" placeholder="Kitchen Renovation">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Client Name *</label>
                    <input type="text" id="projectClient" placeholder="John Doe">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="projectStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">End Date</label>
                        <input type="date" id="projectEnd">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="projectLocked" style="width: 20px; height: 20px;">
                    <label for="projectLocked" style="font-size: 12px; color: var(--text-color);">🔒 Lock project (prevents editing)</label>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="taskModalTitle" style="color: var(--text-color);">New Task</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('taskModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Task Name *</label>
                    <input type="text" id="taskName" placeholder="Install cabinets">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="taskProject"></select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Start Date</label>
                        <input type="date" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Due Date *</label>
                        <input type="date" id="taskDue">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Priority</label>
                        <select id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Status</label>
                        <select id="taskStatus">
                            <option value="Get Ready">Get Ready</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Worker name">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="taskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="transactionModalTitle" style="color: var(--text-color);">Add Transaction</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('transactionModal')">×</span>
            </div>
            <div style="padding: 15px;">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Type</label>
                    <select id="transType" onchange="updateCategories()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Project *</label>
                    <select id="transProject"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Category *</label>
                    <select id="transCategory"></select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Amount ($) *</label>
                    <input type="number" step="0.01" id="transAmount" placeholder="0.00">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Date *</label>
                    <input type="date" id="transDate">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Description</label>
                    <textarea id="transDescription" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: none;"></textarea>
                </div>
            </div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="projectDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="projectDetailTitle" style="color: var(--text-color);">Project Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('projectDetailModal')">×</span>
            </div>
            <div id="projectDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('projectDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="dayDetailTitle" style="color: var(--text-color);">📅 Day Details</h2>
                <span style="font-size: 24px; color: var(--text-secondary); cursor: pointer;" onclick="closeModal('dayDetailModal')">×</span>
            </div>
            <div id="dayDetailBody" style="padding: 15px; max-height: 60vh; overflow-y: auto;"></div>
            <div style="padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('dayDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const APP_CONFIG = {
            binId: '68e121b8ae596e708f05df17',
            baseUrl: 'https://api.jsonbin.io/v3',
            deviceType: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Laptop'
        };

        const themeColors = [
            { name: 'Rose Blush', bg: '#F4EDEB', accent: '#E8A9B3', highlight: '#D47C90', text: '#1C1C1C' },
            { name: 'Mocha Cream', bg: '#FFF6F1', accent: '#C9A48F', highlight: '#8A5C4E', text: '#1C1C1C' },
            { name: 'Sand & Coffee', bg: '#F5EFE6', accent: '#A87C5F', highlight: '#6B4C3B', text: '#1C1C1C' },
            { name: 'Soft Plum', bg: '#F8F3F7', accent: '#B08CA5', highlight: '#8B5E83', text: '#1C1C1C' },
            { name: 'Nude Clay', bg: '#EFE5DC', accent: '#D5AA85', highlight: '#9F6B3F', text: '#1C1C1C' },
            { name: 'Charcoal Rose', bg: '#F0E6E9', accent: '#A77E94', highlight: '#7B4C60', text: '#1C1C1C' },
            { name: 'Muted Mauve', bg: '#F7F2F3', accent: '#C4A3B3', highlight: '#905E78', text: '#1C1C1C' },
            { name: 'Desert Sand', bg: '#F3E9DD', accent: '#C29D7F', highlight: '#7E5439', text: '#1C1C1C' },
            { name: 'Pastel Taupe', bg: '#EDE6E1', accent: '#B89C92', highlight: '#805B4D', text: '#1C1C1C' },
            { name: 'Cocoa Mint', bg: '#F6F4F2', accent: '#A68B76', highlight: '#5D3C2B', text: '#1C1C1C' },
            { name: 'Latte Rose', bg: '#F2E9E4', accent: '#C6A9A3', highlight: '#885E58', text: '#1C1C1C' },
            { name: 'Warm Pebble', bg: '#F4F1EE', accent: '#A39A92', highlight: '#645B52', text: '#1C1C1C' },
            { name: 'Dusty Coral', bg: '#FAF3F0', accent: '#D6A89A', highlight: '#B06653', text: '#1C1C1C' },
            { name: 'Almond Cocoa', bg: '#F5EFE8', accent: '#C9B29B', highlight: '#7C5A3D', text: '#1C1C1C' },
            { name: 'Blush Beige', bg: '#F6F1EF', accent: '#E2C9C0', highlight: '#A67D75', text: '#1C1C1C' },
            { name: 'Earthy Pink', bg: '#F3E5E1', accent: '#CF9D9E', highlight: '#804E50', text: '#1C1C1C' },
            { name: 'Champagne Gold', bg: '#FAF4EF', accent: '#E7D2B9', highlight: '#B18F63', text: '#1C1C1C' },
            { name: 'Neutral Blush', bg: '#F5F3F2', accent: '#D0B8AD', highlight: '#8C6A5A', text: '#1C1C1C' }
        ];

        let data = {
            currentUser: 'Builder Pro',
            userPosition: 'by REFIT Interior',
            currentView: 'home',
            projects: [],
            tasks: [],
            transactions: [],
            permanentlyDeleted: [],
            archivedProjects: [],
            expandedProjects: [],
            expandedScheduleProjects: [],
            showArchived: false,
            nightMode: false,
            themeColor: 0,
            fontSize: 'm',
            contrast: 'normal',
            saturation: 'normal',
            timelineFilter: 'all',
            scheduleView: 'month',
            calendarEvents: [],
            lastUpdated: null
        };

        let editingId = null;
        let editingType = null;
        let syncApiKey = '';
        let autoSyncInterval = null;
        let autoSyncEnabled = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            aggressiveCleanup();
            initUI();
            updateStats();
            renderView();
            initAutoSync();
            initializeLastSync();
            
            if (!navigator.onLine) {
                document.getElementById('syncMode').textContent = 'Offline';
            }
            
            document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
            
            if (data.projects.length === 0 && data.tasks.length === 0) {
                setTimeout(() => {
                    showToast('👋 Welcome to Builder Pro! Press + to get started');
                }, 1000);
            }
        });

        function aggressiveCleanup() {
            const unwantedNames = [
                'william. mock up 1',
                'fnn ice cream booth',
                'fnn meeting room 1-refreshment',
                'fnn add on ac diffuser',
                'ms ng- tmn midah. kl',
                'fnn ceo blind',
                'fnn. relocate ac thermostat',
                'ss3 winsum',
                'usj 11. nicky',
                'dsara damai. james house',
                'william mockup 2',
                'liam. production 50 crackle set',
                'william. production 50 crackle set',
                'elaine bu11/14',
                "adrian home. - d'clover residences",
                'wong n carol no 37, ss3'
            ];
            
            const beforeCount = data.projects.length;
            
            data.projects = data.projects.filter(project => {
                const projectNameLower = project.name.toLowerCase().trim();
                const shouldRemove = unwantedNames.some(unwantedName => 
                    projectNameLower === unwantedName.toLowerCase().trim() ||
                    projectNameLower.includes(unwantedName.toLowerCase().trim())
                );
                return !shouldRemove;
            });
            
            const removedCount = beforeCount - data.projects.length;
            
            if (removedCount > 0) {
                const validProjectIds = data.projects.map(p => p.id);
                data.tasks = data.tasks.filter(task => validProjectIds.includes(task.projectId));
                data.transactions = data.transactions.filter(trans => validProjectIds.includes(trans.projectId));
                saveData();
                console.log(`✅ CLEANUP: Removed ${removedCount} unwanted projects`);
            }
        }

        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                data = { ...data, ...JSON.parse(saved) };
            }
            syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';
            applySettings();
        }

        function saveData() {
            data.lastUpdated = new Date().toISOString();
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        function addTimestamps(item, isNew = false) {
            const now = new Date().toISOString();
            if (isNew) {
                item.created_at = now;
            }
            item.updated_at = now;
            return item;
        }

        function mergeByTimestamp(localItems, cloudItems, type) {
            const merged = new Map();
            
            localItems.forEach(item => {
                merged.set(item.id, { ...item, _source: 'local' });
            });
            
            cloudItems.forEach(cloudItem => {
                const localItem = merged.get(cloudItem.id);
                
                if (!localItem) {
                    merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                } else {
                    const localTime = new Date(localItem.updated_at || localItem.created_at || 0);
                    const cloudTime = new Date(cloudItem.updated_at || cloudItem.created_at || 0);
                    
                    if (cloudTime > localTime) {
                        merged.set(cloudItem.id, { ...cloudItem, _source: 'cloud' });
                    }
                }
            });
            
            const result = Array.from(merged.values()).filter(item => !item.deleted_at);
            result.forEach(item => delete item._source);
            
            return result;
        }

        function applySettings() {
            if (data.nightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('nightToggle').checked = true;
            }
            applyThemeColor(data.themeColor || 0);
            setFontSize(data.fontSize || 'm');
            setContrast(data.contrast || 'normal');
            setSaturation(data.saturation || 'normal');
            updateHeader();
        }

        function initUI() {
            initThemePicker();
            document.getElementById('deviceType').textContent = APP_CONFIG.deviceType;
        }

        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            themeColors.forEach((theme, index) => {
                const div = document.createElement('div');
                div.className = 'theme-option' + (index === (data.themeColor || 0) ? ' active' : '');
                
                const preview = document.createElement('div');
                preview.className = 'theme-preview';
                preview.style.background = `linear-gradient(135deg, ${theme.accent} 0%, ${theme.highlight} 100%)`;
                preview.innerHTML = 'Aa';
                
                const name = document.createElement('div');
                name.className = 'theme-name';
                name.textContent = theme.name;
                
                div.appendChild(preview);
                div.appendChild(name);
                div.onclick = () => selectThemeColor(index);
                
                grid.appendChild(div);
            });
        }

        function selectThemeColor(index) {
            data.themeColor = index;
            applyThemeColor(index);
            saveData();
            
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.theme-option')[index].classList.add('active');
            showToast('Theme updated: ' + themeColors[index].name);
        }

        function applyThemeColor(index) {
            const theme = themeColors[index];
            if (!document.body.classList.contains('night-mode')) {
                document.documentElement.style.setProperty('--bg-color', theme.bg);
                document.documentElement.style.setProperty('--text-color', theme.text);
            }
            document.documentElement.style.setProperty('--accent-color', theme.accent);
            document.documentElement.style.setProperty('--highlight-color', theme.highlight);
            
            document.querySelector('meta[name="theme-color"]').content = theme.accent;
        }

        function setContrast(level) {
            document.body.classList.remove('low-contrast', 'normal-contrast', 'high-contrast', 'extra-contrast');
            document.body.classList.add(level + '-contrast');
            data.contrast = level;
            saveData();
            
            document.querySelectorAll('.contrast-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === level) {
                    btn.classList.add('active');
                }
            });
            
            setSaturation(data.saturation || 'normal');
        }

        function setSaturation(level) {
            document.body.classList.remove('sat-low', 'sat-normal', 'sat-high', 'sat-vibrant');
            document.body.classList.add('sat-' + level);
            data.saturation = level;
            saveData();
            
            const saturationSection = document.querySelectorAll('.contrast-controls')[1];
            if (saturationSection) {
                saturationSection.querySelectorAll('.contrast-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === level) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function setFontSize(size) {
            document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl');
            document.body.classList.add('font-' + size);
            data.fontSize = size;
            saveData();
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            data.nightMode = document.body.classList.contains('night-mode');
            saveData();
            applyThemeColor(data.themeColor);
        }

        function updateHeader() {
            if (data.currentUser !== 'Builder Pro') {
                document.getElementById('headerName').textContent = data.currentUser;
            }
            if (data.userPosition !== 'by REFIT Interior') {
                document.getElementById('headerPosition').textContent = data.userPosition;
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const backdrop = document.getElementById('settingsBackdrop');
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                backdrop.classList.remove('show');
                document.body.style.overflow = '';
            } else {
                panel.classList.add('show');
                backdrop.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    initThemePicker();
                }, 100);
            }
        }

        function toggleFabMenu() {
            document.getElementById('fabMenu').classList.toggle('show');
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function switchView(view) {
            data.currentView = view;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderView();
        }

        function renderView() {
            const content = document.getElementById('mainContent');
            switch(data.currentView) {
                case 'home': renderHome(content); break;
                case 'kanban': renderKanban(content); break;
                case 'projects': renderProjects(content); break;
                case 'schedule': renderSchedule(content); break;
                case 'calendar': renderCalendar(content); break;
            }
        }

        function renderHome(container) {
            const income = data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-color);">💰 Finance Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Income</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--income-color);">$${income.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Expenses</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--expense-color);">$${expenses.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Profit</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${income - expenses >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">
                                $${(income - expenses).toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.projects.length > 0) {
                html += renderProjectTimeline();
            }
            
            container.innerHTML = html || '<div class="empty-state">No data yet. Click + to get started!</div>';
        }

        function renderProjectTimeline() {
            if (data.projects.length === 0) return '';
            
            const projectsWithDates = data.projects.filter(p => p.startDate && p.endDate);
            const projectsWithoutDates = data.projects.filter(p => !p.startDate || !p.endDate);
            
            let html = '<div class="gantt-container"><h3 style="font-size: 14px; margin-bottom: 15px; color: var(--text-color);">📅 Project Timeline</h3>';
            
            if (projectsWithDates.length === 0) {
                html += '<div style="padding: 10px; background: var(--bg-color); border-radius: 8px;">';
                html += '<p style="color: var(--text-secondary); margin-bottom: 10px;">No project dates set. Projects list:</p>';
                data.projects.forEach(project => {
                    html += `
                        <div style="padding: 8px; margin-bottom: 5px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid var(--accent-color); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: var(--text-color);">${project.name}</strong> - <span style="color: var(--text-secondary);">${project.client}</span>
                                ${project.locked ? ' 🔒' : ''}
                            </div>
                            <button class="icon-btn" onclick="editProject(${project.id})" ${project.locked ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>✏️</button>
                        </div>
                    `;
                });
                html += '</div></div>';
                return html;
            }
            
            let minDate = null;
            let maxDate = null;
            
            projectsWithDates.forEach(p => {
                const start = new Date(p.startDate);
                const end = new Date(p.endDate);
                if (!minDate || start < minDate) minDate = start;
                if (!maxDate || end > maxDate) maxDate = end;
            });
            
            const paddingDays = 3;
            minDate.setDate(minDate.getDate() - paddingDays);
            maxDate.setDate(maxDate.getDate() + paddingDays);
            
            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const months = [];
            let current = new Date(minDate);
            while (current <= maxDate) {
                months.push({
                    label: current.toLocaleDateString('en', { month: 'short', year: 'numeric' }),
                    start: new Date(current),
                    end: new Date(current.getFullYear(), current.getMonth() + 1, 0)
                });
                current.setMonth(current.getMonth() + 1);
            }
            
            html += '<div class="gantt-timeline-header"><div class="gantt-timeline-months">';
            months.forEach(month => {
                const monthStart = Math.max(0, Math.ceil((month.start - minDate) / (1000 * 60 * 60 * 24)));
                const monthEnd = Math.min(totalDays, Math.ceil((month.end - minDate) / (1000 * 60 * 60 * 24)) + 1);
                const width = ((monthEnd - monthStart) / totalDays) * 100;
                html += `<div class="gantt-month" style="width: ${width}%;">${month.label}</div>`;
            });
            html += '</div></div>';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (today >= minDate && today <= maxDate) {
                const todayOffset = Math.ceil((today - minDate) / (1000 * 60 * 60 * 24));
                const todayPosition = (todayOffset / totalDays) * 100;
                html += `<div class="today-line" style="left: calc(150px + ${todayPosition}%);"></div>`;
            }
            
            projectsWithDates.forEach(project => {
                const start = new Date(project.startDate);
                const end = new Date(project.endDate);
                const startOffset = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
                const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const width = (duration / totalDays) * 100;
                const left = (startOffset / totalDays) * 100;
                
                const isOverdue = end < today && !project.locked;
                const barColor = isOverdue ? 
                    'linear-gradient(135deg, #ef4444 0%, #f87171 100%)' : 
                    'linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%)';
                
                html += `
                    <div class="gantt-row">
                        <div class="gantt-label" style="display: flex; align-items: center; gap: 8px;">
                            <span title="${project.name}">${project.name} ${project.locked ? '🔒' : ''}</span>
                            <button class="icon-btn" onclick="editProject(${project.id})" 
                                    ${project.locked ? 'disabled style="opacity: 0.5; cursor: not-allowed; width: 24px; height: 24px;"' : 'style="width: 24px; height: 24px;"'}
                                    title="${project.locked ? 'Project is locked' : 'Edit project'}">✏️</button>
                        </div>
                        <div class="gantt-timeline">
                            <div class="gantt-bar" style="left: ${left}%; width: ${width}%; background: ${barColor};" 
                                 onclick="showProjectDetail(${project.id})" title="Click for details">
                                <div style="font-weight: 600;">${duration} days</div>
                                <div class="gantt-bar-dates">
                                    ${start.toLocaleDateString('en', { month: 'short', day: 'numeric' })} - 
                                    ${end.toLocaleDateString('en', { month: 'short', day: 'numeric' })}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (projectsWithoutDates.length > 0) {
                html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">';
                html += '<h4 style="font-size: 12px; margin-bottom: 10px; color: var(--text-secondary);">⚠️ Projects without dates:</h4>';
                projectsWithoutDates.forEach(project => {
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-label" style="display: flex; align-items: center; gap: 8px;">
                                <span>${project.name} ${project.locked ? '🔒' : ''}</span>
                                <button class="icon-btn" onclick="editProject(${project.id})" 
                                        ${project.locked ? 'disabled style="opacity: 0.5; cursor: not-allowed; width: 24px; height: 24px;"' : 'style="width: 24px; height: 24px;"'}>✏️</button>
                            </div>
                            <div class="gantt-timeline" style="display: flex; align-items: center; padding-left: 10px;">
                                <span style="font-size: 11px; color: var(--text-secondary);">No dates set - ${project.client}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function renderProjects(container) {
            if (data.projects.length === 0) {
                container.innerHTML = '<div class="empty-state">No projects yet. Click + to create one!</div>';
                return;
            }
            
            let html = '';
            data.projects.forEach(project => {
                const tasks = data.tasks.filter(t => t.projectId === project.id);
                const transactions = data.transactions.filter(t => t.projectId === project.id);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const incomeList = transactions.filter(t => t.type === 'income');
                const expenseList = transactions.filter(t => t.type === 'expense');
                
                html += `
                    <div class="project-card">
                        <div class="project-header" style="cursor: default;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h3 style="margin-bottom: 5px;">${project.name} ${project.locked ? '🔒' : ''}</h3>
                                    <div style="font-size: 11px; opacity: 0.9;">Client: ${project.client}</div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="action-btn" onclick="editProject(${project.id})" ${project.locked ? 'disabled' : ''}>
                                        ${project.locked ? 'Locked' : 'Edit'}
                                    </button>
                                    <button class="action-btn" onclick="toggleProjectLock(${project.id})">
                                        ${project.locked ? 'Unlock' : 'Lock'}
                                    </button>
                                    <button class="action-btn" onclick="permanentDeleteProject(${project.id})">Delete</button>
                                </div>
                            </div>
                            
                            <div class="project-stats">
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; opacity: 0.8;">Tasks</div>
                                    <div style="font-size: 13px; font-weight: bold;">${tasks.length}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; opacity: 0.8;">Income</div>
                                    <div style="font-size: 13px; font-weight: bold; color: #4ade80;">${income.toFixed(0)}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; opacity: 0.8;">Profit</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${income - expenses >= 0 ? '#4ade80' : '#f87171'};">
                                        ${(income - expenses).toFixed(0)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tasks Section -->
                        <div style="padding: 12px; background: var(--bg-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 13px; color: var(--text-color); margin: 0;">📋 Tasks (${tasks.length})</h4>
                                <button class="btn btn-primary" onclick="showTaskModal(); document.getElementById('taskProject').value = ${project.id};" style="padding: 4px 10px; font-size: 11px;">+ Add Task</button>
                            </div>
                            ${tasks.length === 0 ? '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 12px;">No tasks yet</div>' : ''}
                            ${tasks.map(task => `
                                <div class="task-item" style="margin-bottom: 6px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-color); font-size: 12px;">${task.name}</div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            📅 ${task.dueDate} • ${task.priority} • ${task.status}
                                            ${task.assignee ? ` • 👤 ${task.assignee}` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="icon-btn" onclick="editTask(${task.id})" style="width: 26px; height: 26px; font-size: 11px;">✏️</button>
                                        <button class="icon-btn danger" onclick="deleteTask(${task.id})" style="width: 26px; height: 26px; font-size: 11px;">🗑️</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Income Section -->
                        <div style="padding: 12px; background: var(--card-bg); border-top: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 13px; color: var(--income-color); margin: 0;">💰 Income (${incomeList.length}) - ${income.toFixed(2)}</h4>
                                <button class="btn btn-success" onclick="showTransactionModal('income'); document.getElementById('transProject').value = ${project.id};" style="padding: 4px 10px; font-size: 11px;">+ Add Income</button>
                            </div>
                            ${incomeList.length === 0 ? '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 12px;">No income yet</div>' : ''}
                            ${incomeList.map(trans => `
                                <div style="padding: 8px; margin-bottom: 6px; background: var(--bg-color); border-radius: 6px; border-left: 3px solid var(--income-color); display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-color); font-size: 12px;">${trans.amount.toFixed(2)} - ${trans.category}</div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            📅 ${trans.date}${trans.description ? ` • ${trans.description}` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="icon-btn" onclick="editTransaction(${trans.id})" style="width: 26px; height: 26px; font-size: 11px;">✏️</button>
                                        <button class="icon-btn danger" onclick="deleteTransaction(${trans.id})" style="width: 26px; height: 26px; font-size: 11px;">🗑️</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Expenses Section -->
                        <div style="padding: 12px; background: var(--bg-color); border-top: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="font-size: 13px; color: var(--expense-color); margin: 0;">💸 Expenses (${expenseList.length}) - ${expenses.toFixed(2)}</h4>
                                <button class="btn btn-danger" onclick="showTransactionModal('expense'); document.getElementById('transProject').value = ${project.id};" style="padding: 4px 10px; font-size: 11px;">+ Add Expense</button>
                            </div>
                            ${expenseList.length === 0 ? '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 12px;">No expenses yet</div>' : ''}
                            ${expenseList.map(trans => `
                                <div style="padding: 8px; margin-bottom: 6px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid var(--expense-color); display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-color); font-size: 12px;">${trans.amount.toFixed(2)} - ${trans.category}</div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            📅 ${trans.date}${trans.description ? ` • ${trans.description}` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="icon-btn" onclick="editTransaction(${trans.id})" style="width: 26px; height: 26px; font-size: 11px;">✏️</button>
                                        <button class="icon-btn danger" onclick="deleteTransaction(${trans.id})" style="width: 26px; height: 26px; font-size: 11px;">🗑️</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function editTransaction(id) {
            const trans = data.transactions.find(t => t.id === id);
            if (!trans) return;
            
            editingId = id;
            editingType = 'transaction';
            document.getElementById('transactionModalTitle').textContent = `Edit ${trans.type === 'income' ? 'Income' : 'Expense'}`;
            document.getElementById('transType').value = trans.type;
            document.getElementById('transAmount').value = trans.amount;
            document.getElementById('transDate').value = trans.date;
            document.getElementById('transDescription').value = trans.description || '';
            
            const select = document.getElementById('transProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            select.value = trans.projectId;
            
            updateCategories();
            document.getElementById('transCategory').value = trans.category;
            
            document.getElementById('transactionModal').classList.add('show');
        }

        function deleteTransaction(id) {
            const trans = data.transactions.find(t => t.id === id);
            if (!trans) return;
            
            if (confirm(`⚠️ Delete ${trans.type} of ${trans.amount.toFixed(2)}?`)) {
                const now = new Date().toISOString();
                trans.deleted_at = now;
                data.transactions = data.transactions.filter(t => t.id !== id);
                
                saveData();
                renderView();
                updateStats();
                showToast('Transaction deleted');
            }
        }

        function renderSchedule(container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate 18 months forward from today
            const minDate = new Date(today);
            minDate.setDate(1); // Start of current month
            const maxDate = new Date(today);
            maxDate.setMonth(maxDate.getMonth() + 18);
            maxDate.setDate(0); // End of 18 months forward
            
            const projectsWithDates = data.projects.filter(p => p.startDate && p.endDate);
            const projectsWithoutDates = data.projects.filter(p => !p.startDate || !p.endDate);
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color);">
                    <h3 style="font-size: 14px; margin: 0; color: var(--text-color);">📊 18-Month Project Timeline</h3>
                    <button class="btn btn-primary" onclick="showProjectModal()" style="padding: 6px 12px; font-size: 12px;">+ New Project</button>
                </div>
            `;
            
            if (projectsWithDates.length === 0) {
                html += '<div class="empty-state">No projects with dates yet. Add start and end dates to your projects!</div>';
                container.innerHTML = html;
                return;
            }
            
            // Extend minDate and maxDate to include all project dates
            projectsWithDates.forEach(p => {
                const start = new Date(p.startDate);
                const end = new Date(p.endDate);
                if (start < minDate) minDate.setTime(start.getTime());
                if (end > maxDate) maxDate.setTime(end.getTime());
            });
            
            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Generate months for header
            const months = [];
            let current = new Date(minDate);
            while (current <= maxDate) {
                const monthStart = new Date(current.getFullYear(), current.getMonth(), 1);
                const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 0);
                months.push({
                    label: current.toLocaleDateString('en', { month: 'short', year: 'numeric' }),
                    start: monthStart,
                    end: monthEnd
                });
                current.setMonth(current.getMonth() + 1);
            }
            
            html += '<div class="gantt-container" style="position: relative;">';
            
            // Render month headers
            html += '<div class="gantt-timeline-header"><div class="gantt-timeline-months">';
            months.forEach(month => {
                const monthStart = Math.max(0, Math.ceil((month.start - minDate) / (1000 * 60 * 60 * 24)));
                const monthEnd = Math.min(totalDays, Math.ceil((month.end - minDate) / (1000 * 60 * 60 * 24)) + 1);
                const width = ((monthEnd - monthStart) / totalDays) * 100;
                html += `<div class="gantt-month" style="width: ${width}%;">${month.label}</div>`;
            });
            html += '</div></div>';
            
            // Add TODAY line
            if (today >= minDate && today <= maxDate) {
                const todayOffset = Math.ceil((today - minDate) / (1000 * 60 * 60 * 24));
                const todayPosition = (todayOffset / totalDays) * 100;
                html += `<div class="today-line" style="left: calc(150px + ${todayPosition}%);"></div>`;
            }
            
            // Sort projects by start date
            const sortedProjects = projectsWithDates.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            // Render all projects
            sortedProjects.forEach(project => {
                const start = new Date(project.startDate);
                const end = new Date(project.endDate);
                const tasks = data.tasks.filter(t => t.projectId === project.id);
                const isExpanded = data.expandedScheduleProjects?.includes(project.id);
                
                const startOffset = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
                const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const width = (duration / totalDays) * 100;
                const left = (startOffset / totalDays) * 100;
                
                const isOverdue = end < today && !project.locked;
                const barColor = isOverdue ? 
                    'linear-gradient(135deg, #ef4444 0%, #f87171 100%)' : 
                    'linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%)';
                
                html += `
                    <div style="margin-bottom: ${isExpanded ? '20px' : '8px'};">
                        <div class="gantt-row">
                            <div class="gantt-label" style="display: flex; align-items: center; gap: 8px;">
                                <span title="${project.name}">${project.name} ${project.locked ? '🔒' : ''}</span>
                                <div style="display: flex; gap: 3px;">
                                    <button class="icon-btn" onclick="editProject(${project.id})" 
                                            ${project.locked ? 'disabled style="opacity: 0.5; cursor: not-allowed; width: 22px; height: 22px; font-size: 10px;"' : 'style="width: 22px; height: 22px; font-size: 10px;"'}
                                            title="${project.locked ? 'Project is locked' : 'Edit project'}">✏️</button>
                                    <button class="icon-btn danger" onclick="permanentDeleteProject(${project.id})" style="width: 22px; height: 22px; font-size: 10px;" title="Delete project">🗑️</button>
                                </div>
                            </div>
                            <div class="gantt-timeline">
                                <div class="gantt-bar" style="left: ${left}%; width: ${width}%; background: ${barColor};" 
                                     onclick="toggleScheduleProjectExpand(${project.id})" title="Click to see tasks">
                                    <div style="font-weight: 600; font-size: 10px;">${duration}d • ${tasks.length} tasks</div>
                                    <div class="gantt-bar-dates" style="font-size: 9px;">
                                        ${start.toLocaleDateString('en', { month: 'short', day: 'numeric' })} - 
                                        ${end.toLocaleDateString('en', { month: 'short', day: 'numeric' })}
                                    </div>
                                </div>
                            </div>
                        </div>
                
                        ${isExpanded ? renderScheduleTasksGantt(tasks, project, minDate, totalDays) : ''}
                    </div>
                `;
            });
            
            // Show projects without dates
            if (projectsWithoutDates.length > 0) {
                html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border-color);">';
                html += '<h4 style="font-size: 12px; margin-bottom: 10px; color: var(--text-secondary);">⚠️ Projects without dates:</h4>';
                projectsWithoutDates.forEach(project => {
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-label" style="display: flex; align-items: center; gap: 8px;">
                                <span>${project.name} ${project.locked ? '🔒' : ''}</span>
                                <div style="display: flex; gap: 3px;">
                                    <button class="icon-btn" onclick="editProject(${project.id})" 
                                            ${project.locked ? 'disabled style="opacity: 0.5; cursor: not-allowed; width: 22px; height: 22px; font-size: 10px;"' : 'style="width: 22px; height: 22px; font-size: 10px;"'}>✏️</button>
                                    <button class="icon-btn danger" onclick="permanentDeleteProject(${project.id})" style="width: 22px; height: 22px; font-size: 10px;">🗑️</button>
                                </div>
                            </div>
                            <div class="gantt-timeline" style="display: flex; align-items: center; padding-left: 10px;">
                                <span style="font-size: 11px; color: var(--text-secondary);">No dates set - ${project.client}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderScheduleTasksGantt(tasks, project, minDate, totalDays) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (tasks.length === 0) {
                return `
                    <div style="margin-left: 150px; padding: 10px; background: var(--bg-color); border-radius: 6px; margin-top: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 11px; color: var(--text-secondary);">No tasks yet</span>
                            <button class="btn btn-primary" onclick="showTaskModal(); document.getElementById('taskProject').value = ${project.id};" style="padding: 4px 8px; font-size: 10px;">+ Add Task</button>
                        </div>
                    </div>
                `;
            }
            
            let html = `
                <div style="margin-left: 150px; padding: 10px; background: var(--bg-color); border-radius: 6px; margin-top: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="font-size: 11px; margin: 0; color: var(--text-color);">📋 Tasks (${tasks.length})</h5>
                        <button class="btn btn-primary" onclick="showTaskModal(); document.getElementById('taskProject').value = ${project.id};" style="padding: 4px 8px; font-size: 10px;">+ Add Task</button>
                    </div>
            `;
            
            tasks.forEach(task => {
                const startDate = task.startDate ? new Date(task.startDate) : new Date(task.dueDate);
                const dueDate = new Date(task.dueDate);
                
                const startOffset = Math.max(0, Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24)));
                const duration = Math.ceil((dueDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const width = Math.max((duration / totalDays) * 100, 2);
                const left = (startOffset / totalDays) * 100;
                
                let barColor = 'linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%)';
                if (task.status === 'Completed') barColor = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                else if (task.status === 'In Progress') barColor = 'linear-gradient(135deg, #f39c12 0%, #f9c74f 100%)';
                else if (dueDate < today) barColor = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
                
                html += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; gap: 8px;">
                        <div style="min-width: 100px; font-size: 10px; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${task.name}">${task.name}</div>
                        <div style="flex: 1; position: relative; height: 30px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                            <div style="position: absolute; left: ${left}%; width: ${width}%; height: 100%; background: ${barColor}; border-radius: 4px; display: flex; align-items: center; justify-content: center; padding: 0 5px; color: white; font-size: 8px; font-weight: 500; cursor: pointer;" onclick="editTask(${task.id})" title="${task.priority} - ${task.status}">
                                ${duration}d
                            </div>
                        </div>
                        <div style="display: flex; gap: 3px;">
                            <button class="icon-btn" onclick="editTask(${task.id})" style="width: 22px; height: 22px; font-size: 10px;" title="Edit">✏️</button>
                            <button class="icon-btn danger" onclick="deleteTask(${task.id})" style="width: 22px; height: 22px; font-size: 10px;" title="Delete">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function toggleScheduleProjectExpand(projectId) {
            if (!data.expandedScheduleProjects) {
                data.expandedScheduleProjects = [];
            }
            
            const index = data.expandedScheduleProjects.indexOf(projectId);
            if (index > -1) {
                data.expandedScheduleProjects.splice(index, 1);
            } else {
                data.expandedScheduleProjects.push(projectId);
            }
            
            saveData();
            renderView();
        }

        function setScheduleView(view) {
            data.scheduleView = view;
            saveData();
            renderView();
        }

        function renderKanban(container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dueTasks = data.tasks.filter(t => {
                const dueDate = new Date(t.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate <= today && t.status !== 'Completed';
            });
            
            const inProgressTasks = data.tasks.filter(t => t.status === 'In Progress');
            const getReadyTasks = data.tasks.filter(t => 
                (t.status === 'Get Ready' || !t.status) && !dueTasks.includes(t)
            );
            
            const columns = [
                { title: 'Due', status: 'Due', tasks: dueTasks, color: '#ef4444' },
                { title: 'In Progress', status: 'In Progress', tasks: inProgressTasks, color: '#f39c12' },
                { title: 'Get Ready', status: 'Get Ready', tasks: getReadyTasks, color: 'var(--accent-color)' }
            ];
            
            let html = '<div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">';
            columns.forEach(column => {
                html += `
                    <div style="min-width: 280px; background: var(--card-bg); border-radius: 10px; padding: 10px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <h3 style="font-size: 14px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid ${column.color}; color: ${column.color};">
                            ${column.title} (${column.tasks.length})
                        </h3>
                        <div style="min-height: 100px;">
                `;
                
                column.tasks.forEach(task => {
                    const project = data.projects.find(p => p.id === task.projectId);
                    
                    html += `
                        <div style="background: var(--bg-color); padding: 10px; border-radius: 8px; margin-bottom: 8px; 
                                    border-left: 3px solid ${column.color};">
                            <div style="font-weight: 500; margin-bottom: 5px; color: var(--text-color);">${task.name}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                ${project ? project.name : 'No Project'}
                            </div>
                            <div style="font-size: 10px; margin-top: 5px; color: var(--text-secondary);">
                                📅 ${task.dueDate} • ${task.priority} Priority
                                ${task.assignee ? ` • 👤 ${task.assignee}` : ''}
                            </div>
                            <div style="display: flex; gap: 4px; margin-top: 8px;">
                                <button class="btn btn-secondary" onclick="editTask(${task.id});" 
                                        style="padding: 4px 8px; font-size: 11px;">✏️ Edit</button>
                                <button class="btn btn-secondary" onclick="completeTask(${task.id});" 
                                        style="padding: 4px 8px; font-size: 11px;">✅</button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderCalendar(container) {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let html = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3 style="font-size: 16px; color: var(--text-color);">
                            ${today.toLocaleDateString('en', { month: 'long', year: 'numeric' })}
                        </h3>
                        <button class="sync-calendar-btn" onclick="syncToiPhoneCalendar()">
                            📱 Sync to iPhone Calendar
                        </button>
                    </div>
                    
                    <div class="calendar-grid">
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Sun</div>
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Mon</div>
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Tue</div>
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Wed</div>
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Thu</div>
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Fri</div>
                        <div style="font-weight: bold; text-align: center; color: var(--text-secondary);">Sat</div>
            `;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                
                const dayTasks = data.tasks.filter(t => {
                    return t.dueDate === dateStr || t.startDate === dateStr;
                });
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''} ${dayTasks.length > 0 ? 'has-event' : ''}" 
                             onclick="showDayDetail('${dateStr}')" title="Click to view details">
                    <div style="font-weight: bold;">${day}</div>`;
                
                if (dayTasks.length > 0) {
                    dayTasks.slice(0, 2).forEach(task => {
                        html += `<div class="calendar-event" title="${task.name}">${task.name.substring(0, 10)}</div>`;
                    });
                    if (dayTasks.length > 2) {
                        html += `<div style="font-size: 9px; color: ${isToday ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'};">+${dayTasks.length - 2} more</div>`;
                    }
                }
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add Smart Analytics below calendar
            html += renderCalendarAnalytics();
            
            container.innerHTML = html;
        }

        function renderCalendarAnalytics() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const analytics = analyzeSchedule();
            
            let html = `
                <div style="margin-top: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-color);">🧠 Smart Schedule Analytics</h3>
                    
                    <!-- Available Time -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">📅</span>
                            <h4 style="font-size: 14px; margin: 0; color: var(--text-color);">Available Time (Next 30 Days)</h4>
                        </div>
                        ${renderAvailableDates(analytics.availableDates)}
                    </div>
                    
                    <!-- Overwhelming Dates -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">🔥</span>
                            <h4 style="font-size: 14px; margin: 0; color: var(--text-color);">Overwhelming Dates (Multiple Projects Overlapping)</h4>
                        </div>
                        ${renderOverwhelmingDates(analytics.overwhelmingDates)}
                    </div>
                    
                    <!-- Suggested Breaks -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">🏖️</span>
                            <h4 style="font-size: 14px; margin: 0; color: var(--text-color);">Suggested Break Days</h4>
                        </div>
                        ${renderSuggestedBreaks(analytics.suggestedBreaks)}
                    </div>
                    
                    <!-- Fun Insights -->
                    <div style="background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px var(--shadow-color); color: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">🎉</span>
                            <h4 style="font-size: 14px; margin: 0;">Fun Stats & Insights</h4>
                        </div>
                        ${renderFunInsights(analytics)}
                    </div>
                </div>
            `;
            
            return html;
        }

        function analyzeSchedule() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const next30Days = new Date(today);
            next30Days.setDate(today.getDate() + 30);
            
            const next90Days = new Date(today);
            next90Days.setDate(today.getDate() + 90);
            
            // Analyze each day
            const dailyLoad = {};
            const availableDates = [];
            const overwhelmingDates = [];
            
            // Get active projects
            const activeProjects = data.projects.filter(p => {
                if (!p.startDate || !p.endDate) return false;
                const start = new Date(p.startDate);
                const end = new Date(p.endDate);
                return end >= today;
            });
            
            // Analyze next 90 days
            for (let d = new Date(today); d <= next90Days; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const currentDate = new Date(d);
                
                // Count overlapping projects
                const overlappingProjects = activeProjects.filter(p => {
                    const start = new Date(p.startDate);
                    const end = new Date(p.endDate);
                    return currentDate >= start && currentDate <= end;
                });
                
                // Count tasks due
                const tasksDue = data.tasks.filter(t => t.dueDate === dateStr && t.status !== 'Completed');
                
                const load = {
                    date: new Date(currentDate),
                    dateStr: dateStr,
                    projects: overlappingProjects.length,
                    tasks: tasksDue.length,
                    totalLoad: overlappingProjects.length + tasksDue.length,
                    projectNames: overlappingProjects.map(p => p.name)
                };
                
                dailyLoad[dateStr] = load;
                
                // Available dates (within next 30 days, no projects, no tasks)
                if (currentDate <= next30Days && load.totalLoad === 0) {
                    availableDates.push(load);
                }
                
                // Overwhelming dates (3+ projects overlapping)
                if (load.projects >= 3) {
                    overwhelmingDates.push(load);
                }
            }
            
            // Suggest breaks (find consecutive available dates)
            const suggestedBreaks = findBreakPeriods(availableDates, dailyLoad);
            
            return {
                availableDates: availableDates.slice(0, 10),
                overwhelmingDates: overwhelmingDates.slice(0, 10),
                suggestedBreaks: suggestedBreaks,
                dailyLoad: dailyLoad,
                stats: {
                    totalProjects: activeProjects.length,
                    avgDailyLoad: Object.values(dailyLoad).reduce((sum, d) => sum + d.totalLoad, 0) / Object.keys(dailyLoad).length,
                    busiestDay: Object.values(dailyLoad).sort((a, b) => b.totalLoad - a.totalLoad)[0],
                    quietestDay: Object.values(dailyLoad).filter(d => d.totalLoad > 0).sort((a, b) => a.totalLoad - b.totalLoad)[0]
                }
            };
        }

        function findBreakPeriods(availableDates, dailyLoad) {
            const breaks = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find periods of 2-3 consecutive available days
            for (let i = 0; i < availableDates.length - 1; i++) {
                const current = availableDates[i];
                const next = availableDates[i + 1];
                
                const dayDiff = Math.ceil((next.date - current.date) / (1000 * 60 * 60 * 24));
                
                if (dayDiff === 1) {
                    // Consecutive days found
                    const breakStart = new Date(current.date);
                    let breakEnd = new Date(next.date);
                    let consecutiveDays = 2;
                    
                    // Check if more consecutive days
                    for (let j = i + 2; j < availableDates.length; j++) {
                        const nextDay = availableDates[j];
                        const nextDiff = Math.ceil((nextDay.date - breakEnd) / (1000 * 60 * 60 * 24));
                        if (nextDiff === 1) {
                            breakEnd = new Date(nextDay.date);
                            consecutiveDays++;
                            if (consecutiveDays >= 3) break; // Max 3 days
                        } else {
                            break;
                        }
                    }
                    
                    if (consecutiveDays >= 2 && breakStart > today) {
                        breaks.push({
                            start: breakStart,
                            end: breakEnd,
                            days: consecutiveDays,
                            activities: generateActivitySuggestions(breakStart, consecutiveDays)
                        });
                        
                        if (breaks.length >= 3) break; // Only suggest 3 break periods
                    }
                }
            }
            
            return breaks;
        }

        function generateActivitySuggestions(date, days) {
            const activities = [
                {
                    type: 'Beach Getaway 🏖️',
                    locations: ['Langkawi', 'Penang', 'Port Dickson'],
                    description: 'Relax by the sea, enjoy water sports, and fresh seafood'
                },
                {
                    type: 'Mountain Retreat 🏔️',
                    locations: ['Cameron Highlands', 'Genting Highlands', 'Fraser\'s Hill'],
                    description: 'Cool weather, tea plantations, and hiking trails'
                },
                {
                    type: 'City Exploration 🏙️',
                    locations: ['Georgetown Penang', 'Melaka', 'Ipoh'],
                    description: 'Heritage sites, street food, and cultural experiences'
                },
                {
                    type: 'Nature Adventure 🌲',
                    locations: ['Taman Negara', 'Kinabalu Park', 'Endau-Rompin'],
                    description: 'Jungle trekking, wildlife spotting, and camping'
                },
                {
                    type: 'Spa & Wellness 🧘',
                    locations: ['The Banjaran Ipoh', 'Gaya Island Resort', 'Pangkor Laut'],
                    description: 'Massage, yoga, meditation, and healthy dining'
                },
                {
                    type: 'Food Paradise 🍜',
                    locations: ['Jalan Alor KL', 'Gurney Drive Penang', 'Jonker Street Melaka'],
                    description: 'Street food tours, local delicacies, and night markets'
                },
                {
                    type: 'Shopping Spree 🛍️',
                    locations: ['Pavilion KL', 'Mid Valley', 'Johor Premium Outlets'],
                    description: 'Retail therapy, luxury brands, and great deals'
                },
                {
                    type: 'Theme Park Fun 🎢',
                    locations: ['Sunway Lagoon', 'Legoland Johor', 'Lost World Tambun'],
                    description: 'Roller coasters, water slides, and family fun'
                }
            ];
            
            // Randomly select 3 activities
            const shuffled = activities.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 3);
        }

        function renderAvailableDates(dates) {
            if (dates.length === 0) {
                return '<p style="font-size: 12px; color: var(--text-secondary); text-align: center;">No completely free days in the next 30 days. You\'re fully booked! 💪</p>';
            }
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
            dates.forEach(day => {
                const dayName = day.date.toLocaleDateString('en', { weekday: 'short' });
                const dateStr = day.date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                html += `
                    <div style="padding: 8px 12px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; border-radius: 6px; font-size: 11px; text-align: center;">
                        <div style="font-weight: bold;">${dayName}</div>
                        <div style="font-size: 10px; opacity: 0.9;">${dateStr}</div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderOverwhelmingDates(dates) {
            if (dates.length === 0) {
                return '<p style="font-size: 12px; color: var(--text-secondary); text-align: center;">No overwhelming dates detected. Your workload looks manageable! 👍</p>';
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            dates.forEach(day => {
                const dateStr = day.date.toLocaleDateString('en', { weekday: 'long', month: 'long', day: 'numeric' });
                html += `
                    <div style="padding: 10px; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); color: white; border-radius: 6px;">
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">⚠️ ${dateStr}</div>
                        <div style="font-size: 11px; opacity: 0.9;">${day.projects} projects overlapping${day.tasks > 0 ? ` + ${day.tasks} tasks due` : ''}</div>
                        <div style="font-size: 10px; margin-top: 5px; opacity: 0.8;">Projects: ${day.projectNames.join(', ')}</div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderSuggestedBreaks(breaks) {
            if (breaks.length === 0) {
                return '<p style="font-size: 12px; color: var(--text-secondary); text-align: center;">No consecutive free days found. Consider scheduling some downtime! 🙏</p>';
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            breaks.forEach((breakPeriod, index) => {
                const startStr = breakPeriod.start.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                const endStr = breakPeriod.end.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                
                html += `
                    <div style="padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; border-radius: 8px;">
                        <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px;">
                            🏖️ Break Period ${index + 1}: ${startStr} - ${endStr} (${breakPeriod.days} days)
                        </div>
                        <div style="font-size: 11px; margin-bottom: 10px; opacity: 0.9;">
                            Perfect time for a short getaway! Here are some suggestions:
                        </div>
                        ${breakPeriod.activities.map((activity, i) => `
                            <div style="padding: 8px; background: rgba(255,255,255,0.2); border-radius: 6px; margin-bottom: ${i < breakPeriod.activities.length - 1 ? '8px' : '0'};">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px;">${activity.type}</div>
                                <div style="font-size: 10px; margin-bottom: 4px;">📍 ${activity.locations.join(' • ')}</div>
                                <div style="font-size: 10px; opacity: 0.8;">${activity.description}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderFunInsights(analytics) {
            const stats = analytics.stats;
            const motivationalQuotes = [
                '"Success is the sum of small efforts repeated day in and day out." - Robert Collier',
                '"The key is not to prioritize your schedule, but to schedule your priorities." - Stephen Covey',
                '"Time is what we want most, but what we use worst." - William Penn',
                '"Don\'t watch the clock; do what it does. Keep going." - Sam Levenson',
                '"The bad news is time flies. The good news is you\'re the pilot." - Michael Altshuler'
            ];
            
            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            
            let html = `
                <div style="font-size: 12px; line-height: 1.6;">
                    <div style="margin-bottom: 10px;">
                        <strong>📊 Your Work Stats:</strong><br>
                        • Active Projects: ${stats.totalProjects}<br>
                        • Average Daily Load: ${stats.avgDailyLoad.toFixed(1)} projects/tasks per day<br>
                        ${stats.busiestDay ? `• Busiest Day: ${stats.busiestDay.date.toLocaleDateString('en', { month: 'short', day: 'numeric' })} (${stats.busiestDay.totalLoad} items)<br>` : ''}
                        ${stats.quietestDay ? `• Quietest Work Day: ${stats.quietestDay.date.toLocaleDateString('en', { month: 'short', day: 'numeric' })} (${stats.quietestDay.totalLoad} items)` : ''}
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                        <strong>💪 Productivity Tip:</strong><br>
                        ${getProductivityTip(stats)}
                    </div>
                    
                    <div style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-style: italic; font-size: 11px;">
                        ${randomQuote}
                    </div>
                </div>
            `;
            
            return html;
        }

        function getProductivityTip(stats) {
            if (stats.avgDailyLoad > 5) {
                return 'Your schedule is quite packed! Consider delegating some tasks or extending project timelines to avoid burnout.';
            } else if (stats.avgDailyLoad < 2) {
                return 'You have capacity for more projects! This is a great time to take on new opportunities or focus on business growth.';
            } else {
                return 'Your workload looks balanced! Keep up the great time management. Remember to schedule regular breaks.';
            }
        }

        function syncToiPhoneCalendar() {
            let icsContent = 'BEGIN:VCALENDAR\n';
            icsContent += 'VERSION:2.0\n';
            icsContent += 'PRODID:-//Builder Pro//REFIT Interior//EN\n';
            icsContent += 'CALSCALE:GREGORIAN\n';
            icsContent += 'METHOD:PUBLISH\n';
            
            data.tasks.forEach(task => {
                if (task.dueDate) {
                    const project = data.projects.find(p => p.id === task.projectId);
                    const startDate = task.startDate || task.dueDate;
                    const dueDate = task.dueDate;
                    
                    const formatDate = (dateStr) => dateStr.replace(/-/g, '');
                    
                    icsContent += 'BEGIN:VEVENT\n';
                    icsContent += `UID:${task.id}@builderproapp.com\n`;
                    icsContent += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                    icsContent += `DTSTART:${formatDate(startDate)}\n`;
                    icsContent += `DTEND:${formatDate(dueDate)}\n`;
                    icsContent += `SUMMARY:${task.name}\n`;
                    icsContent += `DESCRIPTION:Project: ${project ? project.name : 'None'}\\nPriority: ${task.priority}\\nStatus: ${task.status}${task.assignee ? '\\nAssignee: ' + task.assignee : ''}\n`;
                    icsContent += `LOCATION:${project ? project.client : 'Builder Pro'}\n`;
                    icsContent += `STATUS:${task.status === 'Completed' ? 'COMPLETED' : 'CONFIRMED'}\n`;
                    icsContent += `LAST-MODIFIED:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                    icsContent += 'END:VEVENT\n';
                }
            });
            
            icsContent += 'END:VCALENDAR';
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-calendar.ics';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('📱 Calendar file created! Open it on your iPhone to sync.');
        }

        function showDayDetail(dateStr) {
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('en', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('dayDetailTitle').textContent = formattedDate;
            
            const dayTasks = data.tasks.filter(t => {
                return t.dueDate === dateStr || t.startDate === dateStr;
            });
            
            let html = '';
            
            if (dayTasks.length === 0) {
                html = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📅</div>
                        <p>No tasks scheduled for this day</p>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="closeModal('dayDetailModal'); showTaskModal();">
                            + Add Task
                        </button>
                    </div>
                `;
            } else {
                html += '<div style="background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 15px;">';
                html += `<h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">📋 Tasks for this day (${dayTasks.length})</h4></div>`;
                
                dayTasks.forEach(task => {
                    const project = data.projects.find(p => p.id === task.projectId);
                    const isCompleted = task.status === 'Completed';
                    
                    html += `
                        <div class="task-item" style="margin-bottom: 8px; ${isCompleted ? 'opacity: 0.7;' : ''}">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: var(--text-color); ${isCompleted ? 'text-decoration: line-through;' : ''}">${task.name}</div>
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                                    📁 ${project ? project.name : 'No Project'} • 
                                    ${task.priority} Priority • 
                                    ${task.status}
                                    ${task.assignee ? ` • 👤 ${task.assignee}` : ''}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <button class="icon-btn" onclick="closeModal('dayDetailModal'); editTask(${task.id});">✏️</button>
                                ${!isCompleted ? `
                                    <button class="icon-btn" style="background: var(--success);" onclick="completeTask(${task.id}); showDayDetail('${dateStr}');">✅</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('dayDetailBody').innerHTML = html;
            document.getElementById('dayDetailModal').classList.add('show');
        }

        function updateStats() {
            document.getElementById('totalProjects').textContent = data.projects.length;
            document.getElementById('totalTasks').textContent = data.tasks.length;
            
            const income = data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('totalIncome').textContent = '$' + income.toFixed(0);
            document.getElementById('totalExpenses').textContent = '$' + expenses.toFixed(0);
        }

        function showProfileModal() {
            document.getElementById('profileName').value = data.currentUser;
            document.getElementById('profilePosition').value = data.userPosition;
            document.getElementById('profileModal').classList.add('show');
        }

        function saveProfile() {
            data.currentUser = document.getElementById('profileName').value || 'Builder Pro';
            data.userPosition = document.getElementById('profilePosition').value || 'by REFIT Interior';
            updateHeader();
            saveData();
            closeModal('profileModal');
            showToast('Profile updated');
        }

        function showProjectModal() {
            editingId = null;
            editingType = 'project';
            document.getElementById('projectModalTitle').textContent = 'New Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectClient').value = '';
            document.getElementById('projectStart').value = '';
            document.getElementById('projectEnd').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectLocked').checked = false;
            document.getElementById('projectModal').classList.add('show');
            toggleFabMenu();
        }

        function editProject(id) {
            const project = data.projects.find(p => p.id === id);
            if (!project || project.locked) return;
            
            editingId = id;
            editingType = 'project';
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectClient').value = project.client;
            document.getElementById('projectStart').value = project.startDate || '';
            document.getElementById('projectEnd').value = project.endDate || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectLocked').checked = project.locked || false;
            document.getElementById('projectModal').classList.add('show');
        }

        function saveProject() {
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                client: document.getElementById('projectClient').value.trim(),
                startDate: document.getElementById('projectStart').value,
                endDate: document.getElementById('projectEnd').value,
                description: document.getElementById('projectDescription').value.trim(),
                locked: document.getElementById('projectLocked').checked
            };
            
            if (!projectData.name || !projectData.client) {
                showToast('Please fill required fields');
                return;
            }
            
            if (editingId) {
                const index = data.projects.findIndex(p => p.id === editingId);
                data.projects[index] = addTimestamps({ 
                    ...data.projects[index], 
                    ...projectData 
                }, false);
                showToast('Project updated');
            } else {
                projectData.id = Date.now();
                data.projects.push(addTimestamps(projectData, true));
                showToast('Project created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('projectModal');
        }

        function permanentDeleteProject(id) {
            const project = data.projects.find(p => p.id === id);
            if (!project) return;
            
            if (confirm(`⚠️ Permanently delete project "${project.name}"?\n\nThis will delete all associated tasks and transactions.\n\nThis action CANNOT be undone.`)) {
                const now = new Date().toISOString();
                
                if (!data.permanentlyDeleted) data.permanentlyDeleted = [];
                data.permanentlyDeleted.push({ 
                    id, 
                    type: 'project', 
                    deletedAt: now,
                    name: project.name 
                });
                
                data.projects = data.projects.filter(p => p.id !== id);
                
                data.tasks.forEach(task => {
                    if (task.projectId === id) {
                        task.deleted_at = now;
                    }
                });
                data.tasks = data.tasks.filter(t => t.projectId !== id);
                
                data.transactions.forEach(trans => {
                    if (trans.projectId === id) {
                        trans.deleted_at = now;
                    }
                });
                data.transactions = data.transactions.filter(t => t.projectId !== id);
                
                saveData();
                renderView();
                updateStats();
                showToast(`Project "${project.name}" permanently deleted`);
            }
        }

        function toggleProjectLock(id) {
            const project = data.projects.find(p => p.id === id);
            if (project) {
                project.locked = !project.locked;
                addTimestamps(project, false);
                saveData();
                renderView();
                showToast(project.locked ? 'Project locked' : 'Project unlocked');
            }
        }

        function showProjectDetail(projectId) {
            const project = data.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const tasks = data.tasks.filter(t => t.projectId === projectId);
            const transactions = data.transactions.filter(t => t.projectId === projectId);
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expenses;
            
            document.getElementById('projectDetailTitle').textContent = project.name + (project.locked ? ' 🔒' : '');
            
            let html = `
                <div style="background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">📋 Project Info</h4>
                    <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                        <div><strong>Client:</strong> ${project.client}</div>
                        ${project.description ? `<div style="margin-top: 8px;"><strong>Description:</strong><br>${project.description}</div>` : ''}
                    </div>
                </div>
                
                <div style="background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">💰 Finance Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Income</div>
                            <div style="font-size: 16px; font-weight: bold; color: var(--income-color);">$${income.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Expenses</div>
                            <div style="font-size: 16px; font-weight: bold; color: var(--expense-color);">$${expenses.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Profit</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${profit >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">
                                $${profit.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4 style="font-size: 13px; margin-bottom: 10px; color: var(--text-color);">📋 Tasks (${tasks.length})</h4>
            `;
            
            if (tasks.length === 0) {
                html += '<p style="text-align: center; color: var(--text-secondary); padding: 20px 0;">No tasks yet</p>';
            } else {
                tasks.forEach(task => {
                    const isCompleted = task.status === 'Completed';
                    html += `
                        <div class="task-item ${isCompleted ? 'completed' : ''}" style="margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: var(--text-color);">${task.name}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">
                                    ${task.dueDate} • ${task.priority} • ${task.status}
                                    ${task.assignee ? ` • ${task.assignee}` : ''}
                                </div>
                            </div>
                            <button class="icon-btn" onclick="closeModal('projectDetailModal'); editTask(${task.id});">✏️</button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('projectDetailBody').innerHTML = html;
            document.getElementById('projectDetailModal').classList.add('show');
        }

        function showTaskModal() {
            editingId = null;
            editingType = 'task';
            document.getElementById('taskModalTitle').textContent = 'New Task';
            document.getElementById('taskName').value = '';
            document.getElementById('taskPriority').value = 'Medium';
            document.getElementById('taskStatus').value = 'Get Ready';
            document.getElementById('taskStart').value = '';
            document.getElementById('taskDue').value = '';
            document.getElementById('taskAssignee').value = '';
            document.getElementById('taskDescription').value = '';
            
            const select = document.getElementById('taskProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            document.getElementById('taskModal').classList.add('show');
            
            // Don't toggle fab menu if we're on Projects or Schedule page
            const currentView = data.currentView;
            if (currentView !== 'projects' && currentView !== 'schedule') {
                toggleFabMenu();
            }
        }

        function editTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (!task) return;
            
            editingId = id;
            editingType = 'task';
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskStart').value = task.startDate || '';
            document.getElementById('taskDue').value = task.dueDate;
            document.getElementById('taskAssignee').value = task.assignee || '';
            document.getElementById('taskDescription').value = task.description || '';
            
            const select = document.getElementById('taskProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            select.value = task.projectId;
            
            document.getElementById('taskModal').classList.add('show');
        }

        function saveTask() {
            const taskData = {
                name: document.getElementById('taskName').value.trim(),
                projectId: parseInt(document.getElementById('taskProject').value),
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                startDate: document.getElementById('taskStart').value,
                dueDate: document.getElementById('taskDue').value,
                assignee: document.getElementById('taskAssignee').value.trim(),
                description: document.getElementById('taskDescription').value.trim()
            };
            
            if (!taskData.name || !taskData.projectId || !taskData.dueDate) {
                showToast('Please fill required fields');
                return;
            }
            
            if (editingId) {
                const index = data.tasks.findIndex(t => t.id === editingId);
                data.tasks[index] = addTimestamps({ 
                    ...data.tasks[index], 
                    ...taskData 
                }, false);
                showToast('Task updated');
            } else {
                taskData.id = Date.now();
                data.tasks.push(addTimestamps(taskData, true));
                showToast('Task created');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('taskModal');
        }

        function completeTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (task) {
                task.status = 'Completed';
                task.completedAt = new Date().toISOString();
                addTimestamps(task, false);
                saveData();
                renderView();
                showToast('✅ Task completed');
            }
        }

        function showTransactionModal(type) {
            editingId = null;
            editingType = 'transaction';
            document.getElementById('transactionModalTitle').textContent = type === 'income' ? 'Add Income' : 'Add Expense';
            document.getElementById('transType').value = type;
            document.getElementById('transAmount').value = '';
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transDescription').value = '';
            
            const select = document.getElementById('transProject');
            select.innerHTML = '<option value="">Select Project</option>';
            data.projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            updateCategories();
            document.getElementById('transactionModal').classList.add('show');
            
            // Don't toggle fab menu if we're on Projects page
            const currentView = data.currentView;
            if (currentView !== 'projects') {
                toggleFabMenu();
            }
        }

        function updateCategories() {
            const type = document.getElementById('transType').value;
            const categories = type === 'expense' ? 
                ['Materials', 'Labor', 'Equipment', 'Transport', 'Other'] : 
                ['Payment', 'Deposit', 'Final Payment', 'Other'];
            
            const select = document.getElementById('transCategory');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function saveTransaction() {
            const transData = {
                type: document.getElementById('transType').value,
                projectId: parseInt(document.getElementById('transProject').value),
                category: document.getElementById('transCategory').value,
                amount: parseFloat(document.getElementById('transAmount').value),
                date: document.getElementById('transDate').value,
                description: document.getElementById('transDescription').value.trim()
            };
            
            if (!transData.projectId || !transData.category || !transData.amount || isNaN(transData.amount)) {
                showToast('Please fill all fields correctly');
                return;
            }
            
            if (editingId && editingType === 'transaction') {
                const index = data.transactions.findIndex(t => t.id === editingId);
                data.transactions[index] = addTimestamps({ 
                    ...data.transactions[index], 
                    ...transData 
                }, false);
                showToast('Transaction updated');
            } else {
                transData.id = Date.now();
                data.transactions.push(addTimestamps(transData, true));
                showToast('Transaction added');
            }
            
            saveData();
            renderView();
            updateStats();
            closeModal('transactionModal');
        }

        function initAutoSync() {
            const savedAutoSync = localStorage.getItem('autoSyncEnabled');
            if (savedAutoSync === 'true' && syncApiKey) {
                autoSyncEnabled = true;
                document.getElementById('autoSyncToggle').checked = true;
                startAutoSync();
            }
        }

        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
            
            if (autoSyncEnabled) {
                startAutoSync();
                showToast('Auto-sync enabled');
            } else {
                stopAutoSync();
                showToast('Auto-sync disabled');
            }
        }

        function startAutoSync() {
            stopAutoSync();
            if (syncApiKey && autoSyncEnabled) {
                autoSyncInterval = setInterval(() => {
                    smartSync();
                }, 5 * 60 * 1000);
            }
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }

        function initializeLastSync() {
            const lastSyncTime = localStorage.getItem('lastSyncTime');
            if (lastSyncTime) {
                const date = new Date(parseInt(lastSyncTime));
                const timeStr = date.toLocaleTimeString();
                document.getElementById('lastSyncTime').textContent = `Last: ${timeStr}`;
            } else {
                document.getElementById('lastSyncTime').textContent = 'Not synced yet';
            }
            
            if (syncApiKey) {
                document.getElementById('syncMode').textContent = 'Ready';
            } else {
                document.getElementById('syncMode').textContent = 'No API key';
            }
        }

        async function smartSync() {
            if (!syncApiKey) {
                showToast('⚠️ No API key! Go to Settings → Smart Sync API → Enter key → Save', 6000);
                document.getElementById('syncMode').textContent = 'No API key';
                return;
            }
            
            const indicator = document.getElementById('syncIndicator');
            const syncMode = document.getElementById('syncMode');
            
            indicator.classList.add('syncing');
            syncMode.textContent = 'Syncing...';
            
            const startTime = Date.now();
            
            try {
                // STEP 1: PULL cloud data
                console.log('🔄 Step 1: Pulling cloud data...');
                syncMode.textContent = 'Pulling...';
                const getResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`Pull failed: ${getResponse.status} - ${getResponse.statusText}`);
                }
                
                let cloudData = null;
                if (getResponse.ok) {
                    const result = await getResponse.json();
                    cloudData = result.record || {};
                    console.log('✅ Cloud data pulled:', {
                        projects: cloudData.projects?.length || 0,
                        tasks: cloudData.tasks?.length || 0,
                        transactions: cloudData.transactions?.length || 0
                    });
                }
                
                // STEP 2: MERGE local and cloud data
                console.log('🔄 Step 2: Merging data...');
                syncMode.textContent = 'Merging...';
                if (cloudData && cloudData.projects) {
                    const beforeCounts = {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    };
                    
                    const mergedProjects = mergeByTimestamp(
                        data.projects || [], 
                        cloudData.projects || [], 
                        'projects'
                    );
                    
                    const mergedTasks = mergeByTimestamp(
                        data.tasks || [], 
                        cloudData.tasks || [], 
                        'tasks'
                    );
                    
                    const mergedTransactions = mergeByTimestamp(
                        data.transactions || [], 
                        cloudData.transactions || [], 
                        'transactions'
                    );
                    
                    // Update local data with merged results
                    data.projects = mergedProjects;
                    data.tasks = mergedTasks;
                    data.transactions = mergedTransactions;
                    
                    // Keep track of permanently deleted items
                    if (cloudData.permanentlyDeleted) {
                        data.permanentlyDeleted = [
                            ...(data.permanentlyDeleted || []),
                            ...cloudData.permanentlyDeleted
                        ];
                        data.permanentlyDeleted = Array.from(
                            new Map(data.permanentlyDeleted.map(item => [item.id, item])).values()
                        );
                    }
                    
                    const afterCounts = {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    };
                    
                    // Show what changed during merge
                    const changes = [];
                    if (afterCounts.projects !== beforeCounts.projects) {
                        changes.push(`${afterCounts.projects - beforeCounts.projects > 0 ? '+' : ''}${afterCounts.projects - beforeCounts.projects} projects`);
                    }
                    if (afterCounts.tasks !== beforeCounts.tasks) {
                        changes.push(`${afterCounts.tasks - beforeCounts.tasks > 0 ? '+' : ''}${afterCounts.tasks - beforeCounts.tasks} tasks`);
                    }
                    if (afterCounts.transactions !== beforeCounts.transactions) {
                        changes.push(`${afterCounts.transactions - beforeCounts.transactions > 0 ? '+' : ''}${afterCounts.transactions - beforeCounts.transactions} trans`);
                    }
                    
                    console.log('✅ Merge complete:', changes.length > 0 ? changes.join(', ') : 'No changes');
                    
                    saveData();
                    renderView();
                    updateStats();
                }
                
                // STEP 3: PUSH merged data back to cloud
                console.log('🔄 Step 3: Pushing merged data to cloud...');
                syncMode.textContent = 'Pushing...';
                const putResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': syncApiKey
                    },
                    body: JSON.stringify(data)
                });
                
                if (!putResponse.ok) {
                    throw new Error(`Push failed: ${putResponse.status} - ${putResponse.statusText}`);
                }
                
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`✅ Sync complete in ${syncDuration}s`);
                
                localStorage.setItem('lastSyncTime', Date.now().toString());
                const nowTime = new Date().toLocaleTimeString();
                document.getElementById('lastSyncTime').textContent = `Last: ${nowTime}`;
                showToast(`✅ Synced ${data.projects.length}p ${data.tasks.length}t ${data.transactions.length}tr in ${syncDuration}s!`, 5000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Connected';
                
            } catch (error) {
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.error('❌ Sync error:', error);
                
                let errorMsg = error.message;
                if (error.message.includes('401')) {
                    errorMsg = 'Invalid API key! Check Settings';
                } else if (error.message.includes('404')) {
                    errorMsg = 'Bin not found! Check Bin ID';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'No internet connection!';
                }
                
                showToast(`❌ ${errorMsg}`, 6000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Error';
                
                // Show detailed error in console
                console.log('Sync diagnostics:', {
                    duration: syncDuration + 's',
                    apiKey: syncApiKey ? 'SET (length: ' + syncApiKey.length + ')' : 'NOT SET',
                    binId: APP_CONFIG.binId,
                    online: navigator.onLine,
                    localData: {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    }
                });
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('✅ API key saved! Now click "Test Sync Connection"', 5000);
        }

        async function testSync() {
            if (!syncApiKey) {
                showToast('⚠️ No API key set! Enter your JSONBin API key first.');
                return;
            }
            
            showToast('🔍 Testing connection...');
            
            try {
                console.log('🔍 Testing sync connection...');
                console.log('API Key length:', syncApiKey.length);
                console.log('Bin ID:', APP_CONFIG.binId);
                console.log('Base URL:', APP_CONFIG.baseUrl);
                
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Connection successful!');
                    console.log('Cloud data:', {
                        projects: result.record?.projects?.length || 0,
                        tasks: result.record?.tasks?.length || 0,
                        transactions: result.record?.transactions?.length || 0
                    });
                    
                    showToast('✅ Connection works! Your API key is valid.');
                    document.getElementById('syncMode').textContent = 'Connected';
                } else if (response.status === 401) {
                    showToast('❌ Invalid API key! Get a new one from jsonbin.io');
                    document.getElementById('syncMode').textContent = 'Invalid Key';
                } else if (response.status === 404) {
                    showToast('❌ Bin not found! Check your Bin ID.');
                    document.getElementById('syncMode').textContent = 'Invalid Bin';
                } else {
                    showToast(`❌ Error ${response.status}: ${response.statusText}`);
                    document.getElementById('syncMode').textContent = 'Error';
                }
            } catch (error) {
                console.error('❌ Test failed:', error);
                showToast('❌ Connection failed! Check internet & open browser console (F12)');
                document.getElementById('syncMode').textContent = 'Offline';
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
