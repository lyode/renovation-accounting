<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#7899b3">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50%' x='50%' text-anchor='middle' font-size='60'>üí∞</text></svg>">
    <title>Renovation Accounting</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJlbm92YXRpb24gQWNjb3VudGluZyIsCiAgInNob3J0X25hbWUiOiAiUmVubyBBY2N0IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmM2Y0ZjYiLAogICJ0aGVtZV9jb2xvciI6ICIjNzg5OWIzIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiCn0=">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        :root {
            /* Darker Pastel Blue (Default) */
            --primary-color: #7899b3;
            --primary-dark: #5879a3;
            --primary-light: #a8c5d6;
            --bg-color: #f3f4f6;
            --card-bg: white;
            --text-color: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            
            /* Contrast levels */
            --contrast: 1;
            --brightness: 1;
        }
        
        /* Contrast Adjustments */
        body.low-contrast {
            --contrast: 0.85;
            --brightness: 1.05;
        }
        
        body.high-contrast {
            --contrast: 1.25;
            --brightness: 0.95;
        }
        
        body.extra-high-contrast {
            --contrast: 1.5;
            --brightness: 0.9;
            --text-color: #000000;
            --text-secondary: #374151;
            --border-color: #9ca3af;
        }
        
        /* Apply contrast filter */
        body {
            filter: contrast(var(--contrast)) brightness(var(--brightness));
        }
        
        /* Darker Pastel Themes */
        body.theme-green { 
            --primary-color: #7fa67f; 
            --primary-dark: #6f966f;
            --primary-light: #a8c6a8;
        }
        body.theme-purple { 
            --primary-color: #8b7aa8; 
            --primary-dark: #6b5a88;
            --primary-light: #b19cd9;
        }
        body.theme-teal { 
            --primary-color: #6fa0a0; 
            --primary-dark: #5f9090;
            --primary-light: #8fc4c4;
        }
        body.theme-pink { 
            --primary-color: #d99ea7; 
            --primary-dark: #c98e97;
            --primary-light: #f0b8c1;
        }
        body.theme-orange { 
            --primary-color: #d9a673; 
            --primary-dark: #c99663;
            --primary-light: #f0c493;
        }
        body.theme-indigo { 
            --primary-color: #8185c9; 
            --primary-dark: #6165b9;
            --primary-light: #a1a5e9;
        }
        body.theme-emerald { 
            --primary-color: #6fa882; 
            --primary-dark: #5f9872;
            --primary-light: #8fc8a2;
        }
        body.theme-rose { 
            --primary-color: #d98c9c; 
            --primary-dark: #c97c8c;
            --primary-light: #f9acbc;
        }
        body.theme-amber { 
            --primary-color: #d9a55c; 
            --primary-dark: #c9954c;
            --primary-light: #f9c57c;
        }
        body.theme-violet { 
            --primary-color: #9c7ac9; 
            --primary-dark: #8c6ab9;
            --primary-light: #bc9ae9;
        }
        
        /* Night Mode */
        body.night-mode {
            --bg-color: #1a1a1f;
            --card-bg: #25252b;
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #35353f;
        }
        
        body.night-mode.extra-high-contrast {
            --text-color: #ffffff;
            --text-secondary: #d0d0d0;
        }
        
        body.night-mode .stat-card,
        body.night-mode .card,
        body.night-mode .quick-add-section {
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        body.night-mode .transaction-item,
        body.night-mode .project-summary-item {
            background: #2f2f36;
        }
        
        body.night-mode .modal-content {
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        body.night-mode .form-input,
        body.night-mode .form-select,
        body.night-mode .form-textarea {
            background: #1a1a1f;
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        body.night-mode .badge-income {
            background: #065f46;
            color: #d1fae5;
        }
        
        body.night-mode .badge-expense {
            background: #991b1b;
            color: #fee2e2;
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background: var(--card-bg);
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            transition: right 0.3s;
            z-index: 100;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .settings-panel.active {
            right: 0;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-title {
            font-size: 1.125rem;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        .settings-section {
            margin-bottom: 1.5rem;
        }
        
        .settings-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .contrast-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .contrast-btn {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contrast-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .toggle-switch input[type="checkbox"] {
            width: 44px;
            height: 24px;
            -webkit-appearance: none;
            appearance: none;
            background: #cbd5e0;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch input[type="checkbox"]:checked {
            background: var(--primary-color);
        }
        
        .toggle-switch input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        
        .toggle-switch input[type="checkbox"]:checked::after {
            left: 22px;
        }
        
        /* Sync Status Bar */
        .sync-status-bar {
            background: var(--primary-light);
            color: var(--text-color);
            padding: 4px 10px;
            font-size: 11px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .sync-status-bar.syncing {
            background: #fbbf24;
            animation: pulse 1s infinite;
        }
        
        .sync-status-bar.success {
            background: #10b981;
            color: white;
        }
        
        .sync-status-bar.error {
            background: #ef4444;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        /* Base Styles */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); 
            color: white; 
            padding: 1rem; 
            padding-top: calc(1rem + env(safe-area-inset-top));
            position: relative;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header h1 { 
            font-size: 1.25rem; 
            margin-bottom: 0.25rem; 
        }
        
        .header p { 
            font-size: 0.75rem; 
            opacity: 0.9; 
        }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .header-btn:active {
            transform: scale(0.95);
        }
        
        /* Cloud Status */
        #cloudStatus {
            position: fixed;
            top: calc(65px + env(safe-area-inset-top));
            right: 10px;
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.6875rem;
            z-index: 1000;
            transition: all 0.3s;
            opacity: 0;
        }
        
        #cloudStatus.show {
            opacity: 1;
        }
        
        .tabs { 
            background: var(--card-bg); 
            display: flex; 
            border-bottom: 1px solid var(--border-color); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .tab { 
            flex: 1; 
            padding: 0.875rem 0.5rem; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .tab.active { 
            color: var(--primary-color); 
            border-bottom-color: var(--primary-color); 
        }
        
        .content { 
            padding: 1rem; 
            max-width: 100%; 
            margin: 0 auto; 
            padding-bottom: 5rem; 
        }
        
        .stat-grid { 
            display: grid; 
            gap: 0.75rem; 
            margin-bottom: 1rem; 
        }
        
        .stat-card { 
            background: var(--card-bg); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-label { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            margin-bottom: 0.25rem; 
        }
        
        .stat-value { 
            font-size: 1.25rem; 
            font-weight: bold; 
        }
        
        .stat-value.green { color: #10b981; }
        .stat-value.red { color: #ef4444; }
        
        .card { 
            background: var(--card-bg); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        
        .btn { 
            width: 100%; 
            padding: 0.875rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-size: 0.9375rem; 
            font-weight: 500; 
            cursor: pointer; 
            margin-bottom: 0.75rem;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-small { 
            padding: 0.5rem 0.75rem; 
            font-size: 0.8125rem; 
            width: auto; 
            margin: 0; 
        }
        .btn-group-horizontal { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 0.5rem; 
            margin-bottom: 1rem; 
        }
        
        .transaction-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 0.875rem; 
            background: var(--bg-color); 
            border-radius: 0.5rem; 
            margin-bottom: 0.5rem; 
        }
        
        .transaction-info { flex: 1; min-width: 0; }
        .transaction-title { font-weight: 500; margin-bottom: 0.25rem; }
        .transaction-meta { font-size: 0.6875rem; color: var(--text-secondary); }
        .transaction-amount { 
            font-weight: bold; 
            font-size: 1rem; 
            white-space: nowrap; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 200; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
        }
        
        .modal.show { display: flex; }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 0.75rem; 
            padding: 1.25rem; 
            width: 100%; 
            max-width: 100%; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        
        .modal-title { 
            font-size: 1.125rem; 
            font-weight: bold; 
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        
        .form-group { margin-bottom: 0.875rem; }
        .form-label { 
            display: block; 
            font-size: 0.8125rem; 
            font-weight: 500; 
            margin-bottom: 0.375rem;
            color: var(--text-color);
        }
        
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 0.625rem; 
            border: 1px solid var(--border-color); 
            border-radius: 0.375rem; 
            font-size: 0.9375rem;
            background: var(--card-bg);
            color: var(--text-color);
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-textarea { resize: vertical; min-height: 60px; }
        .btn-group { display: flex; gap: 0.5rem; }
        .btn-group button { flex: 1; }
        
        .badge { 
            display: inline-block; 
            padding: 0.1875rem 0.4375rem; 
            border-radius: 0.25rem; 
            font-size: 0.6875rem; 
            font-weight: 500; 
        }
        
        .badge-income { background: #d1fae5; color: #065f46; }
        .badge-expense { background: #fee2e2; color: #991b1b; }
        
        .project-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 0.375rem; 
            margin-top: 0.75rem; 
        }
        
        .project-stat { 
            text-align: center; 
            padding: 0.4375rem; 
            border-radius: 0.375rem; 
        }
        .project-stat-label { font-size: 0.6875rem; color: var(--text-secondary); }
        .project-stat-value { font-weight: bold; font-size: 0.8125rem; }
        
        .hidden { display: none; }
        .empty-state { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary); 
            font-size: 0.875rem;
        }
        
        input[type="file"] { 
            padding: 0.375rem; 
            font-size: 0.8125rem; 
        }
        
        .action-buttons { 
            display: flex; 
            gap: 0.375rem; 
            margin-top: 0.375rem; 
            flex-wrap: wrap; 
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        
        .project-actions { 
            display: flex; 
            gap: 0.375rem; 
            margin-top: 0.875rem; 
            flex-wrap: wrap; 
        }
        
        .back-btn { 
            background: #6b7280; 
            color: white; 
            display: inline-flex; 
            align-items: center; 
            gap: 0.375rem; 
            padding: 0.5rem 1rem; 
            border-radius: 0.375rem; 
            border: none; 
            cursor: pointer; 
            margin-bottom: 0.875rem; 
            font-size: 0.8125rem; 
        }
        
        .project-header { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); 
            color: white; 
            padding: 1.25rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1rem; 
        }
        
        .project-header h2 { font-size: 1.25rem; margin-bottom: 0.375rem; }
        .project-header p { opacity: 0.9; font-size: 0.8125rem; }
        
        .quick-add-section { 
            background: var(--card-bg); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 1rem; 
        }
        
        .quick-add-title { 
            font-weight: 600; 
            margin-bottom: 0.75rem; 
            color: var(--text-color);
            font-size: 0.9375rem;
        }
        
        .project-summary-item { 
            background: var(--bg-color); 
            padding: 0.875rem; 
            border-radius: 0.5rem; 
            margin-bottom: 0.625rem; 
            border-left: 3px solid #10b981; 
        }
        
        .project-summary-item.loss { border-left-color: #ef4444; }
        
        /* Theme Grid */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .theme-btn {
            padding: 0.625rem 0.25rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.625rem;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .theme-btn:active {
            transform: scale(0.95);
        }
        
        /* Responsive for tablets */
        @media (min-width: 640px) {
            .content { 
                max-width: 640px; 
                margin: 0 auto;
            }
            .modal-content {
                max-width: 500px;
            }
        }
        
        /* PWA Install prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 1rem;
            right: 1rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 90;
        }
        
        .install-prompt.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <h1>Renovation Accounting</h1>
                <p>Track your business finances</p>
            </div>
            <div class="header-buttons">
                <button onclick="syncData()" class="header-btn" title="Cloud Sync">‚òÅÔ∏è</button>
                <button onclick="toggleSettings()" class="header-btn" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="sync-status-bar" id="syncStatusBar">
            <span id="deviceType"></span> ‚Ä¢ 
            <span id="lastSyncTime">Never synced</span> ‚Ä¢ 
            <span id="syncMode">Offline</span>
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <span class="settings-title">Settings</span>
            <button class="close-settings" onclick="toggleSettings()">‚úï</button>
        </div>
        
        <div class="settings-section">
            <label class="settings-label">Sync Status</label>
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                Device: <strong id="settingsDevice">Mobile</strong><br>
                Mode: <strong id="settingsMode">Manual Sync Only</strong><br>
                Last Sync: <strong id="settingsLastSync">Never</strong>
            </div>
            <button class="btn btn-primary" onclick="forceCloudPull()" style="margin-bottom: 0.5rem;">Force Pull from Cloud</button>
        </div>
        
        <div class="settings-section">
            <label class="settings-label">Page Contrast</label>
            <div class="contrast-buttons">
                <button class="contrast-btn" onclick="setContrast('normal')" id="contrast-normal">Normal</button>
                <button class="contrast-btn" onclick="setContrast('low')" id="contrast-low">Low</button>
                <button class="contrast-btn" onclick="setContrast('high')" id="contrast-high">High</button>
                <button class="contrast-btn" onclick="setContrast('extra')" id="contrast-extra">Extra High</button>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="toggle-switch">
                <span class="settings-label" style="margin: 0;">Night Mode</span>
                <input type="checkbox" id="night-toggle" onchange="toggleDayNight()">
            </div>
        </div>
        
        <div class="settings-section">
            <label class="settings-label">Color Theme</label>
            <div class="theme-grid">
                <button onclick="setTheme('default')" class="theme-btn" style="background: #7899b3;">Blue</button>
                <button onclick="setTheme('green')" class="theme-btn" style="background: #7fa67f;">Green</button>
                <button onclick="setTheme('purple')" class="theme-btn" style="background: #8b7aa8;">Purple</button>
                <button onclick="setTheme('teal')" class="theme-btn" style="background: #6fa0a0;">Teal</button>
                <button onclick="setTheme('pink')" class="theme-btn" style="background: #d99ea7;">Pink</button>
                <button onclick="setTheme('orange')" class="theme-btn" style="background: #d9a673;">Orange</button>
                <button onclick="setTheme('indigo')" class="theme-btn" style="background: #8185c9;">Indigo</button>
                <button onclick="setTheme('emerald')" class="theme-btn" style="background: #6fa882;">Emerald</button>
                <button onclick="setTheme('rose')" class="theme-btn" style="background: #d98c9c;">Rose</button>
                <button onclick="setTheme('amber')" class="theme-btn" style="background: #d9a55c;">Amber</button>
                <button onclick="setTheme('violet')" class="theme-btn" style="background: #9c7ac9;">Violet</button>
                <button onclick="installApp()" class="theme-btn" style="background: #4b5563;">üì± Install</button>
            </div>
        </div>
        
        <div class="settings-section">
            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
            <label class="btn btn-success" style="display: block; text-align: center;">
                Import Data
                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
            </label>
        </div>
    </div>
    
    <div id="cloudStatus"></div>
    
    <div class="tabs">
        <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
        <div class="tab" onclick="showTab('transactions')">Transactions</div>
        <div class="tab" onclick="showTab('projects')">Projects</div>
    </div>
    
    <div class="content">
        <div id="dashboard-tab">
            <div class="stat-grid">
                <div class="stat-card"><div class="stat-label">Total Income</div><div class="stat-value green" id="total-income">$0.00</div></div>
                <div class="stat-card"><div class="stat-label">Total Expenses</div><div class="stat-value red" id="total-expenses">$0.00</div></div>
                <div class="stat-card"><div class="stat-label">Net Profit</div><div class="stat-value" id="net-profit">$0.00</div></div>
            </div>
            <div class="card"><h2 style="margin-bottom: 0.875rem; font-size: 1.125rem;">Projects Summary</h2><div id="projects-summary"></div></div>
            <div class="card"><h2 style="margin-bottom: 0.875rem; font-size: 1.125rem;">Recent Transactions</h2><div id="recent-transactions"></div></div>
        </div>
        
        <div id="transactions-tab" class="hidden">
            <div id="transactions-list"></div>
        </div>
        
        <div id="projects-tab" class="hidden">
            <div id="projects-list"></div>
        </div>
        
        <div id="project-detail-tab" class="hidden">
            <button class="back-btn" onclick="showTab('projects')">‚Üê Back to Projects</button>
            <div class="project-header" id="project-detail-header"></div>
            <div class="quick-add-section">
                <div class="quick-add-title">Quick Add to This Project</div>
                <div class="btn-group-horizontal">
                    <button class="btn btn-danger" onclick="quickAddTransaction('expense')">+ Add Expense</button>
                    <button class="btn btn-success" onclick="quickAddTransaction('income')">+ Add Income</button>
                </div>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 0.875rem; font-size: 1rem;">Project Transactions</h3>
                <div id="project-transactions-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="fab" onclick="handleFABClick()">+</button>
    
    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="install-prompt">
        <p style="font-size: 0.875rem; margin-bottom: 0.5rem;">Install this app for easier access!</p>
        <button class="btn btn-primary" onclick="installApp()">Install App</button>
    </div>
    
    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="transaction-modal-title">Add Transaction</h2>
            <form id="transaction-form">
                <input type="hidden" id="trans-id">
                <input type="hidden" id="trans-locked-project">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="trans-type" onchange="updateCategories()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group" id="project-select-group">
                    <label class="form-label">Project</label>
                    <select class="form-select" id="trans-project"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="trans-category" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount ($)</label>
                    <input type="number" step="0.01" class="form-input" id="trans-amount" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="trans-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="trans-description" placeholder="Add notes..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Receipt/Photo</label>
                    <input type="file" accept="image/*,application/pdf,.doc,.docx" class="form-input" id="trans-receipt" onchange="handleReceipt(event)" multiple>
                    <img id="receipt-preview" style="max-height: 80px; margin-top: 0.375rem; display: none; border-radius: 0.375rem;">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('transaction-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="transaction-submit-btn">Add</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Project Modal -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="project-modal-title">Add Project</h2>
            <form id="project-form">
                <input type="hidden" id="proj-id">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="proj-name" placeholder="Kitchen Renovation" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="proj-client" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-input" id="proj-date" required>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('project-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="project-submit-btn">Add Project</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // PWA Support
        let deferredPrompt;
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install",e=>e.waitUntil(caches.open("v1").then(c=>c.addAll(["/"]))));self.addEventListener("fetch",e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));');
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                document.getElementById('install-prompt').classList.add('show');
            }, 30000);
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(result => {
                    deferredPrompt = null;
                    document.getElementById('install-prompt').classList.remove('show');
                });
            } else if (window.matchMedia('(display-mode: standalone)').matches) {
                alert('App is already installed!');
            } else {
                alert('To install: Safari - Share > Add to Home Screen | Chrome - Menu > Install App');
            }
            toggleSettings();
        }
        
        // Detect device type
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const deviceType = isMobile ? 'Mobile' : 'Laptop';
        
        // Mobile-First Cloud Sync Manager
        class MobileFirstCloudSync {
            constructor() {
                this.binId = '68e121b8ae596e708f05df17';
                this.apiKey = localStorage.getItem('accountingSyncApiKey') || '';
                this.baseUrl = 'https://api.jsonbin.io/v3';
                this.lastSyncTime = parseInt(localStorage.getItem('lastSyncTime')) || 0;
                this.isMobile = isMobile;
                this.isSyncing = false;
                this.syncQueue = false;
            }
            
            async setup() {
                if (!this.apiKey) {
                    const apiKey = prompt('Enter your JSONBin API Key (same as Team Projects app):');
                    if (!apiKey) {
                        alert('Sync cancelled. You can set it up later from the cloud button.');
                        return false;
                    }
                    
                    this.apiKey = apiKey;
                    localStorage.setItem('accountingSyncApiKey', apiKey);
                    
                    // Test the API key
                    try {
                        const response = await fetch(`${this.baseUrl}/b/${this.binId}/latest`, {
                            headers: {
                                'X-Master-Key': this.apiKey
                            }
                        });
                        
                        if (!response.ok) throw new Error('Invalid API key');
                        
                        this.showStatus('‚úÖ Cloud sync connected!');
                        updateSyncStatus('Connected', true);
                        return true;
                    } catch (error) {
                        alert('Invalid API key. Please check and try again.');
                        localStorage.removeItem('accountingSyncApiKey');
                        this.apiKey = '';
                        return false;
                    }
                }
                return true;
            }
            
            async push(forceUpdate = false) {
                // Prevent multiple simultaneous syncs
                if (this.isSyncing) {
                    this.syncQueue = true;
                    return false;
                }
                
                if (!await this.setup()) return false;
                
                this.isSyncing = true;
                updateSyncStatus('Syncing...', true);
                
                try {
                    // Add device info and timestamp to data
                    const pushData = {
                        projects: projects,
                        transactions: transactions,
                        theme: localStorage.getItem('appTheme'),
                        nightMode: document.body.classList.contains('night-mode'),
                        contrast: localStorage.getItem('contrast'),
                        lastUpdated: new Date().toISOString(),
                        lastUpdateDevice: deviceType,
                        version: '2.0'
                    };
                    
                    const response = await fetch(`${this.baseUrl}/b/${this.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.apiKey
                        },
                        body: JSON.stringify(pushData)
                    });
                    
                    if (response.ok) {
                        this.lastSyncTime = Date.now();
                        localStorage.setItem('lastSyncTime', this.lastSyncTime.toString());
                        this.showStatus('‚òÅÔ∏è Saved to cloud');
                        updateSyncStatus('Synced', false);
                        updateLastSyncDisplay();
                        this.isSyncing = false;
                        
                        // Handle queued sync if any
                        if (this.syncQueue) {
                            this.syncQueue = false;
                            setTimeout(() => this.push(), 2000);
                        }
                        
                        return true;
                    } else {
                        this.showStatus('‚ö†Ô∏è Sync failed');
                        updateSyncStatus('Sync Failed', false);
                        this.isSyncing = false;
                        return false;
                    }
                } catch (error) {
                    this.showStatus('üìµ Offline - Data saved locally');
                    updateSyncStatus('Offline', false);
                    this.isSyncing = false;
                    return false;
                }
            }
            
            async pull(force = false) {
                if (!await this.setup()) return false;
                
                updateSyncStatus('Loading...', true);
                
                try {
                    const response = await fetch(`${this.baseUrl}/b/${this.binId}/latest`, {
                        headers: {
                            'X-Master-Key': this.apiKey
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const cloudData = result.record;
                        
                        // Check if cloud data is newer or force pull
                        if (force || !cloudData.lastUpdated || new Date(cloudData.lastUpdated) > new Date(localStorage.getItem('lastLocalUpdate') || 0)) {
                            // Merge or replace based on device type
                            if (this.isMobile && !force) {
                                // Mobile: Only pull if explicitly requested or cloud is significantly newer
                                if (confirm(`Cloud data from ${cloudData.lastUpdateDevice || 'unknown device'}. Replace your local data?`)) {
                                    this.applyCloudData(cloudData);
                                } else {
                                    updateSyncStatus('Cancelled', false);
                                    return false;
                                }
                            } else {
                                // Laptop: Always pull before working
                                this.applyCloudData(cloudData);
                            }
                        }
                        
                        this.lastSyncTime = Date.now();
                        localStorage.setItem('lastSyncTime', this.lastSyncTime.toString());
                        this.showStatus('‚òÅÔ∏è Loaded from cloud');
                        updateSyncStatus('Synced', false);
                        updateLastSyncDisplay();
                        return true;
                    } else {
                        this.showStatus('‚ö†Ô∏è Failed to load from cloud');
                        updateSyncStatus('Load Failed', false);
                        return false;
                    }
                } catch (error) {
                    this.showStatus('üìµ Offline - Using local data');
                    updateSyncStatus('Offline', false);
                    return false;
                }
            }
            
            applyCloudData(cloudData) {
                projects = cloudData.projects || [];
                transactions = cloudData.transactions || [];
                
                // Apply theme settings
                if (cloudData.theme) {
                    setTheme(cloudData.theme);
                }
                if (cloudData.nightMode) {
                    document.body.classList.add('night-mode');
                    document.getElementById('night-toggle').checked = true;
                } else {
                    document.body.classList.remove('night-mode');
                    document.getElementById('night-toggle').checked = false;
                }
                if (cloudData.contrast) {
                    setContrast(cloudData.contrast);
                }
                
                // Save to localStorage
                localStorage.setItem('offlineProjects', JSON.stringify(projects));
                localStorage.setItem('offlineTransactions', JSON.stringify(transactions));
                
                render();
            }
            
            showStatus(message) {
                const status = document.getElementById('cloudStatus');
                if (status) {
                    status.textContent = message;
                    status.classList.add('show');
                    
                    setTimeout(() => {
                        status.classList.remove('show');
                    }, 3000);
                }
            }
        }

        // Initialize cloud sync
        const cloudSync = new MobileFirstCloudSync();

        // Global variables
        let projects = [], transactions = [], currentReceiptData = null, editingTransactionId = null, editingProjectId = null, currentProjectId = null;
        const expenseCategories = ['Materials', 'Labor', 'Tools & Equipment', 'Transportation', 'Permits', 'Subcontractors', 'Other'];
        const incomeCategories = ['Project Payment', 'Deposit', 'Final Payment', 'Other Income'];
        
        // Update sync status display
        function updateSyncStatus(status, isLoading) {
            const statusBar = document.getElementById('syncStatusBar');
            const syncMode = document.getElementById('syncMode');
            const settingsMode = document.getElementById('settingsMode');
            const settingsDevice = document.getElementById('settingsDevice');
            
            // Update device type
            document.getElementById('deviceType').textContent = deviceType;
            settingsDevice.textContent = deviceType;
            
            // Update sync mode
            const mode = 'Manual Sync Only';
            syncMode.textContent = status;
            settingsMode.textContent = mode;
            
            // Update status bar appearance
            statusBar.classList.remove('syncing', 'success', 'error');
            if (isLoading) {
                statusBar.classList.add('syncing');
            } else if (status === 'Synced') {
                statusBar.classList.add('success');
                setTimeout(() => statusBar.classList.remove('success'), 2000);
            } else if (status.includes('Failed')) {
                statusBar.classList.add('error');
            }
        }
        
        function updateLastSyncDisplay() {
            const lastSync = localStorage.getItem('lastSyncTime');
            const elements = ['lastSyncTime', 'settingsLastSync'];
            
            if (lastSync) {
                const date = new Date(parseInt(lastSync));
                const timeStr = date.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = `${dateStr} ${timeStr}`;
                });
            }
        }
        
        // Load data with mobile-first approach
        async function loadData() {
            // Load from localStorage first
            const savedProjects = localStorage.getItem('offlineProjects');
            const savedTrans = localStorage.getItem('offlineTransactions');
            
            if (savedProjects) projects = JSON.parse(savedProjects);
            if (savedTrans) transactions = JSON.parse(savedTrans);
            
            render();
            updateSyncStatus('Local Data', false);
            
            // Different behavior for mobile vs laptop
            if (cloudSync.apiKey) {
                if (!isMobile) {
                    // Laptop: Always pull latest on startup
                    await cloudSync.pull();
                }
                // Mobile: Don't auto-pull, keep local data primary
                updateLastSyncDisplay();
            }
        }
        
        // Save data - NO automatic sync on changes
        async function saveData() {
            // Save locally first
            localStorage.setItem('offlineProjects', JSON.stringify(projects));
            localStorage.setItem('offlineTransactions', JSON.stringify(transactions));
            localStorage.setItem('lastLocalUpdate', new Date().toISOString());
            
            // Mobile: No automatic sync on changes (only via interval or manual)
            // Laptop: Manual sync only
        }
        
        // Manual sync button - same behavior for both mobile and laptop
        async function syncData() {
            if (!cloudSync.apiKey) {
                const success = await cloudSync.setup();
                if (success) {
                    // After setup, offer choice
                    const action = confirm('Choose action:\n\nüì§ OK = Push to cloud\nüì• Cancel = Pull from cloud');
                    if (action) {
                        await cloudSync.push();
                    } else {
                        await cloudSync.pull();
                    }
                }
            } else {
                // Both mobile and laptop get the same choice when manually syncing
                const action = confirm('Choose action:\n\nüì§ OK = Push to cloud\nüì• Cancel = Pull from cloud');
                if (action) {
                    await cloudSync.push();
                } else {
                    await cloudSync.pull();
                }
            }
        }
        
        // Force pull from cloud (for emergency recovery)
        async function forceCloudPull() {
            if (confirm('WARNING: This will replace ALL local data with cloud data. Continue?')) {
                await cloudSync.pull(true);
                toggleSettings();
            }
        }
        
        // Settings Functions
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('active');
        }
        
        function setContrast(level) {
            document.body.classList.remove('low-contrast', 'high-contrast', 'extra-high-contrast');
            document.querySelectorAll('.contrast-btn').forEach(btn => btn.classList.remove('active'));
            
            if (level === 'low') {
                document.body.classList.add('low-contrast');
                document.getElementById('contrast-low').classList.add('active');
            } else if (level === 'high') {
                document.body.classList.add('high-contrast');
                document.getElementById('contrast-high').classList.add('active');
            } else if (level === 'extra') {
                document.body.classList.add('extra-high-contrast');
                document.getElementById('contrast-extra').classList.add('active');
            } else {
                document.getElementById('contrast-normal').classList.add('active');
            }
            
            localStorage.setItem('contrast', level);
            saveData();
        }
        
        function loadContrast() {
            const savedContrast = localStorage.getItem('contrast') || 'normal';
            setContrast(savedContrast);
        }
        
        // FAB Handler
        function handleFABClick() {
            const activeTab = document.querySelector('.tab.active').textContent;
            if (activeTab === 'Dashboard') {
                showAddTransaction();
            } else if (activeTab === 'Transactions') {
                showAddTransaction();
            } else if (activeTab === 'Projects') {
                showAddProject();
            }
        }
        
        // Day/Night Mode
        function toggleDayNight() {
            document.body.classList.toggle('night-mode');
            const isNight = document.body.classList.contains('night-mode');
            localStorage.setItem('nightMode', isNight);
            document.getElementById('night-toggle').checked = isNight;
            saveData();
        }
        
        // Theme functions
        function setTheme(theme) {
            const classes = document.body.className.split(' ').filter(c => !c.startsWith('theme-'));
            document.body.className = classes.join(' ');
            if (theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
            localStorage.setItem('appTheme', theme);
            
            // Update theme color meta tag
            const themeColors = {
                'default': '#7899b3',
                'green': '#7fa67f',
                'purple': '#8b7aa8',
                'teal': '#6fa0a0',
                'pink': '#d99ea7',
                'orange': '#d9a673',
                'indigo': '#8185c9',
                'emerald': '#6fa882',
                'rose': '#d98c9c',
                'amber': '#d9a55c',
                'violet': '#9c7ac9'
            };
            document.querySelector('meta[name="theme-color"]').content = themeColors[theme] || themeColors['default'];
            
            saveData();
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('appTheme');
            if (savedTheme && savedTheme !== 'default') {
                setTheme(savedTheme);
            }
            
            if (localStorage.getItem('nightMode') === 'true') {
                document.body.classList.add('night-mode');
                document.getElementById('night-toggle').checked = true;
            }
            
            loadContrast();
        }
        
        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.tab');
            if (tabName === 'dashboard') tabs[0].classList.add('active');
            else if (tabName === 'transactions') tabs[1].classList.add('active');
            else if (tabName === 'projects') tabs[2].classList.add('active');
            
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('transactions-tab').classList.add('hidden');
            document.getElementById('projects-tab').classList.add('hidden');
            document.getElementById('project-detail-tab').classList.add('hidden');
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Update FAB based on tab
            const fab = document.getElementById('fab');
            if (tabName === 'project-detail') {
                fab.style.display = 'none';
            } else {
                fab.style.display = 'flex';
                fab.textContent = '+';
            }
            
            render();
        }
        
        // Project detail view
        function showProjectDetail(projectId) {
            currentProjectId = projectId;
            showTab('project-detail');
            renderProjectDetail();
        }
        
        function renderProjectDetail() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;
            
            const stats = getProjectStats(currentProjectId);
            document.getElementById('project-detail-header').innerHTML = 
                `<h2>${project.name}</h2>
                <p>Client: ${project.client} | Started: ${project.startDate}</p>
                <div class="project-stats" style="margin-top: 0.875rem;">
                    <div class="project-stat" style="background: rgba(255,255,255,0.2);">
                        <div class="project-stat-label" style="color: white;">Income</div>
                        <div class="project-stat-value" style="color: white;">$${stats.income.toFixed(2)}</div>
                    </div>
                    <div class="project-stat" style="background: rgba(255,255,255,0.2);">
                        <div class="project-stat-label" style="color: white;">Expenses</div>
                        <div class="project-stat-value" style="color: white;">$${stats.expense.toFixed(2)}</div>
                    </div>
                    <div class="project-stat" style="background: rgba(255,255,255,0.2);">
                        <div class="project-stat-label" style="color: white;">Profit</div>
                        <div class="project-stat-value" style="color: white;">$${stats.profit.toFixed(2)}</div>
                    </div>
                </div>`;
            
            const projectTrans = transactions.filter(t => t.projectId === currentProjectId);
            const listEl = document.getElementById('project-transactions-list');
            
            if (projectTrans.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No transactions yet. Use the quick add buttons above!</div>';
            } else {
                listEl.innerHTML = projectTrans.map(t => 
                    `<div class="transaction-item" style="margin-bottom: 0.625rem; padding: 0.875rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                <span class="badge ${t.type === 'income' ? 'badge-income' : 'badge-expense'}">${t.type}</span>
                                <span style="font-weight: bold; font-size: 0.875rem;">${t.category}</span>
                            </div>
                            ${t.description ? `<div style="font-size: 0.8125rem; color: var(--text-secondary);">${t.description}</div>` : ''}
                            <div style="font-size: 0.6875rem; color: var(--text-secondary); margin-top: 0.25rem;">${t.date}</div>
                            ${t.receipt ? '<div style="font-size: 0.6875rem; color: var(--primary-color); margin-top: 0.25rem;">üì∑ Receipt</div>' : ''}
                        </div>
                        <div style="text-align: right;">
                            <div class="transaction-amount ${t.type === 'income' ? 'green' : 'red'}">
                                ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                            </div>
                            <div class="action-buttons">
                                <button onclick="showEditTransaction('${t.id}')" class="btn btn-small btn-edit">Edit</button>
                                <button onclick="deleteTransaction('${t.id}')" class="btn btn-small btn-delete">Delete</button>
                            </div>
                        </div>
                    </div>`
                ).join('');
            }
        }
        
        // Quick add transaction
        function quickAddTransaction(type) {
            editingTransactionId = null;
            document.getElementById('transaction-modal-title').textContent = type === 'expense' ? 'Add Expense' : 'Add Income';
            document.getElementById('transaction-submit-btn').textContent = 'Add';
            document.getElementById('trans-id').value = '';
            document.getElementById('trans-type').value = type;
            document.getElementById('trans-locked-project').value = currentProjectId;
            document.getElementById('trans-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('trans-amount').value = '';
            document.getElementById('trans-description').value = '';
            document.getElementById('receipt-preview').style.display = 'none';
            currentReceiptData = null;
            document.getElementById('project-select-group').style.display = 'none';
            updateCategories();
            document.getElementById('transaction-modal').classList.add('show');
        }
        
        // Add/Edit transactions
        function showAddTransaction() {
            editingTransactionId = null;
            currentProjectId = null;
            document.getElementById('transaction-modal-title').textContent = 'Add Transaction';
            document.getElementById('transaction-submit-btn').textContent = 'Add';
            document.getElementById('trans-id').value = '';
            document.getElementById('trans-locked-project').value = '';
            document.getElementById('trans-type').value = 'expense';
            document.getElementById('trans-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('trans-amount').value = '';
            document.getElementById('trans-description').value = '';
            document.getElementById('receipt-preview').style.display = 'none';
            currentReceiptData = null;
            document.getElementById('project-select-group').style.display = 'block';
            updateProjectDropdown();
            updateCategories();
            document.getElementById('transaction-modal').classList.add('show');
        }
        
        function showEditTransaction(id) {
            const trans = transactions.find(t => t.id === id);
            if (!trans) return;
            
            editingTransactionId = id;
            document.getElementById('transaction-modal-title').textContent = 'Edit Transaction';
            document.getElementById('transaction-submit-btn').textContent = 'Update';
            document.getElementById('trans-id').value = id;
            document.getElementById('trans-type').value = trans.type;
            document.getElementById('trans-project').value = trans.projectId || '';
            document.getElementById('trans-amount').value = trans.amount;
            document.getElementById('trans-date').value = trans.date;
            document.getElementById('trans-description').value = trans.description || '';
            document.getElementById('trans-locked-project').value = '';
            currentReceiptData = trans.receipt;
            
            if (trans.receipt) {
                document.getElementById('receipt-preview').src = trans.receipt;
                document.getElementById('receipt-preview').style.display = 'block';
            } else {
                document.getElementById('receipt-preview').style.display = 'none';
            }
            
            document.getElementById('project-select-group').style.display = 'block';
            updateProjectDropdown();
            updateCategories();
            document.getElementById('trans-category').value = trans.category;
            document.getElementById('transaction-modal').classList.add('show');
        }
        
        // Add/Edit projects
        function showAddProject() {
            editingProjectId = null;
            document.getElementById('project-modal-title').textContent = 'Add Project';
            document.getElementById('project-submit-btn').textContent = 'Add Project';
            document.getElementById('proj-id').value = '';
            document.getElementById('proj-name').value = '';
            document.getElementById('proj-client').value = '';
            document.getElementById('proj-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('project-modal').classList.add('show');
        }
        
        function showEditProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            editingProjectId = id;
            document.getElementById('project-modal-title').textContent = 'Edit Project';
            document.getElementById('project-submit-btn').textContent = 'Update Project';
            document.getElementById('proj-id').value = id;
            document.getElementById('proj-name').value = project.name;
            document.getElementById('proj-client').value = project.client;
            document.getElementById('proj-date').value = project.startDate;
            document.getElementById('project-modal').classList.add('show');
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.getElementById('transaction-form').reset();
            document.getElementById('project-form').reset();
            currentReceiptData = null;
            editingTransactionId = null;
            editingProjectId = null;
            document.getElementById('receipt-preview').style.display = 'none';
            document.getElementById('trans-locked-project').value = '';
        }
        
        // Update dropdowns
        function updateProjectDropdown() {
            const select = document.getElementById('trans-project');
            const currentValue = select.value;
            select.innerHTML = '<option value="">No Project</option>';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                select.appendChild(option);
            });
            select.value = currentValue;
        }
        
        function updateCategories() {
            const type = document.getElementById('trans-type').value;
            const select = document.getElementById('trans-category');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Category</option>';
            const categories = type === 'expense' ? expenseCategories : incomeCategories;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            select.value = currentValue;
        }
        
        // Handle receipt
        function handleReceipt(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentReceiptData = e.target.result;
                    const preview = document.getElementById('receipt-preview');
                    preview.src = currentReceiptData;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Form submissions with immediate sync
        document.getElementById('transaction-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const lockedProject = document.getElementById('trans-locked-project').value;
            const projectId = lockedProject || document.getElementById('trans-project').value;
            
            const transData = {
                type: document.getElementById('trans-type').value,
                projectId: projectId,
                category: document.getElementById('trans-category').value,
                amount: parseFloat(document.getElementById('trans-amount').value),
                date: document.getElementById('trans-date').value,
                description: document.getElementById('trans-description').value,
                receipt: currentReceiptData,
                timestamp: new Date().toISOString(),
                device: deviceType
            };
            
            if (editingTransactionId) {
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) transactions[index] = Object.assign({}, transactions[index], transData);
            } else {
                transData.id = Date.now().toString();
                transactions.push(transData);
            }
            
            await saveData();
            closeModal('transaction-modal');
            if (lockedProject) renderProjectDetail();
            else render();
        });
        
        document.getElementById('project-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const projData = {
                name: document.getElementById('proj-name').value,
                client: document.getElementById('proj-client').value,
                startDate: document.getElementById('proj-date').value,
                status: 'active',
                timestamp: new Date().toISOString(),
                device: deviceType
            };
            
            if (editingProjectId) {
                const index = projects.findIndex(p => p.id === editingProjectId);
                if (index !== -1) projects[index] = Object.assign({}, projects[index], projData);
            } else {
                projData.id = Date.now().toString();
                projects.push(projData);
            }
            
            await saveData();
            closeModal('project-modal');
            render();
        });
        
        // Statistics
        function calculateStats() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            return { income: income, expense: expense, profit: income - expense };
        }
        
        function getProjectStats(projectId) {
            const projectTrans = transactions.filter(t => t.projectId === projectId);
            const income = projectTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = projectTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            return { income: income, expense: expense, profit: income - expense };
        }
        
        // Delete functions with sync
        async function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                await saveData();
                if (currentProjectId) renderProjectDetail();
                else render();
            }
        }
        
        async function deleteProject(id) {
            if (confirm('Delete this project? Transactions will NOT be deleted.')) {
                projects = projects.filter(p => p.id !== id);
                await saveData();
                render();
            }
        }
        
        // Export/Import
        function exportData() {
            const data = {
                projects: projects,
                transactions: transactions,
                exportDate: new Date().toISOString(),
                exportDevice: deviceType
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'renovation-accounts-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            toggleSettings();
        }
        
        async function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.projects) projects = data.projects;
                        if (data.transactions) transactions = data.transactions;
                        await saveData();
                        render();
                        alert('Data imported successfully!');
                        toggleSettings();
                    } catch (error) {
                        alert('Error importing data');
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // Render functions
        function render() {
            renderDashboard();
            renderTransactions();
            renderProjects();
        }
        
        function renderDashboard() {
            const stats = calculateStats();
            document.getElementById('total-income').textContent = '$' + stats.income.toFixed(2);
            document.getElementById('total-expenses').textContent = '$' + stats.expense.toFixed(2);
            const profitEl = document.getElementById('net-profit');
            profitEl.textContent = '$' + stats.profit.toFixed(2);
            profitEl.className = 'stat-value ' + (stats.profit >= 0 ? 'green' : 'red');
            
            const summaryEl = document.getElementById('projects-summary');
            if (projects.length === 0) {
                summaryEl.innerHTML = '<div class="empty-state">No projects yet. Tap + to create your first project!</div>';
            } else {
                summaryEl.innerHTML = projects.map(p => {
                    const pStats = getProjectStats(p.id);
                    const transCount = transactions.filter(t => t.projectId === p.id).length;
                    return `<div class="project-summary-item${pStats.profit < 0 ? ' loss' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.375rem;">
                            <div style="flex: 1;">
                                <h3 style="font-weight: bold; font-size: 0.9375rem; margin-bottom: 0.25rem;">${p.name}</h3>
                                <p style="font-size: 0.6875rem; color: var(--text-secondary);">${p.client} ‚Ä¢ ${transCount} transaction${transCount !== 1 ? 's' : ''}</p>
                            </div>
                            <button onclick="showProjectDetail('${p.id}')" class="btn btn-small" style="background: var(--primary-color); color: white;">View</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.375rem; margin-top: 0.375rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.6875rem; color: var(--text-secondary);">Income</div>
                                <div style="font-weight: bold; color: #10b981; font-size: 0.8125rem;">$${pStats.income.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.6875rem; color: var(--text-secondary);">Expenses</div>
                                <div style="font-weight: bold; color: #ef4444; font-size: 0.8125rem;">$${pStats.expense.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.6875rem; color: var(--text-secondary);">Profit</div>
                                <div style="font-weight: bold; color: ${pStats.profit >= 0 ? '#10b981' : '#ef4444'}; font-size: 0.8125rem;">$${pStats.profit.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            
            const recentEl = document.getElementById('recent-transactions');
            if (transactions.length === 0) {
                recentEl.innerHTML = '<div class="empty-state">No transactions yet</div>';
            } else {
                const recent = transactions.slice(-5).reverse();
                recentEl.innerHTML = recent.map(t => {
                    const project = projects.find(p => p.id === t.projectId);
                    return `<div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-title">${t.category}</div>
                            <div class="transaction-meta">${project ? project.name : 'No Project'} ‚Ä¢ ${t.date}</div>
                        </div>
                        <div class="transaction-amount ${t.type === 'income' ? 'green' : 'red'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                        </div>
                    </div>`;
                }).join('');
            }
        }
        
        function renderTransactions() {
            const listEl = document.getElementById('transactions-list');
            if (transactions.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No transactions yet. Tap + to add your first transaction!</div>';
            } else {
                listEl.innerHTML = transactions.map(t => {
                    const project = projects.find(p => p.id === t.projectId);
                    return `<div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <span class="badge ${t.type === 'income' ? 'badge-income' : 'badge-expense'}">${t.type}</span>
                                <div style="font-weight: bold; margin: 0.375rem 0; font-size: 0.9375rem;">${t.category}</div>
                                ${t.description ? `<div style="font-size: 0.8125rem; color: var(--text-secondary);">${t.description}</div>` : ''}
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    ${project ? project.name : 'No Project'} ‚Ä¢ ${t.date}
                                    ${t.device ? ` ‚Ä¢ ${t.device}` : ''}
                                </div>
                                ${t.receipt ? '<div style="font-size: 0.6875rem; color: var(--primary-color); margin-top: 0.25rem;">üì∑ Receipt attached</div>' : ''}
                            </div>
                            <div style="text-align: right;">
                                <div class="transaction-amount ${t.type === 'income' ? 'green' : 'red'}">
                                    ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                                </div>
                                <div class="action-buttons">
                                    <button onclick="showEditTransaction('${t.id}')" class="btn btn-small btn-edit">Edit</button>
                                    <button onclick="deleteTransaction('${t.id}')" class="btn btn-small btn-delete">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        }
        
        function renderProjects() {
            const listEl = document.getElementById('projects-list');
            if (projects.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No projects yet. Tap + to add your first project!</div>';
            } else {
                listEl.innerHTML = projects.map(p => {
                    const stats = getProjectStats(p.id);
                    return `<div class="card">
                        <h3 style="font-size: 1rem; font-weight: bold;">${p.name}</h3>
                        <p style="font-size: 0.8125rem; color: var(--text-secondary);">Client: ${p.client}</p>
                        <p style="font-size: 0.6875rem; color: var(--text-secondary);">
                            Started: ${p.startDate}
                            ${p.device ? ` ‚Ä¢ Created on ${p.device}` : ''}
                        </p>
                        <div class="project-stats">
                            <div class="project-stat" style="background: #d1fae5;">
                                <div class="project-stat-label">Income</div>
                                <div class="project-stat-value" style="color: #065f46;">$${stats.income.toFixed(2)}</div>
                            </div>
                            <div class="project-stat" style="background: #fee2e2;">
                                <div class="project-stat-label">Expenses</div>
                                <div class="project-stat-value" style="color: #991b1b;">$${stats.expense.toFixed(2)}</div>
                            </div>
                            <div class="project-stat" style="background: #dbeafe;">
                                <div class="project-stat-label">Profit</div>
                                <div class="project-stat-value" style="color: ${stats.profit >= 0 ? '#065f46' : '#991b1b'};">$${stats.profit.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="project-actions">
                            <button onclick="showProjectDetail('${p.id}')" class="btn btn-small btn-primary" style="flex: 2;">Open Project</button>
                            <button onclick="showEditProject('${p.id}')" class="btn btn-small btn-edit">Edit</button>
                            <button onclick="deleteProject('${p.id}')" class="btn btn-small btn-delete">Delete</button>
                        </div>
                    </div>`;
                }).join('');
            }
        }
        
        // Initialize app
        loadTheme();
        loadData();
        updateSyncStatus('Loading...', false);
        updateLastSyncDisplay();
        
        // Prevent iOS rubber banding
        let lastY = 0;
        document.addEventListener('touchstart', e => {
            lastY = e.touches[0].clientY;
        }, { passive: false });
        
        document.addEventListener('touchmove', e => {
            const y = e.touches[0].clientY;
            const scrolling = document.scrollingElement.scrollTop;
            if (scrolling === 0 && y > lastY) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Connection status check only (no auto-sync)
        setInterval(() => {
            if (!navigator.onLine) {
                updateSyncStatus('Offline', false);
            } else if (cloudSync.apiKey) {
                updateSyncStatus('Ready', false);
            }
        }, 30000); // Check connection every 30 seconds
    </script>
</body>
</html>
